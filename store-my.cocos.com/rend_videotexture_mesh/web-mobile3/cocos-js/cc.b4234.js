System.register([],(function(e,t){"use strict";return{execute:function(){function n(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function i(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function r(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}e({BitMask:Xe,CCClass:Gt,CacheMode:void 0,DebugMode:void 0,Enum:Ye,Eventify:Fl,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:ob,WorldNode3DToWorldNodeUI:ab,absMax:_n,absMaxComponent:hn,approx:Yt,assert:L,assertID:Y,bezier:mf,bezierByTime:Nf,ccenum:Ze,clamp:Kt,clamp01:Qt,color:qn,computeRatioByType:Tz,createDefaultPipeline:wO,debug:B,deserialize:yh,earcut:OK,enumerableProps:fn,equals:Xt,error:N,errorID:W,find:AI,fragmentText:aH,getBaselineOffset:function(){return 0},getError:K,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[rc]},getWorldTransformUntilRoot:eG,instantiate:Bh,inverseLerp:un,isCustomTargetModifier:sG,isDisplayStats:Q,isElementModifier:aG,isPropertyModifier:oG,isUnicodeCJK:nH,isUnicodeSpace:iH,isValid:el,lerp:Zt,log:O,logID:G,markAsWarning:void 0,mat4:zn,murmurhash2_32_gc:oo,nextPow2:sn,pingPong:ln,pseudoRandom:rn,pseudoRandomRange:on,pseudoRandomRangeInt:an,quat:Mn,randomRange:tn,randomRangeInt:nn,rect:Vn,removeProperty:void 0,repeat:cn,replaceProperty:void 0,safeMeasureText:rH,sampleAnimationCurve:Sz,setDefaultLogTimes:function(e){e>0&&(tE=e)},setDisplayStats:Z,size:Gn,toDegree:$t,toRadian:Jt,v2:Sn,v3:vn,v4:En,warn:M,warnID:V});var o=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(o);var a=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(e){return(e>0)-(e<0)},abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:n,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:i,nextPow2:r,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return o[255&e]<<24|o[e>>>8&255]<<16|o[e>>>16&255]<<8|o[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>i(e)+1}});function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function l(){return(l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function u(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_(e,t)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _(e,t){return(_=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,n){return(d=f()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&_(r,n.prototype),r}).apply(null,arguments)}function p(e){var t="function"==typeof Map?new Map:void 0;return(p=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return d(e,arguments,h(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),_(i,e)})(e)}function m(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function g(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return v(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?v(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function y(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function x(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}e("bits",a);var S="undefined"==typeof window?global:window,T=e("cclegacy",{_global:S});T.internal={},S.CC_BUILD=!0,S.CC_TEST=!1,S.CC_EDITOR=false,S.CC_PREVIEW=!1,S.CC_DEV=!1,S.CC_DEBUG=!1,S.CC_JSB=!1,S.CC_BYTEDANCE=!1,S.CC_WECHAT=!1,S.CC_ALIPAY=!1,S.CC_XIAOMI=!1,S.CC_BAIDU=!1,S.CC_COCOSPLAY=!1,S.CC_HUAWEI=!1,S.CC_OPPO=!1,S.CC_VIVO=!1,S.CC_MINIGAME=!1,S.CC_RUNTIME_BASED=!1,S.CC_SUPPORT_JIT=!0;var E=e("VERSION","3.4.2");S.CocosEngine=T.ENGINE_VERSION=E,S.cc=T;var C="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",A=null,b=console.log.bind(console),P=b,R=b,w=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+D.apply(void 0,[t].concat(i)))}},I=b;function D(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return T.js.formatStr.apply(null,[e].concat(n))}function O(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return b.apply(void 0,[e].concat(n))}function M(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return P.apply(void 0,[e].concat(n))}function N(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return R.apply(void 0,[e].concat(n))}function L(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return w.apply(void 0,[e,t].concat(i))}function B(){return I.apply(void 0,arguments)}function F(e){if(b=P=R=w=I=function(){},e!==q.NONE){if(e>q.ERROR){var t=function(e){if(T.game.canvas){if(!A){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",T.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(A=document.createElement("textarea")).setAttribute("rows","20"),A.setAttribute("cols","30"),A.setAttribute("disabled","true");var i=A.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(A),T.game.canvas.parentNode.appendChild(t)}A.value=A.value+e+"\r\n",A.scrollTop=A.scrollHeight}};R=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+D.apply(void 0,[e].concat(i)))},w=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t("ASSERT: "+D.apply(void 0,[n].concat(r)))}},e!==q.ERROR_FOR_WEB_PAGE&&(P=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+D.apply(void 0,[e].concat(i)))}),e===q.INFO_FOR_WEB_PAGE&&(b=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(D.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),R=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},w=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=D.apply(void 0,[t].concat(i));throw new Error(o)}});if(e!==q.ERROR&&(P=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=q.INFO&&(b=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=q.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);I=function(){return n.apply(void 0,arguments)}}}}function z(e){N(e.stack||e)}function U(e){return function(t){for(var n=e+" "+t+", please go to "+C+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var k=U("Log");function G(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];O(k.apply(void 0,[e].concat(n)))}var H=U("Warning");function V(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];M(H.apply(void 0,[e].concat(n)))}var j=U("Error");function W(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];N(j.apply(void 0,[e].concat(n)))}var q,X=U("Assert");function Y(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];L(!1,X.apply(void 0,[t].concat(i)))}}function K(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return j.apply(void 0,[e].concat(n))}function Q(){return!!T.profiler&&T.profiler.isShowingStats()}function Z(e){T.profiler&&(e?T.profiler.showStats():T.profiler.hideStats(),T.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(q||(q=e("DebugMode",{})));var J=Object.freeze({__proto__:null,log:O,warn:M,error:N,assert:L,debug:B,_resetDebugSetting:F,_throw:z,logID:G,warnID:V,errorID:W,assertID:Y,get DebugMode(){return q},getError:K,isDisplayStats:Q,setDisplayStats:Z}),$=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},c(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function ee(e,t){e.splice(t,1)}function te(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function ne(e,t){var n=e.indexOf(t);return n>=0&&(ee(e,n),!0)}function ie(e,t){return e.indexOf(t)>=0}var re=Object.freeze({__proto__:null,removeAt:ee,fastRemoveAt:te,remove:ne,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return ee(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=g(e);!(n=i()).done;)if(!(n.value instanceof t))return G(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)ne(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:ie,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:$}),oe=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();oe.global=new oe("global");var ae=new oe("TmpCId."),se="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),ce="__cid__";function le(e){return"number"==typeof e||e instanceof Number}function ue(e){return"string"==typeof e||e instanceof String}function he(e){for(var t in e)return!1;return!0}var _e,fe=(_e={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){_e.value=n,_e.writable=i,_e.enumerable=r,Object.defineProperty(e,t,_e),_e.value=void 0}),de=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),e.get=i,e.set=r,e.enumerable=o,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),pe=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.get=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0}}(),me=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.set=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.set=void 0}}();function ve(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function ge(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?ge(e.constructor):""}function ye(e,t,n,i){var r=/([^.]+)$/,o=r.exec(t)[0],a=r.exec(n)[0];function s(){return this[a]}i?de(e,o,s,(function(e){this[a]=e})):pe(e,o,s)}function xe(e,t,n,i){for(var r in n)ye(e,t+"."+r,n[r],i)}var Se=/(%d)|(%s)/,Te=/%s/;function Ee(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&Se.test(e);if(r)for(var o,a=g(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?Se:Te;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=g(n);!(u=h()).done;){var _=u.value;e+=" "+_}return e}function Ce(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function Ae(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function be(e,t,n){var i=Ae(t,e);i&&Object.defineProperty(n,e,i)}function Pe(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){W(5402,a);continue}for(var s in a)s in e||be(s,a,e)}}return e}function Re(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){W(5403,a);continue}for(var s in a)be(s,a,e)}}return e}function we(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ie(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function De(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ie(e)))return!1;if(e===t)return!0}}return!1}function Oe(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Me=ve(!0),Ne=ve(!0);function Le(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],fe(i.prototype,e,n),n){var r=t[n];r&&r!==i?N("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var Be=Le("__cid__",Me),Fe=Le("__classname__",Ne);function ze(e,t){if(Fe(e,t),!t.prototype.hasOwnProperty(ce)){var n=e||ae.getNewId();n&&Be(n,t)}}function Ue(e,t){var n=Ne[t],i=Me[t],r=!0;if(n&&n!==e&&(N('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(N('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var o=e[se];o||(o=[],e[se]=o),o.push(t),Ne[t]=e,Me[t]=e}}function ke(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Me[s];var c=a.__classname__;c&&delete Ne[c];var l=a[se];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Ne[h],delete Me[h]}}}function Ge(e){return Me[e]}function He(e){return Ne[e]}function Ve(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(ce))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(ce))return e.__cid__}return""}var je=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),We=re,qe={IDGenerator:oe,Pool:je,array:re,isNumber:le,isString:ue,isEmptyObject:he,getPropertyDescriptor:Ae,addon:Pe,mixin:Re,extend:we,getSuper:Ie,isChildClassOf:De,clear:Oe,value:fe,getset:de,get:pe,set:me,unregisterClass:ke,getClassName:ge,setClassName:ze,setClassAlias:Ue,getClassByName:He,get _registeredClassNames(){return l({},Ne)},set _registeredClassNames(e){Oe(Ne),Object.assign(Ne,e)},get _registeredClassIds(){return l({},Me)},set _registeredClassIds(e){Oe(Me),Object.assign(Me,e)},_getClassId:Ve,_setClassId:Be,_getClassById:Ge,obsolete:ye,obsoletes:xe,formatStr:Ee,shiftArguments:Ce,createMap:ve};function Xe(e){if("__bitmask__"in e)return e;fe(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&fe(e,a,r)}return e}function Ye(e){return"__enums__"in e?e:(fe(e,"__enums__",null,!0),Ye.update(e))}function Ke(e){e.hasOwnProperty("__enums__")}function Qe(e){Ke(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function Ze(e){"__enums__"in e||fe(e,"__enums__",null,!0)}T.js=qe,e("js",Object.freeze({__proto__:null,array:We,js:qe,IDGenerator:oe,Pool:je,isNumber:le,isString:ue,isEmptyObject:he,value:fe,getset:de,get:pe,set:me,createMap:ve,getClassName:ge,obsolete:ye,obsoletes:xe,formatStr:Ee,shiftArguments:Ce,getPropertyDescriptor:Ae,addon:Pe,mixin:Re,extend:we,getSuper:Ie,isChildClassOf:De,clear:Oe,_idToClass:Me,_nameToClass:Ne,_setClassId:Be,setClassName:ze,setClassAlias:Ue,unregisterClass:ke,_getClassById:Ge,getClassByName:He,_getClassId:Ve})),Xe.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},Xe.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},T.BitMask=Xe,Ye.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&fe(e,a,r)}return Array.isArray(e.__enums__)&&Qe(e),e},Ye||(Ye=e("Enum",{})),Ye.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},Ye.getList=function(e){return Ke(e),e.__enums__?e.__enums__:Qe(e)},T.Enum=Ye;var Je=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return W(100,ge(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){W(100,ge(this)+".set")},t.toString=function(){return""+{}},e}());ze("cc.ValueType",Je),T.ValueType=Je;var $e=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});T.macro=$e;for(var et=/^(?:cc|dragonBones|sp|ccsg)\..+/,tt=new Array(123),nt=0;nt<123;++nt)tt[nt]=64;for(var it=0;it<64;++it)tt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(it)]=it;var rt=tt;function ot(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var o=e[n];de(e,t,o,e[i])}}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function at(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function st(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function ct(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function lt(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function ut(e){return!(!e||e.constructor!==Object)&&he(e)}function ht(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function _t(e){return e*$e.RAD}function ft(e){return e*$e.DEG}T.misc={BUILTIN_CLASSID_RE:et,BASE64_VALUES:rt,propertyDefine:ot,pushToMap:at,contains:st,isDomNode:ct,callInNextTick:lt,isPlainEmptyObj_DEV:ut,clampf:ht,degreesToRadians:_t,radiansToDegrees:ft},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:et,BASE64_VALUES:rt,propertyDefine:ot,pushToMap:at,contains:st,isDomNode:ct,callInNextTick:lt,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ut,clampf:ht,degreesToRadians:_t,radiansToDegrees:ft}));var dt="$_$";function pt(e,t){var n=t?Object.create(t):{};return fe(e,"__attrs__",n),n}function mt(e){if("function"!=typeof e)return pt(e,gt(e.constructor));for(var t,n=T.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||pt(r,(t=n[i+1])&&t.__attrs__)}return pt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function vt(e,t){var n=gt(e),i=t+dt,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function gt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||mt(e)}function yt(e,t,n,i){gt(e)[t+dt+n]=i}var xt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),St=e("CCInteger",new xt("Integer",0));T.Integer=St,T.CCInteger=St;var Tt=e("CCFloat",new xt("Float",0));T.Float=Tt,T.CCFloat=Tt;var Et=e("CCBoolean",new xt("Boolean",!1));T.Boolean=Et,T.CCBoolean=Et;var Ct=e("CCString",new xt("String",""));function At(e,t){return function(n,i){var r='"'+ge(n)+"."+i+'"',o=vt(n,i),a=o.type;if(a===St||a===Tt?a="Number":a!==Ct&&a!==Et||(a=""+a),a===e){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!ut(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;V(3605,r,ge(o.ctor))}else"Number"!==e&&V(3606,t,r,e);else{if("function"===c)return;e===Ct.default&&null==s?V(3607,r):V(3611,t,r,c)}delete o.type}}}else V(3604,r)}}T.String=Ct,T.CCString=Ct;var bt=Object.freeze({__proto__:null,DELIMETER:dt,createAttrsSingle:pt,createAttrs:mt,attr:vt,getClassAttrs:gt,setClassAttr:yt,PrimitiveType:xt,CCInteger:St,CCFloat:Tt,CCBoolean:Et,CCString:Ct,getTypeChecker_ET:At,getObjTypeChecker_ET:function(e){return function(t,n){At("Object","type")(t,n);var i=gt(t)[n+dt+"default"],r=T.Class.getDefault(i);if(!Array.isArray(r)&&De(e,T.ValueType)){var o=ge(e),a=Ee('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',ge(t),n,o);i?O(a):V(3612,a,o,ge(t),n,o)}}}}),Pt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Rt(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var o={};for(var a in i[r]=o,Pt){var s=Pt[a];e.hasOwnProperty(a)&&(o[a]=e[a],s.canUsedInGet||delete e[a])}}}function wt(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return W(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=T.String:t===Boolean?e.type=T.Boolean:t===Number&&(e.type=T.Float))}function It(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Dt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return It(t,[],e);if("function"==typeof e){var n=e;return It(t,De(n,T.ValueType)?new n:null,n)}return It(t,e instanceof xt?e.default:e)}return null}var Ot=[];function Mt(){return Ot[Ot.length-1]}T._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Ot.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Ot.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Mt};var Nt=dt,Lt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=ge(i);r?kt(i,o,r,i.$super,n.mixins):W(3633,o)}this.datas=null}}};function Bt(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),Vt(e,i,t,n)}function Ft(e,t,n,i){var r=i.get;i.set,r&&(Vt(e,i,t,n),yt(e,n,"serializable",!1))}function zt(e){return"function"==typeof e?e():e}function Ut(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,Ae(t,i))}function kt(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Dt(i,!1);if(r&&(i=e[n]=r),i){var o=i.notify;o&&Rt(i,n,o,e),"type"in i&&wt(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?Ft(e,t,s,c):Bt(e,t,s,c)}var l=gt(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Nt+"serializable"]}))}function Gt(e){var t=e.name,n=e.extends,i=e.mixins,r=function(e,t,n,i){var r=T.Component,o=Mt();if(o&&De(t,r)){if(De(o.cls,r))return W(3615),null;e=e||o.script}var a=function(e,t,n,i){var r=i.ctor,o=[r],a=r;fe(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Ut(s,l.prototype),Gt._isCCClass(l)&&Ut(gt(a),gt(l))}s.constructor=a}return ze(e,a),a}(e,t,n,i);if(o)if(De(t,r)){var s=o.uuid;s&&Be(s,a),o.cls=a}else De(o.cls,r)||(o.cls=a);return a}(t,n,i,e);t||(t=T.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var o=e.properties;"function"==typeof o||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(Lt.push({cls:r,props:o,mixins:i}),r.__props__=r.__values__=null):kt(r,t,o,n,e.mixins);var a=e.editor;return a&&De(n,T.Component)&&T.Component._registerEditorProps(r,a),r}Gt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},Gt.fastDefine=function(e,t,n){ze(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=gt(t),o=0;o<i.length;o++){var a=i[o];r[a+Nt+"visible"]=!1,r[a+Nt+"default"]=n[a]}},Gt.Attr=bt,Gt.attr=vt,Gt.getInheritanceChain=function(e){for(var t=[];e=Ie(e);)e!==Object&&t.push(e);return t};var Ht={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Vt(e,t,n,i){var r=null,o="";function a(){return o=i+Nt,r=gt(e)}"type"in t&&void 0===t.type&&V(3660,i,n);var s=t.type;s&&(Ht[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?Ye.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=Ye.getList(s)):Xe.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=Xe.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in t&&((r||a())[o+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||a())[o+e]=i)}};t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.__noImplicit?(r||a())[o+"serializable"]=null!==(c=t.serializable)&&void 0!==c&&c:!1===t.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Gt.isArray=function(e){return e=zt(e),Array.isArray(e)},Gt.getDefault=zt,Gt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Gt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Gt.getNewValueTypeCode=function(e){for(var t=ge(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},T.Class=Gt;var jt=Math.PI/180,Wt=180/Math.PI,qt=e("EPSILON",1e-6);function Xt(e,t){return Math.abs(e-t)<=qt*Math.max(1,Math.abs(e),Math.abs(t))}function Yt(e,t,n){return n=n||qt,Math.abs(e-t)<=n}function Kt(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function Qt(e){return e<0?0:e>1?1:e}function Zt(e,t,n){return e+(t-e)*n}function Jt(e){return e*jt}function $t(e){return e*Wt}var en=e("random",Math.random);function tn(e,t){return Math.random()*(t-e)+e}function nn(e,t){return Math.floor(tn(e,t))}function rn(e){return(e=(9301*e+49297)%233280)/233280}function on(e,t,n){return rn(e)*(n-t)+t}function an(e,t,n){return Math.floor(on(e,t,n))}function sn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function cn(e,t){return e-Math.floor(e/t)*t}function ln(e,t){return e=cn(e,2*t),t-Math.abs(e-t)}function un(e,t,n){return(n-e)/(t-e)}function hn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function _n(e,t){return Math.abs(e)>Math.abs(t)?e:t}function fn(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var dn=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}u(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<qt?e.x=0:e.x=1/n,Math.abs(i)<qt?e.y=0:e.y=1/i,Math.abs(r)<qt?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z;return e.x=r*c-o*s,e.y=o*a-i*c,e.z=i*s-r*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*en()*Math.PI,i=2*en()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,e.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,e.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o)*a,e.y=(n.m01*i+n.m05*r+n.m09*o)*a,e.z=(n.m02*i+n.m06*r+n.m10*o)*a,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=i*n.m00+r*n.m03+o*n.m06,e.y=i*n.m01+r*n.m04+o*n.m07,e.z=i*n.m02+r*n.m05+o*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13,e.x=n.m02*i+n.m06*r+n.m10*o+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,o=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,e.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,e.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var o=t.x*r.x,a=t.y*r.y,s=t.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var o=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=qt);var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},t.angle=function(e,n){t.normalize(pn,e),t.normalize(mn,n);var i=t.dot(pn,mn);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=qt),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=qt),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=Kt(this.x,e.x,t.x),this.y=Kt(this.y,e.y,t.y),this.z=Kt(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(Je));dn.UNIT_X=Object.freeze(new dn(1,0,0)),dn.UNIT_Y=Object.freeze(new dn(0,1,0)),dn.UNIT_Z=Object.freeze(new dn(0,0,1)),dn.RIGHT=Object.freeze(new dn(1,0,0)),dn.UP=Object.freeze(new dn(0,1,0)),dn.FORWARD=Object.freeze(new dn(0,0,-1)),dn.ZERO=Object.freeze(new dn(0,0,0)),dn.ONE=Object.freeze(new dn(1,1,1)),dn.NEG_ONE=Object.freeze(new dn(-1,-1,-1));var pn=new dn,mn=new dn;function vn(e,t,n){return new dn(e,t,n)}Gt.fastDefine("cc.Vec3",dn,{x:0,y:0,z:0}),T.Vec3=dn,T.v3=vn;var gn=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}u(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<qt?e.x=0:e.x=1/n,Math.abs(i)<qt?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof dn?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,o=t.y;return e.x=r+i*(n.x-r),e.y=o+i*(n.y-o),e},t.random=function(e,t){t=t||1;var n=2*en()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=qt),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(yn,e),t.normalize(xn,n);var i=t.dot(yn,xn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=qt),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=qt),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=Kt(this.x,e.x,t.x),this.y=Kt(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=Kt(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(Je));gn.ZERO=Object.freeze(new gn(0,0)),gn.ONE=Object.freeze(new gn(1,1)),gn.NEG_ONE=Object.freeze(new gn(-1,-1)),gn.UNIT_X=Object.freeze(new gn(1,0)),gn.UNIT_Y=Object.freeze(new gn(0,1));var yn=new gn,xn=new gn;function Sn(e,t){return new gn(e,t)}Gt.fastDefine("cc.Vec2",gn,{x:0,y:0}),T.Vec2=gn,T.v2=Sn;var Tn=e("Vec4",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=r||0),o}u(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return n*n+i*i+r*r+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w;return Math.abs(n)<qt?e.x=0:e.x=1/n,Math.abs(i)<qt?e.y=0:e.y=1/i,Math.abs(r)<qt?e.z=0:e.z=1/r,Math.abs(o)<qt?e.w=0:e.w=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a,e.w=o*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*en()*Math.PI,i=2*en()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,e.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,e.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return e.x=u*l+f*-a+h*-c-_*-s,e.y=h*l+f*-s+_*-a-u*-c,e.z=_*l+f*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=qt),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=qt),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=qt),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=Kt(this.x,e.x,t.x),this.y=Kt(this.y,e.y,t.y),this.z=Kt(this.z,e.z,t.z),this.w=Kt(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(Je));function En(e,t,n,i){return new Tn(e,t,n,i)}Tn.ZERO=Object.freeze(new Tn(0,0,0,0)),Tn.ONE=Object.freeze(new Tn(1,1,1,1)),Tn.NEG_ONE=Object.freeze(new Tn(-1,-1,-1,-1)),Gt.fastDefine("cc.Vec4",Tn,{x:0,y:0,z:0,w:0}),T.Vec4=Tn,T.v4=En;var Cn=e("Mat3",function(e){function t(t,n,i,r,o,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}u(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,o,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,d=n*h+i*_+r*f;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=h*d,e.m01=(-u*i+r*l)*d,e.m02=(s*i-r*a)*d,e.m03=_*d,e.m04=(u*n-r*c)*d,e.m05=(-s*n+r*o)*d,e.m06=f*d,e.m07=(-l*n+i*c)*d,e.m08=(a*n-i*o)*d,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return e.m00=_*i+f*a+d*l,e.m01=_*r+f*s+d*u,e.m02=_*o+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*r+m*s+v*u,e.m05=p*o+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*r+y*s+x*u,e.m08=g*o+y*c+x*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return e.m00=_*i+f*a+d*l,e.m01=_*r+f*s+d*u,e.m02=_*o+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*r+m*s+v*u,e.m05=p*o+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*r+y*s+x*u,e.m08=g*o+y*c+x*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=_*i+f*a+l,e.m07=_*r+f*s+u,e.m08=_*o+f*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*a,e.m01=f*r+_*s,e.m02=f*o+_*c,e.m03=f*a-_*i,e.m04=f*s-_*r,e.m05=f*c-_*o,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return dn.lengthSqr(n)<qt*qt?(t.identity(e),e):(i=i||dn.UNIT_Y,dn.normalize(An,dn.cross(An,i,n)),dn.lengthSqr(An)<qt*qt?(t.identity(e),e):(dn.cross(bn,n,An),t.set(e,An.x,An.y,An.z,bn.x,bn.y,bn.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return e.m00=1-h-d,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-d,e.m07=f-p,e.m02=_-m,e.m05=f+p,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,E=r*l-o*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,P=h*m-_*p,R=h*v-f*p,w=_*v-f*m,I=g*w-y*R+x*P+S*b-T*A+E*C;return I?(I=1/I,e.m00=(s*w-c*R+l*P)*I,e.m01=(c*b-a*w-l*A)*I,e.m02=(a*R-s*b+l*C)*I,e.m03=(r*R-i*w-o*P)*I,e.m04=(n*w-r*b+o*A)*I,e.m05=(i*b-n*R-o*C)*I,e.m06=(p*E-m*T+v*S)*I,e.m07=(m*x-d*E-v*y)*I,e.m08=(d*T-p*x+v*g)*I,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=qt),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,o,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=qt),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(o*t-n*r)*_,this.m03=u*_,this.m04=(c*e-n*a)*_,this.m05=(-o*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*a)*_,this.m08=(r*e-t*i)*_,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*t+d*r+p*s,this.m04=f*n+d*o+p*c,this.m05=f*i+d*a+p*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*t,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+p,this.m01=l+m,this.m04=1-c-f,this.m07=_-d,this.m02=h-p,this.m05=_+d,this.m08=1-c-u,this},t}(Je));Cn.IDENTITY=Object.freeze(new Cn);var An=new dn,bn=new dn;Gt.fastDefine("cc.Mat3",Cn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),T.Mat3=Cn;var Pn=e("Quat",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}u(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=dn.dot(n,i);return r<-.999999?(dn.cross(In,dn.UNIT_X,n),In.length()<1e-6&&dn.cross(In,dn.UNIT_Y,n),dn.normalize(In,In),t.fromAxisAngle(e,In,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(dn.cross(In,n,i),e.x=In.x,e.y=In.y,e.z=In.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,o=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=o,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+c*i,e.y=a*r+s*i,e.z=s*r-a*i,e.w=c*r-o*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r-s*i,e.y=a*r+c*i,e.z=s*r+o*i,e.w=c*r-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+a*i,e.y=a*r-o*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(Rn,n),dn.transformQuat(In,i,Rn),t.fromAxisAngle(Rn,In,r),t.multiply(e,n,Rn),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(Rn,i,r),t.multiply(e,n,Rn),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return e.x=r*t.x+o*a,e.y=r*t.y+o*s,e.z=r*t.z+o*c,e.w=r*t.w+o*l,e},t.sqlerp=function(e,n,i,r,o,a){return t.slerp(Rn,n,o,a),t.slerp(wn,i,r,a),t.slerp(e,Rn,wn,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return Cn.set(Dn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,Dn))},t.fromViewUp=function(e,n,i){return Cn.fromViewUp(Dn,n,i),t.normalize(e,t.fromMat3(e,Dn))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(r-c)*_,e.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+o)/f,e.z=(r+c)/f}else if(a>u){var d=2*Math.sqrt(1+a-n-u);e.w=(r-c)/d,e.x=(i+o)/d,e.y=.25*d,e.z=(s+l)/d}else{var p=2*Math.sqrt(1+u-n-a);e.w=(o-i)/p,e.x=(r+c)/p,e.y=(s+l)/p,e.z=.25*p}return e},t.fromEuler=function(e,t,n,i){t*=On,n*=On,i*=On;var r=Math.sin(t),o=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+o*a*c,e.y=o*a*l+r*s*c,e.z=o*s*c-r*a*l,e.w=o*s*l-r*a*c,e},t.fromAngleZ=function(e,t){return t*=On,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=$t(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-$t(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=$t(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=$t(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=$t(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=qt),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=qt),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(Je));Pn.IDENTITY=Object.freeze(new Pn);var Rn=new Pn,wn=new Pn,In=new dn,Dn=new Cn,On=.5*Math.PI/180;function Mn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new Pn(e,t,n,i)}Gt.fastDefine("cc.Quat",Pn,{x:0,y:0,z:0,w:1}),T.Quat=Pn,T.quat=Mn;var Nn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Ln=e("Mat4",function(e){function t(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=d,v.m14=p,v.m15=m),v}u(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=d,e.m14=p,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,E=r*l-o*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,P=h*m-_*p,R=h*v-f*p,w=_*v-f*m,I=g*w-y*R+x*P+S*b-T*A+E*C;return 0===I?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(I=1/I,e.m00=(s*w-c*R+l*P)*I,e.m01=(r*R-i*w-o*P)*I,e.m02=(p*E-m*T+v*S)*I,e.m03=(_*T-h*E-f*S)*I,e.m04=(c*b-a*w-l*A)*I,e.m05=(n*w-r*b+o*A)*I,e.m06=(m*x-d*E-v*y)*I,e.m07=(u*E-_*x+f*y)*I,e.m08=(a*R-s*b+l*C)*I,e.m09=(i*b-n*R-o*C)*I,e.m10=(d*T-p*x+v*g)*I,e.m11=(h*x-u*T-f*g)*I,e.m12=(s*A-a*P-c*C)*I,e.m13=(n*P-i*A+r*C)*I,e.m14=(p*y-d*S-m*g)*I,e.m15=(u*S-h*y+_*g)*I,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,d=e.m13,p=e.m14,m=e.m15;return(t*a-n*o)*(h*m-_*p)-(t*s-i*o)*(u*m-_*d)+(t*c-r*o)*(u*p-h*d)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*p-h*f)+(i*c-r*s)*(l*d-u*f)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,d=t.m11,p=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,x=n.m01,S=n.m02,T=n.m03;return e.m00=y*i+x*s+S*h+T*p,e.m01=y*r+x*c+S*_+T*m,e.m02=y*o+x*l+S*f+T*v,e.m03=y*a+x*u+S*d+T*g,y=n.m04,x=n.m05,S=n.m06,T=n.m07,e.m04=y*i+x*s+S*h+T*p,e.m05=y*r+x*c+S*_+T*m,e.m06=y*o+x*l+S*f+T*v,e.m07=y*a+x*u+S*d+T*g,y=n.m08,x=n.m09,S=n.m10,T=n.m11,e.m08=y*i+x*s+S*h+T*p,e.m09=y*r+x*c+S*_+T*m,e.m10=y*o+x*l+S*f+T*v,e.m11=y*a+x*u+S*d+T*g,y=n.m12,x=n.m13,S=n.m14,T=n.m15,e.m12=y*i+x*s+S*h+T*p,e.m13=y*r+x*c+S*_+T*m,e.m14=y*o+x*l+S*f+T*v,e.m15=y*a+x*u+S*d+T*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,o=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*o+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*o+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*o+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*o+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,d=t.m08,p=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=d,e.m09=p,e.m10=m,e.m11=v,e.m12=a*i+u*r+d*o+t.m12,e.m13=s*i+h*r+p*o+t.m13,e.m14=c*i+_*r+m*o+t.m14,e.m15=l*i+f*r+v*o+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,o=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<qt)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,d=t.m03,p=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,x=t.m09,S=t.m10,T=t.m11,E=r*r*u+l,C=o*r*u+a*c,A=a*r*u-o*c,b=r*o*u-a*c,P=o*o*u+l,R=a*o*u+r*c,w=r*a*u+o*c,I=o*a*u-r*c,D=a*a*u+l;return e.m00=h*E+p*C+y*A,e.m01=_*E+m*C+x*A,e.m02=f*E+v*C+S*A,e.m03=d*E+g*C+T*A,e.m04=h*b+p*P+y*R,e.m05=_*b+m*P+x*R,e.m06=f*b+v*P+S*R,e.m07=d*b+g*P+T*R,e.m08=h*w+p*I+y*D,e.m09=_*w+m*I+x*D,e.m10=f*w+v*I+S*D,e.m11=d*w+g*I+T*D,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*r+l*i,e.m05=a*r+u*i,e.m06=s*r+h*i,e.m07=c*r+_*i,e.m08=l*r-o*i,e.m09=u*r-a*i,e.m10=h*r-s*i,e.m11=_*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r-l*i,e.m01=a*r-u*i,e.m02=s*r-h*i,e.m03=c*r-_*i,e.m08=o*i+l*r,e.m09=a*i+u*r,e.m10=s*i+h*r,e.m11=c*i+_*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r+l*i,e.m01=a*r+u*i,e.m02=s*r+h*i,e.m03=c*r+_*i,e.m04=l*r-o*i,e.m05=u*r-a*i,e.m06=h*r-s*i,e.m07=_*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<qt)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+o*s,e.m02=o*i*l-r*s,e.m03=0,e.m04=i*r*l-o*s,e.m05=r*r*l+c,e.m06=o*r*l+i*s,e.m07=0,e.m08=i*o*l+r*s,e.m09=r*o*l-i*s,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(f+p),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+p),e.m06=d+m,e.m07=0,e.m08=_+v,e.m09=d-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Fn.m00=t.m00,i=Fn.m01=t.m01,r=Fn.m02=t.m02,o=Fn.m03=t.m04,a=Fn.m04=t.m05,s=Fn.m05=t.m06,c=Fn.m06=t.m08,l=Fn.m07=t.m09,u=Fn.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Cn.determinant(Fn)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=dn.set(Bn,e.m00,e.m01,e.m02).length(),Fn.m00=e.m00/i.x,Fn.m01=e.m01/i.x,Fn.m02=e.m02/i.x,i.y=dn.set(Bn,e.m04,e.m05,e.m06).length(),Fn.m03=e.m04/i.y,Fn.m04=e.m05/i.y,Fn.m05=e.m06/i.y,i.z=dn.set(Bn,e.m08,e.m09,e.m10).length(),Fn.m06=e.m08/i.z,Fn.m07=e.m09/i.z,Fn.m08=e.m10/i.z,Cn.determinant(Fn)<0&&(i.x*=-1,Fn.m00*=-1,Fn.m01*=-1,Fn.m02*=-1),Pn.fromMat3(t,Fn),dn.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=t.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,d=o*l,p=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,T=i.z;return e.m00=(1-(d+m))*x,e.m01=(_+y)*x,e.m02=(f-g)*x,e.m03=0,e.m04=(_-y)*S,e.m05=(1-(h+m))*S,e.m06=(p+v)*S,e.m07=0,e.m08=(f+g)*T,e.m09=(p-v)*T,e.m10=(1-(h+d))*T,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var o=t.x,a=t.y,s=t.z,c=t.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,d=o*h,p=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,T=i.y,E=i.z,C=r.x,A=r.y,b=r.z;return e.m00=(1-(p+v))*S,e.m01=(f+x)*S,e.m02=(d-y)*S,e.m03=0,e.m04=(f-x)*T,e.m05=(1-(_+v))*T,e.m06=(m+g)*T,e.m07=0,e.m08=(d+y)*E,e.m09=(m-g)*E,e.m10=(1-(_+p))*E,e.m11=0,e.m12=n.x+C-(e.m00*C+e.m04*A+e.m08*b),e.m13=n.y+A-(e.m01*C+e.m05*A+e.m09*b),e.m14=n.z+b-(e.m02*C+e.m06*A+e.m10*b),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return e.m00=1-h-d,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-d,e.m06=f+p,e.m07=0,e.m08=_+m,e.m09=f-p,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),c=1/(r-i),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=Nn[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,d=-2*h,p=(t+n)*u,m=(r+i)*h,v=Nn[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=d*v[2],e.m05=d*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=p*v[0]+m*v[2],e.m13=p*v[1]+m*v[3],e.m14=(o-s*a)*_,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),d=c*(_*=f)-l*(h*=f),p=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(d*d+p*p+m*m))-_*(p*=f),g=_*(d*=f)-u*m,y=u*p-h*d;return e.m00=d,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(d*r+p*o+m*a),e.m13=-(v*r+g*o+y*a),e.m14=-(u*r+h*o+_*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,E=r*l-o*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,P=h*m-_*p,R=h*v-f*p,w=_*v-f*m,I=g*w-y*R+x*P+S*b-T*A+E*C;return I?(I=1/I,e.m00=(s*w-c*R+l*P)*I,e.m01=(c*b-a*w-l*A)*I,e.m02=(a*R-s*b+l*C)*I,e.m03=0,e.m04=(r*R-i*w-o*P)*I,e.m05=(n*w-r*b+o*A)*I,e.m06=(i*b-n*R-o*C)*I,e.m07=0,e.m08=(p*E-m*T+v*S)*I,e.m09=(m*x-d*E-v*y)*I,e.m10=(d*T-p*x+v*g)*I,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=qt),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=d,this.m15=p,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=qt),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15,m=e*o-t*r,v=e*a-n*r,g=e*s-i*r,y=t*a-n*o,x=t*s-i*o,S=n*s-i*a,T=c*f-l*_,E=c*d-u*_,C=c*p-h*_,A=l*d-u*f,b=l*p-h*f,P=u*p-h*d,R=m*P-v*b+g*A+y*C-x*E+S*T;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(o*P-a*b+s*A)*R,this.m01=(n*b-t*P-i*A)*R,this.m02=(f*S-d*x+p*y)*R,this.m03=(u*x-l*S-h*y)*R,this.m04=(a*C-r*P-s*E)*R,this.m05=(e*P-n*C+i*E)*R,this.m06=(d*g-_*S-p*v)*R,this.m07=(c*S-u*g+h*v)*R,this.m08=(r*b-o*C+s*T)*R,this.m09=(t*C-e*b-i*T)*R,this.m10=(_*x-f*g+p*m)*R,this.m11=(l*g-c*x-h*m)*R,this.m12=(o*E-r*A-a*T)*R,this.m13=(e*A-t*E+n*T)*R,this.m14=(f*v-_*y-d*m)*R,this.m15=(c*y-l*v+u*m)*R,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15;return(e*o-t*r)*(u*p-h*d)-(e*a-n*r)*(l*p-h*f)+(e*s-i*r)*(l*d-u*f)+(t*a-n*o)*(c*p-h*_)-(t*s-i*o)*(c*d-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,d=this.m13,p=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,x=e.m03;return this.m00=v*t+g*o+y*l+x*f,this.m01=v*n+g*a+y*u+x*d,this.m02=v*i+g*s+y*h+x*p,this.m03=v*r+g*c+y*_+x*m,v=e.m04,g=e.m05,y=e.m06,x=e.m07,this.m04=v*t+g*o+y*l+x*f,this.m05=v*n+g*a+y*u+x*d,this.m06=v*i+g*s+y*h+x*p,this.m07=v*r+g*c+y*_+x*m,v=e.m08,g=e.m09,y=e.m10,x=e.m11,this.m08=v*t+g*o+y*l+x*f,this.m09=v*n+g*a+y*u+x*d,this.m10=v*i+g*s+y*h+x*p,this.m11=v*r+g*c+y*_+x*m,v=e.m12,g=e.m13,y=e.m14,x=e.m15,this.m12=v*t+g*o+y*l+x*f,this.m13=v*n+g*a+y*u+x*d,this.m14=v*i+g*s+y*h+x*p,this.m15=v*r+g*c+y*_+x*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<qt)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,d=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,T=i*n*c+r*a,E=r*n*c-i*a,C=n*i*c-r*a,A=i*i*c+s,b=r*i*c+n*a,P=n*r*c+i*a,R=i*r*c-n*a,w=r*r*c+s;return this.m00=l*S+f*T+v*E,this.m01=u*S+d*T+g*E,this.m02=h*S+p*T+y*E,this.m03=_*S+m*T+x*E,this.m04=l*C+f*A+v*b,this.m05=u*C+d*A+g*b,this.m06=h*C+p*A+y*b,this.m07=_*C+m*A+x*b,this.m08=l*P+f*R+v*w,this.m09=u*P+d*R+g*w,this.m10=h*P+p*R+y*w,this.m11=_*P+m*R+x*w,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Fn.m00=this.m00,n=Fn.m01=this.m01,i=Fn.m02=this.m02,r=Fn.m03=this.m04,o=Fn.m04=this.m05,a=Fn.m05=this.m06,s=Fn.m06=this.m08,c=Fn.m07=this.m09,l=Fn.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),Cn.determinant(Fn)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(f+p))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+p))*x,this.m06=(d+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(d-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-p,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+d,this.m07=0,this.m08=h+p,this.m09=_-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(Je));Ln.IDENTITY=Object.freeze(new Ln);var Bn=new dn,Fn=new Cn;function zn(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new Ln(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p)}Gt.fastDefine("cc.Mat4",Ln,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),T.Mat4=Ln,T.mat4=zn;var Un=e("AffineTransform",function(){function e(e,t,n,i,r,o){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=o}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=o*n.a+a*n.c,e.d=o*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,o;void 0===i?(i=n,r=t.x,o=t.y):(r=t,o=n),e.x=i.a*r+i.c*o+i.tx,e.y=i.b*r+i.d*o+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,o=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);e.x=f,e.y=p,e.width=d-f,e.height=m-p},e.transformObb=function(e,t,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());T.AffineTransform=Un;var kn=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}u(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},c(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(Je));function Gn(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new kn(e,t)}kn.ZERO=Object.freeze(new kn(0,0)),kn.ONE=Object.freeze(new kn(1,1)),Gt.fastDefine("cc.Size",kn,{width:0,height:0}),T.size=Gn,T.Size=kn;var Hn=e("Rect",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.y=t.y,o.width=t.width,o.height=t.height,o.x=t.x):(o.x=t||0,o.y=n||0,o.width=i||0,o.height=r||0),o}u(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),o=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=o-i,e.height=a-r,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y,a=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=o+(n.y-o)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,o=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,o=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+o,s+l)-e.x,e.height=Math.max(r+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,o=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,_=e.m01*i+e.m05*r+e.m13,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=p,this.width=d-f,this.height=m-p,this},n.transformMat4ToPoints=function(e,t,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*o+e.m04*c+e.m12,n.y=e.m01*o+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},c(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new gn(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new gn(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new kn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(Je));function Vn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new Hn(e,t,n,i)}Gt.fastDefine("cc.Rect",Hn,{x:0,y:0,width:0,height:0}),T.Rect=Hn,T.rect=Vn;var jn=1/255,Wn=e("Color",function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this)._val=0,"string"==typeof t?o.fromHEX(t):void 0!==n?o.set(t,n,i,r):o.set(t),o}u(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var n=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(n)?255:n,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,o=t.g,a=t.b,s=t.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=qt),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*jn).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,o=0;if(0===t)i=r=o=n;else if(0===n)i=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*jn,t=this.g*jn,n=this.b*jn,i={h:0,s:0,v:0},r=Math.max(e,t,n),o=Math.min(e,t,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=e===r?(t-n)/a:t===r?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},c(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~Kt(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~Kt(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~Kt(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~Kt(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*jn},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*jn},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*jn},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*jn},set:function(e){this.a=255*e}}]),t}(Je));function qn(e,t,n,i){return new Wn(e,t,n,i)}Wn.WHITE=Object.freeze(new Wn(255,255,255,255)),Wn.GRAY=Object.freeze(new Wn(127,127,127,255)),Wn.BLACK=Object.freeze(new Wn(0,0,0,255)),Wn.TRANSPARENT=Object.freeze(new Wn(0,0,0,0)),Wn.RED=Object.freeze(new Wn(255,0,0,255)),Wn.GREEN=Object.freeze(new Wn(0,255,0,255)),Wn.BLUE=Object.freeze(new Wn(0,0,255,255)),Wn.CYAN=Object.freeze(new Wn(0,255,255,255)),Wn.MAGENTA=Object.freeze(new Wn(255,0,255,255)),Wn.YELLOW=Object.freeze(new Wn(255,255,0,255)),Gt.fastDefine("cc.Color",Wn,{r:0,g:0,b:0,a:255}),T.Color=Wn,T.color=qn;var Xn=e("MATH_FLOAT_ARRAY",Float64Array),Yn=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.createFloatArray=function(e){return new Xn(e)},c(t,[{key:"array",get:function(){return this._array}}]),t}(Je)),Kn=Object.freeze({__proto__:null,bits:a,Vec2:gn,v2:Sn,Vec3:dn,v3:vn,Vec4:Tn,v4:En,Quat:Pn,quat:Mn,Mat3:Cn,Mat4:Ln,mat4:zn,AffineTransform:Un,Size:kn,size:Gn,Rect:Hn,rect:Vn,Color:Wn,color:qn,EPSILON:qt,equals:Xt,approx:Yt,clamp:Kt,clamp01:Qt,lerp:Zt,toRadian:Jt,toDegree:$t,random:en,randomRange:tn,randomRangeInt:nn,pseudoRandom:rn,pseudoRandomRange:on,pseudoRandomRangeInt:an,nextPow2:sn,repeat:cn,pingPong:ln,inverseLerp:un,absMaxComponent:hn,absMax:_n,enumerableProps:fn,MATH_FLOAT_ARRAY:Xn,MathBase:Yn});e("math",Kn);var Qn,Zn,Jn,$n,ei,ti,ni,ii,ri,oi,ai,si,ci,li,ui,hi,_i,fi,di,pi,mi,vi,gi,yi,xi,Si,Ti,Ei,Ci,Ai,bi,Pi,Ri,wi,Ii,Di,Oi,Mi,Ni,Li,Bi,Fi=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(Qn||(Qn={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(Zn||(Zn={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(Jn||(Jn={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}($n||($n={})),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_SRGB=7]="FORMAT_SRGB",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.FORMAT_RGB8=13]="FORMAT_RGB8",e[e.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=17]="BLEND_MINMAX",e[e.COMPUTE_SHADER=18]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=20]="COUNT"}(ei||(ei={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(ti||(ti={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(ni||(ni={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(ii||(ii={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(ri||(ri={})),function(e){e[e.NONE=0]="NONE"}(oi||(oi={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(ai||(ai={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(si||(si={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(ci||(ci={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(li||(li={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(ui||(ui={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(hi||(hi={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(_i||(_i={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(fi||(fi={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(di||(di={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(pi||(pi={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(mi||(mi={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(vi||(vi={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(gi||(gi={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(yi||(yi={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(xi||(xi={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Si||(Si={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Ti||(Ti={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(Ei||(Ei={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Ci||(Ci={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Ai||(Ai={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(bi||(bi={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Pi||(Pi={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Ri||(Ri={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(wi||(wi={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Ii||(Ii={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(Di||(Di={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Oi||(Oi={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Mi||(Mi={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(Ni||(Ni={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(Li||(Li={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Bi||(Bi={}));var zi,Ui=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),ki=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=new Ui),void 0===v&&(v=new Ui),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=d,this.maxComputeWorkGroupInvocations=p,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),Gi=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),Hi=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),Vi=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),ji=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),Wi=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),qi=function(){function e(e,t,n,i,r){void 0===e&&(e=new ji),void 0===t&&(t=new Gi),void 0===n&&(n=new ji),void 0===i&&(i=new Gi),void 0===r&&(r=new Vi),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),Xi=function(){function e(e,t,n,i,r,o){void 0===e&&(e=new ji),void 0===t&&(t=new Gi),void 0===n&&(n=new Vi),void 0===i&&(i=new ji),void 0===r&&(r=new Gi),void 0===o&&(o=new Vi),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),Yi=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new Gi),void 0===i&&(i=new Vi),void 0===r&&(r=new ji),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),Ki=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),Qi=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),Zi=function(){function e(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=0),this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=n}return e.prototype.copy=function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this},e}(),Ji=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=_i.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),$i=function(){function e(e){void 0===e&&(e=new Zi),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),er=function(){function e(e,t,n,i,r){void 0===e&&(e=ri.NONE),void 0===t&&(t=si.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=oi.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),tr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),nr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),ir=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),rr=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return Fi(this.drawInfos,e.drawInfos,nr),this},e}(),or=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=ci.TEX2D),void 0===t&&(t=li.NONE),void 0===n&&(n=ti.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=ui.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=hi.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),ar=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=null),void 0===t&&(t=ci.TEX2D),void 0===n&&(n=ti.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),sr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=fi.LINEAR),void 0===t&&(t=fi.LINEAR),void 0===n&&(n=fi.NONE),void 0===i&&(i=di.WRAP),void 0===r&&(r=di.WRAP),void 0===o&&(o=di.WRAP),void 0===a&&(a=0),void 0===s&&(s=pi.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),cr=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=ii.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),lr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,Fi(this.members,e.members,cr),this.count=e.count,this},e}(),ur=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=ii.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),hr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),_r=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=ii.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),fr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=ii.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=ai.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),dr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=ai.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),pr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),mr=function(){function e(e,t){void 0===e&&(e=xi.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),vr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=""),void 0===t&&(t=ti.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),gr=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,Fi(this.stages,e.stages,mr),Fi(this.attributes,e.attributes,vr),Fi(this.blocks,e.blocks,lr),Fi(this.buffers,e.buffers,dr),Fi(this.samplerTextures,e.samplerTextures,ur),Fi(this.samplers,e.samplers,hr),Fi(this.textures,e.textures,_r),Fi(this.images,e.images,fr),Fi(this.subpassInputs,e.subpassInputs,pr),this},e}(),yr=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return Fi(this.attributes,e.attributes,vr),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),xr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=ti.UNKNOWN),void 0===t&&(t=hi.ONE),void 0===n&&(n=Si.CLEAR),void 0===i&&(i=Ti.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Ei.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Sr=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=ti.UNKNOWN),void 0===t&&(t=hi.ONE),void 0===n&&(n=Si.CLEAR),void 0===i&&(i=Ti.STORE),void 0===r&&(r=Si.CLEAR),void 0===o&&(o=Ti.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Ei.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Tr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Ci.NONE),void 0===s&&(s=Ci.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),Er=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=e,this.dstSubpass=t,this.srcAccesses=n,this.dstAccesses=i}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this},e}(),Cr=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Sr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return Fi(this.colorAttachments,e.colorAttachments,xr),this.depthStencilAttachment.copy(e.depthStencilAttachment),Fi(this.subpasses,e.subpasses,Tr),Fi(this.dependencies,e.dependencies,Er),this},e}(),Ar=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this},e}(),br=function(){function e(e,t,n,i,r){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),Pr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),Rr=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=Oi.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=xi.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),wr=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return Fi(this.bindings,e.bindings,Rr),this},e}(),Ir=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),Dr=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),Or=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return Fi(this.attributes,e.attributes,vr),this},e}(),Mr=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=Li.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),Nr=function(){function e(e){void 0===e&&(e=Mi.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),Lr=function(){function e(e,t,n){void 0===e&&(e=Ni.OCCLUSION),void 0===t&&(t=65536),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),Br=function(e,t,n,i,r,o,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=ni.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},Fr=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),zr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),Ur=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=new Ki),void 0===t&&(t=new Hi),void 0===n&&(n=new Qi),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new zr),void 0===u&&(u=new zr),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),kr=function(){function e(t){this._objectType=Qn.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=t,this._objectID=e._idTable[Qn.UNKNOWN]++,this._typedID=e._idTable[t]++}return c(e,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),e}();kr._idTable=Array(Qn.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(zi||(zi={}));var Gr=Object.freeze([new Br("UNKNOWN",0,0,ni.NONE,!1,!1,!1,!1),new Br("A8",1,1,ni.UNORM,!0,!1,!1,!1),new Br("L8",1,1,ni.UNORM,!1,!1,!1,!1),new Br("LA8",1,2,ni.UNORM,!0,!1,!1,!1),new Br("R8",1,1,ni.UNORM,!1,!1,!1,!1),new Br("R8SN",1,1,ni.SNORM,!1,!1,!1,!1),new Br("R8UI",1,1,ni.UINT,!1,!1,!1,!1),new Br("R8I",1,1,ni.INT,!1,!1,!1,!1),new Br("R16F",2,1,ni.FLOAT,!1,!1,!1,!1),new Br("R16UI",2,1,ni.UINT,!1,!1,!1,!1),new Br("R16I",2,1,ni.INT,!1,!1,!1,!1),new Br("R32F",4,1,ni.FLOAT,!1,!1,!1,!1),new Br("R32UI",4,1,ni.UINT,!1,!1,!1,!1),new Br("R32I",4,1,ni.INT,!1,!1,!1,!1),new Br("RG8",2,2,ni.UNORM,!1,!1,!1,!1),new Br("RG8SN",2,2,ni.SNORM,!1,!1,!1,!1),new Br("RG8UI",2,2,ni.UINT,!1,!1,!1,!1),new Br("RG8I",2,2,ni.INT,!1,!1,!1,!1),new Br("RG16F",4,2,ni.FLOAT,!1,!1,!1,!1),new Br("RG16UI",4,2,ni.UINT,!1,!1,!1,!1),new Br("RG16I",4,2,ni.INT,!1,!1,!1,!1),new Br("RG32F",8,2,ni.FLOAT,!1,!1,!1,!1),new Br("RG32UI",8,2,ni.UINT,!1,!1,!1,!1),new Br("RG32I",8,2,ni.INT,!1,!1,!1,!1),new Br("RGB8",3,3,ni.UNORM,!1,!1,!1,!1),new Br("SRGB8",3,3,ni.UNORM,!1,!1,!1,!1),new Br("RGB8SN",3,3,ni.SNORM,!1,!1,!1,!1),new Br("RGB8UI",3,3,ni.UINT,!1,!1,!1,!1),new Br("RGB8I",3,3,ni.INT,!1,!1,!1,!1),new Br("RGB16F",6,3,ni.FLOAT,!1,!1,!1,!1),new Br("RGB16UI",6,3,ni.UINT,!1,!1,!1,!1),new Br("RGB16I",6,3,ni.INT,!1,!1,!1,!1),new Br("RGB32F",12,3,ni.FLOAT,!1,!1,!1,!1),new Br("RGB32UI",12,3,ni.UINT,!1,!1,!1,!1),new Br("RGB32I",12,3,ni.INT,!1,!1,!1,!1),new Br("RGBA8",4,4,ni.UNORM,!0,!1,!1,!1),new Br("BGRA8",4,4,ni.UNORM,!0,!1,!1,!1),new Br("SRGB8_A8",4,4,ni.UNORM,!0,!1,!1,!1),new Br("RGBA8SN",4,4,ni.SNORM,!0,!1,!1,!1),new Br("RGBA8UI",4,4,ni.UINT,!0,!1,!1,!1),new Br("RGBA8I",4,4,ni.INT,!0,!1,!1,!1),new Br("RGBA16F",8,4,ni.FLOAT,!0,!1,!1,!1),new Br("RGBA16UI",8,4,ni.UINT,!0,!1,!1,!1),new Br("RGBA16I",8,4,ni.INT,!0,!1,!1,!1),new Br("RGBA32F",16,4,ni.FLOAT,!0,!1,!1,!1),new Br("RGBA32UI",16,4,ni.UINT,!0,!1,!1,!1),new Br("RGBA32I",16,4,ni.INT,!0,!1,!1,!1),new Br("R5G6B5",2,3,ni.UNORM,!1,!1,!1,!1),new Br("R11G11B10F",4,3,ni.FLOAT,!1,!1,!1,!1),new Br("RGB5A1",2,4,ni.UNORM,!0,!1,!1,!1),new Br("RGBA4",2,4,ni.UNORM,!0,!1,!1,!1),new Br("RGB10A2",2,4,ni.UNORM,!0,!1,!1,!1),new Br("RGB10A2UI",2,4,ni.UINT,!0,!1,!1,!1),new Br("RGB9E5",2,4,ni.FLOAT,!0,!1,!1,!1),new Br("DEPTH",4,1,ni.FLOAT,!1,!0,!1,!1),new Br("DEPTH_STENCIL",5,2,ni.FLOAT,!1,!0,!0,!1),new Br("BC1",1,3,ni.UNORM,!1,!1,!1,!0),new Br("BC1_ALPHA",1,4,ni.UNORM,!0,!1,!1,!0),new Br("BC1_SRGB",1,3,ni.UNORM,!1,!1,!1,!0),new Br("BC1_SRGB_ALPHA",1,4,ni.UNORM,!0,!1,!1,!0),new Br("BC2",1,4,ni.UNORM,!0,!1,!1,!0),new Br("BC2_SRGB",1,4,ni.UNORM,!0,!1,!1,!0),new Br("BC3",1,4,ni.UNORM,!0,!1,!1,!0),new Br("BC3_SRGB",1,4,ni.UNORM,!0,!1,!1,!0),new Br("BC4",1,1,ni.UNORM,!1,!1,!1,!0),new Br("BC4_SNORM",1,1,ni.SNORM,!1,!1,!1,!0),new Br("BC5",1,2,ni.UNORM,!1,!1,!1,!0),new Br("BC5_SNORM",1,2,ni.SNORM,!1,!1,!1,!0),new Br("BC6H_UF16",1,3,ni.UFLOAT,!1,!1,!1,!0),new Br("BC6H_SF16",1,3,ni.FLOAT,!1,!1,!1,!0),new Br("BC7",1,4,ni.UNORM,!0,!1,!1,!0),new Br("BC7_SRGB",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ETC_RGB8",1,3,ni.UNORM,!1,!1,!1,!0),new Br("ETC2_RGB8",1,3,ni.UNORM,!1,!1,!1,!0),new Br("ETC2_SRGB8",1,3,ni.UNORM,!1,!1,!1,!0),new Br("ETC2_RGB8_A1",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ETC2_SRGB8_A1",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ETC2_RGBA8",2,4,ni.UNORM,!0,!1,!1,!0),new Br("ETC2_SRGB8_A8",2,4,ni.UNORM,!0,!1,!1,!0),new Br("EAC_R11",1,1,ni.UNORM,!1,!1,!1,!0),new Br("EAC_R11SN",1,1,ni.SNORM,!1,!1,!1,!0),new Br("EAC_RG11",2,2,ni.UNORM,!1,!1,!1,!0),new Br("EAC_RG11SN",2,2,ni.SNORM,!1,!1,!1,!0),new Br("PVRTC_RGB2",2,3,ni.UNORM,!1,!1,!1,!0),new Br("PVRTC_RGBA2",2,4,ni.UNORM,!0,!1,!1,!0),new Br("PVRTC_RGB4",2,3,ni.UNORM,!1,!1,!1,!0),new Br("PVRTC_RGBA4",2,4,ni.UNORM,!0,!1,!1,!0),new Br("PVRTC2_2BPP",2,4,ni.UNORM,!0,!1,!1,!0),new Br("PVRTC2_4BPP",2,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_4x4",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_5x4",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_5x5",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_6x5",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_6x6",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_8x5",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_8x6",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_8x8",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_10x5",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_10x6",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_10x8",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_10x10",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_12x10",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_RGBA_12x12",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_4x4",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_5x4",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_5x5",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_6x5",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_6x6",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_8x5",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_8x6",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_8x8",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_10x5",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_10x6",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_10x8",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_10x10",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_12x10",1,4,ni.UNORM,!0,!1,!1,!0),new Br("ASTC_SRGBA_12x12",1,4,ni.UNORM,!0,!1,!1,!0)]),Hr=Oi.UNIFORM_BUFFER|Oi.DYNAMIC_UNIFORM_BUFFER|Oi.STORAGE_BUFFER|Oi.DYNAMIC_STORAGE_BUFFER,Vr=Oi.SAMPLER_TEXTURE|Oi.SAMPLER|Oi.TEXTURE|Oi.STORAGE_IMAGE|Oi.INPUT_ATTACHMENT,jr=Oi.DYNAMIC_STORAGE_BUFFER|Oi.DYNAMIC_UNIFORM_BUFFER;function Wr(e){return e>0&&0==(e&e-1)}function qr(e,t,n,i){if(!Gr[e].isCompressed)return t*n*i*Gr[e].size;switch(e){case ti.BC1:case ti.BC1_ALPHA:case ti.BC1_SRGB:case ti.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case ti.BC2:case ti.BC2_SRGB:case ti.BC3:case ti.BC3_SRGB:case ti.BC4:case ti.BC4_SNORM:case ti.BC6H_SF16:case ti.BC6H_UF16:case ti.BC7:case ti.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case ti.BC5:case ti.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case ti.ETC_RGB8:case ti.ETC2_RGB8:case ti.ETC2_SRGB8:case ti.ETC2_RGB8_A1:case ti.EAC_R11:case ti.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case ti.ETC2_RGBA8:case ti.ETC2_SRGB8_A1:case ti.EAC_RG11:case ti.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case ti.PVRTC_RGB2:case ti.PVRTC_RGBA2:case ti.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case ti.PVRTC_RGB4:case ti.PVRTC_RGBA4:case ti.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case ti.ASTC_RGBA_4X4:case ti.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case ti.ASTC_RGBA_5X4:case ti.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case ti.ASTC_RGBA_5X5:case ti.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case ti.ASTC_RGBA_6X5:case ti.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case ti.ASTC_RGBA_6X6:case ti.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case ti.ASTC_RGBA_8X5:case ti.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case ti.ASTC_RGBA_8X6:case ti.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case ti.ASTC_RGBA_8X8:case ti.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case ti.ASTC_RGBA_10X5:case ti.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case ti.ASTC_RGBA_10X6:case ti.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case ti.ASTC_RGBA_10X8:case ti.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case ti.ASTC_RGBA_10X10:case ti.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case ti.ASTC_RGBA_12X10:case ti.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case ti.ASTC_RGBA_12X12:case ti.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function Xr(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=qr(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var Yr=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Kr(e){return Yr[e]||0}function Qr(e){var t=e.size/e.count;switch(e.type){case ni.UNORM:case ni.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case ni.SNORM:case ni.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case ni.FLOAT:return Float32Array}return Float32Array}var Zr=Object.freeze({__proto__:null,get ObjectType(){return Qn},get Status(){return Zn},get API(){return Jn},get SurfaceTransform(){return $n},get Feature(){return ei},get Format(){return ti},get FormatType(){return ni},get Type(){return ii},get BufferUsageBit(){return ri},get BufferFlagBit(){return oi},get MemoryAccessBit(){return ai},get MemoryUsageBit(){return si},get TextureType(){return ci},get TextureUsageBit(){return li},get TextureFlagBit(){return ui},get SampleCount(){return hi},get VsyncMode(){return _i},get Filter(){return fi},get Address(){return di},get ComparisonFunc(){return pi},get StencilOp(){return mi},get BlendFactor(){return vi},get BlendOp(){return gi},get ColorMask(){return yi},get ShaderStageFlagBit(){return xi},get LoadOp(){return Si},get StoreOp(){return Ti},get AccessType(){return Ei},get ResolveMode(){return Ci},get PipelineBindPoint(){return Ai},get PrimitiveMode(){return bi},get PolygonMode(){return Pi},get ShadeModel(){return Ri},get CullMode(){return wi},get DynamicStateFlagBit(){return Ii},get StencilFace(){return Di},get DescriptorType(){return Oi},get QueueType(){return Mi},get QueryType(){return Ni},get CommandBufferType(){return Li},get ClearFlagBit(){return Bi},Size:Ui,DeviceCaps:ki,Offset:Gi,Rect:Hi,Extent:Vi,TextureSubresLayers:ji,TextureSubresRange:Wi,TextureCopy:qi,TextureBlit:Xi,BufferTextureCopy:Yi,Viewport:Ki,Color:Qi,BindingMappingInfo:Zi,SwapchainInfo:Ji,DeviceInfo:$i,BufferInfo:er,BufferViewInfo:tr,DrawInfo:nr,DispatchInfo:ir,IndirectBuffer:rr,TextureInfo:or,TextureViewInfo:ar,SamplerInfo:sr,Uniform:cr,UniformBlock:lr,UniformSamplerTexture:ur,UniformSampler:hr,UniformTexture:_r,UniformStorageImage:fr,UniformStorageBuffer:dr,UniformInputAttachment:pr,ShaderStage:mr,Attribute:vr,ShaderInfo:gr,InputAssemblerInfo:yr,ColorAttachment:xr,DepthStencilAttachment:Sr,SubpassInfo:Tr,SubpassDependency:Er,RenderPassInfo:Cr,GlobalBarrierInfo:Ar,TextureBarrierInfo:br,FramebufferInfo:Pr,DescriptorSetLayoutBinding:Rr,DescriptorSetLayoutInfo:wr,DescriptorSetInfo:Ir,PipelineLayoutInfo:Dr,InputState:Or,CommandBufferInfo:Mr,QueueInfo:Nr,QueryPoolInfo:Lr,FormatInfo:Br,MemoryStatus:Fr,DynamicStencilStates:zr,DynamicStates:Ur,GFXObject:kr,get AttributeName(){return zi},FormatInfos:Gr,DESCRIPTOR_BUFFER_TYPE:Hr,DESCRIPTOR_SAMPLER_TYPE:Vr,DESCRIPTOR_DYNAMIC_TYPE:jr,DRAW_INFO_SIZE:28,IsPowerOf2:Wr,FormatSize:qr,FormatSurfaceSize:Xr,GetTypeSize:Kr,getTypedArrayConstructor:Qr}),Jr=function(e){function t(){var t;return(t=e.call(this,Qn.BUFFER)||this)._usage=ri.NONE,t._memUsage=si.NONE,t._size=0,t._stride=1,t._count=0,t._flags=oi.NONE,t._isBufferView=!1,t}return u(t,e),c(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(kr),$r=function(e){function t(){var t;return(t=e.call(this,Qn.COMMAND_BUFFER)||this)._queue=null,t._type=Li.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return u(t,e),c(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(kr),eo=function(){function e(){this._gfxAPI=Jn.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(ei.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Fr,this._caps=new ki,this._bindingMappingInfo=new Zi,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return e.prototype.hasFeature=function(e){return this._features[e]},c(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();eo.canvas=void 0;var to=function(e){function t(){var t;return(t=e.call(this,Qn.SWAPCHAIN)||this)._transform=$n.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return u(t,e),c(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}(kr),no=function(e){function t(){var t;return(t=e.call(this,Qn.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return u(t,e),c(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(kr),io=String.prototype.charCodeAt;function ro(e){return this[e]}function oo(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?io:ro;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var ao=function(e){function t(){var t;return(t=e.call(this,Qn.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new nr,t}u(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return oo(e,666)},c(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}(kr),so=function(e){function t(){var t;return(t=e.call(this,Qn.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}u(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&Hr){var o=this._layout.descriptorIndices[e];this._buffers[o+n]!==t&&(this._buffers[o+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&Vr){var o=this._layout.descriptorIndices[e];this._samplers[o+n]!==t&&(this._samplers[o+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&Vr){var o=this._layout.descriptorIndices[e];this._textures[o+n]!==t&&(this._textures[o+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},c(t,[{key:"layout",get:function(){return this._layout}}]),t}(kr),co=function(e){function t(){var t;return(t=e.call(this,Qn.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return u(t,e),c(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(kr),lo=function(e){function t(){var t;return(t=e.call(this,Qn.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return u(t,e),c(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(kr),uo=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Pi.FILL),void 0===n&&(n=Ri.GOURAND),void 0===i&&(i=wi.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Pi.FILL,this.shadeModel=Ri.GOURAND,this.cullMode=wi.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},c(e,[{key:"native",get:function(){return this}}]),e}(),ho=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=pi.LESS),void 0===i&&(i=!1),void 0===r&&(r=pi.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=mi.KEEP),void 0===c&&(c=mi.KEEP),void 0===l&&(l=mi.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=pi.ALWAYS),void 0===f&&(f=65535),void 0===d&&(d=65535),void 0===p&&(p=mi.KEEP),void 0===m&&(m=mi.KEEP),void 0===v&&(v=mi.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=d,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=pi.LESS,this.stencilTestFront=!1,this.stencilFuncFront=pi.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=mi.KEEP,this.stencilZFailOpFront=mi.KEEP,this.stencilPassOpFront=mi.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=pi.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=mi.KEEP,this.stencilZFailOpBack=mi.KEEP,this.stencilPassOpBack=mi.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},c(e,[{key:"native",get:function(){return this}}]),e}(),_o=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=!1),void 0===t&&(t=vi.ONE),void 0===n&&(n=vi.ZERO),void 0===i&&(i=gi.ADD),void 0===r&&(r=vi.ONE),void 0===o&&(o=vi.ZERO),void 0===a&&(a=gi.ADD),void 0===s&&(s=yi.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=vi.ONE,this.blendDst=vi.ZERO,this.blendEq=gi.ADD,this.blendSrcAlpha=vi.ONE,this.blendDstAlpha=vi.ZERO,this.blendAlphaEq=gi.ADD,this.blendColorMask=yi.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),fo=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new Qi),void 0===i&&(i=[new _o]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new _o),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},c(e,[{key:"native",get:function(){return this}}]),e}(),po=function(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new Or),void 0===r&&(r=new uo),void 0===o&&(o=new ho),void 0===a&&(a=new fo),void 0===s&&(s=bi.TRIANGLE_LIST),void 0===c&&(c=Ii.NONE),void 0===l&&(l=Ai.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},mo=function(e){function t(){var t;return(t=e.call(this,Qn.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=bi.TRIANGLE_LIST,t._is=null,t._rs=new uo,t._dss=new ho,t._bs=new fo,t._dynamicStates=Ii.NONE,t._renderPass=null,t}return u(t,e),c(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(kr),vo=function(e){function t(){var t;return(t=e.call(this,Qn.QUEUE)||this)._type=Mi.GRAPHICS,t}return u(t,e),c(t,[{key:"type",get:function(){return this._type}}]),t}(kr),go=function(e){function t(){var t;return(t=e.call(this,Qn.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return u(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return oo(e,666)},c(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(kr),yo=function(e){function t(t,n){var i;return(i=e.call(this,Qn.SAMPLER)||this)._info=new sr,i._hash=0,i._info.copy(t),i._hash=n,i}return u(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new sr;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},c(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(kr),xo=function(e){function t(){var t;return(t=e.call(this,Qn.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return u(t,e),c(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(kr),So=function(e){function t(){var t;return(t=e.call(this,Qn.TEXTURE)||this)._type=ci.TEX2D,t._usage=li.NONE,t._format=ti.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._layerCount=1,t._levelCount=1,t._samples=hi.ONE,t._flags=ui.NONE,t._isPowerOf2=!1,t._size=0,t}return u(t,e),c(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),t}(kr),To=function(e){function t(t,n){var i;return(i=e.call(this,Qn.GLOBAL_BARRIER)||this)._info=new Ar,i._hash=0,i._info.copy(t),i._hash=n,i}return u(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return oo(t,666)},c(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(kr),Eo=function(e){function t(t,n){var i;return(i=e.call(this,Qn.TEXTURE_BARRIER)||this)._info=new br,i._hash=0,i._info.copy(t),i._hash=n,i}return u(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,oo(t+=e.dstQueue?e.dstQueue.type:0,666)},c(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(kr),Co={Device:eo,Swapchain:to,Buffer:Jr,Texture:So,Sampler:yo,Shader:xo,InputAssembler:ao,RenderPass:go,Framebuffer:no,DescriptorSet:so,DescriptorSetLayout:co,PipelineLayout:lo,PipelineState:mo,CommandBuffer:$r,Queue:vo,GlobalBarrier:To,TextureBarrier:Eo,RasterizerState:uo,BlendState:fo,BlendTarget:_o,DepthStencilState:ho,PipelineStateInfo:po};Object.assign(Co,Zr),T.gfx=Co,e("gfx",Object.freeze({__proto__:null,DescriptorSet:so,Buffer:Jr,CommandBuffer:$r,get ObjectType(){return Qn},get Status(){return Zn},get API(){return Jn},get SurfaceTransform(){return $n},get Feature(){return ei},get Format(){return ti},get FormatType(){return ni},get Type(){return ii},get BufferUsageBit(){return ri},get BufferFlagBit(){return oi},get MemoryAccessBit(){return ai},get MemoryUsageBit(){return si},get TextureType(){return ci},get TextureUsageBit(){return li},get TextureFlagBit(){return ui},get SampleCount(){return hi},get VsyncMode(){return _i},get Filter(){return fi},get Address(){return di},get ComparisonFunc(){return pi},get StencilOp(){return mi},get BlendFactor(){return vi},get BlendOp(){return gi},get ColorMask(){return yi},get ShaderStageFlagBit(){return xi},get LoadOp(){return Si},get StoreOp(){return Ti},get AccessType(){return Ei},get ResolveMode(){return Ci},get PipelineBindPoint(){return Ai},get PrimitiveMode(){return bi},get PolygonMode(){return Pi},get ShadeModel(){return Ri},get CullMode(){return wi},get DynamicStateFlagBit(){return Ii},get StencilFace(){return Di},get DescriptorType(){return Oi},get QueueType(){return Mi},get QueryType(){return Ni},get CommandBufferType(){return Li},get ClearFlagBit(){return Bi},Size:Ui,DeviceCaps:ki,Offset:Gi,Rect:Hi,Extent:Vi,TextureSubresLayers:ji,TextureSubresRange:Wi,TextureCopy:qi,TextureBlit:Xi,BufferTextureCopy:Yi,Viewport:Ki,Color:Qi,BindingMappingInfo:Zi,SwapchainInfo:Ji,DeviceInfo:$i,BufferInfo:er,BufferViewInfo:tr,DrawInfo:nr,DispatchInfo:ir,IndirectBuffer:rr,TextureInfo:or,TextureViewInfo:ar,SamplerInfo:sr,Uniform:cr,UniformBlock:lr,UniformSamplerTexture:ur,UniformSampler:hr,UniformTexture:_r,UniformStorageImage:fr,UniformStorageBuffer:dr,UniformInputAttachment:pr,ShaderStage:mr,Attribute:vr,ShaderInfo:gr,InputAssemblerInfo:yr,ColorAttachment:xr,DepthStencilAttachment:Sr,SubpassInfo:Tr,SubpassDependency:Er,RenderPassInfo:Cr,GlobalBarrierInfo:Ar,TextureBarrierInfo:br,FramebufferInfo:Pr,DescriptorSetLayoutBinding:Rr,DescriptorSetLayoutInfo:wr,DescriptorSetInfo:Ir,PipelineLayoutInfo:Dr,InputState:Or,CommandBufferInfo:Mr,QueueInfo:Nr,QueryPoolInfo:Lr,FormatInfo:Br,MemoryStatus:Fr,DynamicStencilStates:zr,DynamicStates:Ur,GFXObject:kr,get AttributeName(){return zi},FormatInfos:Gr,DESCRIPTOR_BUFFER_TYPE:Hr,DESCRIPTOR_SAMPLER_TYPE:Vr,DESCRIPTOR_DYNAMIC_TYPE:jr,DRAW_INFO_SIZE:28,IsPowerOf2:Wr,FormatSize:qr,FormatSurfaceSize:Xr,GetTypeSize:Kr,getTypedArrayConstructor:Qr,Device:eo,Swapchain:to,Framebuffer:no,InputAssembler:ao,DescriptorSetLayout:co,PipelineLayout:lo,RasterizerState:uo,DepthStencilState:ho,BlendTarget:_o,BlendState:fo,PipelineStateInfo:po,PipelineState:mo,Queue:vo,RenderPass:go,Sampler:yo,Shader:xo,Texture:So,GlobalBarrier:To,TextureBarrier:Eo}));var Ao=new dn,bo=new dn,Po=new dn,Ro=new dn,wo=new dn,Io=new dn,Do=new Array(3),Oo=new Array(3);function Mo(e,t){return dn.dot(t.n,e)-t.d}function No(e,t,n){return dn.copy(e,t),dn.subtract(wo,n.center,n.halfExtents),dn.add(Io,n.center,n.halfExtents),e.x=e.x<wo.x?wo.x:e.x,e.y=e.y<wo.y?wo.y:e.y,e.z=e.z<wo.z?wo.z:e.z,e.x=e.x>Io.x?Io.x:e.x,e.y=e.y>Io.y?Io.y:e.y,e.z=e.z>Io.z?Io.z:e.z,e}function Lo(e,t,n){dn.set(Ao,n.orientation.m00,n.orientation.m01,n.orientation.m02),dn.set(bo,n.orientation.m03,n.orientation.m04,n.orientation.m05),dn.set(Po,n.orientation.m06,n.orientation.m07,n.orientation.m08),Do[0]=Ao,Do[1]=bo,Do[2]=Po,Oo[0]=n.halfExtents.x,Oo[1]=n.halfExtents.y,Oo[2]=n.halfExtents.z,dn.subtract(Ro,t,n.center),dn.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=dn.dot(Ro,Do[i]);r>Oo[i]&&(r=Oo[i]),r<-Oo[i]&&(r=-Oo[i]),e.x+=r*Do[i].x,e.y+=r*Do[i].y,e.z+=r*Do[i].z}return e}var Bo=Object.freeze({__proto__:null,point_plane:Mo,pt_point_plane:function(e,t,n){var i=Mo(t,n);return dn.subtract(e,t,dn.multiplyScalar(e,n.n,i))},pt_point_aabb:No,pt_point_obb:Lo,pt_point_line:function(e,t,n,i){dn.subtract(Ao,n,i);var r=Ao,o=dn.lengthSqr(r);if(0==o)dn.copy(e,n);else{dn.subtract(Ao,t,n);var a=dn.dot(Ao,r)/o;a<0?dn.copy(e,n):a>1?dn.copy(e,i):dn.scaleAndAdd(e,n,r,a)}}}),Fo={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},zo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Fo.SHAPE_RAY,this.o=new dn(e,t,n),this.d=new dn(i,r,o)}return e.create=function(t,n,i,r,o,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return dn.copy(e.o,t.o),dn.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return dn.copy(e.o,t),dn.normalize(e.d,dn.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e},e.prototype.computeHit=function(e,t){dn.normalize(e,this.d),dn.scaleAndAdd(e,this.o,e,t)},c(e,[{key:"type",get:function(){return this._type}}]),e}(),Uo=new dn,ko=new dn,Go=new dn,Ho=new dn;function Vo(e){return Math.max(Math.max(e.x,e.y),e.z)}var jo,Wo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new dn(0,0,0),this._radius=0,this._type=void 0,this._type=Fo.SHAPE_SPHERE,this._center=new dn(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return dn.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return dn.multiplyScalar(e.center,dn.add(Uo,t,n),.5),e.radius=.5*dn.subtract(Uo,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){dn.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),dn.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){dn.transformMat4(r.center,this.center,e),r.radius=this.radius*Vo(i)},t.translateAndRotate=function(e,t,n){dn.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*Vo(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),dn.subtract(ko,e,this.center);var t=ko.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,dn.multiplyScalar(ko,ko,n/t),dn.add(this.center,this.center,ko)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(Go,Ho),this.mergePoint(Go),this.mergePoint(Ho)},c(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),qo=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Fo.SHAPE_TRIANGLE,this.a=new dn(e,t,n),this.b=new dn(i,r,o),this.c=new dn(a,s,c)}return e.create=function(t,n,i,r,o,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,o,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return dn.copy(e.a,t.a),dn.copy(e.b,t.b),dn.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return dn.copy(e.a,t),dn.copy(e.b,n),dn.copy(e.c,i),e},e.set=function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},c(e,[{key:"type",get:function(){return this._type}}]),e}();!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(jo||(jo={}));var Xo,Yo,Ko,Qo,Zo,Jo,$o,ea,ta=(Xo=new dn(0,0,0),function(e,t){var n=dn.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;dn.multiplyScalar(Xo,t.n,t.d);var i=dn.dot(dn.subtract(Xo,Xo,e.o),t.n)/n;return i<0?0:i}),na=(Yo=new dn(0,0,0),Ko=new dn(0,0,0),Qo=new dn(0,0,0),Zo=new dn(0,0,0),Jo=new dn(0,0,0),function(e,t,n){dn.subtract(Yo,t.b,t.a),dn.subtract(Ko,t.c,t.a),dn.cross(Qo,e.d,Ko);var i=dn.dot(Yo,Qo);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;dn.subtract(Zo,e.o,t.a);var o=dn.dot(Zo,Qo)*r;if(o<0||o>1)return 0;dn.cross(Jo,Zo,Yo);var a=dn.dot(e.d,Jo)*r;if(a<0||o+a>1)return 0;var s=dn.dot(Ko,Jo)*r;return s<0?0:s}),ia=function(){var e=new dn(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,s=i*i;dn.subtract(e,r,o);var c=e.lengthSqr(),l=dn.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),ra=($o=new dn,ea=new dn,function(e,t){return dn.subtract($o,t.center,t.halfExtents),dn.add(ea,t.center,t.halfExtents),oa(e,$o,ea)});function oa(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,h=(n.y-i.y)*a,_=(t.z-i.z)*s,f=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),p=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return p<0||d>p?0:d>0?d:p}var aa,sa,ca,la,ua=function(){var e=new dn,t=new dn,n=new dn,i=new dn,r=new dn,o=new dn,a=new dn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,dn.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),dn.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),dn.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),dn.subtract(a,e,t),c[0]=dn.dot(i,n),c[1]=dn.dot(r,n),c[2]=dn.dot(o,n),l[0]=dn.dot(i,a),l[1]=dn.dot(r,a),l[2]=dn.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||d>p?0:d>0?d:p}}(),ha=function(){var e=new dn,t=new dn,n=new dn,i=new dn,r=new dn,o=new dn,a=new dn,s=new Wo;return function(c,l){var u=l.radius*l.radius,h=dn.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,d=dn.subtract(t,f,_);if(d.equals(dn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),Ka.raySphere(c,s);var p=c.o,m=dn.subtract(n,p,_),v=dn.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=dn.subtract(r,f,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),Ka.raySphere(c,s)}var x=dn.cross(r,m,d),S=d.lengthSqr(),T=2*dn.dot(v,x),E=T*T-4*g*(x.lengthSqr()-u*S);if(E<0)return 0;var C=(-T-Math.sqrt(E))/(2*g);if(C<0){s.radius=l.radius;var A=dn.subtract(o,f,p);return m.lengthSqr()<A.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),Ka.raySphere(c,s)}var b=dn.scaleAndAdd(o,c.o,h,C),P=dn.subtract(a,b,_),R=dn.dot(P,d)/S;return R>=0&&R<=1?C:R<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),Ka.raySphere(c,s)):R>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),Ka.raySphere(c,s)):0}}(),_a=(aa=qo.create(),sa={distance:1/0,doubleSided:!1,mode:jo.ANY},ca=0,la=function(e,t,n,i,r,o){e===jo.CLOSEST?(ca>t||0===ca)&&(ca=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(ca=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(ca=0,0===t.geometricInfo.positions.length)return ca;var i=void 0===n?sa:n;if(oa(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,o=t.geometricInfo;!function(e,t,n,i,r){if(n===bi.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];dn.set(aa.a,e[s],e[s+1],e[s+2]),dn.set(aa.b,e[c],e[c+1],e[c+2]),dn.set(aa.c,e[l],e[l+1],e[l+2]);var u=Ka.rayTriangle(i,aa,r.doubleSided);if(!(0===u||u>r.distance)&&(la(r.mode,u,s,c,l,r.result),r.mode===jo.ANY))return u}else if(n===bi.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var d=3*t[f-_],p=3*t[f+_+1],m=3*t[f+2];dn.set(aa.a,e[d],e[d+1],e[d+2]),dn.set(aa.b,e[p],e[p+1],e[p+2]),dn.set(aa.c,e[m],e[m+1],e[m+2]),_=~_;var v=Ka.rayTriangle(i,aa,r.doubleSided);if(!(0===v||v>r.distance)&&(la(r.mode,v,d,p,m,r.result),r.mode===jo.ANY))return v}else if(n===bi.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];dn.set(aa.a,e[y],e[y+1],e[y+2]);for(var x=1;x<g;x+=1){var S=3*t[x],T=3*t[x+1];dn.set(aa.b,e[S],e[S+1],e[S+2]),dn.set(aa.c,e[T],e[T+1],e[T+2]);var E=Ka.rayTriangle(i,aa,r.doubleSided);if(!(0===E||E>r.distance)&&(la(r.mode,E,y,S,T,r.result),r.mode===jo.ANY))return E}}}(o.positions,o.indices,r,e,i)}return ca}),fa=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:jo.ANY};return function(n,i,r){e=0;var o=void 0===r?t:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!oa(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=_a(n,u,o);if(h)if(o.mode===jo.CLOSEST)(0===e||e>h)&&(e=h,o.subIndices&&(o.subIndices[0]=l));else if(e=h,o.subIndices&&o.subIndices.push(l),o.mode===jo.ANY)return h}return e&&o.mode===jo.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),da=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:jo.ANY},n=new zo,i=new Ln;return function(r,o,a){e=0;var s=void 0===a?t:a,c=o.worldBounds;if(c&&!ra(r,c))return e;zo.copy(n,r),o.node&&(Ln.invert(i,o.node.getWorldMatrix(i)),dn.transformMat4(n.o,r.o,i),dn.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=_a(n,h,s);if(_)if(s.mode===jo.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===jo.ANY)return _}return e&&s.mode===jo.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),pa=function(){var e=new dn(0,0,0);return function(t,n){dn.subtract(e,t.e,t.s);var i=(n.d-dn.dot(t.s,n.n))/dn.dot(e,n.n);return i<0||i>1?0:i}}(),ma=function(){var e=new dn(0,0,0),t=new dn(0,0,0),n=new dn(0,0,0),i=new dn(0,0,0),r=new dn(0,0,0),o=new dn(0,0,0);return function(a,s,c){dn.subtract(e,s.b,s.a),dn.subtract(t,s.c,s.a),dn.subtract(n,a.s,a.e),dn.cross(r,e,t);var l=dn.dot(n,r);if(l<=0)return 0;dn.subtract(i,a.s,s.a);var u=dn.dot(i,r);if(u<0||u>l)return 0;dn.cross(o,n,i);var h=dn.dot(t,o);if(h<0||h>l)return 0;var _=-dn.dot(e,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,d=1-(h*=f)-(_*=f);dn.set(c,s.a.x*d+s.b.x*h+s.c.x*_,s.a.y*d+s.b.y*h+s.c.y*_,s.a.z*d+s.b.z*h+s.c.z*_)}return 1}}(),va=new zo;function ga(e,t){va.o.set(e.s),dn.subtract(va.d,e.e,e.s),va.d.normalize();var n=ra(va,t);return n<=e.length()?n:0}function ya(e,t){va.o.set(e.s),dn.subtract(va.d,e.e,e.s),va.d.normalize();var n=ua(va,t);return n<=e.length()?n:0}function xa(e,t){va.o.set(e.s),dn.subtract(va.d,e.e,e.s),va.d.normalize();var n=ia(va,t);return n<=e.length()?n:0}var Sa,Ta,Ea,Ca,Aa=(Sa=new dn,Ta=new dn,Ea=new dn,Ca=new dn,function(e,t){return dn.subtract(Sa,e.center,e.halfExtents),dn.add(Ta,e.center,e.halfExtents),dn.subtract(Ea,t.center,t.halfExtents),dn.add(Ca,t.center,t.halfExtents),Sa.x<=Ca.x&&Ta.x>=Ea.x&&Sa.y<=Ca.y&&Ta.y>=Ea.y&&Sa.z<=Ca.z&&Ta.z>=Ea.z});function ba(e,t,n,i,r,o){dn.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),dn.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),dn.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),dn.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),dn.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),dn.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),dn.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),dn.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function Pa(e,t){for(var n=dn.dot(t,e[0]),i=n,r=1;r<8;++r){var o=dn.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Ra,wa,Ia,Da=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new dn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new dn(0,0,0),i[r]=new dn(0,0,0);var o=new dn,a=new dn;return function(t,r){dn.set(e[0],1,0,0),dn.set(e[1],0,1,0),dn.set(e[2],0,0,1),dn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),dn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),dn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)dn.cross(e[6+3*s],e[s],e[3]),dn.cross(e[7+3*s],e[s],e[4]),dn.cross(e[7+3*s],e[s],e[5]);dn.subtract(o,t.center,t.halfExtents),dn.add(a,t.center,t.halfExtents),function(e,t,n){dn.set(n[0],e.x,t.y,t.z),dn.set(n[1],e.x,t.y,e.z),dn.set(n[2],e.x,e.y,t.z),dn.set(n[3],e.x,e.y,e.z),dn.set(n[4],t.x,t.y,t.z),dn.set(n[5],t.x,t.y,e.z),dn.set(n[6],t.x,e.y,t.z),dn.set(n[7],t.x,e.y,e.z)}(o,a,n),ba(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Pa(n,e[c]),u=Pa(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Oa=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=dn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Ma=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Oa(e,t.planes[n]))return 0;return 1},Na=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new dn(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Oa(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)dn.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),La=(Ra=new dn(0,0,0),wa=new Cn,function(e,t){return dn.subtract(Ra,t,e.center),dn.transformMat3(Ra,Ra,Cn.transpose(wa,e.orientation)),n=Ra,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Ba=(Ia=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Ia(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ia(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ia(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=dn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),Fa=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ba(e,t.planes[n]))return 0;return 1},za=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new dn(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Ba(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)dn.subtract(e[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=o(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),Ua=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new dn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new dn(0,0,0),i[r]=new dn(0,0,0);return function(t,r){dn.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),dn.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),dn.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),dn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),dn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),dn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)dn.cross(e[6+3*o],e[o],e[3]),dn.cross(e[7+3*o],e[o],e[4]),dn.cross(e[8+3*o],e[o],e[5]);ba(t.center,t.halfExtents,e[0],e[1],e[2],n),ba(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=Pa(n,e[a]),c=Pa(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),ka=function(){for(var e=new Wo,t=new dn,n=new dn,i=new dn,r=new Array(8),o=0;o<8;o++)r[o]=new dn;for(var a=new Array(8),s=0;s<8;s++)a[s]=new dn;return function(o,s){if(0===dn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),Ka.sphereOBB(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,ba(o.center,o.halfExtents,t,n,i,r);var c=a,l=dn.copy(c[0],t),u=dn.copy(c[1],n),h=dn.copy(c[2],i);dn.subtract(c[3],s.center,o.center).normalize();var _=dn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),dn.cross(c[5],l,_),dn.cross(c[6],u,_),dn.cross(c[7],h,_);for(var f=0;f<8;++f){var d=Pa(r,c[f]),p=dn.dot(c[f],s.ellipseCenter0),m=dn.dot(c[f],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),Ga=function(e,t){var n=dn.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},Ha=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ga(e,t.planes[n]))return 0;return 1},Va=function(){var e=new dn(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=dn.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){dn.add(e,s,dn.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=i.planes[h];if(dn.dot(_.n,e)<_.d)return 0}}}return 1}}(),ja=function(e,t){var n=e.radius+t.radius;return dn.squaredDistance(e.center,t.center)<n*n},Wa=function(){var e=new dn;return function(t,n){return No(e,t.center,n),dn.squaredDistance(t.center,e)<t.radius*t.radius}}(),qa=function(){var e=new dn;return function(t,n){return Lo(e,t.center,n),dn.squaredDistance(t.center,e)<t.radius*t.radius}}(),Xa=function(){var e=new dn,t=new dn;return function(n,i){var r=n.radius+i.radius,o=r*r,a=dn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return dn.squaredDistance(n.center,i.center)<o;dn.subtract(e,n.center,i.ellipseCenter0),dn.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=dn.dot(e,t)/a;return s<0?dn.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?dn.squaredDistance(n.center,i.ellipseCenter1)<o:(dn.scaleAndAdd(e,i.ellipseCenter0,t,s),dn.squaredDistance(n.center,e)<o)}}(),Ya=function(){var e=new dn,t=new dn,n=new dn,i=new dn,r=new dn,o=new dn;return function(a,s){var c,l,u=dn.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=dn.subtract(t,s.ellipseCenter1,s.ellipseCenter0),_=dn.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=dn.dot(u,u),d=dn.dot(u,h),p=dn.dot(h,h),m=dn.dot(u,_),v=dn.dot(h,_),g=f*p-d*d,y=g,x=g;g<qt?(c=0,y=1,l=v,x=p):(l=f*v-d*m,(c=d*v-p*m)<0?(c=0,l=v,x=p):c>y&&(c=y,l=v+d,x=p)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+d<0?c=0:-m+d>f?c=y:(c=-m+d,y=f));var S=Math.abs(c)<qt?0:c/y,T=Math.abs(l)<qt?0:l/x,E=i;E.set(_),E.add(dn.multiplyScalar(r,u,S)),E.subtract(dn.multiplyScalar(o,h,T));var C=a.radius+s.radius;return E.lengthSqr()<C*C}}(),Ka={raySphere:ia,rayAABB:ra,rayOBB:ua,rayPlane:ta,rayTriangle:na,rayCapsule:ha,raySubMesh:_a,rayMesh:fa,rayModel:da,lineSphere:xa,lineAABB:ga,lineOBB:ya,linePlane:pa,lineTriangle:ma,sphereWithSphere:ja,sphereAABB:Wa,sphereOBB:qa,spherePlane:Ga,sphereFrustum:Ha,sphereFrustumAccurate:Va,sphereCapsule:Xa,aabbWithAABB:Aa,aabbWithOBB:Da,aabbPlane:Oa,aabbFrustum:Ma,aabbFrustumAccurate:Na,obbWithOBB:Ua,obbPlane:Ba,obbFrustum:Fa,obbFrustumAccurate:za,obbPoint:La,obbCapsule:ka,capsuleWithCapsule:Ya,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}};Ka[Fo.SHAPE_RAY|Fo.SHAPE_SPHERE]=ia,Ka[Fo.SHAPE_RAY|Fo.SHAPE_AABB]=ra,Ka[Fo.SHAPE_RAY|Fo.SHAPE_OBB]=ua,Ka[Fo.SHAPE_RAY|Fo.SHAPE_PLANE]=ta,Ka[Fo.SHAPE_RAY|Fo.SHAPE_TRIANGLE]=na,Ka[Fo.SHAPE_RAY|Fo.SHAPE_CAPSULE]=ha,Ka[Fo.SHAPE_LINE|Fo.SHAPE_SPHERE]=xa,Ka[Fo.SHAPE_LINE|Fo.SHAPE_AABB]=ga,Ka[Fo.SHAPE_LINE|Fo.SHAPE_OBB]=ya,Ka[Fo.SHAPE_LINE|Fo.SHAPE_PLANE]=pa,Ka[Fo.SHAPE_LINE|Fo.SHAPE_TRIANGLE]=ma,Ka[Fo.SHAPE_SPHERE]=ja,Ka[Fo.SHAPE_SPHERE|Fo.SHAPE_AABB]=Wa,Ka[Fo.SHAPE_SPHERE|Fo.SHAPE_OBB]=qa,Ka[Fo.SHAPE_SPHERE|Fo.SHAPE_PLANE]=Ga,Ka[Fo.SHAPE_SPHERE|Fo.SHAPE_FRUSTUM]=Ha,Ka[Fo.SHAPE_SPHERE|Fo.SHAPE_FRUSTUM_ACCURATE]=Va,Ka[Fo.SHAPE_SPHERE|Fo.SHAPE_CAPSULE]=Xa,Ka[Fo.SHAPE_AABB]=Aa,Ka[Fo.SHAPE_AABB|Fo.SHAPE_OBB]=Da,Ka[Fo.SHAPE_AABB|Fo.SHAPE_PLANE]=Oa,Ka[Fo.SHAPE_AABB|Fo.SHAPE_FRUSTUM]=Ma,Ka[Fo.SHAPE_AABB|Fo.SHAPE_FRUSTUM_ACCURATE]=Na,Ka[Fo.SHAPE_OBB]=Ua,Ka[Fo.SHAPE_OBB|Fo.SHAPE_PLANE]=Ba,Ka[Fo.SHAPE_OBB|Fo.SHAPE_FRUSTUM]=Fa,Ka[Fo.SHAPE_OBB|Fo.SHAPE_FRUSTUM_ACCURATE]=za,Ka[Fo.SHAPE_OBB|Fo.SHAPE_CAPSULE]=ka,Ka[Fo.SHAPE_CAPSULE]=Ya;var Qa,Za,Ja,$a,es,ts,ns,is=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Fo.SHAPE_LINE,this.s=new dn(e,t,n),this.e=new dn(i,r,o)}return e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return dn.copy(e.s,t.s),dn.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return dn.copy(e.s,t),dn.copy(e.e,n),e},e.set=function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e},e.len=function(e){return dn.distance(e.s,e.e)},e.prototype.length=function(){return dn.distance(this.s,this.e)},c(e,[{key:"type",get:function(){return this._type}}]),e}(),rs=new dn(0,0,0),os=new dn(0,0,0),as=T.mat4(),ss=T.v4(),cs=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Fo.SHAPE_PLANE,this.n=new dn(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return dn.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return dn.subtract(rs,n,t),dn.subtract(os,i,t),dn.normalize(e.n,dn.cross(e.n,rs,os)),e.d=dn.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return dn.copy(e.n,t),e.d=dn.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return dn.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){Ln.invert(as,e),Ln.transpose(as,as),Tn.set(ss,this.n.x,this.n.y,this.n.z,this.d),Tn.transformMat4(ss,ss,as),dn.set(this.n,ss.x,ss.y,ss.z),this.d=ss.w},c(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),ls=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(ns||(ns={}));var us,hs,_s=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new ls(e,r,this._stride);var o=ns.NEVER,a=!1,s=!1;for(var c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==ns.FLOAT32?s||o!==ns.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,o=(this._dataType[t]===ns.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[t];return o.subarray(r,r+a)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(us||(us={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(hs||(hs={}));var fs,ds=((Qa={})[hs.DIRTY_FLAG]=ns.UINT32,Qa[hs.LAYER]=ns.UINT32,Qa[hs.WORLD_SCALE]=ns.FLOAT32,Qa[hs.WORLD_POSITION]=ns.FLOAT32,Qa[hs.WORLD_ROTATION]=ns.FLOAT32,Qa[hs.WORLD_MATRIX]=ns.FLOAT32,Qa[hs.LOCAL_SCALE]=ns.FLOAT32,Qa[hs.LOCAL_POSITION]=ns.FLOAT32,Qa[hs.LOCAL_ROTATION]=ns.FLOAT32,Qa[hs.COUNT]=ns.NEVER,Qa),ps=((Za={})[hs.DIRTY_FLAG]=hs.LAYER-hs.DIRTY_FLAG,Za[hs.LAYER]=hs.WORLD_SCALE-hs.LAYER,Za[hs.WORLD_SCALE]=hs.WORLD_POSITION-hs.WORLD_SCALE,Za[hs.WORLD_POSITION]=hs.WORLD_ROTATION-hs.WORLD_POSITION,Za[hs.WORLD_ROTATION]=hs.WORLD_MATRIX-hs.WORLD_ROTATION,Za[hs.WORLD_MATRIX]=hs.LOCAL_SCALE-hs.WORLD_MATRIX,Za[hs.LOCAL_SCALE]=hs.LOCAL_POSITION-hs.LOCAL_SCALE,Za[hs.LOCAL_POSITION]=hs.LOCAL_ROTATION-hs.LOCAL_POSITION,Za[hs.LOCAL_ROTATION]=hs.COUNT-hs.LOCAL_ROTATION,Za[hs.COUNT]=1,Za),ms=new _s(us.NODE,ds,ps,hs);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(fs||(fs={}));var vs,gs=((Ja={})[fs.PRIORITY]=ns.UINT32,Ja[fs.STAGE]=ns.UINT32,Ja[fs.PHASE]=ns.UINT32,Ja[fs.PRIMITIVE]=ns.UINT32,Ja[fs.BATCHING_SCHEME]=ns.UINT32,Ja[fs.DYNAMIC_STATE]=ns.UINT32,Ja[fs.HASH]=ns.UINT32,Ja[fs.COUNT]=ns.NEVER,Ja),ys=(($a={})[fs.PRIORITY]=fs.STAGE-fs.PRIORITY,$a[fs.STAGE]=fs.PHASE-fs.STAGE,$a[fs.PHASE]=fs.PRIMITIVE-fs.PHASE,$a[fs.PRIMITIVE]=fs.BATCHING_SCHEME-fs.PRIMITIVE,$a[fs.BATCHING_SCHEME]=fs.DYNAMIC_STATE-fs.BATCHING_SCHEME,$a[fs.DYNAMIC_STATE]=fs.HASH-fs.DYNAMIC_STATE,$a[fs.HASH]=fs.COUNT-fs.HASH,$a[fs.COUNT]=1,$a),xs=new _s(us.PASS,gs,ys,fs);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(vs||(vs={}));var Ss=((es={})[vs.CENTER]=ns.FLOAT32,es[vs.HALFEXTENTS]=ns.FLOAT32,es[vs.COUNT]=ns.NEVER,es),Ts=((ts={})[vs.CENTER]=vs.HALFEXTENTS-vs.CENTER,ts[vs.HALFEXTENTS]=vs.COUNT-vs.HALFEXTENTS,ts[vs.COUNT]=1,ts),Es=new _s(us.AABB,Ss,Ts,vs),Cs=new dn,As=new dn,bs=new dn,Ps=new dn,Rs=new Cn,ws=function(e,t,n){Rs.m00=Math.abs(n.m00),Rs.m01=Math.abs(n.m01),Rs.m02=Math.abs(n.m02),Rs.m03=Math.abs(n.m04),Rs.m04=Math.abs(n.m05),Rs.m05=Math.abs(n.m06),Rs.m06=Math.abs(n.m08),Rs.m07=Math.abs(n.m09),Rs.m08=Math.abs(n.m10),dn.transformMat3(e,t,Rs)},Is=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=Fo.SHAPE_AABB,this.center=new dn(e,t,n),this.halfExtents=new dn(i,r,o)}e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return dn.copy(e.center,t.center),dn.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return dn.add(Cs,n,t),dn.subtract(As,n,t),dn.multiplyScalar(e.center,Cs,.5),dn.multiplyScalar(e.halfExtents,As,.5),e},e.set=function(e,t,n,i,r,o,a){return e.center.set(t,n,i),e.halfExtents.set(r,o,a),e},e.merge=function(t,n,i){return dn.subtract(Cs,n.center,n.halfExtents),dn.subtract(As,i.center,i.halfExtents),dn.add(bs,n.center,n.halfExtents),dn.add(Ps,i.center,i.halfExtents),dn.max(Ps,bs,Ps),dn.min(bs,Cs,As),e.fromPoints(t,bs,Ps)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return dn.transformMat4(e.center,t.center,n),ws(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){dn.subtract(e,this.center,this.halfExtents),dn.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){dn.transformMat4(r.center,this.center,e),ws(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(Cs,As),e.x<Cs.x&&(Cs.x=e.x),e.y<Cs.y&&(Cs.y=e.y),e.z<Cs.z&&(Cs.z=e.z),e.x>As.x&&(As.x=e.x),e.y>As.y&&(As.y=e.y),e.z>As.z&&(As.z=e.z),dn.add(bs,Cs,As),this.center.set(dn.multiplyScalar(bs,bs,.5)),this.halfExtents.set(As.x-bs.x,As.y-bs.y,As.z-bs.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},c(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Ds=new dn,Os=new dn,Ms=new Cn,Ns=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Fo.SHAPE_OBB,this.center=new dn(e,t,n),this.halfExtents=new dn(i,r,o),this.orientation=new Cn(a,s,c,l,u,h,_,f,d)}e.create=function(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new e(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return dn.copy(e.center,t.center),dn.copy(e.halfExtents,t.halfExtents),Cn.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return dn.multiplyScalar(e.center,dn.add(Ds,t,n),.5),dn.multiplyScalar(e.halfExtents,dn.subtract(Os,n,t),.5),Cn.identity(e.orientation),e},e.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return dn.set(e.center,t,n,i),dn.set(e.halfExtents,r,o,a),Cn.set(e.orientation,s,c,l,u,h,_,f,d,p),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){Ms.m00=Math.abs(n.m00),Ms.m01=Math.abs(n.m01),Ms.m02=Math.abs(n.m02),Ms.m03=Math.abs(n.m03),Ms.m04=Math.abs(n.m04),Ms.m05=Math.abs(n.m05),Ms.m06=Math.abs(n.m06),Ms.m07=Math.abs(n.m07),Ms.m08=Math.abs(n.m08),dn.transformMat3(e,t,Ms)}(Ds,this.halfExtents,this.orientation),dn.subtract(e,this.center,Ds),dn.add(t,this.center,Ds)},t.transform=function(e,t,n,i,r){dn.transformMat4(r.center,this.center,e),Cn.fromQuat(r.orientation,n),dn.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){dn.transformMat4(n.center,this.center,e),Cn.fromQuat(n.orientation,t)},t.setScale=function(e,t){dn.multiply(t.halfExtents,this.halfExtents,e)},c(e,[{key:"type",get:function(){return this._type}}]),e}(),Ls=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Fo.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new dn,this.rotation=new Pn,this.ellipseCenter0=new dn(0,t,0),this.ellipseCenter1=new dn(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var o=i,a=hn(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,dn.transformMat4(r.center,this.center,e),Pn.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),dn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),dn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},c(e,[{key:"type",get:function(){return this._type}}]),e}(),Bs=new Array(8);Bs[0]=new dn(1,1,1),Bs[1]=new dn(-1,1,1),Bs[2]=new dn(-1,-1,1),Bs[3]=new dn(1,-1,1),Bs[4]=new dn(1,1,-1),Bs[5]=new dn(-1,1,-1),Bs[6]=new dn(-1,-1,-1),Bs[7]=new dn(1,-1,-1);var Fs,zs,Us=new dn,ks=new dn,Gs=new dn,Hs=function(){function e(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Fo.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=cs.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new dn}e.createFromAABB=function(e,t){var n=new dn,i=new dn;return dn.subtract(n,t.center,t.halfExtents),dn.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==Fo.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var o=Math.tan(.5*t.fov),a=o*t.aspect;Us.set(i*a,i*o,i),ks.set(r*a,r*o,r);var s=e.vertices;return Gs.set(Us.x,Us.y,Us.z),dn.transformMat4(s[0],Gs,n),Gs.set(-Us.x,Us.y,Us.z),dn.transformMat4(s[1],Gs,n),Gs.set(-Us.x,-Us.y,Us.z),dn.transformMat4(s[2],Gs,n),Gs.set(Us.x,-Us.y,Us.z),dn.transformMat4(s[3],Gs,n),Gs.set(ks.x,ks.y,ks.z),dn.transformMat4(s[4],Gs,n),Gs.set(-ks.x,ks.y,ks.z),dn.transformMat4(s[5],Gs,n),Gs.set(-ks.x,-ks.y,ks.z),dn.transformMat4(s[6],Gs,n),Gs.set(ks.x,-ks.y,ks.z),dn.transformMat4(s[7],Gs,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)cs.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)dn.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(dn.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),dn.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),dn.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),dn.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),dn.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),dn.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===Fo.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();dn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)dn.transformMat4(this.vertices[o],Bs[o],t)}},t.transform=function(e){if(this._type===Fo.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)dn.transformMat4(this.vertices[t],this.vertices[t],e);cs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),cs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),cs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),cs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),cs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),cs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},t.updatePlanes=function(){cs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),cs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),cs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),cs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),cs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),cs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},c(e,[{key:"accurate",set:function(e){this._type=e?Fo.SHAPE_FRUSTUM_ACCURATE:Fo.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();Hs.createOrtho=function(e,t,n,i,r,o){var a=t/2,s=n/2;dn.set(Gs,a,s,-i),dn.transformMat4(e.vertices[0],Gs,o),dn.set(Gs,-a,s,-i),dn.transformMat4(e.vertices[1],Gs,o),dn.set(Gs,-a,-s,-i),dn.transformMat4(e.vertices[2],Gs,o),dn.set(Gs,a,-s,-i),dn.transformMat4(e.vertices[3],Gs,o),dn.set(Gs,a,s,-r),dn.transformMat4(e.vertices[4],Gs,o),dn.set(Gs,-a,s,-r),dn.transformMat4(e.vertices[5],Gs,o),dn.set(Gs,-a,-s,-r),dn.transformMat4(e.vertices[6],Gs,o),dn.set(Gs,a,-s,-r),dn.transformMat4(e.vertices[7],Gs,o),cs.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),cs.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),cs.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),cs.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),cs.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),cs.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Fs||(Fs={})),function(e){e[e.Default=Fs.Default]="Default",e[e.Normal=Fs.Normal]="Normal",e[e.Reverse=Fs.Reverse]="Reverse",e[e.Loop=Fs.Loop]="Loop",e[e.LoopReverse=Fs.Loop|Fs.Reverse]="LoopReverse",e[e.PingPong=Fs.PingPong]="PingPong",e[e.PingPongReverse=Fs.PingPong|Fs.Reverse]="PingPongReverse"}(zs||(zs={})),Ze(zs);var Vs=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function js(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=e[o];if(a>t+n)r=o-1;else{if(!(a<t-n))return o;i=o+1}}return~i}var Ws=function(){},qs=function(){return Ws},Xs=Ys((function(){}));function Ys(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function Ks(e){return function(t){return function(n){!function(e,t,n){var i=Zs(e);if(i){var r=Js(i,"proto");Js(r,"editor")[t]=n}}(n,e,t)}}}var Qs="__ccclassCache__";function Zs(e){return Js(e,Qs)}function Js(e,t){return e[t]||(e[t]={})}var $s=Ys((function(e,t){var n=qe.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[Qs];if(r){var o=r.proto;o&&qe.mixin(i,o),e[Qs]=void 0}return Gt(i)})),ec=Ks("requireComponent"),tc=Ks("executionOrder"),nc=Xs;function ic(e,t,n){var i=null;function r(e,t,n){var r=Zs(e.constructor);if(r){var o=Js(r,"proto"),a=Js(o,"properties");!function(e,t,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=Dt(i,s));var c=t[n],l=qe.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var u=o.default||(o.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(n)&&(l.default=u[n])}t[n]=l}(e.constructor,a,t,i,n,r)}}return void 0===e?ic({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}var rc=Symbol("cc:SerializationMetadata"),oc=function(e,t,n){return ic(cc({}))(e,t,n)};function ac(e){return ic(cc({formerlySerializedAs:e}))}var sc=function(e,t,n){return ic({editorOnly:!0})(e,t,n)};function cc(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var lc=Ws,uc=Xs,hc=qs,_c=Xs,fc=qs,dc=qs,pc=qs,mc=Ws,vc=qs,gc=Ws,yc=qs,xc=qs,Sc=qs,Tc=qs,Ec=qs,Cc=qs,Ac=Ws,bc=qs,Pc=Ws,Rc=Ws,wc=Mc(St),Ic=Mc(Tt),Dc=Mc(Et),Oc=Mc(Ct);function Mc(e){return ic({type:e})}var Nc,Lc,Bc,Fc,zc,Uc,kc,Gc,Hc,Vc=function(e,t,n){return ic({__noImplicit:!0,override:!0})(e,t,n)},jc=$s("cc.KeyframeCurve")((Nc=Symbol.iterator,Uc=function(){function e(){y(this,"_times",Fc,this),y(this,"_values",zc,this)}var t=e.prototype;return t[Nc]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return js(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return js(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||Yt(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,o=js(n,e);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(e),i.unshift(t)):a===r?(n.push(e),i.push(t)):(n.splice(a-1,0,e),i.splice(a-1,0,t)),a},c(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}(),Fc=x((Bc=Uc).prototype,"_times",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zc=x(Bc.prototype,"_values",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lc=Bc))||Lc;function Wc(e){return e>-1e-9&&e<1e-9}!function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(kc||(kc=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(Gc||(Gc=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(Hc||(Hc=e("TangentWeightMode",{})));var qc,Xc=e("editorExtrasTag","__editorExtras__"),Yc=function(){},Kc=Object.freeze({__proto__:null,uniquelyReferenced:lc,ccclass:$s,property:ic,requireComponent:ec,executionOrder:tc,disallowMultiple:nc,allowReplicated:function(e){Gt.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:uc,menu:hc,playOnFocus:_c,inspector:fc,icon:dc,help:pc,type:Mc,integer:wc,float:Ic,boolean:Dc,string:Oc});e("_decorator",Kc);var Qc=1<<22,Zc=[],Jc=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=Zc.length,t=0;t<e;++t){var n=Zc[t];1&n._objFlags||n._destroyImmediate()}e===Zc.length?Zc.length=0:Zc.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(V(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Zc.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof T._BaseNode||e instanceof T.Component,r=i?"_id":null,o={};for(n in e)if(e.hasOwnProperty(n)){if(n===r)continue;switch(typeof e[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(Gt._isCCClass(t))for(var a=T.Class.Attr.getClassAttrs(t),s=t.__props__,c=0;c<s.length;c++){var l=(n=s[c])+T.Class.Attr.DELIMETER+"default";if(l in a){if(i&&"_id"===n)continue;switch(typeof a[l]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var u="";for(n in o){var h;h=Gt.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Gt.escapeForJS(n)+"]=";var _=o[n];""===_&&(_='""'),u+=h+_+";\n"}return Function("o",u)}(this,e),fe(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?W(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},c(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&Qc)},set:function(e){e?this._objFlags|=Qc:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),$c=Jc.prototype;function el(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}$c._deserialize=null,$c._onPreDestroy=null,Gt.fastDefine("cc.Object",Jc,((qc={_name:"",_objFlags:0})[Xc]={},qc)),Gt.Attr.setClassAttr(Jc,Xc,"editorOnly",!0),Gt.Attr.setClassAttr(Jc,"replicated","visible",!1),fe(Jc,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),T.isValid=el,T.Object=Jc;var tl=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=qe.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=qe.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},c(e,[{key:"count",get:function(){return this._count}}]),e}(),nl=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(V(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();nl._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=qe.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},c(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var il,rl=new tl,ol=new tl,al=new tl,sl=new tl,cl=new nl("normal load",[]),ll=new nl("fetch",[]),ul=new nl("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(il||(il={}));var hl,_l={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(hl||(hl={}));var fl=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();fl.MAX_DEAD_NUM=500,fl._taskId=0,fl._deadPool=[];var dl="0123456789abcdef".split(""),pl=["","","",""],ml=pl.concat(pl,"-",pl,"-",pl,"-",pl,"-",pl,pl,pl),vl=ml.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function gl(e){var t=e.split("@")[0];if(22!==t.length)return e;ml[0]=e[0],ml[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=rt[e.charCodeAt(n)],o=rt[e.charCodeAt(n+1)];ml[vl[i++]]=dl[r>>2],ml[vl[i++]]=dl[(3&r)<<2|o>>4],ml[vl[i++]]=dl[15&o]}return e.replace(t,ml.join(""))}var yl=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function xl(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;var n=sl.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),El(e,t)}function Sl(e){return!!e&&(e instanceof T.SceneAsset||e instanceof T.Scene)}function Tl(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function El(e,t){var n=fl.create({input:e,options:t}),i=[];try{for(var r,o=g(ul.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=g(n.output);!(c=l()).done;)c.value.recycle();N(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var Cl=Object.freeze({__proto__:null,getUuidFromURL:function(e){var t=yl.exec(e);return t?t[1]:""},getUrlWithUuid:xl,isScene:Sl,normalize:Tl,transform:El,decodeUuid:gl}),Al=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,qe.array.fastRemoveAt(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),bl=function(){function e(){this._poolHandle=-1,Al.addContainer(this)}return e.prototype.destroy=function(){Al.removeContainer(this)},e}(),Pl=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(t());return r}u(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&V(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(bl)),Rl=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=t();return r}u(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},c(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(bl)),wl=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=void 0!==n?n:function(e,t){return e-t},i}u(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(bl));e("memop",Object.freeze({__proto__:null,Pool:Pl,RecyclePool:Rl,CachedArray:wl}));var Il=We.fastRemoveAt;function Dl(){}var Ol=function(){function e(){this.callback=Dl,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||Dl,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=Dl,this.once=!1},t.check=function(){return!(this.target instanceof Jc&&!el(this.target,!0))},e}(),Ml=new Pl((function(){return new Ol}),32),Nl=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),Ml.free(n),Il(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),Ml.free(n),Il(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Il(this.callbackInfos,e),Ml.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),Ml.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Il(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),Ll=new Pl((function(){return new Nl}),16),Bl=function(){function e(){this._callbackTable=ve(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=Ll.alloc());var o=Ml.alloc();o.set(t,n,i),r.callbackInfos.push(o)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),Ll.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===e&&r.cancel(a)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var o=r.callbackInfos;if(t)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===t&&s.target===n){r.cancel(a);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,r,o):_(t,n,i,r,o):this.off(e,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),Ll.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function Fl(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=ve(!0),t}u(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=Bl.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(t.prototype,o,a)}}return t}var zl=e("EventTarget",Fl((function(){})));T.EventTarget=zl;var Ul,kl,Gl,Hl,Vl,jl,Wl,ql=new(function(){function e(){this._finalizationRegistry=null}var t=e.prototype;return t.registerGCObject=function(e){return e},t.unregisterGCObject=function(){},t.init=function(){},t.finalizationRegistryCallback=function(e){e.isValid&&e.destroy()},t.destroy=function(){},e}()),Xl=$s("cc.GCObject")(Ul=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return t=e.call.apply(e,[this].concat(i))||this,ql.registerGCObject(m(t))||m(t)}u(t,e);var n=t.prototype;return n.equals=function(e){return!!e&&e===this},n.destroy=function(){return ql.unregisterGCObject(this),e.prototype.destroy.call(this)},t}(Jc))||Ul;!function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(kl||(kl={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(Gl||(Gl={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(Hl||(Hl={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(Vl||(Vl={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(jl||(jl={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(Wl||(Wl={}));var Yl,Kl,Ql,Zl,Jl=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(t=o.getBattery)||void 0===t||t.call(o).then((function(e){i._battery=e})),i.networkType=Hl.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?jl.MOBILE_BROWSER:jl.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:Gl.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=Vl.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=Vl.WINDOWS:l?f=Vl.IOS:-1!==o.appVersion.indexOf("Mac")?f=Vl.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=Vl.LINUX:c?f=Vl.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=Vl.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=kl.UNKNOWN;var d=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),p=d?d[0].toLowerCase():Vl.UNKNOWN;("safari"===p&&c||"qq"===p&&/android.*applewebkit/i.test(a))&&(p=kl.ANDROID);var m={micromessenger:kl.WECHAT,wechat:kl.WECHAT,weixin:kl.WECHAT,trident:kl.IE,edge:kl.EDGE,"360 aphone":kl.BROWSER_360,mxbrowser:kl.MAXTHON,"opr/":kl.OPERA,ubrowser:kl.UC,huaweibrowser:kl.HUAWEI};i.browserType=m[p]||p,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){x=!0,null==e||e.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,T=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[Wl.WEBP]=g,n[Wl.IMAGE_BITMAP]=x,n[Wl.WEB_VIEW]=!0,n[Wl.VIDEO_PLAYER]=!0,n[Wl.SAFE_AREA]=!1,n[Wl.INPUT_TOUCH]=S,n[Wl.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[Wl.EVENT_MOUSE]=T,n[Wl.EVENT_TOUCH]=S||T,n[Wl.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}u(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,o,a){n&&(n=!1,t.emit("show",e,i,r,o,a))};if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(zl)),$l=/(\.[^\.\/\?\\]*)(\?.*)?$/,eu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,tu=/[^\.\/]+\/\.\.\//;function nu(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function iu(e){var t=$l.exec(e);return t?t[1]:""}function ru(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function ou(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function au(e){var t=eu.exec(e);return t?t[2]:""}function su(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function cu(e,t,n){if(0===t.indexOf("."))return su(e,t);var i=e.indexOf("?"),r="",o=n?iu(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function lu(e){var t=e=String(e);do{t=e,e=e.replace(tu,"")}while(t.length!==e.length);return e}function uu(e){return e.replace(/[\/\\]$/,"")}function hu(){return Jl.os===Vl.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:nu,extname:iu,mainFileName:ru,basename:ou,dirname:au,changeExtname:su,changeBasename:cu,_normalize:lu,stripSep:uu,getSeperator:hu}));var _u,fu,du,pu=e("Asset",$s("cc.Asset")((Zl=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,y(t,"_native",Ql,m(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(m(t),"_uuid",{value:"",writable:!0}),t}u(t,e),t.deserialize=function(e){return T.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&T.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return B(K(12101,this._uuid)),e.prototype.destroy.call(this)},c(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=xl(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=xl(this._uuid,{__nativeName__:e,nativeExt:iu(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(Fl(Xl)),Ql=x((Kl=Zl).prototype,"_native",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),x(Kl.prototype,"_nativeAsset",[ic],Object.getOwnPropertyDescriptor(Kl.prototype,"_nativeAsset"),Kl.prototype),Yl=Kl))||Yl);pu.prototype.createNode=null,T.Asset=pu;var mu=e("Script",$s("cc.Script")(_u=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(pu))||_u);T._Script=mu;var vu=e("JavaScript",$s("cc.JavaScript")(fu=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(mu))||fu);T._JavaScript=vu;var gu,yu,xu,Su,Tu,Eu,Cu,Au,bu,Pu,Ru,wu=e("TypeScript",$s("cc.TypeScript")(du=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(mu))||du);T._TypeScript=wu;var Iu,Du,Ou,Mu,Nu=new oe("Comp"),Lu=Jc.Flags.IsOnLoadCalled,Bu=e("Component",(gu=$s("cc.Component"),yu=yc(),xu=Mc(mu),Su=xc(),gu((Ru=Pu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"node",Cu,m(t)),y(t,"_enabled",Au,m(t)),y(t,"__prefab",bu,m(t)),t._sceneGetter=null,t._id=Nu.getNewId(),t}u(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&T.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),T.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=T.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=T.macro.REPEAT_FOREVER),void 0===i&&(i=0),Y(e,1619),Y((t=t||0)>=0,1620),n=Number.isNaN(n)?T.macro.REPEAT_FOREVER:n,i=i||0;var r=T.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(e,this,t,n,i,o)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&T.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){T.director.getScheduler().unscheduleAllForTarget(this)},c(t,[{key:"name",get:function(){if(this._name)return this._name;var e=ge(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=T.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Lu}}]),t}(Jc),Pu.system=null,x((Eu=Ru).prototype,"__scriptAsset",[yu,xu,Su,Rc],Object.getOwnPropertyDescriptor(Eu.prototype,"__scriptAsset"),Eu.prototype),Cu=x(Eu.prototype,"node",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Au=x(Eu.prototype,"_enabled",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bu=x(Eu.prototype,"__prefab",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tu=Eu))||Tu)),Fu=Bu.prototype;Fu.update=null,Fu.lateUpdate=null,Fu.__preload=null,Fu.onLoad=null,Fu.start=null,Fu.onEnable=null,Fu.onDisable=null,Fu.onDestroy=null,Fu.onFocusInEditor=null,Fu.onLostFocusInEditor=null,Fu.resetInEditor=null,Fu._getLocalBounds=null,Fu.onRestore=null,Bu._requireComponent=null,Bu._executionOrder=0,fe(Bu,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),T.Component=Bu;var zu,Uu=e("MissingScript",$s("cc.MissingScript")(Iu=fc()((Mu=function(e){function t(){var t;return y(t=e.call(this)||this,"_$erialized",Ou,m(t)),t}return u(t,e),t.safeFindClass=function(e){var t=Ge(e);if(t)return t;T.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){V(4600,this.node.name)},t}(Bu),Ou=x((Du=Mu).prototype,"_$erialized",[oc,sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Iu=Du))||Iu)||Iu);T._MissingScript=Uu;try{var ku=Uu.__values__;0!==ku.length&&"_$erialized"===ku[ku.length-1]||(N("The '_$erialized' prop in MissingScript is missing. Please contact jare."),N("    Error props: ['"+ku+"']"))}catch(Oo){N("Error when checking MissingScript 5, "+Oo)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(zu||(zu={}));var Gu,Hu={auto:zu.AUTO,landscape:zu.LANDSCAPE,portrait:zu.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(Gu||(Gu={}));var Vu=new(function(e){function t(){var t,n,i,r,o,a;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new kn(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=zu.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)t._fn[s[0][l]]=a[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}u(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=Hu[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===Gu.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===Gu.Fullscreen?document[this._fn.fullscreenElement]:e===Gu.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=Jl.isMobile&&(t&&e===zu.PORTRAIT||!t&&e===zu.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void V(9201);var e,t,n=T.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,o=i.clientHeight,a=n.width,s=n.height,c=r/a,l=o/s,u=this._gameContainer.style;c<l?(e=r,t=s*c):(e=a*l,t=o),u.width=e+"px",u.height=t+"px"}else{var h=this._gameContainer.style;h.width="100%",h.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else V(9201)},c(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===Gu.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):V(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new kn(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new kn(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(V(9201),new kn(0,0));var e,t,n;switch(this._windowType){case Gu.SubFrame:return this._gameFrame?new kn(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(V(9201),new kn(0,0));case Gu.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new kn(t,n);case Gu.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new kn(t,n);case Gu.Unknown:default:return new kn(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?Gu.Fullscreen:this._gameFrame?this._exactFitScreen?Gu.BrowserWindow:Gu.SubFrame:(V(9201),Gu.Unknown)}}]),t}(zl)),ju=function(){function e(){}var t=e.prototype;return t._init=function(e){Vu.init(e,(function(){var e,t=T.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=Vu.resolutionScale:V(1220)}))},t.fullScreen=function(){return Vu.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&V(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),Vu.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return Vu.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},c(e,[{key:"devicePixelRatio",get:function(){return Vu.devicePixelRatio}},{key:"windowSize",get:function(){return Vu.windowSize},set:function(e){Vu.windowSize=e}},{key:"resolution",get:function(){return Vu.resolution}},{key:"supportsFullScreen",get:function(){return Vu.supportFullScreen}}]),e}(),Wu=e("screen",new ju);T.screen=Wu;var qu=e("sys",{Feature:Wl,hasFeature:function(e){return Jl.hasFeature(e)},NetworkType:Hl,Language:Gl,OS:Vl,Platform:jl,BrowserType:kl,isNative:Jl.isNative,isBrowser:Jl.isBrowser,isMobile:Jl.isMobile,isLittleEndian:Jl.isLittleEndian,platform:Jl.platform,language:Jl.language,languageCode:Jl.nativeLanguage,os:Jl.os,osVersion:Jl.osVersion,osMainVersion:Jl.osMainVersion,browserType:Jl.browserType,browserVersion:Jl.browserVersion,windowPixelResolution:Wu.windowSize,capabilities:{canvas:!0,opengl:!0,webp:Jl.hasFeature(Wl.WEBP),imageBitmap:Jl.hasFeature(Wl.IMAGE_BITMAP),touches:Jl.hasFeature(Wl.INPUT_TOUCH),mouse:Jl.hasFeature(Wl.EVENT_MOUSE),keyboard:Jl.hasFeature(Wl.EVENT_KEYBOARD),accelerometer:Jl.hasFeature(Wl.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return Jl.networkType},getBatteryLevel:function(){return Jl.getBatteryLevel()},garbageCollect:function(){Jl.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",O(e+="Using "+(T.game.renderType===T.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){Jl.openURL(e)},now:function(){return Jl.now()},restartVM:function(){Jl.restartJSVM()},getSafeAreaRect:function(){var e=T.view,t=Vu.safeAreaEdge,n=Vu.windowSize,i=new gn(t.left,t.bottom),r=new gn(n.width-t.right,n.height-t.top);e._convertToUISpace(i),e._convertToUISpace(r);var o=i.x,a=i.y,s=r.x-i.x,c=r.y-i.y;return new Hn(o,a,s,c)}});!function(){try{var e=qu.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){V(5200)};qu.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}qu.__isWebIOS14OrIPadOS14Env=(qu.os===Vl.IOS||qu.os===Vl.OSX)&&Jl.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),T.sys=qu;var Xu=e("serializeTag",Symbol("[[Serialize]]")),Yu=e("deserializeTag",Symbol("[[Deserialize]]")),Ku=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return c(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function Qu(e){var t=e;return{chunks:t.chunks,document:t.document}}function Zu(e){if(e.length<16)throw new Ju(K(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new Ju(K(13100));var n=t.getUint32(4,!0);if(1!==n)throw new Ju(K(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new Ju(K(13102));var i=12,r=t.getUint32(i,!0);i+=4;var o=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var a,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(K(13104))}(o);try{a=JSON.parse(s)}catch(e){throw new Ju(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new Ju(K(13102));return new Ku(a,c)}var Ju=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(p(Error));function $u(e,t,n,i,r){if(t instanceof T.ValueType){r||e.push("if(prop){");var o=ge(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),r||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},c(e,[{key:"byteLength",get:function(){return this._length}}])}(),T.internal.parseCCONJson=Qu,T.internal.decodeCCONBinary=Zu,T.internal.CCON=Ku;var eh="$_$default",th="$_$formerlySerializedAs",nh=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return u(t,e),t.prototype.get=function(e,t,n,i,r){var o=this._get();return o?(o.reset(e,t,n,i,r),o):new ih(e,t,n,i,r)},t}(je),ih=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof Ku?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,o=e.__type__,a=this._classFinder(o,e,n,i);if(!a)return this._classFinder===Ge&&this._reportMissingClass(o),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(a);return this._deserializeInto(e,s,a),s},t._deserializeInto=function(e,t,n,i){void 0===i&&(i=!1),i||!t[Yu]?t._deserialize?t._deserialize(e.content,this):T.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Ie(n);r&&i._deserializeInto(e,t,r)}};t[Yu](r,this._context)},t._deserializeFireClass=function(e,t,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(e,t){for(var n=gt(t),i=t.__values__,r=["var prop;"],o=et.test(Ve(t)),a=0;a<i.length;a++){var s=i[a],c=void 0,l=void 0;Gt.IDENTIFIER_RE.test(s)?(l='"'+s+'"',c="."+s):c="["+(l=Gt.escapeForJS(s))+"]";var u=c;if(n[s+th]){var h=n[s+th];u=Gt.IDENTIFIER_RE.test(h)?"."+h:"["+Gt.escapeForJS(h)+"]"}r.push("prop=d"+u+";"),r.push('if(typeof prop!=="undefined"){');var _=Gt.getDefault(n[s+eh]);if(o){var f=void 0,d=n[s+"$_$type"];if(void 0===_&&d)f=d instanceof xt;else{var p=typeof _;f="string"===p||"number"===p||"boolean"===p}f?r.push("o"+c+"=prop;"):$u(r,_,c,l,!0)}else r.push('if(typeof prop!=="object"){o'+c+"=prop;}else{"),$u(r,_,c,l,!1),r.push("}");r.push("}")}return(T.js.isChildClassOf(t,T._BaseNode)||T.js.isChildClassOf(t,T.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===Uu){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(N("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),N("    Error props: ['"+r+"']. Please contact jare."));var o=i;i=function(e,t,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||N("Unable to load previously serialized data. "+JSON.stringify(n))}catch(e){N("Error when checking MissingScript 7, "+e)}o(e,t,n,i)}}}catch(e){N("Error when checking MissingScript 6, "+e)}fe(n,"__deserialize__",i,!0)}i(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var o,a=this._serializedData[i];e[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===T.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===T.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==T.Color){if(n===T.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=gt(n),r=n.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];void 0!==s||t.hasOwnProperty(a)||(s=Gt.getDefault(i[a+eh])),"object"!=typeof s?e[a]=s:s?this._deserializeAndAssignField(e,s,a):e[a]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}},e}();ih.pool=new nh;var rh=[gn,dn,Tn,Pn,Wn,kn,Hn,Ln];function oh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var ah=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},oh,oh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){Ln.fromArray(e,t,1)}],sh=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function ch(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=t[c];for(;c<t.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,dh[u])(e,r,l,t[c])}return r}function lh(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):W(5303,ge(t)),i}function uh(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function hh(e){return function(t,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)e(t,r,o,r[o])}}function _h(e,t,n,i){t[n]=null,e[8][i]=t}function fh(e,t,n,i){t[n]=ch(e,i)}sh.pool=new je((function(e){e.reset()}),5),sh.pool.get=function(){return this._get()||new sh};var dh=new Array(13);function ph(e,t,n){return e||n(t),Object}function mh(e,t,n,i,r,o,a){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||ph(o,i,a);return t[n]=r,new r}}(n,i,t));s=ph(o,t,a)}n[i]=s}function vh(e,t,n,i){for(var r=n||Ge,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?mh(r,s[0],s,0,t,n,i):mh(r,s,o,a,t,n,i)}}function gh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function yh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,r=!t;if(t=t||sh.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof xh}return!1}(e)){t.init(e),n=n||{};var o,a=e[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(K(5304,a));n._version=a,n.result=t,e[0]=n,s||(vh(e,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:yh.reportMissingClass),gh(e)),T.game._isCloning=!0;var c=e[5],l=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],o=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=ch(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=lh(e,h,u)}else(0,dh[l=~l])(e,t,a,u)}return r}(e);T.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,o=3*e[i];r<o;r+=3){var a=e[r],s=t[e[r+2]],c=e[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],c,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],o=e[9],a=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),i=c[l]}else i=function(e,t,n){var i,r=(n=n||{}).classFinder||Ge,o=n.createAssetRefs||qu.platform===jl.EDITOR_CORE,a=n.customEnv,s=n.ignoreEditorOnly,c=null!==(i=n.reportMissingClass)&&void 0!==i?i:T.deserialize.reportMissingClass;t.init();var l=ih.pool.get(t,r,c,a,s);T.game._isCloning=!0;var u=l.deserialize(e);return T.game._isCloning=!1,ih.pool.put(l),o&&t.assignAssetsBy(EditorExtends.serialize.asAsset),u}(e,t,n);return r&&sh.pool.put(t),i}dh[0]=function(e,t,n,i){t[n]=i},dh[1]=uh,dh[2]=hh(uh),dh[3]=hh(_h),dh[4]=fh,dh[5]=function(e,t,n,i){ah[i[0]](t[n],i)},dh[6]=_h,dh[7]=function(e,t,n,i){t[n].set(i)},dh[8]=function(e,t,n,i){var r=new rh[i[0]];ah[i[0]](r,i),t[n]=r},dh[9]=hh(fh),dh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=lh(e,r,i[1])},dh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,dh[s])(e,r,a,c)}},dh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,dh[s])(e,r,o,a)}},yh.Details=sh,yh.reportMissingClass=function(e){W(5302,e)};var xh=function(e){this.preprocessed=!0,this.version=e};function Sh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}T.deserialize=yh;var Th,Eh,Ch,Ah,bh,Ph,Rh,wh,Ih,Dh,Oh,Mh=Jc.Flags.Destroyed,Nh=Jc.Flags.PersistentMask,Lh=[];function Bh(e){var t;if(e instanceof Jc){if(e._instantiate)return T.game._isCloning=!0,t=e._instantiate(null,!0),T.game._isCloning=!1,t;if(e instanceof T.Asset)throw new TypeError(K(6903))}return T.game._isCloning=!0,t=Fh(e),T.game._isCloning=!1,t}function Fh(e,t){var n;zh(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=Lh.length;i<r;++i)Lh[i]._iN$t=null;return Lh.length=0,n}function zh(e,t,n){qe.value(e,"_iN$t",t,!0),Lh.push(e);var i=e.constructor;if(T.Class._isCCClass(i))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof Je&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||Uh(s,i)}else n[a]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=e[r];if("object"==typeof o&&o){if(o===t)continue;t[r]=o._iN$t||Uh(o,n)}else t[r]=o}e instanceof Jc&&(t._objFlags&=Nh)}function Uh(e,t){if(e instanceof Je)return e.clone();if(e instanceof T.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,Lh.push(e);for(var r=0;r<i;++r)n[r]=e[r];return n}if(Array.isArray(e)){var o=e.length;n=new Array(o),e._iN$t=n,Lh.push(e);for(var a=0;a<o;++a){var s=e[a];n[a]="object"==typeof s&&s?s._iN$t||Uh(s,t):s}return n}if(e._objFlags&Mh)return null;var c=e.constructor;if(T.Class._isCCClass(c)){if(t)if(t instanceof T.Component){if(e instanceof T._BaseNode||e instanceof T.Component)return e}else if(t instanceof T._BaseNode)if(e instanceof T._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof T.Component&&e.node&&!e.node.isChildOf(t))return e;n=new c}else if(c===Object)n={};else{if(c)return e;n=Object.create(null)}return zh(e,n,t),n}function kh(e,t){return(t<<3)+e}function Gh(e){return Vh[e]}function Hh(e){switch(e){case Dh.Uint8:return Uint8Array;case Dh.Uint16:return Uint16Array;case Dh.Uint32:return Uint32Array;case Dh.Int8:return Int8Array;case Dh.Int16:return Int16Array;case Dh.Int32:return Int32Array;case Dh.Float32:return Float32Array;case Dh.Float64:return Float64Array}}Bh._clone=Fh,T.instantiate=Bh,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Dh||(Dh={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Oh||(Oh={})),e("CompactValueTypeArray",$s("cc.CompactValueTypeArray")((wh=Rh=function(){function e(){y(this,"_byteOffset",Ch,this),y(this,"_unitCount",Ah,this),y(this,"_unitElement",bh,this),y(this,"_length",Ph,this)}return e.lengthFor=function(e,t,n){return Gh(t).requiredUnits*e.length*Hh(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,o,a){for(var s=Gh(n),c=Hh(i),l=s.requiredUnits*t.length,u=new c(r,o,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=kh(i,n),_._byteOffset=a,_._unitCount=l,_._length=t.length,_},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=Gh(n.elementType),o=new(Hh(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},e}(),Rh.StorageUnit=Dh,Rh.ElementType=Oh,Ch=x((Eh=wh).prototype,"_byteOffset",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ah=x(Eh.prototype,"_unitCount",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bh=x(Eh.prototype,"_unitElement",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kh(Dh.Uint8,Oh.Scalar)}}),Ph=x(Eh.prototype,"_length",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Th=Eh))||Th);var Vh=((Ih={})[Oh.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},Ih[Oh.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new dn(e[2*t],e[2*t+1])}},Ih[Oh.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new dn(e[3*t],e[3*t+1],e[3*t+2])}},Ih[Oh.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Tn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Ih[Oh.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Pn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Ih[Oh.Mat4]={requiredUnits:16,compress:function(e,t,n){Ln.toArray(e,n,16*t)},decompress:function(e,t){return Ln.fromArray(new Ln,e,16*t)}},Ih);function jh(){return 0}function Wh(e){return e}function qh(e){return e*e}function Xh(e){return e*(2-e)}function Yh(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function Kh(e){return e*e*e}function Qh(e){return--e*e*e+1}function Zh(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function Jh(e){return e*e*e*e}function $h(e){return 1- --e*e*e*e}function e_(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function t_(e){return e*e*e*e*e}function n_(e){return--e*e*e*e*e+1}function i_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function r_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function o_(e){return Math.sin(e*Math.PI/2)}function a_(e){return.5*(1-Math.cos(Math.PI*e))}function s_(e){return 0===e?0:Math.pow(1024,e-1)}function c_(e){return 1===e?1:1-Math.pow(2,-10*e)}function l_(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function u_(e){return 1-Math.sqrt(1-e*e)}function h_(e){return Math.sqrt(1- --e*e)}function __(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function f_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function d_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function p_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function m_(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function v_(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function g_(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function y_(e){return 1-x_(1-e)}function x_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function S_(e){return e<.5?.5*y_(2*e):.5*x_(2*e-1)+.5}function T_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function E_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}T._decorator=Kc;var C_=N_(qh,Xh),A_=N_(Kh,Qh),b_=N_(Jh,$h),P_=N_(t_,n_),R_=N_(r_,o_),w_=N_(s_,c_),I_=N_(u_,h_),D_=N_(f_,d_),O_=N_(m_,v_),M_=N_(y_,x_);function N_(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var L_,B_,F_=Object.freeze({__proto__:null,constant:jh,linear:Wh,quadIn:qh,quadOut:Xh,quadInOut:Yh,cubicIn:Kh,cubicOut:Qh,cubicInOut:Zh,quartIn:Jh,quartOut:$h,quartInOut:e_,quintIn:t_,quintOut:n_,quintInOut:i_,sineIn:r_,sineOut:o_,sineInOut:a_,expoIn:s_,expoOut:c_,expoInOut:l_,circIn:u_,circOut:h_,circInOut:__,elasticIn:f_,elasticOut:d_,elasticInOut:p_,backIn:m_,backOut:v_,backInOut:g_,bounceIn:y_,bounceOut:x_,bounceInOut:S_,smooth:T_,fade:E_,quadOutIn:C_,cubicOutIn:A_,quartOutIn:b_,quintOutIn:P_,sineOutIn:R_,expoOutIn:w_,circOutIn:I_,elasticOutIn:D_,backOutIn:O_,bounceOutIn:M_});e("easing",F_),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(B_||(B_={}));var z_,U_,k_,G_,H_,V_=((L_={})[B_.CONSTANT]=jh,L_[B_.LINEAR]=Wh,L_[B_.QUAD_IN]=qh,L_[B_.QUAD_OUT]=Xh,L_[B_.QUAD_IN_OUT]=Yh,L_[B_.QUAD_OUT_IN]=C_,L_[B_.CUBIC_IN]=Kh,L_[B_.CUBIC_OUT]=Qh,L_[B_.CUBIC_IN_OUT]=Zh,L_[B_.CUBIC_OUT_IN]=A_,L_[B_.QUART_IN]=Jh,L_[B_.QUART_OUT]=$h,L_[B_.QUART_IN_OUT]=e_,L_[B_.QUART_OUT_IN]=b_,L_[B_.QUINT_IN]=t_,L_[B_.QUINT_OUT]=n_,L_[B_.QUINT_IN_OUT]=i_,L_[B_.QUINT_OUT_IN]=P_,L_[B_.SINE_IN]=r_,L_[B_.SINE_OUT]=o_,L_[B_.SINE_IN_OUT]=a_,L_[B_.SINE_OUT_IN]=R_,L_[B_.EXPO_IN]=s_,L_[B_.EXPO_OUT]=c_,L_[B_.EXPO_IN_OUT]=l_,L_[B_.EXPO_OUT_IN]=w_,L_[B_.CIRC_IN]=u_,L_[B_.CIRC_OUT]=h_,L_[B_.CIRC_IN_OUT]=__,L_[B_.CIRC_OUT_IN]=I_,L_[B_.ELASTIC_IN]=f_,L_[B_.ELASTIC_OUT]=d_,L_[B_.ELASTIC_IN_OUT]=p_,L_[B_.ELASTIC_OUT_IN]=D_,L_[B_.BACK_IN]=m_,L_[B_.BACK_OUT]=v_,L_[B_.BACK_IN_OUT]=g_,L_[B_.BACK_OUT_IN]=O_,L_[B_.BOUNCE_IN]=y_,L_[B_.BOUNCE_OUT]=x_,L_[B_.BOUNCE_IN_OUT]=S_,L_[B_.BOUNCE_OUT_IN]=M_,L_[B_.SMOOTH]=T_,L_[B_.FADE]=E_,L_);function j_(e){return V_[e]}var W_,q_,X_,Y_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).interpolationMode=kc.LINEAR,t.tangentWeightMode=Hc.NONE,t.value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t.easingMethod=B_.LINEAR,t}return u(t,e),t}(Yc);function K_(e){var t=new Y_;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,o=e.rightTangent,a=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[Xc];t.value=null!=r?r:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[Xc]=u)}return t}Gt.fastDefine("cc.RealKeyframeValue",Y_,{interpolationMode:kc.LINEAR,tangentWeightMode:Hc.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:B_.LINEAR}),Gt.Attr.setClassAttr(Y_,Xc,"editorOnly",!0),(W_=Y_,null!==(X_=(q_=W_)[rc])&&void 0!==X_?X_:q_[rc]={}).uniquelyReferenced=!0;var Q_,Z_=e("RealCurve",$s("cc.RealCurve")((H_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",k_,m(t)),y(t,"postExtrapolation",G_,m(t)),t}u(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],o=t[i-1];if(e<r){var a=this.preExtrapolation,s=n[0];if(a===Gc.CLAMP||i<2)return s.value;switch(a){case Gc.LINEAR:return df(r,n[0].value,t[1],n[1].value,e);case Gc.LOOP:e=_f(e,r,o);break;case Gc.PING_PONG:e=ff(e,r,o);break;default:return s.value}}else if(e>o){var c=this.postExtrapolation,l=n[i-1];if(c===Gc.CLAMP||i<2)return l.value;switch(c){case Gc.LINEAR:return df(o,l.value,t[i-2],n[i-2].value,e);case Gc.LOOP:e=_f(e,r,o);break;case Gc.PING_PONG:e=ff(e,r,o);break;default:return l.value}}var u=js(t,e);if(u>=0)return n[u].value;var h=~u,_=h-1,f=t[_],d=n[_],p=t[h];return function(e,t,n,i,r){var o=n-e;switch(t.interpolationMode){default:case kc.CONSTANT:return t.value;case kc.LINEAR:var a=t.easingMethod===B_.LINEAR?r:j_(t.easingMethod)(r);return Zt(t.value,i.value,a);case kc.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&Hc.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&Hc.LEFT);if(u||f){var d=0;if(u)d=l;else{var p=o,m=o*c;d=Math.sqrt(p*p+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*d+e,y=Math.sin(v)*d+t.value,x=0;if(f)x=_;else{var S=o,T=o*h;x=Math.sqrt(S*S+T*T)*s}var E=Math.atan(h),C=(g-e)/o,A=(-Math.cos(E)*x+n-e)/o,b=y,P=-Math.sin(E)*x+i.value,R=[0,0,0],w=function(e,t,n,i,r){var o=n/i,a=t/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+e/i),u=c*c*c,h=l*l+u,_=0;if(Wc(h)){if(Wc(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var d=1/3*Math.acos(-l/Math.sqrt(-u)),p=2*Math.sqrt(-c);r[0]=p*Math.cos(d),r[1]=-p*Math.cos(d+Math.PI/3),r[2]=-p*Math.cos(d-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*C,3*A-6*C,3*(C-A)+1,R),I=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var o=e[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(R,w,r);return pf(t.value,b,P,i.value,I)}var D=t.value+s*c*o,O=i.value-s*h*o;return pf(t.value,D,O,i.value,r)}}(f,d,p,n[h],(e-f)/(p-f))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,K_(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return K_(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return K_(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return Yt(n.value,t,e)}))},n[Xu]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+J_+J_+$_+ef*r+lf*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=J_,o.setUint8(a,this.postExtrapolation),a+=J_,o.setUint32(a,r,!0),a+=$_,n.forEach((function(e,t){return o.setFloat32(a+ef*t,e,!0)})),a+=ef*r;for(var s,c=g(i);!(s=c()).done;){var l=s.value;a=uf(o,l,a)}var u=new Uint8Array(o.buffer,0,a);e.writeProperty("bytes",u);var h=i.map((function(e){return e[Xc]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[Yu]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=J_,this.postExtrapolation=i.getUint8(r),r+=J_;var o=i.getUint32(r,!0);r+=$_;var a=Array.from({length:o},(function(e,t){return i.getFloat32(r+ef*t,!0)}));r+=ef*o;for(var s=new Array(o),c=0;c<o;++c){var l=K_({});r=hf(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][Xc]=e}))),this._times=a,this._values=s}else e.readThis()},t}(jc),k_=x((U_=H_).prototype,"preExtrapolation",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gc.CLAMP}}),G_=x(U_.prototype,"postExtrapolation",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gc.CLAMP}}),z_=U_))||z_);!function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(Q_||(Q_={}));var J_=1,$_=4,ef=4,tf=K_({}),nf=tf.interpolationMode,rf=tf.tangentWeightMode,of=tf.leftTangent,af=tf.leftTangentWeight,sf=tf.rightTangent,cf=tf.rightTangentWeight,lf=26;function uf(e,t,n){var i=0,r=n,o=r;r+=4;var a=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,s!==nf&&(i|=Q_.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==rf&&(i|=Q_.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==of&&(i|=Q_.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),_!==af&&(i|=Q_.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),l!==sf&&(i|=Q_.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==cf&&(i|=Q_.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=f<<8,e.setUint32(o,i,!0),r}function hf(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&Q_.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&Q_.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&Q_.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&Q_.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&Q_.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&Q_.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return t.easingMethod=o,i}function _f(e,t,n){return t+cn(e-t,n-t)}function ff(e,t,n){return t+ln(e-t,n-t)}function df(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function pf(e,t,n,i,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*n+r*r*r*i}function mf(e,t,n,i,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}T.bezier=mf;var vf,gf,yf,xf,Sf,Tf,Ef,Cf,Af,bf,Pf,Rf=Math.cos,wf=Math.acos,If=Math.max,Df=2*Math.PI,Of=Math.sqrt;function Mf(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Nf(e,t){var n=function(e,t){var n,i,r,o,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,d=f*_,p=(-c+l)*h,m=(3*p-f*f)*_,v=m*_,g=(2*f*f*f-9*f*p+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,T=Of(S*S*S),E=-g/(2*T),C=wf(E<-1?-1:E>1?1:E),A=2*Mf(T);return i=A*Rf(C*_)-d,r=A*Rf((C+Df)*_)-d,o=A*Rf((C+2*Df)*_)-d,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?If(i,r,o):If(i,r):o>=0&&o<=1?If(i,o):i:r>=0&&r<=1?o>=0&&o<=1?If(r,o):r:o}if(0===x)return r=-(n=y<0?Mf(-y):-Mf(y))-d,(i=2*n-d)>=0&&i<=1?r>=0&&r<=1?If(i,r):i:r;var b=Of(x);return(n=Mf(-y+b))-Mf(y+b)-d}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}T.bezierByTime=Nf,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(Pf||(Pf=e("QuatInterpolationMode",{})));var Lf=$s("cc.QuatKeyframeValue")(vf=lc((yf=x((gf=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;y(this,"interpolationMode",yf,this),y(this,"value",xf,this),y(this,"easingMethod",Sf,this),this.value=n?Pn.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pf.SLERP}}),xf=x(gf.prototype,"value",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.clone(Pn.IDENTITY)}}),Sf=x(gf.prototype,"easingMethod",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return B_.LINEAR}}),vf=gf))||vf)||vf;function Bf(e){return new Lf(e)}var Ff,zf=e("QuatCurve",$s("cc.QuatCurve")((bf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",Cf,m(t)),y(t,"postExtrapolation",Af,m(t)),t}u(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new Pn);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(a){case Gc.LOOP:e=c+cn(e-c,l-c);break;case Gc.PING_PONG:e=c+ln(e-c,l-c);break;case Gc.CLAMP:default:return Pn.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(o){case Gc.LOOP:e=c+cn(e-c,l-c);break;case Gc.PING_PONG:e=c+ln(e-c,l-c);break;case Gc.CLAMP:default:return Pn.copy(t,h.value)}}var _=js(i,e);if(_>=0)return Pn.copy(t,r[_].value);var f=~_,d=f-1,p=i[d],m=r[d],v=i[f],g=r[f],y=(e-p)/(v-p);switch(m.interpolationMode){default:case Pf.CONSTANT:return Pn.copy(t,m.value);case Pf.SLERP:var x=m.easingMethod,S=x===B_.LINEAR?y:Array.isArray(x)?Nf(x,y):j_(x)(y);return Pn.slerp(t,m.value,g.value,S)}},n.addKeyFrame=function(t,n){var i=new Lf(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Bf(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return Bf(e[1])})))}},n[Xu]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=Kf*(r?1:o),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?Qf+4*Jf:Qf)}),0),c=0,l=new DataView(new ArrayBuffer(c+=Wf+qf+Xf*o+4*Yf*o+s+a+0)),u=0,h=0;r&&(h|=Ff.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=Wf,l.setUint32(u,o,!0),u+=qf,n.forEach((function(e,t){return l.setFloat32(u+Xf*t,e,!0)})),u+=Xf*o,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*Yf*t;l.setFloat32(s+0*Yf,i,!0),l.setFloat32(s+1*Yf,r,!0),l.setFloat32(s+2*Yf,o,!0),l.setFloat32(s+3*Yf,a,!0)})),u+=4*Yf*o,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,Zf),++u,l.setFloat32(u+0*Jf,t[0],!0),l.setFloat32(u+1*Jf,t[1],!0),l.setFloat32(u+2*Jf,t[2],!0),l.setFloat32(u+3*Jf,t[3],!0),u+=4*Jf):(l.setUint8(u,t),++u)}));var _=u;u+=a;var f=_;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(f,t),r||(f+=Kf)}));var d=new Uint8Array(l.buffer);e.writeProperty("bytes",d)}else e.writeThis()},n[Yu]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=Wf;var a=o&Ff.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=qf;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+Xf*t,!0)})),l=r+=Xf*s;r+=4*Yf*s;var u=Array.from({length:s},(function(e,t){var n=l+4*Yf*t,o=i.getFloat32(n+0*Yf,!0),a=i.getFloat32(n+1*Yf,!0),s=i.getFloat32(n+2*Yf,!0),c=i.getFloat32(n+3*Yf,!0),u=i.getUint8(r);++r;var h=Bf({value:{x:o,y:a,z:s,w:c}});return u!==Zf?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*Jf,!0),i.getFloat32(r+1*Jf,!0),i.getFloat32(r+2*Jf,!0),i.getFloat32(r+3*Jf,!0)],r+=4*Jf),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var d=i.getUint8(r+f);u[f].interpolationMode=d}r+=s}this._times=c,this._values=u}else e.readThis()},t}(jc),Cf=x((Ef=bf).prototype,"preExtrapolation",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gc.CLAMP}}),Af=x(Ef.prototype,"postExtrapolation",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gc.CLAMP}}),Tf=Ef))||Tf);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Ff||(Ff={}));var Uf,kf,Gf,Hf,Vf,jf,Wf=1,qf=4,Xf=4,Yf=4,Kf=1,Qf=1,Zf=255,Jf=4,$f=e("ObjectCurve",$s("cc.ObjectCurve")(Uf=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=Kt(~t-1,0,this._values.length-1);return this._values[n]},t}(jc))||Uf),ed=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Gt.fastDefine("cc.Keyframe",ed,{time:0,value:0,inTangent:0,outTangent:0});var td=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),nd=$s("cc.AnimationCurve")((jf=Vf=function(){function e(e){if(void 0===e&&(e=null),y(this,"_curve",Hf,this),this.cachedKey=void 0,e instanceof Z_)this._curve=e;else{var t=new Z_;this._curve=t,t.preExtrapolation=Gc.LOOP,t.postExtrapolation=Gc.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:kc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:kc.CUBIC,value:1}],[1,{interpolationMode:kc.CUBIC,value:1}]])}this.cachedKey=new td}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:kc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,o=e<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case Gc.LOOP:r=cn(e-a,s-a)+a;break;case Gc.PING_PONG:r=ln(e-a,s-a)+a;break;case Gc.CLAMP:default:r=Kt(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(t),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,_=l-a,f=1/(h*h),d=s*h,p=u*h;e.coefficient[0]=(d+p-_-_)*f/h,e.coefficient[1]=(_+_+_-d-d-p)*f,e.coefficient[2]=s,e.coefficient[3]=a},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},c(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new ed;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:kc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return rd(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=id(e)}},{key:"postWrapMode",get:function(){return rd(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=id(e)}}]),e}(),Vf.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Hf=x((Gf=jf).prototype,"_curve",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kf=Gf))||kf;function id(e){switch(e){default:case Fs.Default:case Fs.Normal:case Fs.Clamp:return Gc.CLAMP;case Fs.PingPong:return Gc.PING_PONG;case Fs.Loop:return Gc.LOOP}}function rd(e){switch(e){default:case Gc.LINEAR:case Gc.CLAMP:return Fs.Clamp;case Gc.PING_PONG:return Fs.PingPong;case Gc.LOOP:return Fs.Loop}}var od=Object.freeze({__proto__:null,distance:Bo,enums:Fo,intersect:Ka,Line:is,Plane:cs,Ray:zo,Triangle:qo,Sphere:Wo,AABB:Is,OBB:Ns,Capsule:Ls,Frustum:Hs,Keyframe:ed,AnimationCurve:nd,get ERaycastMode(){return jo}});e("geometry",od);var ad={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},sd=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=g(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],K(2104,t),e.Enum[t]=i,qe.value(e.Enum,String(i),t),e.BitMask[t]=i,qe.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):n(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());sd.Enum=Ye(ad),sd.BitMask=Xe(l({},ad)),T.Layers=sd;var cd,ld,ud="MainFlow",hd="ForwardFlow",_d="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(cd||(cd={})),T.RenderPassStage=cd,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(ld||(ld={}));var fd,dd={bindings:[],layouts:{}},pd={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(fd||(fd={}));var md,vd=fd.SAMPLER_SHADOWMAP,gd=fd.COUNT-vd;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(md||(md={}));var yd,xd=md.SAMPLER_JOINTS,Sd=md.COUNT-xd;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(yd||(yd={}));var Td=new Zi;Td.bufferOffsets=[0,vd+xd,vd],Td.samplerOffsets=[-vd,gd+Sd,gd-xd],Td.flexibleSet=1;var Ed=function(){};Ed.SIZE=4*(Ed.COUNT=4+(Ed.SCREEN_SIZE_OFFSET=4+(Ed.NATIVE_SIZE_OFFSET=4+(Ed.TIME_OFFSET=0)))),Ed.NAME="CCGlobal",Ed.BINDING=fd.UBO_GLOBAL,Ed.DESCRIPTOR=new Rr(Ed.BINDING,Oi.UNIFORM_BUFFER,1,xi.ALL),Ed.LAYOUT=new lr(yd.GLOBAL,Ed.BINDING,Ed.NAME,[new cr("cc_time",ii.FLOAT4,1),new cr("cc_screenSize",ii.FLOAT4,1),new cr("cc_nativeSize",ii.FLOAT4,1)],1),dd.layouts[Ed.NAME]=Ed.LAYOUT,dd.bindings[Ed.BINDING]=Ed.DESCRIPTOR;var Cd=function(){};Cd.SIZE=4*(Cd.COUNT=4+(Cd.VIEW_PORT_OFFSET=4+(Cd.NEAR_FAR_OFFSET=4+(Cd.GLOBAL_FOG_ADD_OFFSET=4+(Cd.GLOBAL_FOG_BASE_OFFSET=4+(Cd.GLOBAL_FOG_COLOR_OFFSET=4+(Cd.AMBIENT_GROUND_OFFSET=4+(Cd.AMBIENT_SKY_OFFSET=4+(Cd.MAIN_LIT_COLOR_OFFSET=4+(Cd.MAIN_LIT_DIR_OFFSET=4+(Cd.EXPOSURE_OFFSET=4+(Cd.SCREEN_SCALE_OFFSET=4+(Cd.CAMERA_POS_OFFSET=16+(Cd.MAT_VIEW_PROJ_INV_OFFSET=16+(Cd.MAT_VIEW_PROJ_OFFSET=16+(Cd.MAT_PROJ_INV_OFFSET=16+(Cd.MAT_PROJ_OFFSET=16+(Cd.MAT_VIEW_INV_OFFSET=16+(Cd.MAT_VIEW_OFFSET=0))))))))))))))))))),Cd.NAME="CCCamera",Cd.BINDING=fd.UBO_CAMERA,Cd.DESCRIPTOR=new Rr(Cd.BINDING,Oi.UNIFORM_BUFFER,1,xi.ALL),Cd.LAYOUT=new lr(yd.GLOBAL,Cd.BINDING,Cd.NAME,[new cr("cc_matView",ii.MAT4,1),new cr("cc_matViewInv",ii.MAT4,1),new cr("cc_matProj",ii.MAT4,1),new cr("cc_matProjInv",ii.MAT4,1),new cr("cc_matViewProj",ii.MAT4,1),new cr("cc_matViewProjInv",ii.MAT4,1),new cr("cc_cameraPos",ii.FLOAT4,1),new cr("cc_screenScale",ii.FLOAT4,1),new cr("cc_exposure",ii.FLOAT4,1),new cr("cc_mainLitDir",ii.FLOAT4,1),new cr("cc_mainLitColor",ii.FLOAT4,1),new cr("cc_ambientSky",ii.FLOAT4,1),new cr("cc_ambientGround",ii.FLOAT4,1),new cr("cc_fogColor",ii.FLOAT4,1),new cr("cc_fogBase",ii.FLOAT4,1),new cr("cc_fogAdd",ii.FLOAT4,1),new cr("cc_nearFar",ii.FLOAT4,1),new cr("cc_viewPort",ii.FLOAT4,1)],1),dd.layouts[Cd.NAME]=Cd.LAYOUT,dd.bindings[Cd.BINDING]=Cd.DESCRIPTOR;var Ad=function(){};Ad.SIZE=4*(Ad.COUNT=4+(Ad.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Ad.SHADOW_COLOR_OFFSET=4+(Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Ad.SHADOW_PROJ_INFO_OFFSET=4+(Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Ad.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Ad.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Ad.MAT_LIGHT_VIEW_OFFSET=16+(Ad.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Ad.NAME="CCShadow",Ad.BINDING=fd.UBO_SHADOW,Ad.DESCRIPTOR=new Rr(Ad.BINDING,Oi.UNIFORM_BUFFER,1,xi.ALL),Ad.LAYOUT=new lr(yd.GLOBAL,Ad.BINDING,Ad.NAME,[new cr("cc_matLightPlaneProj",ii.MAT4,1),new cr("cc_matLightView",ii.MAT4,1),new cr("cc_matLightViewProj",ii.MAT4,1),new cr("cc_shadowInvProjDepthInfo",ii.FLOAT4,1),new cr("cc_shadowProjDepthInfo",ii.FLOAT4,1),new cr("cc_shadowProjInfo",ii.FLOAT4,1),new cr("cc_shadowNFLSInfo",ii.FLOAT4,1),new cr("cc_shadowWHPBInfo",ii.FLOAT4,1),new cr("cc_shadowLPNNInfo",ii.FLOAT4,1),new cr("cc_shadowColor",ii.FLOAT4,1),new cr("cc_planarNDInfo",ii.FLOAT4,1)],1),dd.layouts[Ad.NAME]=Ad.LAYOUT,dd.bindings[Ad.BINDING]=Ad.DESCRIPTOR;var bd=fd.SAMPLER_SHADOWMAP,Pd=new Rr(bd,Oi.SAMPLER_TEXTURE,1,xi.FRAGMENT),Rd=new ur(yd.GLOBAL,bd,"cc_shadowMap",ii.SAMPLER2D,1);dd.layouts.cc_shadowMap=Rd,dd.bindings[bd]=Pd;var wd=fd.SAMPLER_ENVIRONMENT,Id=new Rr(wd,Oi.SAMPLER_TEXTURE,1,xi.FRAGMENT),Dd=new ur(yd.GLOBAL,wd,"cc_environment",ii.SAMPLER_CUBE,1);dd.layouts.cc_environment=Dd,dd.bindings[wd]=Id;var Od=fd.SAMPLER_DIFFUSEMAP,Md=new Rr(Od,Oi.SAMPLER_TEXTURE,1,xi.FRAGMENT),Nd=new ur(yd.GLOBAL,Od,"cc_diffuseMap",ii.SAMPLER_CUBE,1);dd.layouts.cc_diffuseMap=Nd,dd.bindings[Od]=Md;var Ld=fd.SAMPLER_SPOT_LIGHTING_MAP,Bd=new Rr(Ld,Oi.SAMPLER_TEXTURE,1,xi.FRAGMENT),Fd=new ur(yd.GLOBAL,Ld,"cc_spotLightingMap",ii.SAMPLER2D,1);dd.layouts.cc_spotLightingMap=Fd,dd.bindings[Ld]=Bd;var zd=function(){};zd.SIZE=4*(zd.COUNT=4+(zd.LIGHTINGMAP_UVPARAM=16+(zd.MAT_WORLD_IT_OFFSET=16+(zd.MAT_WORLD_OFFSET=0)))),zd.NAME="CCLocal",zd.BINDING=md.UBO_LOCAL,zd.DESCRIPTOR=new Rr(zd.BINDING,Oi.UNIFORM_BUFFER,1,xi.VERTEX|xi.COMPUTE),zd.LAYOUT=new lr(yd.LOCAL,zd.BINDING,zd.NAME,[new cr("cc_matWorld",ii.MAT4,1),new cr("cc_matWorldIT",ii.MAT4,1),new cr("cc_lightingMapUVParam",ii.FLOAT4,1)],1),pd.layouts[zd.NAME]=zd.LAYOUT,pd.bindings[zd.BINDING]=zd.DESCRIPTOR;var Ud=function(){};Ud.SIZE=4*(Ud.COUNT=4+(Ud.WORLD_BOUND_HALF_EXTENTS=4+(Ud.WORLD_BOUND_CENTER=0))),Ud.NAME="CCWorldBound",Ud.BINDING=md.UBO_LOCAL,Ud.DESCRIPTOR=new Rr(Ud.BINDING,Oi.UNIFORM_BUFFER,1,xi.VERTEX|xi.COMPUTE),Ud.LAYOUT=new lr(yd.LOCAL,Ud.BINDING,Ud.NAME,[new cr("cc_worldBoundCenter",ii.FLOAT4,1),new cr("cc_worldBoundHalfExtents",ii.FLOAT4,1)],1),pd.layouts[Ud.NAME]=Ud.LAYOUT,pd.bindings[Ud.BINDING]=Ud.DESCRIPTOR;var kd="a_matWorld0",Gd=function(){};Gd.BATCHING_COUNT=10,Gd.MAT_WORLDS_OFFSET=0,Gd.SIZE=4*(Gd.COUNT=16*Gd.BATCHING_COUNT),Gd.NAME="CCLocalBatched",Gd.BINDING=md.UBO_LOCAL,Gd.DESCRIPTOR=new Rr(Gd.BINDING,Oi.UNIFORM_BUFFER,1,xi.VERTEX|xi.COMPUTE),Gd.LAYOUT=new lr(yd.LOCAL,Gd.BINDING,Gd.NAME,[new cr("cc_matWorlds",ii.MAT4,Gd.BATCHING_COUNT)],1),pd.layouts[Gd.NAME]=Gd.LAYOUT,pd.bindings[Gd.BINDING]=Gd.DESCRIPTOR;var Hd=function(){};Hd.LIGHTS_PER_PASS=1,Hd.SIZE=4*(Hd.COUNT=(Hd.LIGHT_DIR_OFFSET=(Hd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Hd.LIGHT_COLOR_OFFSET=(Hd.LIGHT_POS_OFFSET=0)+4*Hd.LIGHTS_PER_PASS)+4*Hd.LIGHTS_PER_PASS)+4*Hd.LIGHTS_PER_PASS)+4*Hd.LIGHTS_PER_PASS),Hd.NAME="CCForwardLight",Hd.BINDING=md.UBO_FORWARD_LIGHTS,Hd.DESCRIPTOR=new Rr(Hd.BINDING,Oi.DYNAMIC_UNIFORM_BUFFER,1,xi.FRAGMENT),Hd.LAYOUT=new lr(yd.LOCAL,Hd.BINDING,Hd.NAME,[new cr("cc_lightPos",ii.FLOAT4,Hd.LIGHTS_PER_PASS),new cr("cc_lightColor",ii.FLOAT4,Hd.LIGHTS_PER_PASS),new cr("cc_lightSizeRangeAngle",ii.FLOAT4,Hd.LIGHTS_PER_PASS),new cr("cc_lightDir",ii.FLOAT4,Hd.LIGHTS_PER_PASS)],1),pd.layouts[Hd.NAME]=Hd.LAYOUT,pd.bindings[Hd.BINDING]=Hd.DESCRIPTOR;var Vd=function(){};Vd.LIGHTS_PER_PASS=10;var jd=function(){};jd.SIZE=4*(jd.COUNT=4+(jd.JOINTS_TEXTURE_INFO_OFFSET=0)),jd.NAME="CCSkinningTexture",jd.BINDING=md.UBO_SKINNING_TEXTURE,jd.DESCRIPTOR=new Rr(jd.BINDING,Oi.UNIFORM_BUFFER,1,xi.VERTEX),jd.LAYOUT=new lr(yd.LOCAL,jd.BINDING,jd.NAME,[new cr("cc_jointTextureInfo",ii.FLOAT4,1)],1),pd.layouts[jd.NAME]=jd.LAYOUT,pd.bindings[jd.BINDING]=jd.DESCRIPTOR;var Wd=function(){};Wd.SIZE=4*(Wd.COUNT=4+(Wd.JOINTS_ANIM_INFO_OFFSET=0)),Wd.NAME="CCSkinningAnimation",Wd.BINDING=md.UBO_SKINNING_ANIMATION,Wd.DESCRIPTOR=new Rr(Wd.BINDING,Oi.UNIFORM_BUFFER,1,xi.VERTEX),Wd.LAYOUT=new lr(yd.LOCAL,Wd.BINDING,Wd.NAME,[new cr("cc_jointAnimInfo",ii.FLOAT4,1)],1),pd.layouts[Wd.NAME]=Wd.LAYOUT,pd.bindings[Wd.BINDING]=Wd.DESCRIPTOR;var qd="a_jointAnimInfo",Xd=function(){};Xd.SIZE=4*(Xd.COUNT=360+(Xd.JOINTS_OFFSET=0)),Xd.NAME="CCSkinning",Xd.BINDING=md.UBO_SKINNING_TEXTURE,Xd.DESCRIPTOR=new Rr(Xd.BINDING,Oi.UNIFORM_BUFFER,1,xi.VERTEX),Xd.LAYOUT=new lr(yd.LOCAL,Xd.BINDING,Xd.NAME,[new cr("cc_joints",ii.FLOAT4,90)],1),pd.layouts[Xd.NAME]=Xd.LAYOUT,pd.bindings[Xd.BINDING]=Xd.DESCRIPTOR;var Yd=function(){};Yd.MAX_MORPH_TARGET_COUNT=60,Yd.OFFSET_OF_WEIGHTS=0,Yd.OFFSET_OF_VERTICES_COUNT=4+(Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Yd.MAX_MORPH_TARGET_COUNT)),Yd.COUNT_BASE_4_BYTES=4*Math.ceil(Yd.MAX_MORPH_TARGET_COUNT/4)+4,Yd.SIZE=4*Yd.COUNT_BASE_4_BYTES,Yd.NAME="CCMorph",Yd.BINDING=md.UBO_MORPH,Yd.DESCRIPTOR=new Rr(Yd.BINDING,Oi.UNIFORM_BUFFER,1,xi.VERTEX),Yd.LAYOUT=new lr(yd.LOCAL,Yd.BINDING,Yd.NAME,[new cr("cc_displacementWeights",ii.FLOAT4,Yd.MAX_MORPH_TARGET_COUNT/4),new cr("cc_displacementTextureInfo",ii.FLOAT4,1)],1),pd.layouts[Yd.NAME]=Yd.LAYOUT,pd.bindings[Yd.BINDING]=Yd.DESCRIPTOR;var Kd=function(){};Kd.NAME="CCUILocal",Kd.BINDING=md.UBO_UI_LOCAL,Kd.DESCRIPTOR=new Rr(Kd.BINDING,Oi.DYNAMIC_UNIFORM_BUFFER,1,xi.VERTEX),Kd.LAYOUT=new lr(yd.LOCAL,Kd.BINDING,Kd.NAME,[new cr("cc_local_data",ii.FLOAT4,1)],1),pd.layouts[Kd.NAME]=Kd.LAYOUT,pd.bindings[Kd.BINDING]=Kd.DESCRIPTOR;var Qd=md.SAMPLER_JOINTS,Zd=new Rr(Qd,Oi.SAMPLER_TEXTURE,1,xi.VERTEX),Jd=new ur(yd.LOCAL,Qd,"cc_jointTexture",ii.SAMPLER2D,1);pd.layouts.cc_jointTexture=Jd,pd.bindings[Qd]=Zd;var $d=md.SAMPLER_MORPH_POSITION,ep=new Rr($d,Oi.SAMPLER_TEXTURE,1,xi.VERTEX),tp=new ur(yd.LOCAL,$d,"cc_PositionDisplacements",ii.SAMPLER2D,1);pd.layouts.cc_PositionDisplacements=tp,pd.bindings[$d]=ep;var np=md.SAMPLER_MORPH_NORMAL,ip=new Rr(np,Oi.SAMPLER_TEXTURE,1,xi.VERTEX),rp=new ur(yd.LOCAL,np,"cc_NormalDisplacements",ii.SAMPLER2D,1);pd.layouts.cc_NormalDisplacements=rp,pd.bindings[np]=ip;var op=md.SAMPLER_MORPH_TANGENT,ap=new Rr(op,Oi.SAMPLER_TEXTURE,1,xi.VERTEX),sp=new ur(yd.LOCAL,op,"cc_TangentDisplacements",ii.SAMPLER2D,1);pd.layouts.cc_TangentDisplacements=sp,pd.bindings[op]=ap;var cp=md.SAMPLER_LIGHTMAP,lp=new Rr(cp,Oi.SAMPLER_TEXTURE,1,xi.FRAGMENT),up=new ur(yd.LOCAL,cp,"cc_lightingMap",ii.SAMPLER2D,1);pd.layouts.cc_lightingMap=up,pd.bindings[cp]=lp;var hp=md.SAMPLER_SPRITE,_p=new Rr(hp,Oi.SAMPLER_TEXTURE,1,xi.FRAGMENT),fp=new ur(yd.LOCAL,hp,"cc_spriteTexture",ii.SAMPLER2D,1);pd.layouts.cc_spriteTexture=fp,pd.bindings[hp]=_p;var dp=md.SAMPLER_REFLECTION,pp=new Rr(dp,Oi.SAMPLER_TEXTURE,1,xi.FRAGMENT),mp=new ur(yd.LOCAL,dp,"cc_reflectionTexture",ii.SAMPLER2D,1);pd.layouts.cc_reflectionTexture=mp,pd.bindings[dp]=pp;var vp=md.STORAGE_REFLECTION,gp=new Rr(vp,Oi.STORAGE_IMAGE,1,xi.COMPUTE),yp=new fr(yd.LOCAL,vp,"cc_reflectionStorage",ii.IMAGE2D,1);pd.layouts.cc_reflectionStorage=yp,pd.bindings[vp]=gp;var xp,Sp,Tp=sd.makeMaskExclude([sd.BitMask.UI_2D,sd.BitMask.GIZMOS,sd.BitMask.EDITOR,sd.BitMask.SCENE_GIZMO,sd.BitMask.PROFILER]),Ep=sd.makeMaskExclude([sd.BitMask.UI_2D,sd.BitMask.PROFILER]),Cp=sd.Enum.ALL;function Ap(e){return e.hasFeature(ei.COLOR_FLOAT)&&e.hasFeature(ei.TEXTURE_FLOAT)&&!(e.gfxAPI===Jn.WEBGL)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:ud,PIPELINE_FLOW_FORWARD:hd,PIPELINE_FLOW_SHADOW:_d,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return cd},get RenderPriority(){return ld},globalDescriptorSetLayout:dd,localDescriptorSetLayout:pd,get PipelineGlobalBindings(){return fd},get ModelLocalBindings(){return md},get SetIndex(){return yd},bindingMappingInfo:Td,UBOGlobal:Ed,UBOCamera:Cd,UBOShadow:Ad,UNIFORM_SHADOWMAP_BINDING:bd,UNIFORM_ENVIRONMENT_BINDING:wd,UNIFORM_DIFFUSEMAP_BINDING:Od,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:Ld,UBOLocal:zd,UBOWorldBound:Ud,INST_MAT_WORLD:kd,UBOLocalBatched:Gd,UBOForwardLight:Hd,UBODeferredLight:Vd,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:jd,UBOSkinningAnimation:Wd,INST_JOINT_ANIM_INFO:qd,UBOSkinning:Xd,UBOMorph:Yd,UBOUILocal:Kd,UNIFORM_JOINT_TEXTURE_BINDING:Qd,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:$d,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:np,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:op,UNIFORM_LIGHTMAP_TEXTURE_BINDING:cp,UNIFORM_SPRITE_TEXTURE_BINDING:hp,UNIFORM_REFLECTION_TEXTURE_BINDING:dp,UNIFORM_REFLECTION_STORAGE_BINDING:vp,CAMERA_DEFAULT_MASK:Tp,CAMERA_EDITOR_MASK:Ep,MODEL_ALWAYS_MASK:Cp,supportsHalfFloatTexture:function(e){return e.hasFeature(ei.COLOR_HALF_FLOAT)&&e.hasFeature(ei.TEXTURE_HALF_FLOAT)&&!(e.gfxAPI===Jn.WEBGL)},supportsFloatTexture:Ap}));var bp=4227858432,Pp=66060288,Rp=1044480,wp=function(e,t,n,i){return void 0===i&&(i=0),t<<26&bp|e<<20&Pp|n<<12&Rp|4095&i},Ip=function(e){return(e&bp)>>>26},Dp=function(e){return(e&Pp)>>>20},Op=function(e){return(e&Rp)>>>12},Mp=function(e){return 4095&e},Np=function(e,t){return 67108863&e|t<<26&bp},Lp=((xp={})[ii.UNKNOWN]=function(){return console.warn("illegal uniform handle")},xp[ii.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},xp[ii.INT2]=function(e,t,n){return void 0===n&&(n=0),gn.fromArray(t,e,n)},xp[ii.INT3]=function(e,t,n){return void 0===n&&(n=0),dn.fromArray(t,e,n)},xp[ii.INT4]=function(e,t,n){return void 0===n&&(n=0),Tn.fromArray(t,e,n)},xp[ii.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},xp[ii.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),gn.fromArray(t,e,n)},xp[ii.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),dn.fromArray(t,e,n)},xp[ii.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Tn.fromArray(t,e,n)},xp[ii.MAT3]=function(e,t,n){return void 0===n&&(n=0),Cn.fromArray(t,e,n)},xp[ii.MAT4]=function(e,t,n){return void 0===n&&(n=0),Ln.fromArray(t,e,n)},xp),Bp=((Sp={})[ii.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Sp[ii.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Sp[ii.INT2]=function(e,t,n){return void 0===n&&(n=0),gn.toArray(e,t,n)},Sp[ii.INT3]=function(e,t,n){return void 0===n&&(n=0),dn.toArray(e,t,n)},Sp[ii.INT4]=function(e,t,n){return void 0===n&&(n=0),Tn.toArray(e,t,n)},Sp[ii.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Sp[ii.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),gn.toArray(e,t,n)},Sp[ii.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),dn.toArray(e,t,n)},Sp[ii.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Tn.toArray(e,t,n)},Sp[ii.MAT3]=function(e,t,n){return void 0===n&&(n=0),Cn.toArray(e,t,n)},Sp[ii.MAT4]=function(e,t,n){return void 0===n&&(n=0),Ln.toArray(e,t,n)},Sp),Fp=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function zp(e){switch(e){case ii.BOOL:case ii.INT:case ii.UINT:case ii.FLOAT:return Fp[0];case ii.BOOL2:case ii.INT2:case ii.UINT2:case ii.FLOAT2:return Fp[1];case ii.BOOL4:case ii.INT4:case ii.UINT4:case ii.FLOAT4:return Fp[2];case ii.MAT4:return Fp[3];case ii.SAMPLER2D:return"default-texture";case ii.SAMPLER_CUBE:return"default-cube-texture"}return Fp[0]}function Up(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var kp=new wr;function Gp(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Hp(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function Vp(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=function(e){var t=o.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&Hr))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var l=[],u=function(e){var t=o.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&Vr))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function jp(e){return e.members.reduce((function(e,t){return e+Kr(t.type)*t.count}),0)}function Wp(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function qp(e){switch(e.gfxAPI){case Jn.GLES2:case Jn.WEBGL:return"glsl1";case Jn.GLES3:case Jn.WEBGL2:return"glsl3";default:return"glsl4"}}var Xp,Yp,Kp,Qp,Zp,Jp,$p,em,tm=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=l({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=Gp(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=Gp(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new gr,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var u=n.blocks[c];s.blockSizes.push(jp(u)),s.bindings.push(new Rr(u.binding,Oi.UNIFORM_BUFFER,1,u.stageFlags)),s.shaderInfo.blocks.push(new lr(yd.MATERIAL,u.binding,u.name,u.members.map((function(e){return new cr(e.name,e.type,e.count)})),1))}for(var h=0;h<n.samplerTextures.length;h++){var _=n.samplerTextures[h];s.bindings.push(new Rr(_.binding,Oi.SAMPLER_TEXTURE,_.count,_.stageFlags)),s.shaderInfo.samplerTextures.push(new ur(yd.MATERIAL,_.binding,_.name,_.type,_.count))}for(var f=0;f<n.samplers.length;f++){var d=n.samplers[f];s.bindings.push(new Rr(d.binding,Oi.SAMPLER,d.count,d.stageFlags)),s.shaderInfo.samplers.push(new hr(yd.MATERIAL,d.binding,d.name,d.count))}for(var p=0;p<n.textures.length;p++){var m=n.textures[p];s.bindings.push(new Rr(m.binding,Oi.TEXTURE,m.count,m.stageFlags)),s.shaderInfo.textures.push(new _r(yd.MATERIAL,m.binding,m.name,m.type,m.count))}for(var v=0;v<n.buffers.length;v++){var g=n.buffers[v];s.bindings.push(new Rr(g.binding,Oi.STORAGE_BUFFER,1,g.stageFlags)),s.shaderInfo.buffers.push(new dr(yd.MATERIAL,g.binding,g.name,1,g.memoryAccess))}for(var y=0;y<n.images.length;y++){var x=n.images[y];s.bindings.push(new Rr(x.binding,Oi.STORAGE_IMAGE,x.count,x.stageFlags)),s.shaderInfo.images.push(new fr(yd.MATERIAL,x.binding,x.name,x.type,x.count,x.memoryAccess))}for(var S=0;S<n.subpassInputs.length;S++){var T=n.subpassInputs[S];s.bindings.push(new Rr(T.binding,Oi.INPUT_ATTACHMENT,T.count,T.stageFlags)),s.shaderInfo.subpassInputs.push(new pr(yd.MATERIAL,T.binding,T.name,T.count))}s.gfxAttributes=[];for(var E=0;E<n.attributes.length;E++){var C=n.attributes[E];s.gfxAttributes.push(new vr(C.name,C.format,C.isNormalized,0,C.isInstanced,C.location))}Vp(n,s,pd,"locals"),s.shaderInfo.stages.push(new mr(xi.VERTEX,"")),s.shaderInfo.stages.push(new mr(xi.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=wp(i.binding,s.type,s.count,o),o+=(Kr(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=wp(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(kp.bindings=r.bindings,r.setLayouts[yd.MATERIAL]=e.createDescriptorSetLayout(kp),kp.bindings=pd.bindings,r.setLayouts[yd.LOCAL]=e.createDescriptorSetLayout(kp)),r.setLayouts[n?yd.LOCAL:yd.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=t[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];B("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),Vp(a,s,dd,"globals"),s.setLayouts[yd.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new Dr(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=Hp(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=qp(e);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,o=t.gfxAttributes,a=0;a<r.length;a++)Wp(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());T.programLib=tm;var nm=e("EffectAsset",$s("cc.EffectAsset")((em=$p=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"techniques",Kp,m(t)),y(t,"shaders",Qp,m(t)),y(t,"combinations",Zp,m(t)),y(t,"hideInEditor",Jp,m(t)),t}u(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name].equals(e)&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){tm.register(this),t.register(this),T.game.once(T.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=T.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],o=0;o<i.length;++o){var a=l({},n);a[t]=i[o],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return tm.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(pu),$p._effects={},Kp=x((Yp=em).prototype,"techniques",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qp=x(Yp.prototype,"shaders",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zp=x(Yp.prototype,"combinations",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jp=x(Yp.prototype,"hideInEditor",[oc,sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Xp=Yp))||Xp);T.EffectAsset=nm;var im,rm,om,am,sm,cm,lm,um,hm,_m,fm,dm,pm,mm,vm,gm=1024;!function(e){e[e.RGB565=ti.R5G6B5]="RGB565",e[e.RGB5A1=ti.RGB5A1]="RGB5A1",e[e.RGBA4444=ti.RGBA4]="RGBA4444",e[e.RGB888=ti.RGB8]="RGB888",e[e.RGB32F=ti.RGB32F]="RGB32F",e[e.RGBA8888=ti.RGBA8]="RGBA8888",e[e.RGBA32F=ti.RGBA32F]="RGBA32F",e[e.A8=ti.A8]="A8",e[e.I8=ti.L8]="I8",e[e.AI8=ti.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=ti.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=ti.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=gm++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=ti.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=ti.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=gm++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=ti.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=gm++]="RGBA_ETC1",e[e.RGB_ETC2=ti.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=ti.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=ti.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=ti.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=ti.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=ti.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=ti.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=ti.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=ti.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=ti.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=ti.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=ti.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=ti.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=ti.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=ti.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=ti.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(im||(im={})),function(e){e[e.REPEAT=di.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=di.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=di.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=di.BORDER]="CLAMP_TO_BORDER"}(rm||(rm={})),function(e){e[e.NONE=fi.NONE]="NONE",e[e.LINEAR=fi.LINEAR]="LINEAR",e[e.NEAREST=fi.POINT]="NEAREST"}(om||(om={})),Ze(ti);var ym,xm,Sm,Tm,Em=new oe("Tex"),Cm=$s("cc.TextureBase")((vm=mm=function(e){function t(){var t;return y(t=e.call(this)||this,"_format",cm,m(t)),y(t,"_minFilter",lm,m(t)),y(t,"_magFilter",um,m(t)),y(t,"_mipFilter",hm,m(t)),y(t,"_wrapS",_m,m(t)),y(t,"_wrapT",fm,m(t)),y(t,"_wrapR",dm,m(t)),y(t,"_anisotropy",pm,m(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new sr,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=Em.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=oo(t._id,666),t}u(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=T.director.root)||void 0===t?void 0:t.batcher2D)&&T.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):W(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return T.director.root?T.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?im.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===im.RGBA_ETC1?e=im.RGB_ETC1:e===im.RGB_A_PVRTC_4BPPV1?e=im.RGB_PVRTC_4BPPV1:e===im.RGB_A_PVRTC_2BPPV1&&(e=im.RGB_PVRTC_2BPPV1),e},c(t,[{key:"isCompressed",get:function(){return this._format>=im.RGB_ETC1&&this._format<=im.RGBA_ASTC_12x12||this._format>=im.RGB_A_PVRTC_2BPPV1&&this._format<=im.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(pu),mm.PixelFormat=im,mm.WrapMode=rm,mm.Filter=om,cm=x((sm=vm).prototype,"_format",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return im.RGBA8888}}),lm=x(sm.prototype,"_minFilter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return om.LINEAR}}),um=x(sm.prototype,"_magFilter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return om.LINEAR}}),hm=x(sm.prototype,"_mipFilter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return om.NONE}}),_m=x(sm.prototype,"_wrapS",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rm.REPEAT}}),fm=x(sm.prototype,"_wrapT",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rm.REPEAT}}),dm=x(sm.prototype,"_wrapR",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rm.REPEAT}}),pm=x(sm.prototype,"_anisotropy",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),am=sm))||am;function Am(e){return!!(T.sys.hasFeature(T.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}T.TextureBase=Cm;var bm=e("ImageAsset",$s("cc.ImageAsset")((Tm=Sm=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=im.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}u(t,e);var n=t.prototype;return n.reset=function(e){Am(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Am(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var i,r=T.director.root?T.director.root.device:null,o=n.split("_"),a=Number.MAX_VALUE,s=this._format,c="",l=T.macro.SUPPORT_TEXTURE_FORMATS,u=g(o);!(i=u()).done;){var h=i.value.split("@"),_=parseInt(h[0],void 0),f=t.extnames[_]||h[0],d=l.indexOf(f);if(-1!==d&&d<a){var p=h[1]?parseInt(h[1]):this._format;if(!(".astc"!==f||r&&r.hasFeature(ei.FORMAT_ASTC)))continue;if(!(".pvr"!==f||r&&r.hasFeature(ei.FORMAT_PVRTC)))continue;if(!(p!==im.RGB_ETC1&&p!==im.RGBA_ETC1||r&&r.hasFeature(ei.FORMAT_ETC1)))continue;if(!(p!==im.RGB_ETC2&&p!==im.RGBA_ETC2||r&&r.hasFeature(ei.FORMAT_ETC2)))continue;if(".webp"===f&&!T.sys.hasFeature(T.sys.Feature.WEBP))continue;a=d,c=f,s=p}}c?(this._setRawAsset(c),this._format=s):V(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},c(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||Am(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Am(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=im.RGB_ETC1&&this._format<=im.RGBA_ASTC_12x12||this._format>=im.RGB_A_PVRTC_2BPPV1&&this._format<=im.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(pu),Sm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Sm._sharedPlaceHolderCanvas=null,x((xm=Tm).prototype,"_nativeAsset",[Vc],Object.getOwnPropertyDescriptor(xm.prototype,"_nativeAsset"),xm.prototype),ym=xm))||ym);T.ImageAsset=bm;var Pm=new WeakMap,Rm=new WeakSet,wm=new WeakSet;function Im(e,t){var n;n=Uu.safeFindClass;var i,r=sh.pool.get();try{i=yh(e,r,{classFinder:n,customEnv:t})}catch(e){throw N(e),sh.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:gl(h),owner:a[u],prop:s[u],type:qe._getClassById(c[u])}}return Pm.set(i,l),i._native&&Rm.add(i),sh.pool.put(r),i}var Dm,Om=new(function(){function e(){this._depends=new tl}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?l({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof Ku){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var o=Im(t,{__uuid__:e});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=e),al.add(e+"@import",o)}catch(t){ol.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=Pm.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Rm.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=gl(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,n.push(o),this._descend(o,t,n))}},e}()),Mm=[new Yi];function Nm(e){return e&&0==(e&e-1)}var Lm,Bm,Fm,zm,Um,km,Gm=$s("cc.SimpleTexture")(Dm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t}u(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=Mm[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,Mm):i.copyTexImagesToTexture([e],this._gfxTexture,Mm)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),$e.CLEANUP_IMAGE_CACHE)){var r=Om.getDeps(this._uuid),o=r.indexOf(e._uuid);-1!==o&&(te(r,o),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=ui.NONE;this._mipFilter!==om.NONE&&function(e,t,n){return!(e.gfxAPI===Jn.WEBGL)||Nm(t)&&Nm(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=ui.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:li.SAMPLED|li.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},c(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Cm))||Dm;T.SimpleTexture=Gm;var Hm,Vm,jm,Wm,qm,Xm,Ym,Km=e("Texture2D",(Lm=$s("cc.Texture2D"),Bm=Mc([bm]),Lm((km=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",Um,m(t)),t}u(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.create=function(e,t,n,i){void 0===n&&(n=im.RGBA8888),void 0===i&&(i=1),this.reset({width:e,height:t,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new bm,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,qe._getClassId(bm))}},n._getGfxTextureCreateInfo=function(e){var t=new or(ci.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new bm;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},c(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Gm),Um=x((zm=km).prototype,"_mipmaps",[Bm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fm=zm))||Fm));T.Texture2D=Km,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Ym||(Ym={}));var Qm=e("TextureCube",$s("cc.TextureCube")((Xm=qm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",jm,m(t)),y(t,"_mipmaps",Wm,m(t)),t}u(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+Ym.front].image,back:e[a+Ym.back].image,left:e[a+Ym.left].image,right:e[a+Ym.right].image,top:e[a+Ym.top].image,bottom:e[a+Ym.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;Zm(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new bm,back:new bm,left:new bm,right:new bm,top:new bm,bottom:new bm};var o=i.mipmaps[r],a=qe._getClassId(bm);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new or(ci.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new bm;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},c(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){Zm(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Gm),qm.FaceIndex=Ym,jm=x((Vm=Xm).prototype,"isRGBE",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wm=x(Vm.prototype,"_mipmaps",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hm=Vm))||Hm);function Zm(e,t){t(e.front,Ym.front),t(e.back,Ym.back),t(e.left,Ym.left),t(e.right,Ym.right),t(e.top,Ym.top),t(e.bottom,Ym.bottom)}T.TextureCube=Qm;var Jm,$m,ev,tv=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2554907268,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:730673320,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:4277052359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),nv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},iv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=0,l=0;l<4;l++)i[c]=0,i[c+1]=0,i[c+2]=0,i[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,o[c]=119,o[c+1]=119,o[c+2]=119,o[c+3]=255,a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;var u=new Uint8Array(1024);c=0;for(var h=0;h<256;h++)u[c]=221,u[c+1]=221,u[c+2]=221,u[c+3]=255,c+=4;c=0;for(var _=0;_<8;_++){for(var f=0;f<8;f++)u[c]=85,u[c+1]=85,u[c+2]=85,u[c+3]=255,c+=4;c+=32}c+=32;for(var d=0;d<8;d++){for(var p=0;p<8;p++)u[c]=85,u[c+1]=85,u[c+2]=85,u[c+3]=255,c+=4;c+=32}var m={width:2,height:2,_data:i,_compressed:!1,format:Km.PixelFormat.RGBA8888},v={width:2,height:2,_data:r,_compressed:!1,format:Km.PixelFormat.RGBA8888},g={width:2,height:2,_data:o,_compressed:!1,format:Km.PixelFormat.RGBA8888},y={width:2,height:2,_data:a,_compressed:!1,format:Km.PixelFormat.RGBA8888},x={width:2,height:2,_data:s,_compressed:!1,format:Km.PixelFormat.RGBA8888},S={width:16,height:16,_data:u,_compressed:!1,format:Km.PixelFormat.RGBA8888},E=new bm(m),C=new Km;C._uuid="black-texture",C.image=E,n[C._uuid]=C;var A=new bm(v),b=new Km;b._uuid="empty-texture",b.image=A,n[b._uuid]=b;var P=new Qm;P._uuid="black-cube-texture",P.setMipFilter(Qm.Filter.NEAREST),P.image={front:new bm(m),back:new bm(m),left:new bm(m),right:new bm(m),top:new bm(m),bottom:new bm(m)},n[P._uuid]=P;var R=new bm(g),w=new Km;w._uuid="grey-texture",w.image=R,n[w._uuid]=w;var I=new bm(y),D=new Km;D._uuid="white-texture",D.image=I,n[D._uuid]=D;var O=new Qm;O._uuid="white-cube-texture",O.setMipFilter(Qm.Filter.NEAREST),O.image={front:new bm(y),back:new bm(y),left:new bm(y),right:new bm(y),top:new bm(y),bottom:new bm(y)},n[O._uuid]=O;var M=new bm(x),N=new Km;N._uuid="normal-texture",N.image=M,n[N._uuid]=N;var L=new bm(S),B=new Km;B._uuid="default-texture",B.image=L,n[B._uuid]=B;var F=new Qm;if(F.setMipFilter(Qm.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new bm(S),back:new bm(S),left:new bm(S),right:new bm(S),top:new bm(S),bottom:new bm(S)},n[F._uuid]=F,T.SpriteFrame){var z=new T.SpriteFrame,U=E,k=new Km;k.image=U,z.texture=k,z._uuid="default-spriteframe",n[z._uuid]=z}var G=qp(e);if(!G)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=nv[G];return H?Promise.resolve().then((function(){tv.forEach((function(e,t){var n=Object.assign(new T.EffectAsset,e);n.shaders.forEach((function(e,n){var i=H[t][n];i&&(e[G]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+G+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new T.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new T.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",T.color("#ffff00")),e[i._uuid]=i,t.push(i);var r=new T.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",T.color("#ff00ff")),e[r._uuid]=r,t.push(r);var o=new T.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[o._uuid]=o,t.push(o);var a=new T.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[a._uuid]=a,t.push(a);var s=new T.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new T.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new T.Material;l._uuid="ui-sprite-gray-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new T.Material;u._uuid="ui-sprite-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new T.Material;h._uuid="ui-sprite-gray-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var _=new T.Material;_._uuid="ui-graphics-material",_.initialize({effectName:"graphics"}),e[_._uuid]=_,t.push(_);var f=new T.Material;f._uuid="default-particle-material",f.initialize({effectName:"particle"}),e[f._uuid]=f,t.push(f);var d=new T.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),e[d._uuid]=d,t.push(d);var p=new T.Material;p._uuid="default-trail-material",p.initialize({effectName:"particle-trail"}),e[p._uuid]=p,t.push(p);var m=new T.Material;m._uuid="default-billboard-material",m.initialize({effectName:"billboard"}),e[m._uuid]=m,t.push(m);var v=new T.Material;v._uuid="default-spine-material",v.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[v._uuid]=v,t.push(v),T.game.on(T.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),rv=e("builtinResMgr",T.builtinResMgr=new iv),ov=e("getPhaseID",(Jm=new Map,$m=0,function(e){return"number"==typeof e?e:(Jm.has(e)||(Jm.set(e,1<<$m),$m++),Jm.get(e))})),av=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var o=e.inputAssembler,a=e.descriptorSet.getTexture(cp),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.HOST|si.DEVICE,32*r,r)),d=new Uint8Array(32*r),p=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],x=new vr(y.name,y.format,y.isNormalized,p.length,!0);m.push(x)}d.set(t.buffer),p.push(f);var S=new yr(m,p,v),T=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:f,data:d,ia:T,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),sv=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<Gd.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var d=0;d<_.vbs.length;++d){var p=i[d],m=_.vbs[d],v=_.vbDatas[d];(r=(a+_.vbCount)*p.stride)>m.size&&(m.resize(r),_.vbDatas[d]=new Uint8Array(r),_.vbDatas[d].set(v)),_.vbDatas[d].set(p.buffer,_.vbCount*p.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+a,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var T=y;T<x;T++)g[T]=S+.1;return Ln.toArray(_.uboData,n.transform.worldMatrix,Gd.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(Gd.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var E=[],C=[],A=[],b=0;b<i.length;++b){var P=i[b],R=this._device.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.HOST|si.DEVICE,P.count*P.stride,P.stride));R.update(P.buffer.buffer),E.push(R),C.push(new Uint8Array(R.size)),A.push(R)}var w=this._device.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.HOST|si.DEVICE,4*a,4)),I=new Float32Array(a);I.fill(0),w.update(I),A.push(w);for(var D=e.inputAssembler.attributes,O=new Array(D.length+1),M=0;M<D.length;++M)O[M]=D[M];O[D.length]=new vr("a_dyn_batch_id",ti.R32F,!1,i.length);var N=new yr(O,A),L=this._device.createInputAssembler(N),B=this._device.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,Gd.SIZE,Gd.SIZE));l.bindBuffer(Gd.BINDING,B),l.update();var F=new Float32Array(Gd.COUNT);Ln.toArray(F,n.transform.worldMatrix,Gd.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:C,vbIdx:w,vbIdxData:I,vbCount:a,ia:L,ubo:B,uboData:F,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),cv=new er(ri.UNIFORM|ri.TRANSFER_DST,si.DEVICE),lv=new tr(null),uv=new Ir(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(ev||(ev={}));var hv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new fo,this._dss=new ho,this._rs=new uo,this._priority=ld.DEFAULT,this._stage=cd.DEFAULT,this._phase=ov("default"),this._primitive=bi.TRIANGLE_LIST,this._batchingScheme=ev.NONE,this._dynamicStates=Ii.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(ov(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=tm.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=g(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),oo(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=ii.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=Np(i,n):t&&(i=Np(i,Ip(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);Bp[r](a,n,o),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);return Lp[r](a,n,o)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=Kr(r)>>2,a=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&Bp[r](a,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):W(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new av(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new sv(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||zp(i),u=(Kr(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":zp(r),l=rv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?yo.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],o=this._getBlockView(r.type,t.binding),a=this._properties[r.name],s=a&&a.value||zp(r.type),c=(Kr(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=tm.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(tm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=tm.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(ld.DEFAULT),this._setStage(cd.DEFAULT),this._setPhase(ov("default")),this._setPrimitive(bi.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?l({},t.defines):t.defines,this._shaderInfo=tm.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),uv.layout=tm.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(uv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=tm.getTemplateInfo(t.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,u=[],h=0,_=0,f=0;f<r.length;f++){var d=a[f];u.push(_),_+=Math.ceil(d/c)*c,h=d}var p=u[u.length-1]+h;p&&(cv.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(cv),this._rootBlock=new ArrayBuffer(p));for(var m=0,v=0;m<r.length;m++){var g=r[m].binding,y=a[m];lv.buffer=this._rootBuffer,lv.offset=u[v++],lv.range=16*Math.ceil(y/16);var x=this._buffers[g]=i.createBuffer(lv);this._blocks[g]=new Float32Array(this._rootBlock,lv.offset,y/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[g]=new Int32Array(this._blocks[g].buffer,this._blocks[g].byteOffset,this._blocks[g].length),this._descriptorSet.bindBuffer(g,x)}var S=this._propertyHandleMap=s,T={};for(var E in this._properties){var C=this._properties[E];C.handleInfo&&(T[E]=this.getHandle.apply(this,C.handleInfo))}Object.assign(S,T)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(ei.INSTANCED_ARRAYS)?this._setBatchingScheme(ev.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(ev.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(ev.VB_MERGING):this._setBatchingScheme(ev.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<ii.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(tm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},c(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return tm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();hv.getTypeFromHandle=Ip,hv.getBindingFromHandle=Dp,hv.getCountFromHandle=Op,hv.getOffsetFromHandle=Mp;var _v=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var o=t.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=t.pipelineLayout,c=new Or(r.attributes),l=new po(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},e}());_v._PSOHashMap=new Map;var fv=new Ki,dv=new Hi;function pv(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var mv,vv,gv,yv,xv,Sv,Tv,Ev,Cv,Av,bv=null;function Pv(e,t,n,i,r){if(i&&i.enabled&&r===bv){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;fv.width=dv.width=r.window.width,fv.height=dv.height=r.window.height;var u=_v.getOrCreatePipelineState(e,s[0],c[0],t,a);n.setViewport(fv),n.setScissor(dv),n.bindPipelineState(u),n.bindDescriptorSet(yd.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(yd.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Rv,wv,Iv,Dv,Ov,Mv=new Tn,Nv=e("Material",(mv=$s("cc.Material"),vv=Mc(nm),mv((Av=function(e){function t(){var t;return y(t=e.call(this)||this,"_effectAsset",xv,m(t)),y(t,"_techIdx",Sv,m(t)),y(t,"_defines",Tv,m(t)),y(t,"_states",Ev,m(t)),y(t,"_props",Cv,m(t)),t._passes=[],t._hash=0,t}u(t,e),t.getHash=function(e){for(var t,n=0,i=g(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?V(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=g(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var n=0;n<e._props.length;n++)this._props[n]=l({},e._props[n]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=l({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=l({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},n._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=nm.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],o=r.passIndex=i,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new hv(T.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(hv.getTypeFromHandle(i)<ii.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var o=n;pv(Mv,o),Mv.w=o.w,n=Mv}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(e,i,n[a],a);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=hv.getBindingFromHandle(t);if(n instanceof So)e.bindTexture(r,n,i);else if(n instanceof Cm){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=g(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Wn("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},c(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(pu),xv=x((yv=Av).prototype,"_effectAsset",[vv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sv=x(yv.prototype,"_techIdx",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tv=x(yv.prototype,"_defines",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ev=x(yv.prototype,"_states",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cv=x(yv.prototype,"_props",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gv=yv))||gv));T.Material=Nv,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Rv||(Rv={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(wv||(wv={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Iv||(Iv={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Dv||(Dv={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Ov||(Ov={}));var Lv=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Bv=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Fv=[100,200,400,800],zv=new dn,Uv=new dn,kv=new Ln,Gv=Bi.STENCIL<<1,Hv=[],Vv=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Rv.VERTICAL,this._fov=Jt(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Qi(.2,.2,.2,1),this._viewport=new Hn(0,0,1,1),this._orientedViewport=new Hn(0,0,1,1),this._curTransform=$n.IDENTITY,this._isProjDirty=!0,this._matView=new Ln,this._matProj=new Ln,this._matProjInv=new Ln,this._matViewProj=new Ln,this._matViewProjInv=new Ln,this._frustum=new Hs,this._forward=new dn,this._position=new dn,this._priority=0,this._aperture=Iv.F16_0,this._apertureValue=void 0,this._shutter=Ov.D125,this._shutterValue=0,this._iso=Dv.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Bi.NONE,this._clearDepth=1,this._visibility=Tp,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=Lv[this._aperture],this._shutterValue=Bv[this._shutter],this._isoValue=Fv[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!Hv.length){var t=e.capabilities.clipSpaceSignY;Hv[$n.IDENTITY]=new Ln(1,0,0,0,0,t),Hv[$n.ROTATE_90]=new Ln(0,1,0,0,-t,0),Hv[$n.ROTATE_180]=new Ln(-1,0,0,0,0,-t),Hv[$n.ROTATE_270]=new Ln(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||$n.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Bi.NONE,this.clearDepth=1,this.visibility=Tp,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t._destroy=function(){},t.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(Ln.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||$n.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===wv.PERSPECTIVE)Ln.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Rv.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Ln.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Ln.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Ln.multiply(this._matViewProj,this._matProj,this._matView),Ln.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,o=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||$n.IDENTITY){case $n.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case $n.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case $n.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case $n.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||T.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||$n.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===wv.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Nn[this._curTransform];dn.set(zv,(t-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=zv.x,f=zv.y;return zv.x=_*h[0]+f*h[2]*u,zv.y=_*h[1]+f*h[3]*u,dn.transformMat4(l?zv:e.o,zv,this._matViewProjInv),l?(this._node.getWorldPosition(Uv),zo.fromPoints(e,Uv,zv)):dn.transformQuat(e.d,dn.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Nn[this._curTransform];if(this._proj===wv.PERSPECTIVE){dn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,dn.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(zv),dn.lerp(e,zv,e,Zt(this._nearClip/this._farClip,1,t.z))}else{dn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*l[0]+f*l[2]*c,e.y=_*l[1]+f*l[3]*c,dn.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=Nn[this._curTransform];dn.transformMat4(e,t,this._matViewProj);var r=e.x,o=e.y;e.x=r*i[0]+o*i[2]*n,e.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){Ln.multiply(e,this._matViewProj,t),Ln.multiply(e,Hv[this._curTransform],e);var r=n/2,o=i/2;return Ln.identity(kv),Ln.transform(kv,kv,dn.set(zv,r,o,0)),Ln.scale(kv,kv,dn.set(zv,r,o,1)),Ln.multiply(e,kv,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},c(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){V(8302),this.setViewportInOrientedSpace(e)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=Lv[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=Bv[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=Fv[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),jv=Ye({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Wv=Ye({Planar:0,ShadowMap:1}),qv=Ye({HARD:0,SOFT:1,SOFT_2X:2}),Xv=Wv.ShadowMap+1,Yv=function(){function e(){this.fixedSphere=new Wo(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Ln,this.matShadowProj=new Ln,this.matShadowViewProj=new Ln,this._normal=new dn(0,1,0),this._shadowColor=new Wn(0,0,0,76),this._matLight=new Ln,this._material=null,this._instancingMaterial=null,this._size=new gn(512,512),this._enabled=!1,this._distance=0,this._type=Xv,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new Nv,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Nv,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:Xv},t.initialize=function(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation},t.activate=function(){this.enabled&&this.type===Wv.Planar&&this._updatePlanarInfo()},t._updatePlanarInfo=function(){this._material||(this._material=new Nv,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Nv,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){dn.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"near",get:function(){return this._near},set:function(e){this._near=e}},{key:"far",get:function(){return this._far},set:function(e){this._far=e}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();Yv.MAX_FAR=2e3,Yv.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),T.Shadows=Yv;var Kv=new dn,Qv=(new dn,new dn,new dn),Zv=new Ln,Jv=new Is,$v=new Is,eg=!1,tg=Wo.create(0,0,0,1),ng=new Wo,ig=new Hs;ig.accurate=!0;var rg=new Hs;rg.accurate=!0;var og=new Hs,ag=new Ln,sg=new Ln,cg=new Ln,lg=new Ln,ug=new Ln,hg=new Ln,_g=new Ln,fg=new dn,dg=new gn,pg=new dn,mg=new dn,vg=new dn(0,0,0),gg=(new Is,new Pl((function(){return{model:null,depth:0}}),128)),yg=new Pl((function(){return{model:null,depth:0}}),128),xg=new Pl((function(){return{model:null,depth:0}}),128);function Sg(e,t){var n=0;e.node&&(dn.subtract(Kv,e.node.worldPosition,t.position),n=dn.dot(Kv,t.forward));var i=gg.alloc();return i.model=e,i.depth=n,i}function Tg(e,t){var n=0;e.node&&(dn.subtract(Kv,e.node.worldPosition,t.position),n=dn.dot(Kv,t.forward));var i=yg.alloc();return i.model=e,i.depth=n,i}function Eg(e,t){var n=0;e.node&&(dn.subtract(Kv,e.node.worldPosition,t.position),n=dn.dot(Kv,t.forward));var i=xg.alloc();return i.model=e,i.depth=n,i}function Cg(e,t,n){var i=t.direction,r=e.normal,o=e.distance+.001,a=1/dn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,Ln.toArray(n,f,Ad.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Ag(e,t){dn.normalize(Kv,e.normal),t[Ad.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Kv.x,t[Ad.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Kv.y,t[Ad.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Kv.z,t[Ad.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function bg(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(Wo.set(tg,o.position.x,o.position.y,o.position.z,o.range),Ka.sphereFrustum(tg,t.frustum)&&n.push(o))}for(var a=t.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(Wo.set(tg,c.position.x,c.position.y,c.position.z,c.range),Ka.sphereFrustum(tg,t.frustum)&&n.push(c))}}function Pg(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;gg.freeArray(s),s.length=0;var c=r.castShadowObjects;xg.freeArray(c),c.length=0,eg=!1;var l=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(Ad.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===Wv.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,yg.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var o=t.device;if(r.fixedArea){var a=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;Ln.fromRT(ag,n.node.getWorldRotation(),n.node.getWorldPosition()),Ln.invert(sg,ag),Ln.ortho(lg,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),Ln.multiply(ug,lg,sg),Ln.invert(cg,sg),r.matShadowView=sg,r.matShadowProj=lg,r.matShadowViewProj=ug,Hs.createOrtho(e,2*a,2*s,c,l,cg)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();Ln.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(Zv,i),Hs.split(ig,i,Zv,.1,r.shadowDistance),rg=Hs.clone(ig),Ln.fromRT(ag,n.node.rotation,vg),Ln.invert(sg,ag),Ln.invert(cg,sg);var _=sg.clone();rg.transform(sg),Is.fromPoints(Jv,new dn(1e7,1e7,1e7),new dn(-1e7,-1e7,-1e7)),Jv.mergeFrustum(rg);var f=2*Jv.halfExtents.z;Qv.set(Jv.center.x,Jv.center.y,Jv.center.z+Jv.halfExtents.z+u),dn.transformMat4(Qv,Qv,cg),Ln.fromRT(ag,n.node.rotation,Qv),Ln.invert(sg,ag),Ln.invert(cg,sg);var d=dn.distance(ig.vertices[0],ig.vertices[6]);ng.center.set(0,0,0),ng.radius=-1,ng.mergePoints(ig.vertices);var p=.8*d+.4*ng.radius;r.shadowCameraFar=f+u;var m=.5*p;if(Ln.ortho(lg,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){Ln.multiply(hg,lg,_),dn.transformMat4(fg,Qv,hg);var v=2/h;dg.set(v,v);var g=fg.x%dg.x,y=fg.y%dg.y;pg.set(fg.x-g,fg.y-y,fg.z),Ln.invert(_g,hg),dn.transformMat4(mg,pg,_g),Ln.fromRT(ag,n.node.rotation,mg),Ln.invert(sg,ag),Ln.invert(cg,sg),Hs.createOrtho(e,p,p,.1,r.shadowCameraFar,cg)}else{for(var x=0;x<8;x++)e.vertices[x].set(0,0,0);e.updatePlanes()}Ln.multiply(ug,lg,sg),r.matShadowView=sg,r.matShadowProj=lg,r.matShadowViewProj=ug}}(og,e,i,t,o);else{for(var u=0;u<8;u++)og.vertices[u].set(0,0,0);og.updatePlanes()}i&&o.type===Wv.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,o=n.distance+.001,a=1/dn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,e.pipelineUBO.updateShadowUBORange(Ad.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&Gv&&s.push(Sg(a.model,t));for(var h=n.models,_=t.visibility,f=0;f<h.length;f++){var d=h[f];if(d.enabled&&(d.castShadow&&c.push(Eg(d,t)),o.firstSetCSM&&d.worldBounds&&(eg||($v.copy(d.worldBounds),eg=!0),Is.merge($v,$v,d.worldBounds)),d.node&&(_&d.node.layer)===d.node.layer||_&d.visFlags)){if(null!=l&&d.castShadow&&d.worldBounds&&Ka.aabbFrustum(d.worldBounds,og)&&l.push(Tg(d,t)),d.worldBounds&&!Ka.aabbFrustum(d.worldBounds,t.frustum))continue;s.push(Sg(d,t))}}o.firstSetCSM&&(o.shadowDistance=2*$v.halfExtents.length(),o.firstSetCSM=!1)}var Rg,wg,Ig,Dg=new sr(fi.LINEAR,fi.LINEAR,fi.NONE,di.CLAMP,di.CLAMP,di.CLAMP),Og=new sr(fi.POINT,fi.POINT,fi.NONE,di.CLAMP,di.CLAMP,di.CLAMP),Mg=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(Dg),this._pointSampler=this._device.getSampler(Og);var t=new wr(dd.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new Ir(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new Ir(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=fd.UBO_GLOBAL;r<fd.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=t.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,Ad.SIZE,Ad.SIZE));i.bindBuffer(Ad.BINDING,o),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},c(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}();function Ng(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Rg||(Rg={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(wg||(wg={})),T.internal.TransformBit=wg,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Ig||(Ig={}));var Lg,Bg,Fg,zg,Ug,kg,Gg,Hg,Vg,jg,Wg=function(e){return 4*Math.PI*Math.PI*e*e},qg=function(){function e(){this._baked=!1,this._color=new dn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new dn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Ig.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new dn(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},c(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Ng(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=wg.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Xg=new Ln,Yg=new Ln,Kg=new Ln,Qg=new Tn,Zg=new Tn(0,0,1,0),Jg=function(){function e(){this._globalUBO=new Float32Array(Ed.COUNT),this._cameraUBO=new Float32Array(Cd.COUNT),this._shadowUBO=new Float32Array(Ad.COUNT)}e.updateGlobalUBOView=function(e,t){var n=T.director.root,i=t,r=Math.floor(e.width),o=Math.floor(e.height);i[Ed.TIME_OFFSET]=n.cumulativeTime,i[Ed.TIME_OFFSET+1]=n.frameTime,i[Ed.TIME_OFFSET+2]=T.director.getTotalFrames(),i[Ed.SCREEN_SIZE_OFFSET]=r,i[Ed.SCREEN_SIZE_OFFSET+1]=o,i[Ed.SCREEN_SIZE_OFFSET+2]=1/r,i[Ed.SCREEN_SIZE_OFFSET+3]=1/o,i[Ed.NATIVE_SIZE_OFFSET]=r,i[Ed.NATIVE_SIZE_OFFSET+1]=o,i[Ed.NATIVE_SIZE_OFFSET+2]=1/i[Ed.NATIVE_SIZE_OFFSET],i[Ed.NATIVE_SIZE_OFFSET+3]=1/i[Ed.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var i=(n.scene?n.scene:T.director.getScene().renderScene).mainLight,r=e.pipelineSceneData,o=r.ambient,a=r.fog,s=r.shadows,c=t,l=n.exposure,u=r.isHDR;if(c[Cd.SCREEN_SCALE_OFFSET]=r.shadingScale,c[Cd.SCREEN_SCALE_OFFSET+1]=r.shadingScale,c[Cd.SCREEN_SCALE_OFFSET+2]=1/c[Cd.SCREEN_SCALE_OFFSET],c[Cd.SCREEN_SCALE_OFFSET+3]=1/c[Cd.SCREEN_SCALE_OFFSET+1],c[Cd.EXPOSURE_OFFSET]=l,c[Cd.EXPOSURE_OFFSET+1]=1/l,c[Cd.EXPOSURE_OFFSET+2]=u?1:0,c[Cd.EXPOSURE_OFFSET+3]=0,i){var h=s.enabled&&s.type===Wv.ShadowMap?1:0,_=i.direction;if(Zg.set(_.x,_.y,_.z,h),Tn.toArray(c,Zg,Cd.MAIN_LIT_DIR_OFFSET),dn.toArray(c,i.color,Cd.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var f=i.colorTemperatureRGB;c[Cd.MAIN_LIT_COLOR_OFFSET]*=f.x,c[Cd.MAIN_LIT_COLOR_OFFSET+1]*=f.y,c[Cd.MAIN_LIT_COLOR_OFFSET+2]*=f.z}c[Cd.MAIN_LIT_COLOR_OFFSET+3]=u?i.illuminance*l:i.illuminance}else Zg.set(0,0,1,0),Tn.toArray(c,Zg,Cd.MAIN_LIT_DIR_OFFSET),Tn.toArray(c,Tn.ZERO,Cd.MAIN_LIT_COLOR_OFFSET);var d=o.skyColor;d.w=u?o.skyIllum*l:o.skyIllum,c[Cd.AMBIENT_SKY_OFFSET+0]=d.x,c[Cd.AMBIENT_SKY_OFFSET+1]=d.y,c[Cd.AMBIENT_SKY_OFFSET+2]=d.z,c[Cd.AMBIENT_SKY_OFFSET+3]=d.w,c[Cd.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,c[Cd.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,c[Cd.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,c[Cd.AMBIENT_GROUND_OFFSET+3]=o.mipmapCount,Ln.toArray(c,n.matView,Cd.MAT_VIEW_OFFSET),Ln.toArray(c,n.node.worldMatrix,Cd.MAT_VIEW_INV_OFFSET),dn.toArray(c,n.position,Cd.CAMERA_POS_OFFSET),Ln.toArray(c,n.matProj,Cd.MAT_PROJ_OFFSET),Ln.toArray(c,n.matProjInv,Cd.MAT_PROJ_INV_OFFSET),Ln.toArray(c,n.matViewProj,Cd.MAT_VIEW_PROJ_OFFSET),Ln.toArray(c,n.matViewProjInv,Cd.MAT_VIEW_PROJ_INV_OFFSET),c[Cd.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var p=a.colorArray;c[Cd.GLOBAL_FOG_COLOR_OFFSET]=p.x,c[Cd.GLOBAL_FOG_COLOR_OFFSET+1]=p.y,c[Cd.GLOBAL_FOG_COLOR_OFFSET+2]=p.z,c[Cd.GLOBAL_FOG_COLOR_OFFSET+3]=p.z,c[Cd.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,c[Cd.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,c[Cd.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,c[Cd.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,c[Cd.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,c[Cd.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten,c[Cd.NEAR_FAR_OFFSET]=n.nearClip,c[Cd.NEAR_FAR_OFFSET+1]=n.farClip,c[Cd.VIEW_PORT_OFFSET]=r.shadingScale*n.window.width*n.viewport.x,c[Cd.VIEW_PORT_OFFSET+1]=r.shadingScale*n.window.height*n.viewport.y,c[Cd.VIEW_PORT_OFFSET+2]=r.shadingScale*n.window.width*n.viewport.z,c[Cd.VIEW_PORT_OFFSET+3]=r.shadingScale*n.window.height*n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,o=e.pipelineSceneData.shadows,a=t;if(o.enabled){if(r&&o.type===Wv.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;o.fixedArea?(s=o.near,c=o.far):(s=.1,c=o.shadowCameraFar),Ln.toArray(t,l,Ad.MAT_LIGHT_VIEW_OFFSET),a[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Ad.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Ad.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Ad.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Ad.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Ln.toArray(t,h,Ad.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=Ap(i)?0:1;a[Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,a[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===Wv.Planar&&(Cg(o,r,a),Ag(o,a));Wn.toArray(a,o.shadowColor,Ad.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i=e.device,r=e.pipelineSceneData.shadows,o=t,a=Ap(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case Ig.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),Ln.toArray(t,l,Ad.MAT_LIGHT_VIEW_OFFSET),o[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Ad.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Ad.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Ad.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Ad.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Ln.toArray(t,h,Ad.MAT_LIGHT_VIEW_PROJ_OFFSET),Qg.set(s,c,0,1-r.saturation),Tn.toArray(o,Qg,Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Qg.set(0,a,r.normalBias,0),Tn.toArray(o,Qg,Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case Ig.SPOT:Ln.invert(Xg,n.node.getWorldMatrix()),Ln.toArray(o,Xg,Ad.MAT_LIGHT_VIEW_OFFSET),Ln.perspective(Yg,n.angle,n.aspect,.001,n.range),Ln.multiply(Kg,Yg,Xg),Ln.toArray(o,Kg,Ad.MAT_LIGHT_VIEW_PROJ_OFFSET),Qg.set(.01,n.range,0,1-r.saturation),Tn.toArray(o,Qg,Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Qg.set(1,a,r.normalBias,0),Tn.toArray(o,Qg,Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}Qg.set(r.size.x,r.size.y,r.pcf,r.bias),Tn.toArray(o,Qg,Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Wn.toArray(o,r.shadowColor,Ad.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,Ed.SIZE,Ed.SIZE));n.bindBuffer(Ed.BINDING,i);var r=e.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,Cd.SIZE,Cd.SIZE));n.bindBuffer(Cd.BINDING,r);var o=e.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,Ad.SIZE,Ad.SIZE));n.bindBuffer(Ad.BINDING,o)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(Ed.BINDING),this._globalUBO),n.bindBuffer(Ed.BINDING,i.getBuffer(Ed.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(Cd.BINDING),this._cameraUBO),n.bindBuffer(Cd.BINDING,i.getBuffer(Cd.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=t.scene.mainLight;a&&o.has(a)&&i.bindTexture(bd,o.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(Ad.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(bd,rv.get("default-texture").getGFXTexture()),t.bindTexture(Ld,rv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(Ad.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof Ln?Ln.toArray(this._shadowUBO,t,e):t instanceof Wn&&Wn.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();Jg._combineSignY=0;var $g,ey,ty,ny,iy,ry,oy,ay,sy,cy,ly,uy,hy,_y=e("RenderStage",(Lg=$s("RenderStage"),Bg=bc(),Fg=bc(),zg=bc(),Lg((jg=function(){function e(){y(this,"_name",Gg,this),y(this,"_priority",Hg,this),this._enabled=!0,y(this,"_tag",Vg,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},c(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),Gg=x((kg=jg).prototype,"_name",[Bg,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hg=x(kg.prototype,"_priority",[Fg,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vg=x(kg.prototype,"_tag",[zg,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ug=kg))||Ug));T.RenderStage=_y;var fy,dy=e("RenderFlow",($g=$s("RenderFlow"),ey=bc(),ty=bc(),ny=bc(),iy=bc(),ry=Mc([_y]),$g((hy=function(){function e(){y(this,"_name",sy,this),y(this,"_priority",cy,this),y(this,"_tag",ly,this),y(this,"_stages",uy,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},c(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),sy=x((ay=hy).prototype,"_name",[ey,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cy=x(ay.prototype,"_priority",[ty,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ly=x(ay.prototype,"_tag",[ny,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uy=x(ay.prototype,"_stages",[iy,ry,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oy=ay))||oy));T.RenderFlow=dy,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(fy||(fy=e("PipelineEventType",{})));var py,my,vy,gy,yy,xy,Sy,Ty,Ey,Cy,Ay,by,Py,Ry,wy,Iy=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}u(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(zl)),Dy=new Hi,Oy=new Ki,My=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},Ny=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},Ly=e("RenderPipeline",(py=$s("cc.RenderPipeline"),my=bc(),vy=bc(),gy=Mc([dy]),py((Ey=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_tag",Sy,m(t)),y(t,"_flows",Ty,m(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new Iy,t._commandBuffers=[],t._pipelineUBO=new Jg,t._macros={},t._constantMacros="",t._profiler=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new Hi,t._clusterEnabled=!1,t._bloomEnabled=!1,t}u(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new xr,o=new Sr;r.format=t,o.format=n,o.stencilStoreOp=Ti.DISCARD,o.depthStoreOp=Ti.DISCARD,e&Bi.COLOR||(e&Gv?r.loadOp=Si.DISCARD:(r.loadOp=Si.LOAD,r.beginAccesses=[Ei.COLOR_ATTACHMENT_WRITE])),(e&Bi.DEPTH_STENCIL)!==Bi.DEPTH_STENCIL&&(e&Bi.DEPTH||(o.depthLoadOp=Si.LOAD),e&Bi.STENCIL||(o.stencilLoadOp=Si.LOAD)),o.beginAccesses=[Ei.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Cr([r],o);return i.createRenderPass(a)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new Pr(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,Dy),t||(t=Oy);var n=this.pipelineSceneData.shadingScale;return t.left=Dy.x*n,t.top=Dy.y*n,t.width=Dy.width*n,t.height=Dy.height*n,t},n.generateScissor=function(e,t){t||(t=Dy),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=T.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new Mg(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(fy.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(bv=n)}bv=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(fy.RENDER_CAMERA_BEGIN,n),bg(this,n),Pg(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(fy.RENDER_CAMERA_END,n)}}this.emit(fy.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,o=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(e){case $n.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case $n.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case $n.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case $n.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var e=new Ny,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE|si.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new er(ri.INDEX|ri.TRANSFER_DST,si.DEVICE,o,r));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new vr("a_position",ti.RG32F),c[1]=new vr("a_texCoord",ti.RG32F);var l=this._device.createInputAssembler(new yr(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData($n.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||$n.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(ei.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(ei.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(Jl.os===Vl.ANDROID&&Jl.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+($e.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new My,t=this.device,n=new xr;n.format=ti.RGBA8,n.loadOp=Si.CLEAR,n.storeOp=Ti.STORE,n.endAccesses=[Ei.COLOR_ATTACHMENT_WRITE],e.renderPass=t.createRenderPass(new Cr([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED,ti.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Pr(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)e.downsampleTexs.push(t.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED,ti.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[o]=t.createFramebuffer(new Pr(e.renderPass,[e.downsampleTexs[o]])),e.upsampleTexs.push(t.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED,ti.RGBA8,i,r))),e.upsampleFramebuffers[o]=t.createFramebuffer(new Pr(e.renderPass,[e.upsampleTexs[o]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED,ti.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Pr(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},c(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(pu),Sy=x((xy=Ey).prototype,"_tag",[my,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ty=x(xy.prototype,"_flows",[vy,gy,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yy=xy))||yy));T.RenderPipeline=Ly,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(Cy||(Cy={})),function(e){e[e.FORWARD=10]="FORWARD"}(Ay||(Ay={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(by||(by={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(Py||(Py={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(Ry||(Ry={}));var By=new xr;By.format=ti.RGBA8,By.beginAccesses=[Ei.FRAGMENT_SHADER_READ_TEXTURE],By.endAccesses=[Ei.FRAGMENT_SHADER_READ_TEXTURE];var Fy=new Sr;Fy.format=ti.DEPTH_STENCIL;var zy,Uy,ky,Gy,Hy,Vy,jy,Wy,qy,Xy,Yy,Ky,Qy,Zy,Jy,$y,ex,tx,nx,ix,rx,ox,ax,sx,cx,lx,ux,hx,_x,fx,dx,px,mx,vx,gx,yx,xx,Sx,Tx,Ex,Cx,Ax,bx,Px,Rx,wx,Ix,Dx,Ox,Mx,Nx,Lx,Bx,Fx,zx,Ux,kx,Gx,Hx,Vx,jx,Wx,qx,Xx,Yx,Kx,Qx,Zx,Jx,$x,eS,tS,nS,iS,rS,oS,aS,sS,cS,lS=new Cr([By],Fy),uS={width:1,height:1,renderPassInfo:lS},hS=e("RenderTexture",$s("cc.RenderTexture")(wy=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=T.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(Kt(e,1,2048)),this._height=Math.floor(Kt(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=T.director.root;uS.title=this._name,uS.width=this._width,uS.height=this._height,uS.renderPassInfo=e&&e.passInfo?e.passInfo:lS,this._window?(this._window.destroy(),this._window.initialize(t.device,uS)):this._window=t.createWindow(uS)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return W(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return W(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new Yi;return u.texOffset.x=e,u.texOffset.y=t,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},c(t,[{key:"window",get:function(){return this._window}}]),t}(Cm))||wy);T.RenderTexture=hS,Ze(ci),Ze(li),Ze(Ti),Ze(Si),Ze(Ei),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(cS||(cS={})),Ze(cS),zy=$s("RenderTextureDesc"),Uy=Mc(ci),ky=Mc(li),Gy=Mc(ti),zy((Vy=x((Hy=function(){y(this,"name",Vy,this),y(this,"type",jy,this),y(this,"usage",Wy,this),y(this,"format",qy,this),y(this,"width",Xy,this),y(this,"height",Yy,this)}).prototype,"name",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jy=x(Hy.prototype,"type",[Uy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ci.TEX2D}}),Wy=x(Hy.prototype,"usage",[ky],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return li.COLOR_ATTACHMENT}}),qy=x(Hy.prototype,"format",[Gy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ti.UNKNOWN}}),Xy=x(Hy.prototype,"width",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Yy=x(Hy.prototype,"height",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Hy));var _S,fS=(Ky=$s("RenderTextureConfig"),Qy=Mc(hS),Ky(($y=x((Jy=function(){y(this,"name",$y,this),y(this,"texture",ex,this)}).prototype,"name",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ex=x(Jy.prototype,"texture",[Qy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zy=Jy))||Zy),dS=(tx=$s("MaterialConfig"),nx=Mc(Nv),tx((rx=x((ix=function(){y(this,"name",rx,this),y(this,"material",ox,this)}).prototype,"name",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ox=x(ix.prototype,"material",[nx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ix)),ax=$s("FrameBufferDesc"),sx=Mc([Ct]),cx=Mc(hS),ax((ux=x((lx=function(){y(this,"name",ux,this),y(this,"renderPass",hx,this),y(this,"colorTextures",_x,this),y(this,"depthStencilTexture",fx,this),y(this,"texture",dx,this)}).prototype,"name",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hx=x(lx.prototype,"renderPass",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_x=x(lx.prototype,"colorTextures",[sx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fx=x(lx.prototype,"depthStencilTexture",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dx=x(lx.prototype,"texture",[cx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lx)),px=$s("ColorDesc"),mx=Mc(ti),vx=Mc(Si),gx=Mc(Ti),yx=Mc([Ei]),xx=Mc([Ei]),px((Ex=x((Tx=function(){y(this,"format",Ex,this),y(this,"loadOp",Cx,this),y(this,"storeOp",Ax,this),y(this,"sampleCount",bx,this),y(this,"beginAccesses",Px,this),y(this,"endAccesses",Rx,this)}).prototype,"format",[mx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ti.UNKNOWN}}),Cx=x(Tx.prototype,"loadOp",[vx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Si.CLEAR}}),Ax=x(Tx.prototype,"storeOp",[gx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.STORE}}),bx=x(Tx.prototype,"sampleCount",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Px=x(Tx.prototype,"beginAccesses",[yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rx=x(Tx.prototype,"endAccesses",[xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Ei.COLOR_ATTACHMENT_WRITE]}}),Sx=Tx))||Sx),pS=(wx=$s("DepthStencilDesc"),Ix=Mc(ti),Dx=Mc(Si),Ox=Mc(Ti),Mx=Mc(Si),Nx=Mc(Ti),Lx=Mc([Ei]),Bx=Mc([Ei]),wx((Ux=x((zx=function(){y(this,"format",Ux,this),y(this,"depthLoadOp",kx,this),y(this,"depthStoreOp",Gx,this),y(this,"stencilLoadOp",Hx,this),y(this,"stencilStoreOp",Vx,this),y(this,"sampleCount",jx,this),y(this,"beginAccesses",Wx,this),y(this,"endAccesses",qx,this)}).prototype,"format",[Ix],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ti.UNKNOWN}}),kx=x(zx.prototype,"depthLoadOp",[Dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Si.CLEAR}}),Gx=x(zx.prototype,"depthStoreOp",[Ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.STORE}}),Hx=x(zx.prototype,"stencilLoadOp",[Mx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Si.CLEAR}}),Vx=x(zx.prototype,"stencilStoreOp",[Nx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.STORE}}),jx=x(zx.prototype,"sampleCount",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Wx=x(zx.prototype,"beginAccesses",[Lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qx=x(zx.prototype,"endAccesses",[Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Ei.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),Fx=zx))||Fx);Xx=$s("RenderPassDesc"),Yx=Mc([dS]),Kx=Mc(pS),Xx((Zx=x((Qx=function(){y(this,"index",Zx,this),y(this,"colorAttachments",Jx,this),y(this,"depthStencilAttachment",$x,this)}).prototype,"index",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Jx=x(Qx.prototype,"colorAttachments",[Yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$x=x(Qx.prototype,"depthStencilAttachment",[Kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new pS}}),Qx)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(_S||(_S={})),Ze(_S);var mS=(eS=$s("RenderQueueDesc"),tS=Mc(_S),nS=Mc([Ct]),eS((oS=x((rS=function(){y(this,"isTransparent",oS,this),y(this,"sortMode",aS,this),y(this,"stages",sS,this)}).prototype,"isTransparent",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),aS=x(rS.prototype,"sortMode",[tS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _S.FRONT_TO_BACK}}),sS=x(rS.prototype,"stages",[nS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iS=rS))||iS);function vS(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function gS(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var yS=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Rl((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new wl(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=e.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=_v.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(yd.MATERIAL,c.descriptorSet),n.bindDescriptorSet(yd.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function xS(e){for(var t=0,n=0;n<e.stages.length;n++)t|=ov(e.stages[n]);var i=vS;switch(e.sortMode){case _S.BACK_TO_FRONT:i=gS;break;case _S.FRONT_TO_BACK:i=vS}return new yS({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function SS(e){e.clear()}function TS(e){e.sort()}var ES=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=_v.getOrCreatePipelineState(e,s.pass,c,t,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(yd.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(yd.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},e}(),CS=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(yd.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,_=_v.getOrCreatePipelineState(e,s,h,t,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(yd.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},e}(),AS=function(){function e(){this._groundAlbedoHDR=new Tn(.2,.2,.2,1),this._skyColorHDR=new Tn(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Tn(.2,.2,.2,1),this._skyColorLDR=new Tn(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(e){this._mipmapCount=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();AS.SUN_ILLUM=65e3,AS.SKY_ILLUM=2e4,T.Ambient=AS;var bS,PS=function(){function e(){this._enabled=!1,this._minPos=new dn(0,0,0),this._maxPos=new dn(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),RS=new dn(0,0,-1),wS=new dn,IS=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new dn(1,-1,-1),t._illuminanceHDR=AS.SUN_ILLUM,t._illuminanceLDR=1,t._type=Ig.DIRECTIONAL,t}u(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=AS.SUN_ILLUM,this.direction=new dn(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=dn.transformQuat(wS,RS,this._node.worldRotation))},c(t,[{key:"direction",get:function(){return this._dir},set:function(e){dn.normalize(this._dir,e)}},{key:"illuminance",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}}]),t}(qg),DS=new Ir(null),OS=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=ld.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var i=T.director.root;this._device=i.device,DS.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(DS);var r=T.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Ir(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===ev.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=ld.DEFAULT,t[0].phase===ov("reflection")){var a=i.mainWindow.width,s=i.mainWindow.height,c=512;s<a?(a=c*a/s,s=c):s=c*s/(a=c),this._reflectionTex=this._device.createTexture(new or(ci.TEX2D,li.STORAGE|li.TRANSFER_SRC|li.SAMPLED,ti.RGBA8,a,s)),this.descriptorSet.bindTexture(dp,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new sr(fi.LINEAR,fi.LINEAR,fi.NONE,di.CLAMP,di.CLAMP,di.CLAMP)),this.descriptorSet.bindSampler(dp,this._reflectionSampler),this.descriptorSet.bindTexture(vp,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=T.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=T.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=ld.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},c(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?W(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===ev.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),DS.layout=e[0].localSetLayout,this._createDescriptorSet(DS)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===ev.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),MS=new Ln,NS=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(bS||(bS={}));var LS=new sr(fi.LINEAR,fi.LINEAR,fi.NONE,di.CLAMP,di.CLAMP,di.CLAMP),BS=new sr(fi.LINEAR,fi.LINEAR,fi.LINEAR,di.CLAMP,di.CLAMP,di.CLAMP),FS=function(){function e(){this.type=bS.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(zd.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Tn,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=sd.Enum.NONE,this._device=T.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=sd.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Ln.toArray(this._localData,i,zd.MAT_WORLD_OFFSET),Ln.inverseTranspose(MS,i);var a=Math.abs(Ln.determinant(MS)),s=1/Math.sqrt(a);Ln.multiplyScalar(MS,MS,s),Ln.toArray(this._localData,MS,zd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Is.fromPoints(Is.create(),e,t),this._worldBounds=Is.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new OS},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){Tn.toArray(this._localData,t,zd.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=rv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?BS:LS),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(cp,n),a.bindSampler(cp,i),a.update()}},t.getMacroPatches=function(){return this.receiveShadow?NS:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(ei.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=Gr[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new vr;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=Gr[c.format],h=new(Qr(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}t.batchingScheme===ev.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(kd)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.DEVICE,zd.SIZE,zd.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.DEVICE,Ud.SIZE,Ud.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(zd.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(Ud.BINDING,this._worldBoundBuffer)},c(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),zS=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t._destroy=function(){},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=g(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=wg.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=g(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=g(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._createNativeObject=function(){},c(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),e}(),US=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return e.prototype.tryCompile.call(m(i)),i}u(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),hv.fillPipelineInfo(this,e),hv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!Up(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(ev.NONE)},n._onStateChange=function(){this._setHash(hv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},c(t,[{key:"parent",get:function(){return this._parent}}]),t}(hv),kS=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}u(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=g(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=Nv.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new US(t[n],this));return e},c(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Nv),GS=null,HS=null,VS=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t;var n=T.director.root;n.pipeline.pipelineSceneData.isHDR?e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel):t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=T.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=rv.get("default-cube-texture"),this._model||(this._model=T.director.root.createModel(T.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!HS){var n=new Nv;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),HS=new kS({parent:n})}this.enabled&&(GS||(GS=T.utils.createMesh(T.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,GS.renderingSubMeshes[0],HS)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=T.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===i&&t.macros.CC_USE_HDR===r||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=i,t.macros.CC_USE_HDR=r,e.onGlobalPipelineStateChanged()),this.enabled&&HS&&HS.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,HS)},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=T.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),i=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(wd,i),this._globalDSManager.bindTexture(wd,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=e.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(Od,a),this._globalDSManager.bindTexture(Od,o)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},c(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();T.Skybox=VS;var jS=function(e){u(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=Is.create(),t._pos=new dn,t._type=Ig.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/Wg(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;Is.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},c(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(qg),WS=new dn(0,0,-1),qS=new Pn,XS=new Ln,YS=new Ln,KS=new Ln,QS=new Ln,ZS=function(e){u(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new dn(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._aspect=0,t._aabb=Is.create(),t._frustum=Hs.create(),t._pos=new dn,t._type=Ig.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/Wg(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new dn(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),dn.transformQuat(this._dir,WS,this._node.getWorldRotation(qS)),dn.normalize(this._dir,this._dir),Is.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(XS),Ln.invert(XS,XS),Ln.perspective(YS,this._angle,1,.001,this._range),Ln.multiply(KS,YS,XS),this._frustum.update(KS,QS),this._needUpdate=!1)},c(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(qg),JS=Object.freeze({__proto__:null,Ambient:AS,Octree:PS,get CameraFOVAxis(){return Rv},get CameraProjection(){return wv},get CameraAperture(){return Iv},get CameraISO(){return Dv},get CameraShutter(){return Ov},SKYBOX_FLAG:Gv,Camera:Vv,DirectionalLight:IS,ColorTemperatureToRGB:Ng,get LightType(){return Ig},nt2lm:Wg,Light:qg,get ModelType(){return bS},Model:FS,ShadowSize:jv,ShadowType:Wv,PCFType:qv,Shadows:Yv,RenderScene:zS,Skybox:VS,SphereLight:jS,SpotLight:ZS,SubModel:OS,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null}),$S=new Pl((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),eT=new Float32Array(4),tT=[],nT=[],iT=new Ln,rT=new Ln;function oT(e,t){return!(!t.worldBounds||Ka.aabbWithAABB(t.worldBounds,e.aabb))}function aT(e,t){return!(!t.worldBounds||Ka.aabbWithAABB(t.worldBounds,e.aabb)&&Ka.aabbFrustum(t.worldBounds,e.frustum))}var sT=ov("forward-add"),cT=[];function lT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===sT){o=a,n=!0;break}t.push(o)}return n}var uT,hT,_T,fT,dT,pT,mT,vT,gT,yT,xT,ST=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Ad.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new CS,this._batchedQueue=new ES;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Hd.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new tr(this._lightBuffer,0,Hd.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}$S.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(Ad.BINDING).destroy(),r.getTexture(bd).destroy(),r.getTexture(Ld).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(lT(a,cT)&&(nT.length=0,this._lightCulling(o,n),nT.length))for(var s=0;s<a.length;s++){var c=cT[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(Hd.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],_=a.inputAssembler,f=_v.getOrCreatePipelineState(e,u,h,t,_),d=u.descriptorSet,p=a.descriptorSet;n.bindPipelineState(f),n.bindDescriptorSet(yd.MATERIAL,d),n.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);tT[0]=c[m],n.bindDescriptorSet(yd.GLOBAL,g),n.bindDescriptorSet(yd.LOCAL,p,tT),n.draw(_)}}},t._lightCulling=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=!1;switch(i.type){case Ig.SPHERE:r=oT(i,e);break;case Ig.SPOT:r=aT(i,e)}r||nT.push(n)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===ev.INSTANCING)for(var o=0;o<nT.length;o++){var a=nT[o],s=e.getInstancedBuffer(a);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===ev.VB_MERGING)for(var c=0;c<nT.length;c++){var l=nT[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=$S.alloc();h.subModel=t,h.passIdx=i;for(var _=0;_<nT.length;_++){var f=nT[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=e.scene.mainLight,s=Ap(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,d=void 0;switch(h.type){case Ig.SPHERE:a&&(Cg(r,a,this._shadowUBO),Ag(r,this._shadowUBO)),this._shadowUBO[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Wn.toArray(this._shadowUBO,r.shadowColor,Ad.SHADOW_COLOR_OFFSET);break;case Ig.SPOT:if(a&&(Cg(r,a,this._shadowUBO),Ag(r,this._shadowUBO)),Ln.invert(iT,h.node.getWorldMatrix()),Ln.perspective(rT,h.angle,h.aspect,.001,h.range),f=rT.clone(),d=rT.clone().invert(),Ln.multiply(rT,rT,iT),Ln.toArray(this._shadowUBO,iT,Ad.MAT_LIGHT_VIEW_OFFSET),Ln.toArray(this._shadowUBO,rT,Ad.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Ad.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Ad.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Ad.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Ad.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Ad.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[Ad.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[Ad.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[Ad.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[Ad.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Ad.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Ad.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Ad.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Wn.toArray(this._shadowUBO,r.shadowColor,Ad.SHADOW_COLOR_OFFSET),o.has(h)){var p,m=null===(p=o.get(h))||void 0===p?void 0:p.colorTextures[0];m&&_.bindTexture(Ld,m)}}_.update(),t.updateBuffer(_.getBuffer(Ad.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=sn(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new tr(this._lightBuffer,0,Hd.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case Ig.SPHERE:if(dn.toArray(eT,l.position),eT[3]=0,this._lightBufferData.set(eT,c+Hd.LIGHT_POS_OFFSET),eT[0]=l.size,eT[1]=l.range,eT[2]=0,eT[3]=o.enabled&&o.type===Wv.ShadowMap?1:0,this._lightBufferData.set(eT,c+Hd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),dn.toArray(eT,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;eT[0]*=u.x,eT[1]*=u.y,eT[2]*=u.z}eT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(eT,c+Hd.LIGHT_COLOR_OFFSET);break;case Ig.SPOT:if(dn.toArray(eT,l.position),eT[3]=1,this._lightBufferData.set(eT,c+Hd.LIGHT_POS_OFFSET),eT[0]=l.size,eT[1]=l.range,eT[2]=l.spotAngle,eT[3]=o.enabled&&o.type===Wv.ShadowMap?1:0,this._lightBufferData.set(eT,c+Hd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),dn.toArray(eT,l.direction),this._lightBufferData.set(eT,c+Hd.LIGHT_DIR_OFFSET),dn.toArray(eT,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;eT[0]*=h.x,eT[1]*=h.y,eT[2]*=h.z}eT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(eT,c+Hd.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),TT=new Is,ET=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new CS,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===Wv.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,o=e.frustum,a=0!=(e.visibility&sd.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(Is.transform(TT,_.worldBounds,i.matLight),Ka.aabbFrustum(TT,o)))if(_.isInstancingEnabled)for(var f=_.subModels,d=0;d<f.length;d++){var p=f[d];u.merge(p,_.instancedAttributes,0,p.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Wv.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(yd.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=_v.getOrCreatePipelineState(e,r,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(yd.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},e}(),CT=function(){function e(){this._phaseID=ov("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,d=_v.getOrCreatePipelineState(i,h,_,t,f);r.bindPipelineState(d),r.bindDescriptorSet(yd.MATERIAL,h.descriptorSet);var p=s.descriptorSet;r.bindDescriptorSet(yd.LOCAL,p),r.bindInputAssembler(f),r.draw(f)}}}},e}(),AT=[new Qi(0,0,0,1)],bT=e("ForwardStage",(uT=$s("ForwardStage"),hT=Mc([mS]),_T=bc(),uT((vT=mT=function(e){function t(){var t;return y(t=e.call(this)||this,"renderQueues",pT,m(t)),t._renderQueues=[],t._renderArea=new Hi,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=ov("default"),t._clearFlag=4294967295,t._batchedQueue=new ES,t._instancedQueue=new CS,t._uiPhase=new CT,t}u(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=xS(this.renderQueues[i]);this._additiveLightQueue=new ST(this._pipeline),this._planarQueue=new ET(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(SS);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===ev.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===ev.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(TS);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&Bi.COLOR&&(AT[0].x=e.clearColor.x,AT[0].y=e.clearColor.y,AT[0].z=e.clearColor.z,AT[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,g=t.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,AT,e.clearDepth,e.clearStencil),m.bindDescriptorSet(yd.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(yd.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(e,g),Pv(n,g,m,t.profiler,e),m.endRenderPass()},t}(_y),mT.initInfo={name:"ForwardStage",priority:Ay.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:_S.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:_S.BACK_TO_FRONT,stages:["default","planarShadow"]}]},pT=x((dT=vT).prototype,"renderQueues",[hT,oc,_T],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fT=dT))||fT)),PT=e("ForwardFlow",$s("ForwardFlow")((xT=yT=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new bT;n.initialize(bT.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(dy),yT.initInfo={name:hd,priority:by.FORWARD,stages:[]},gT=xT))||gT),RT=new Ln,wT=new Ln,IT=new Ln,DT=new Is,OT=ov("shadow-caster"),MT=[];function NT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===OT){o=a,n=!0;break}t.push(o)}return n}var LT,BT,FT,zT,UT,kT,GT=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new CS,this._batchedQueue=new ES}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===Wv.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case Ig.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;NT(l.subModels,MT)&&this.add(l,MT)}break;case Ig.SPOT:Ln.invert(RT,n.node.getWorldMatrix()),Ln.perspective(wT,n.angle,n.aspect,.001,n.range),Ln.multiply(IT,wT,RT);for(var u=0;u<s.length;u++){var h=s[u].model;NT(h.subModels,MT)&&(h.worldBounds&&(Is.transform(DT,h.worldBounds,IT),!Ka.aabbFrustum(DT,t.frustum))||this.add(h,MT))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t){for(var n=e.subModels,i=0;i<n.length;i++){var r=n[i],o=t[i],a=r.passes[o];if(a.batchingScheme===ev.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,e.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===ev.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,e),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=_v.getOrCreatePipelineState(e,a,o,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(yd.MATERIAL,l),n.bindDescriptorSet(yd.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),HT=[new Qi(1,1,1,1)],VT=e("ShadowStage",$s("ShadowStage")((FT=BT=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new Hi,t._light=null,t._globalDS=null,t}u(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){HT[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,HT,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,e,this._light,a);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,HT,e.clearDepth,e.clearStencil),a.bindDescriptorSet(yd.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new GT(t)},t}(_y),BT.initInfo={name:"ShadowStage",priority:Ay.FORWARD,tag:0},LT=FT))||LT),jT=[],WT=e("ShadowFlow",$s("ShadowFlow")((kT=UT=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}u(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new VT;n.initialize(VT.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===Wv.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===Ig.SPOT&&(jT.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(e)}}for(var d=0;d<jT.length;d++){var p=jT[d],m=t.globalDSManager.getOrCreateDescriptorSet(d);i.has(p)||this._initShadowFrameBuffer(t,p,e.window.swapchain);for(var v=i.get(p),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,p,v),y.render(e)}}jT.length=0}else this.clearShadowMap(jT,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,o=Ap(n)?ti.R32F:ti.RGBA8;if(!this._shadowRenderPass){var a=new xr;a.format=o,a.loadOp=Si.CLEAR,a.storeOp=Ti.STORE,a.sampleCount=1;var s=new Sr;s.format=ti.DEPTH_STENCIL,s.depthLoadOp=Si.CLEAR,s.depthStoreOp=Ti.DISCARD,s.stencilLoadOp=Si.CLEAR,s.stencilStoreOp=Ti.DISCARD,s.sampleCount=1;var c=new Cr([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new or(ci.TEX2D,li.DEPTH_STENCIL_ATTACHMENT,ti.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new Pr(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var d=this._stages[f];d.setUsage(_,u,h),d.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=Ap(i)?ti.R32F:ti.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED,o,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new Pr(h,l,u)),s=a.next()}else s=a.next()}e.shadowMapDirty=!1},t}(dy),UT.initInfo={name:_d,priority:by.SHADOW,tag:cS.SCENE,stages:[]},zT=kT))||zT),qT=new Tn,XT=Ye({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),YT=XT.LAYERED+1,KT=function(){function e(){this._fogColor=new Wn("#C8C8C8"),this._colorArray=new Tn(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:YT},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=T.director.root,t=this.enabled?this.type:YT,n=this.accurate?1:0,i=e.pipeline;i.macros.CC_USE_FOG===t&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=t,i.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=YT,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),qT.set(e.x,e.y,e.z,e.w),pv(this._colorArray,qT)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();T.Fog=KT;var QT,ZT,JT,$T,eE,tE=10,nE=0,iE=new Map;function rE(e,t){for(var n,i=g(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?rE(e,r):e.push(r)}}function oE(e){var t=[];return rE(t,e),t.join("")}JT=function(e,t,n,i,r,o,a){var s=iE.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},QT=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=nE++;iE.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:tE});var r=null!=n.target?n.target:e,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return JT(t,n.name,a,o,M,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return JT(t,n.name,a,o,M,i,c),n.customGetter.call(this)},set:function(e){JT(t,n.name,a,o,M,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){JT(t,n.name,a,o,M,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return JT(t,n.name,a,o,M,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return JT(t,n.name,a,o,M,i,c),s?this[o]:r[o]},set:function(e){JT(t,n.name,a,o,M,i,c),s?this[o]=e:r[o]=e},enumerable:!1})}))})),eE=function(e,t,n,i,r){var o=iE.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,e+"."+t),o.count++)},ZT=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=nE++;iE.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:tE});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return eE(t,n.name,N,i,r)},set:function(){eE(t,n.name,N,i,r)},enumerable:!1})}))})),$T=function(e,t,n,i,r){var o=iE.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,e+"."+t),o.count++)},e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var o=nE++;iE.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:tE});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return $T(t,i,M,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return $T(t,i,M,o,a),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){$T(t,i,M,o,a),c=e}})}else!function(t,n,i,r,o,a){if(t.get){var s=t.get;t.get=function(){return $T(n,i,r,o,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){$T(n,i,r,o,a),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,M,o,a);Object.defineProperty(e,i,{enumerable:!1})}}))}));var aE=Jc.Flags.Destroyed,sE=Jc.Flags.PersistentMask,cE=Gt.IDENTIFIER_RE,lE="var ",uE="o",hE={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},_E=Gt.escapeForJS,fE=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return lE+this.varName+"="+this.expression+";"},e}();function dE(e,t){return t instanceof fE?new fE(t.varName,e+t.expression):e+t}function pE(e,t,n){Array.isArray(n)?(n[0]=dE(t,n[0]),e.push(n)):e.push(dE(t,n)+";")}var mE=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];pE(e,t+vE(i[0])+"=",i[1])}},e}();function vE(e){return cE.test(e)?"."+e:"["+_E(e)+"]"}mE.pool=void 0,mE.pool=new je((function(e){e._exps.length=0,e._targetExp=null}),1),mE.pool.get=function(e){var t=this._get()||new mE;return t._targetExp=e,t};var gE=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ve(),Re(this.funcModuleCache,hE),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=lE+this.globalVariables.join(",")+";");var i=oE(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=ge(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=mE.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),mE.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var i=n.__values__,r=gt(n),o=0;o<i.length;o++){var a=i[o],s=t[a],c=r[a+"$_$default"];if(!yE(c,s))if("object"==typeof s&&s instanceof T.ValueType&&(c=Gt.getDefault(c))&&c.constructor===s.constructor){var l=uE+vE(a);this.setValueType(e,c,s,l)}else this.setObjProp(e,t,a,s)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new fE(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)pE(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new fE(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&pE(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=dE(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?_E(n):("_objFlags"===t&&e instanceof Jc&&(n&=sE),n)},t.setObjProp=function(e,t,n,i){pE(e,uE+vE(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(T.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"==typeof r&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}},t.instantiateObj=function(e){if(e instanceof T.ValueType)return Gt.getNewValueTypeCode(e);if(e instanceof T.Asset)return this.getObjRef(e);if(e._objFlags&aE)return null;var t,n=e.constructor;if(T.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof T.Component){if(e instanceof T._BaseNode||e instanceof T.Component)return this.getObjRef(e)}else if(this.parent instanceof T._BaseNode)if(e instanceof T._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof T.Component){var i;if(!(null===(i=e.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(e)}t=new fE(uE,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new fE(uE,"{}");else{if(n)return this.getObjRef(e);t=new fE(uE,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]},e}();function yE(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof T.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return he(e)&&he(t)}return!1}var xE,SE,TE,EE,CE,AE,bE,PE,RE,wE,IE=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(){},c(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?V(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]),e}();Jc.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(xE||(xE={}));var DE=Jc.Flags.Destroying,OE=Jc.Flags.DontDestroy,ME=Jc.Flags.Deactivating,NE=new oe("Node");function LE(e){return e?"string"==typeof e?He(e):e:(W(3804),null)}var BE,FE,zE,UE,kE,GE,HE,VE,jE,WE,qE,XE=e("BaseNode",$s("cc.BaseNode")((wE=RE=function(e){u(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],o=n._findComponent(r,t);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,t)))return o}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var o=e[r];n._findComponents(o,t,i),o._children.length>0&&n._findChildComponents(o._children,t,i)}};var t=n.prototype;function n(t){var n;return y(n=e.call(this,t)||this,"_parent",EE,m(n)),y(n,"_children",CE,m(n)),y(n,"_active",AE,m(n)),y(n,"_components",bE,m(n)),y(n,"_prefab",PE,m(n)),n._scene=null,n._activeInHierarchy=!1,n._id=NE.getNewId(),n._name=void 0,n._eventProcessor=new T.NodeEventProcessor(m(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?N("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){Re(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(xE.PARENT_CHANGED,n),n&&!(n._objFlags&DE)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(xE.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(xE.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return O("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return O("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&ME)W(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&t&&t(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=LE(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=LE(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=LE(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=LE(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=He(e)))throw T._RF.peek()&&W(3808,e),TypeError(K(3807,e))}else{if(!e)throw TypeError(K(3804));t=e}if("function"!=typeof t)throw TypeError(K(3809));if(!De(t,T.Component))throw TypeError(K(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var a=new t;return a.node=this,this._components.push(a),this._activeInHierarchy&&T.director._nodeActivator.activateComp(a),a},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof Bu?e:this.getComponent(e))&&t.destroy()}else W(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case xE.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case xE.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(xE.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&DE)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&W(3815)}}else W(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(xE.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=T.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof T.Scene||T.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&T.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=DE;var e=this._parent,t=!!e&&0!=(e._objFlags&DE);if(this._persistNode&&T.game.removePersistRootNode(this),!t&&e){this.emit(xE.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(xE.CHILD_REMOVED,this)}this.emit(xE.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return t},c(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&OE)>0},set:function(e){e?this._objFlags|=OE:this._objFlags&=~OE}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&T.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(Jc),RE.idGenerator=NE,RE._stacks=[[]],RE._stackId=0,x((TE=wE).prototype,"_persistNode",[ic],Object.getOwnPropertyDescriptor(TE.prototype,"_persistNode"),TE.prototype),x(TE.prototype,"name",[mc],Object.getOwnPropertyDescriptor(TE.prototype,"name"),TE.prototype),x(TE.prototype,"children",[mc],Object.getOwnPropertyDescriptor(TE.prototype,"children"),TE.prototype),x(TE.prototype,"active",[mc],Object.getOwnPropertyDescriptor(TE.prototype,"active"),TE.prototype),x(TE.prototype,"activeInHierarchy",[mc],Object.getOwnPropertyDescriptor(TE.prototype,"activeInHierarchy"),TE.prototype),x(TE.prototype,"parent",[mc],Object.getOwnPropertyDescriptor(TE.prototype,"parent"),TE.prototype),EE=x(TE.prototype,"_parent",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CE=x(TE.prototype,"_children",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AE=x(TE.prototype,"_active",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bE=x(TE.prototype,"_components",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PE=x(TE.prototype,"_prefab",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SE=TE))||SE);T._BaseNode=XE;var YE=new dn,KE=new Pn,QE=new Pn,ZE=new Pn,JE=new Cn,$E=new Cn,eC=new Ln,tC=[],nC=[],iC=[],rC=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return iC[0]=this._chunks[e],iC[1]=this._freelists[e].pop(),iC},e}();rC.CAPACITY_PER_CHUNK=256;var oC,aC,sC,cC,lC,uC,hC,_C,fC,dC,pC,mC,vC,gC,yC,xC,SC,TC,EC,CC,AC,bC,PC,RC,wC,IC,DC,OC,MC,NC,LC,BC,FC,zC,UC,kC,GC,HC,VC,jC,WC,qC,XC,YC,KC,QC,ZC,JC,$C,eA,tA,nA,iA,rA,oA,aA,sA,cA,lA,uA,hA,_A,fA,dA,pA,mA,vA,gA,yA,xA=new rC,SA=Symbol("ReserveContentsForAllSyncablePrefab"),TA=e("Node",(BE=$s("cc.Node"),FE=Mc(dn),BE((qE=WE=function(e){u(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new IE(m(n)),n._static=!1,y(n,"_lpos",kE,m(n)),y(n,"_lrot",GE,m(n)),y(n,"_lscale",HE,m(n)),y(n,"_layer",VE,m(n)),y(n,"_euler",jE,m(n)),n._dirtyFlagsPri=wg.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=xA.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new dn,this._rot=new Pn,this._scale=new dn(1,1,1),this._mat=new Ln},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof T.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return xA.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[Xu]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),Ln.multiply(eC,Ln.invert(eC,i._mat),this._mat),Ln.toRTS(eC,this._lrot,this._lpos,this._lscale)):(dn.copy(this._lpos,this._pos),Pn.copy(this._lrot,this._rot),dn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(wg.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=wg.TRS,this._dirtyFlags|=wg.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(wg.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||Rg.LOCAL;if(n===Rg.LOCAL)dn.transformQuat(YE,e,this._lrot),this._lpos.x+=YE.x,this._lpos.y+=YE.y,this._lpos.z+=YE.z;else if(n===Rg.WORLD)if(this._parent){Pn.invert(KE,this._parent.worldRotation),dn.transformQuat(YE,e,KE);var i=this.worldScale;this._lpos.x+=YE.x/i.x,this._lpos.y+=YE.y/i.y,this._lpos.z+=YE.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(wg.POSITION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.POSITION)},t.rotate=function(e,t){var n=t||Rg.LOCAL;if(Pn.normalize(KE,e),n===Rg.LOCAL)Pn.multiply(this._lrot,this._lrot,KE);else if(n===Rg.WORLD){var i=this.worldRotation;Pn.multiply(QE,KE,i),Pn.invert(KE,i),Pn.multiply(QE,KE,QE),Pn.multiply(this._lrot,this._lrot,QE)}this._eulerDirty=!0,this.invalidateChildren(wg.ROTATION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(YE),dn.subtract(YE,YE,e),dn.normalize(YE,YE),Pn.fromViewUp(KE,YE,t),this.setWorldRotation(KE)},t._setDirtyNode=function(e,t){tC[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,o=0,a=0,s=0,c=0,l=e|wg.POSITION;for(tC[0]=this;r>=0;){if(c=(t=tC[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,a=(i=t._children).length,o=0;o<a;o++)n=i[o],tC[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=tC[--n])._dirtyFlags,t?(i&wg.POSITION&&(dn.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&wg.RS&&(Ln.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Ln.multiply(e._mat,t._mat,e._mat),i&wg.ROTATION&&Pn.multiply(e._rot,t._rot,e._lrot),Cn.fromQuat(JE,Pn.conjugate(ZE,e._rot)),Cn.multiplyMat4(JE,JE,e._mat),e._scale.x=JE.m00,e._scale.y=JE.m04,e._scale.z=JE.m08)):(i&wg.POSITION&&(dn.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&wg.RS&&(i&wg.ROTATION&&Pn.copy(e._rot,e._lrot),i&wg.SCALE&&(dn.copy(e._scale,e._lscale),Ln.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=wg.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?dn.copy(this._lpos,e):void 0===n?dn.set(this._lpos,e,t,this._lpos.z):dn.set(this._lpos,e,t,n),this.invalidateChildren(wg.POSITION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.POSITION)},t.getPosition=function(e){return e?dn.set(e,this._lpos.x,this._lpos.y,this._lpos.z):dn.copy(new dn,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Pn.copy(this._lrot,e):Pn.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(wg.ROTATION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(dn.copy(this._euler,e),Pn.fromEuler(this._lrot,e.x,e.y,e.z)):(dn.set(this._euler,e,t,i),Pn.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(wg.ROTATION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.ROTATION)},t.getRotation=function(e){return e?Pn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Pn.copy(new Pn,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?dn.copy(this._lscale,e):void 0===n?dn.set(this._lscale,e,t,this._lscale.z):dn.set(this._lscale,e,t,n),this.invalidateChildren(wg.SCALE),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.SCALE)},t.getScale=function(e){return e?dn.set(e,this._lscale.x,this._lscale.y,this._lscale.z):dn.copy(new dn,this._lscale)},t.inverseTransformPoint=function(e,t){dn.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)dn.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=tC[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?dn.copy(this._pos,e):dn.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),dn.transformMat4(r,this._pos,Ln.invert(eC,i._mat))):dn.copy(r,this._pos),this.invalidateChildren(wg.POSITION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?dn.copy(e,this._pos):dn.copy(new dn,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Pn.copy(this._rot,e):Pn.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),Pn.multiply(this._lrot,Pn.conjugate(this._lrot,this._parent._rot),this._rot)):Pn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(wg.ROTATION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){Pn.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),Pn.multiply(this._lrot,Pn.conjugate(this._lrot,this._parent._rot),this._rot)):Pn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(wg.ROTATION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?Pn.copy(e,this._rot):Pn.copy(new Pn,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?dn.copy(this._scale,e):dn.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Cn.fromQuat(JE,Pn.conjugate(ZE,i._rot)),Cn.multiplyMat4(JE,JE,i._mat),$E.m00=this._scale.x,$E.m04=this._scale.y,$E.m08=this._scale.z,Cn.multiply(JE,$E,Cn.invert(JE,JE)),this._lscale.x=dn.set(YE,JE.m00,JE.m01,JE.m02).length(),this._lscale.y=dn.set(YE,JE.m03,JE.m04,JE.m05).length(),this._lscale.z=dn.set(YE,JE.m06,JE.m07,JE.m08).length()):dn.copy(this._lscale,this._scale),this.invalidateChildren(wg.SCALE),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?dn.copy(e,this._scale):dn.copy(new dn,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new Ln;return Ln.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new Ln;return Ln.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new Ln;return Ln.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=wg.ROTATION,void 0!==e.w?(Pn.copy(this._lrot,e),this._eulerDirty=!0):(dn.copy(this._euler,e),Pn.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(dn.copy(this._lpos,t),i|=wg.POSITION),n&&(dn.copy(this._lscale,n),i|=wg.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){xA.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,tC.length=0,nC.length=0)},c(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Pn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){dn.set(this._euler,0,0,e),Pn.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(wg.ROTATION),1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Ln.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(wg.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(xE.TRANSFORM_CHANGED,wg.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return dn.transformQuat(new dn,dn.FORWARD,this.worldRotation)},set:function(e){var t=e.length();dn.multiplyScalar(YE,e,-1/t),Pn.fromViewUp(KE,YE),this.setWorldRotation(KE)}},{key:"up",get:function(){return dn.transformQuat(new dn,dn.UP,this.worldRotation)}},{key:"right",get:function(){return dn.transformQuat(new dn,dn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(xE.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(XE),WE.EventType=xE,WE.NodeSpace=Rg,WE.TransformDirtyBit=wg,WE.TransformBit=wg,WE.reserveContentsForAllSyncablePrefabTag=SA,WE.ClearFrame=0,WE.ClearRound=1e3,kE=x((UE=qE).prototype,"_lpos",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dn}}),GE=x(UE.prototype,"_lrot",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn}}),HE=x(UE.prototype,"_lscale",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dn(1,1,1)}}),VE=x(UE.prototype,"_layer",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sd.Enum.DEFAULT}}),jE=x(UE.prototype,"_euler",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dn}}),x(UE.prototype,"eulerAngles",[FE],Object.getOwnPropertyDescriptor(UE.prototype,"eulerAngles"),UE.prototype),x(UE.prototype,"angle",[mc],Object.getOwnPropertyDescriptor(UE.prototype,"angle"),UE.prototype),x(UE.prototype,"layer",[mc],Object.getOwnPropertyDescriptor(UE.prototype,"layer"),UE.prototype),zE=UE))||zE));T.Node=TA;var EA=$s("cc.TargetInfo")((sC=x((aC=function(){y(this,"localID",sC,this)}).prototype,"localID",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oC=aC))||oC,CA=(cC=$s("cc.TargetOverrideInfo"),lC=Mc(Jc),uC=Mc(EA),hC=Mc(TA),_C=Mc(EA),cC((pC=x((dC=function(){y(this,"source",pC,this),y(this,"sourceInfo",mC,this),y(this,"propertyPath",vC,this),y(this,"target",gC,this),y(this,"targetInfo",yC,this)}).prototype,"source",[oc,lC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mC=x(dC.prototype,"sourceInfo",[oc,uC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vC=x(dC.prototype,"propertyPath",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gC=x(dC.prototype,"target",[oc,hC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yC=x(dC.prototype,"targetInfo",[oc,_C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fC=dC))||fC),AA=$s("cc.CompPrefabInfo")((TC=x((SC=function(){y(this,"fileId",TC,this)}).prototype,"fileId",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xC=SC))||xC,bA=(EC=$s("CCPropertyOverrideInfo"),CC=Mc(EA),EC((IC=function(){function e(){y(this,"targetInfo",PC,this),y(this,"propertyPath",RC,this),y(this,"value",wC,this)}return e.prototype.isTarget=function(){},e}(),PC=x((bC=IC).prototype,"targetInfo",[oc,CC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RC=x(bC.prototype,"propertyPath",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wC=x(bC.prototype,"value",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),AC=bC))||AC),PA=(DC=$s("cc.MountedChildrenInfo"),OC=Mc(EA),MC=Mc([TA]),DC((zC=function(){function e(){y(this,"targetInfo",BC,this),y(this,"nodes",FC,this)}return e.prototype.isTarget=function(){},e}(),BC=x((LC=zC).prototype,"targetInfo",[oc,OC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FC=x(LC.prototype,"nodes",[oc,MC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NC=LC))||NC),RA=(UC=$s("cc.MountedComponentsInfo"),kC=Mc(EA),GC=Mc([Bu]),UC((qC=function(){function e(){y(this,"targetInfo",jC,this),y(this,"components",WC,this)}return e.prototype.isTarget=function(){},e}(),jC=x((VC=qC).prototype,"targetInfo",[oc,kC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WC=x(VC.prototype,"components",[oc,GC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HC=VC))||HC),wA=(XC=$s("cc.PrefabInstance"),YC=Mc(TA),KC=Mc([PA]),QC=Mc([RA]),ZC=Mc([bA]),JC=Mc([EA]),XC((sA=function(){function e(){y(this,"fileId",tA,this),y(this,"prefabRootNode",nA,this),y(this,"mountedChildren",iA,this),y(this,"mountedComponents",rA,this),y(this,"propertyOverrides",oA,this),y(this,"removedComponents",aA,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),tA=x((eA=sA).prototype,"fileId",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nA=x(eA.prototype,"prefabRootNode",[oc,YC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),iA=x(eA.prototype,"mountedChildren",[oc,KC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rA=x(eA.prototype,"mountedComponents",[oc,QC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oA=x(eA.prototype,"propertyOverrides",[oc,ZC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aA=x(eA.prototype,"removedComponents",[oc,JC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$C=eA))||$C),IA=(cA=$s("cc.PrefabInfo"),lA=Mc(TA),uA=Mc(wA),hA=Mc([CA]),cA((dA=x((fA=function(){y(this,"root",dA,this),y(this,"asset",pA,this),y(this,"fileId",mA,this),y(this,"instance",vA,this),y(this,"targetOverrides",gA,this),y(this,"nestedPrefabInstanceRoots",yA,this)}).prototype,"root",[oc,lA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pA=x(fA.prototype,"asset",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),mA=x(fA.prototype,"fileId",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vA=x(fA.prototype,"instance",[oc,uA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),gA=x(fA.prototype,"targetOverrides",[oc,hA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yA=x(fA.prototype,"nestedPrefabInstanceRoots",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_A=fA))||_A);function DA(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return W(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,r=e._id,o=e._prefab;e[Xc],T.game._isCloning=!0,t.asset._doInstantiate(e),T.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=r,e._prefab&&(e._prefab.instance=null==o?void 0:o.instance)}}function OA(e,t,n){var i;if(t&&e){var r=t,o=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&o&&(t[o.fileId]={},r=t[o.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)OA(e.children[u],r,!1)}}function MA(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function NA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=MA(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,OA(u,a,!1),u._siblingIndex=o._children.length-1,UA(u,!0))}}}}function LA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=MA(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function BA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=MA(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function FA(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var o=t[r];if(o&&o.targetInfo){if(!(i=MA(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof Je?a[c].set(o.value):a[c]=o.value}}}}function zA(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=MA(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var d=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(d&&d.targetMap&&(_=MA(f.localID,d.targetMap))){var p=a.propertyPath.slice(),m=s;if(p.length>0){var v=p.pop();if(!v)return;for(var g=0;g<p.length&&(m=m[p[g]]);g++);if(!m)continue;m[v]=_}}}}}}function UA(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){DA(e);var r={};i.targetMap=r,OA(e,r,!0),NA(0,i.mountedChildren,r),BA(0,i.removedComponents,r),LA(0,i.mountedComponents,r),FA(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){UA(e,!0)}))}function kA(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){UA(e)}))}T._PrefabInfo=IA;var GA,HA,VA,jA,WA,qA,XA,YA,KA,QA,ZA,JA,$A,eb,tb=Object.freeze({__proto__:null,TargetInfo:EA,TargetOverrideInfo:CA,CompPrefabInfo:AA,PropertyOverrideInfo:bA,MountedChildrenInfo:PA,MountedComponentsInfo:RA,PrefabInstance:wA,PrefabInfo:IA,createNodeWithPrefab:DA,generateTargetMap:OA,getTarget:MA,applyMountedChildren:NA,applyMountedComponents:LA,applyRemovedComponents:BA,applyPropertyOverrides:FA,applyTargetOverrides:zA,expandPrefabInstanceNode:UA,expandNestedPrefabInstanceNode:kA}),nb=Ye({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),ib=e("Prefab",$s("cc.Prefab")((XA=qA=function(e){function t(){var t;return y(t=e.call(this)||this,"data",VA,m(t)),y(t,"optimizationPolicy",jA,m(t)),y(t,"persistent",WA,m(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}u(t,e);var n=t.prototype;return n.createNode=function(e){var t=T.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof T._BaseNode&&e,new gE(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||V(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==nb.SINGLE_INSTANCE&&(this.optimizationPolicy===nb.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new TA,this.data.name="(Missing Node)";var n=new T._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;kA(e),zA(e)},t}(pu),qA.OptimizationPolicy=nb,qA.OptimizationPolicyThreshold=3,VA=x((HA=XA).prototype,"data",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jA=x(HA.prototype,"optimizationPolicy",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nb.AUTO}}),WA=x(HA.prototype,"persistent",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GA=HA))||GA);qe.value(ib,"_utils",tb),T.Prefab=ib,ye(T,"cc._Prefab","Prefab"),e("PrefabLink",(YA=$s("cc.PrefabLink"),KA=Mc(ib),QA=vc(),YA((eb=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"prefab",$A,m(t)),t}return u(t,e),t}(Bu),$A=x((JA=eb).prototype,"prefab",[KA,oc,QA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZA=JA))||ZA));var rb=new dn;function ob(e,t,n,i){i||(i=new dn),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function ab(e,t,n){return n||(n=new dn),e.worldToScreen(t,n),n.x/=T.view.getScaleX(),n.y/=T.view.getScaleY(),n}var sb,cb,lb=e("convertUtils",{WorldNode3DToLocalNodeUI:ob,WorldNode3DToWorldNodeUI:ab});T.pipelineUtils=lb,QT(T.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||rb;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),ZT(Cm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),QT(hS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var ub,hb=e("BufferAsset",$s("cc.BufferAsset")((x((cb=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}u(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},c(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(pu)).prototype,"_nativeAsset",[Vc],Object.getOwnPropertyDescriptor(cb.prototype,"_nativeAsset"),cb.prototype),sb=cb))||sb);T.BufferAsset=hb;var _b=((ub={})[ni.UNORM]="Uint",ub[ni.SNORM]="Int",ub[ni.UINT]="Uint",ub[ni.INT]="Int",ub[ni.UFLOAT]="Float",ub[ni.FLOAT]="Float",ub.default="Uint",ub);function fb(e){return""+(_b[e.type]||_b.default)+e.size/e.count*8}function db(e,t,n,i,r){void 0===n&&(n=ti.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=Gr[n];r||(r=o.size);for(var a="set"+fb(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=qu.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<o.count;++_){var f=h+s*_;e[a](f,t[o.count*u+_],l)}}function pb(e,t,n,i,r,o){void 0===t&&(t=ti.R32F),void 0===n&&(n=0),void 0===i&&(i=e.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=Gr[t];r||(r=a.size);for(var s="get"+fb(a),c=a.size/a.count,l=Math.floor(i/r),u=qu.isLittleEndian,h=0;h<l;++h)for(var _=n+r*h,f=0;f<a.count;++f){var d=_+c*f;o[a.count*h+f]=e[s](d,u)}return o}function mb(e,t,n,i,r,o,a){void 0===n&&(n=ti.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=Gr[n];o||(o=s.size);for(var c="set"+fb(s),l="get"+fb(s),u=s.size/s.count,h=Math.floor(r/o),_=qu.isLittleEndian,f=0;f<h;++f)for(var d=i+o*f,p=0;p<s.count;++p){var m=d+u*p,v=e[l](m,_);a[c](m,t(v,p,e),_)}return a}var vb,gb,yb=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new yr(t,e,i,r),this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=e.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*s,d=h[_]*s,p=0;p<s;++p)u[f+p]=l[d+p];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new vr("a_vertexId",ti.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},c(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:dn.ZERO,max:dn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:dn.ZERO,max:dn.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,zi.ATTR_POSITION),i=e.readIndices(t),r=new dn,o=new dn,a=this.attributes.find((function(e){return e.name===zi.ATTR_POSITION}));if(a){var s=Gr[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=T.director.root.device,c=0;c<a.vertexBundelIndices.length;c++){var l=o.vertexBundles[a.vertexBundelIndices[c]];r=0,i=ti.UNKNOWN;for(var u=0;u<l.attributes.length;u++){var h=l.attributes[u];if(h.name===zi.ATTR_JOINTS){i=h.format;break}r+=Gr[h.format].size}i?function(){var u=new Uint8Array(e.mesh.data.buffer,l.view.offset,l.view.length),h=new DataView(u.slice().buffer),_=o.jointMaps[a.jointMapIndex];mb(h,(function(e){return _.indexOf(e)}),i,r,l.view.length,l.view.stride,h);var f=s.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE,l.view.length,l.view.stride));f.update(h.buffer),t.push(f),n.push(c)}():t.push(this.vertexBuffers[a.vertexBundelIndices[c]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(vb||(vb=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(gb||(gb={})),T.SystemEventType=vb;var xb,Sb=new Array(16),Tb=null,Eb=new gn,Cb=[xE.TOUCH_START,xE.TOUCH_MOVE,xE.TOUCH_END,xE.TOUCH_CANCEL],Ab=[xE.MOUSE_DOWN,xE.MOUSE_ENTER,xE.MOUSE_MOVE,xE.MOUSE_LEAVE,xE.MOUSE_UP,xE.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(xb||(xb={}));var bb,Pb,Rb,wb,Ib,Db,Ob,Mb,Nb,Lb,Bb,Fb,zb,Ub,kb,Gb,Hb,Vb,jb,Wb,qb,Xb,Yb,Kb,Qb,Zb,Jb,$b,eP,tP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,dP,pP,mP,vP,gP,yP,xP,SP,TP,EP,CP,AP,bP,PP,RP,wP,IP,DP,OP,MP,NP,LP,BP,FP,zP,UP,kP,GP,HP,VP,jP,WP,qP,XP,YP,KP,QP,ZP,JP,$P,eR,tR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,_R,fR,dR,pR,mR,vR,gR,yR,xR,SR,TR,ER,CR,AR,bR,PR,RR,wR,IR,DR,OR,MR,NR,LR,BR,FR,zR,UR,kR,GR,HR,VR,jR,WR,qR,XR,YR,KR,QR,ZR,JR,$R,ew,tw,nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,_w,fw,dw,pw,mw,vw,gw,yw,xw,Sw,Tw,Ew,Cw,Aw,bw,Pw,Rw,ww,Iw,Dw,Ow,Mw,Nw,Lw,Bw,Fw,zw,Uw,kw,Gw,Hw,Vw,jw,Ww,qw,Xw,Yw,Kw,Qw,Zw,Jw,$w,eI,tI,nI,iI,rI,oI=function(){var e=t.prototype;function t(e){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=e}return e.setEnabled=function(e,n){if(void 0===n&&(n=!1),this._isEnabled!==e){this._isEnabled=e;var i=this.node.children;if(e&&this._attachMask(),t.callbacksInvoker.emit(xb.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(e,!0)}},e._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&TA.isNode(r);r=r.parent,++n){var o=r.getComponent(e);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},e._attachMask=function(){this.maskList=this._searchComponentsInParent(t._maskComp)},e.reattach=function(){var e,n=this;this.node.walk((function(i){e||(e=n._searchComponentsInParent(t._maskComp)),i.eventProcessor.maskList=e}))},e.destroy=function(){Tb===this._node&&(Tb=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),t.callbacksInvoker.emit(xb.REMOVE_POINTER_EVENT_PROCESSOR,this)},e._isTouchEvent=function(e){return-1!==Cb.indexOf(e)},e._isMouseEvent=function(e){return-1!==Ab.indexOf(e)},e._hasTouchListeners=function(){for(var e=0;e<Cb.length;++e){var t=Cb[e];if(this.hasEventListener(t))return!0}return!1},e._hasMouseListeners=function(){for(var e=0;e<Ab.length;++e){var t=Ab[e];if(this.hasEventListener(t))return!0}return!1},e._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},e._tryEmittingAddEvent=function(e){var n=this._isTouchEvent(e),i=this._isMouseEvent(e);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||t.callbacksInvoker.emit(xb.ADD_POINTER_EVENT_PROCESSOR,this)},e._newCallbacksInvoker=function(){var e=this,n=new Bl;return n._registerOffCallback((function(){e.shouldHandleEventTouch&&!e._hasTouchListeners()&&(e.shouldHandleEventTouch=!1),e.shouldHandleEventMouse&&!e._hasMouseListeners()&&(e.shouldHandleEventMouse=!1),e._hasPointerListeners()||t.callbacksInvoker.emit(xb.REMOVE_POINTER_EVENT_PROCESSOR,e)})),n},e.on=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},e.once=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},e.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},e.targetOff=function(e){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(e),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(e),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||t.callbacksInvoker.emit(xb.REMOVE_POINTER_EVENT_PROCESSOR,this)},e.emit=function(e,t,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,n,i,r,o)},e.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,Sb.length=0,this.getCapturingTargets(e.type,Sb),e.eventPhase=1,i=Sb.length-1;i>=0;--i)if((t=Sb[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,Sb),e.propagationStopped))return void(Sb.length=0);if(Sb.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,Sb),e.eventPhase=3,i=0;i<Sb.length;++i)if((t=Sb[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(Sb.length=0);Sb.length=0},e.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},e.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e._handleEventMouse=function(e){switch(e.type){case gb.MOUSE_DOWN:return this._handleMouseDown(e);case gb.MOUSE_MOVE:return this._handleMouseMove(e);case gb.MOUSE_UP:return this._handleMouseUp(e);case gb.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},e._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(Eb=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(Eb)||(e.type=xE.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(Eb=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Eb)?(this.previousMouseIn||(Tb&&Tb!==t&&(e.type=xE.MOUSE_LEAVE,Tb.dispatchEvent(e),Tb.eventProcessor.previousMouseIn=!1),Tb=t,e.type=xE.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=xE.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=xE.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,Tb=null),1)))},e._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(Eb=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(Eb)||(e.type=xE.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(Eb=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(Eb)||(e.type=xE.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleEventTouch=function(e){switch(e.type){case gb.TOUCH_START:return this._handleTouchStart(e);case gb.TOUCH_MOVE:return this._handleTouchMove(e);case gb.TOUCH_END:return this._handleTouchEnd(e);case gb.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},e._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getUILocation(Eb),!t._uiProps.uiTransformComp.isHit(Eb)||(e.type=xE.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},e._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=xE.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},e._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getUILocation(Eb),t._uiProps.uiTransformComp.isHit(Eb)?e.type=xE.TOUCH_END:e.type=xE.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},e._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=xE.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},c(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),t}();oI._maskComp=null,oI.callbacksInvoker=new Bl,T.NodeEventProcessor=oI;var aI=new dn(0,1,0),sI=new dn,cI=new Tn,lI=new Wn,uI=new Pn,hI=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},_I=(bb=$s("cc.AmbientInfo"),Pb=pc(),Rb=ac("_skyColor"),wb=ac("_skyIllum"),Ib=ac("_groundAlbedo"),Db=vc(),Ob=xc(),Mb=Mc(Tt),Nb=xc(),Lb=vc(),Bb=xc(),bb(Fb=Pb((Wb=function(){function e(){y(this,"_skyColorHDR",Ub,this),y(this,"_skyIllumHDR",kb,this),y(this,"_groundAlbedoHDR",Gb,this),y(this,"_skyColorLDR",Hb,this),y(this,"_skyIllumLDR",Vb,this),y(this,"_groundAlbedoLDR",jb,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},c(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=T.director.root.pipeline.pipelineSceneData.isHDR;return cI.set(e?this._skyColorHDR:this._skyColorLDR),hI(cI),lI.set(255*cI.x,255*cI.y,255*cI.z,255)},set:function(e){cI.set(e.x,e.y,e.z,e.w),T.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(cI):this._skyColorLDR.set(cI),this._resource&&this._resource.skyColor.set(cI)}},{key:"skyColor",set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=T.director.root.pipeline.pipelineSceneData.isHDR;return cI.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),hI(cI),lI.set(255*cI.x,255*cI.y,255*cI.z,255)},set:function(e){cI.set(e.x,e.y,e.z,e.w),T.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(cI):this._groundAlbedoLDR.set(cI),this._resource&&this._resource.groundAlbedo.set(cI)}},{key:"groundAlbedo",set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}(),Ub=x((zb=Wb).prototype,"_skyColorHDR",[oc,Rb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(.2,.5,.8,1)}}),kb=x(zb.prototype,"_skyIllumHDR",[oc,wb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AS.SKY_ILLUM}}),Gb=x(zb.prototype,"_groundAlbedoHDR",[oc,Ib],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(.2,.2,.2,1)}}),Hb=x(zb.prototype,"_skyColorLDR",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(.2,.5,.8,1)}}),Vb=x(zb.prototype,"_skyIllumLDR",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AS.SKY_ILLUM}}),jb=x(zb.prototype,"_groundAlbedoLDR",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(.2,.2,.2,1)}}),x(zb.prototype,"skyLightingColor",[Db,mc,Ob],Object.getOwnPropertyDescriptor(zb.prototype,"skyLightingColor"),zb.prototype),x(zb.prototype,"skyIllum",[mc,Mb,Nb],Object.getOwnPropertyDescriptor(zb.prototype,"skyIllum"),zb.prototype),x(zb.prototype,"groundLightingColor",[Lb,mc,Bb],Object.getOwnPropertyDescriptor(zb.prototype,"groundLightingColor"),zb.prototype),Fb=zb))||Fb)||Fb);T.AmbientInfo=_I;var fI=(qb=$s("cc.SkyboxInfo"),Xb=pc(),Yb=Mc(Qm),Kb=ac("_envmap"),Qb=Mc(Qm),Zb=Mc(Qm),Jb=Mc(Qm),$b=vc(),eP=xc(),tP=bc(),nP=xc(),iP=xc(),rP=xc(),oP=Mc(Qm),aP=xc(),sP=vc(),cP=Mc(Qm),lP=bc(),qb(uP=Xb((xP=function(){function e(){y(this,"_applyDiffuseMap",_P,this),y(this,"_envmapHDR",fP,this),y(this,"_envmapLDR",dP,this),y(this,"_diffuseMapHDR",pP,this),y(this,"_diffuseMapLDR",mP,this),y(this,"_enabled",vP,this),y(this,"_useIBL",gP,this),y(this,"_useHDR",yP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},c(e,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(e){this._applyDiffuseMap=e,this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=e:this._envmapLDR=e,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}(),_P=x((hP=xP).prototype,"_applyDiffuseMap",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fP=x(hP.prototype,"_envmapHDR",[oc,Yb,Kb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dP=x(hP.prototype,"_envmapLDR",[oc,Qb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pP=x(hP.prototype,"_diffuseMapHDR",[oc,Zb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mP=x(hP.prototype,"_diffuseMapLDR",[oc,Jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vP=x(hP.prototype,"_enabled",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gP=x(hP.prototype,"_useIBL",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yP=x(hP.prototype,"_useHDR",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x(hP.prototype,"applyDiffuseMap",[$b,mc,eP,tP],Object.getOwnPropertyDescriptor(hP.prototype,"applyDiffuseMap"),hP.prototype),x(hP.prototype,"enabled",[mc,nP],Object.getOwnPropertyDescriptor(hP.prototype,"enabled"),hP.prototype),x(hP.prototype,"useIBL",[mc,iP],Object.getOwnPropertyDescriptor(hP.prototype,"useIBL"),hP.prototype),x(hP.prototype,"useHDR",[mc,rP],Object.getOwnPropertyDescriptor(hP.prototype,"useHDR"),hP.prototype),x(hP.prototype,"envmap",[mc,oP,aP],Object.getOwnPropertyDescriptor(hP.prototype,"envmap"),hP.prototype),x(hP.prototype,"diffuseMap",[sP,mc,gc,cP,lP],Object.getOwnPropertyDescriptor(hP.prototype,"diffuseMap"),hP.prototype),uP=hP))||uP)||uP);T.SkyboxInfo=fI;var dI=(SP=$s("cc.FogInfo"),TP=pc(),EP=xc(),CP=bc(),AP=xc(),bP=bc(),PP=xc(),RP=Mc(XT),wP=bc(),IP=xc(),DP=vc(),OP=Mc(Tt),MP=Sc(),NP=Cc(),LP=xc(),BP=vc(),FP=Mc(Tt),zP=Cc(),UP=xc(),kP=vc(),GP=Mc(Tt),HP=Cc(),VP=xc(),jP=vc(),WP=Mc(Tt),qP=Tc(),XP=Cc(),YP=xc(),KP=vc(),QP=Mc(Tt),ZP=Cc(),JP=xc(),$P=vc(),eR=Mc(Tt),tR=Cc(),nR=xc(),SP(iR=TP((mR=pR=function(){function e(){y(this,"_type",oR,this),y(this,"_fogColor",aR,this),y(this,"_enabled",sR,this),y(this,"_fogDensity",cR,this),y(this,"_fogStart",lR,this),y(this,"_fogEnd",uR,this),y(this,"_fogAtten",hR,this),y(this,"_fogTop",_R,this),y(this,"_fogRange",fR,this),y(this,"_accurate",dR,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),pR.FogType=XT,oR=x((rR=mR).prototype,"_type",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XT.LINEAR}}),aR=x(rR.prototype,"_fogColor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn("#C8C8C8")}}),sR=x(rR.prototype,"_enabled",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cR=x(rR.prototype,"_fogDensity",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),lR=x(rR.prototype,"_fogStart",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),uR=x(rR.prototype,"_fogEnd",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),hR=x(rR.prototype,"_fogAtten",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),_R=x(rR.prototype,"_fogTop",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),fR=x(rR.prototype,"_fogRange",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),dR=x(rR.prototype,"_accurate",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x(rR.prototype,"enabled",[mc,EP,CP],Object.getOwnPropertyDescriptor(rR.prototype,"enabled"),rR.prototype),x(rR.prototype,"accurate",[mc,AP,bP],Object.getOwnPropertyDescriptor(rR.prototype,"accurate"),rR.prototype),x(rR.prototype,"fogColor",[mc,PP],Object.getOwnPropertyDescriptor(rR.prototype,"fogColor"),rR.prototype),x(rR.prototype,"type",[mc,RP,wP,IP],Object.getOwnPropertyDescriptor(rR.prototype,"type"),rR.prototype),x(rR.prototype,"fogDensity",[DP,OP,MP,NP,Ac,LP],Object.getOwnPropertyDescriptor(rR.prototype,"fogDensity"),rR.prototype),x(rR.prototype,"fogStart",[BP,FP,zP,UP],Object.getOwnPropertyDescriptor(rR.prototype,"fogStart"),rR.prototype),x(rR.prototype,"fogEnd",[kP,GP,HP,VP],Object.getOwnPropertyDescriptor(rR.prototype,"fogEnd"),rR.prototype),x(rR.prototype,"fogAtten",[jP,WP,qP,XP,YP],Object.getOwnPropertyDescriptor(rR.prototype,"fogAtten"),rR.prototype),x(rR.prototype,"fogTop",[KP,QP,ZP,JP],Object.getOwnPropertyDescriptor(rR.prototype,"fogTop"),rR.prototype),x(rR.prototype,"fogRange",[$P,eR,tR,nR],Object.getOwnPropertyDescriptor(rR.prototype,"fogRange"),rR.prototype),iR=rR))||iR)||iR),pI=(vR=$s("cc.ShadowsInfo"),gR=pc(),yR=xc(),xR=Mc(Wv),SR=vc(),TR=vc(),ER=xc(),CR=Mc(Tt),AR=xc(),bR=vc(),PR=Sc(),RR=Mc(Tt),wR=xc(),IR=vc(),DR=Mc(qv),OR=xc(),MR=vc(),NR=Mc(St),LR=vc(),BR=Mc(Tt),FR=xc(),zR=vc(),UR=Mc(Tt),kR=xc(),GR=vc(),HR=Mc(jv),VR=xc(),jR=vc(),WR=Mc(Et),qR=xc(),XR=vc(),YR=Mc(Tt),KR=xc(),QR=vc(),ZR=Mc(Tt),JR=xc(),$R=vc(),ew=Sc(),tw=Mc(Tt),nw=xc(),iw=vc(),rw=Sc(),ow=Mc(Tt),aw=xc(),sw=vc(),cw=Mc(Tt),lw=xc(),uw=vc(),vR(hw=gR((Dw=function(){function e(){y(this,"_type",fw,this),y(this,"_enabled",dw,this),y(this,"_normal",pw,this),y(this,"_distance",mw,this),y(this,"_shadowColor",vw,this),y(this,"_firstSetCSM",gw,this),y(this,"_fixedArea",yw,this),y(this,"_pcf",xw,this),y(this,"_bias",Sw,this),y(this,"_normalBias",Tw,this),y(this,"_near",Ew,this),y(this,"_far",Cw,this),y(this,"_shadowDistance",Aw,this),y(this,"_invisibleOcclusionRange",bw,this),y(this,"_orthoSize",Pw,this),y(this,"_maxReceived",Rw,this),y(this,"_size",ww,this),y(this,"_saturation",Iw,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(uI),this.normal=dn.transformQuat(sI,aI,uI),e.getWorldPosition(sI),this.distance=dn.dot(this._normal,sI)},t.activate=function(e){this.pcf=Math.min(this._pcf,qv.SOFT_2X),this._resource=e,this._resource.initialize(this),this._resource.activate()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){dn.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"saturation",get:function(){return this._saturation},set:function(e){e>1?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=Math.min(e,Yv.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=Math.min(e,Yv.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,Yv.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}}]),e}(),fw=x((_w=Dw).prototype,"_type",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wv.Planar}}),dw=x(_w.prototype,"_enabled",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pw=x(_w.prototype,"_normal",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dn(0,1,0)}}),mw=x(_w.prototype,"_distance",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vw=x(_w.prototype,"_shadowColor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(0,0,0,76)}}),gw=x(_w.prototype,"_firstSetCSM",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yw=x(_w.prototype,"_fixedArea",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xw=x(_w.prototype,"_pcf",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qv.HARD}}),Sw=x(_w.prototype,"_bias",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),Tw=x(_w.prototype,"_normalBias",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ew=x(_w.prototype,"_near",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Cw=x(_w.prototype,"_far",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Aw=x(_w.prototype,"_shadowDistance",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),bw=x(_w.prototype,"_invisibleOcclusionRange",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),Pw=x(_w.prototype,"_orthoSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Rw=x(_w.prototype,"_maxReceived",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),ww=x(_w.prototype,"_size",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gn(512,512)}}),Iw=x(_w.prototype,"_saturation",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),x(_w.prototype,"enabled",[mc,yR],Object.getOwnPropertyDescriptor(_w.prototype,"enabled"),_w.prototype),x(_w.prototype,"type",[mc,xR],Object.getOwnPropertyDescriptor(_w.prototype,"type"),_w.prototype),x(_w.prototype,"shadowColor",[SR],Object.getOwnPropertyDescriptor(_w.prototype,"shadowColor"),_w.prototype),x(_w.prototype,"normal",[TR,ER],Object.getOwnPropertyDescriptor(_w.prototype,"normal"),_w.prototype),x(_w.prototype,"distance",[CR,AR,bR],Object.getOwnPropertyDescriptor(_w.prototype,"distance"),_w.prototype),x(_w.prototype,"saturation",[mc,PR,Ac,RR,wR,IR],Object.getOwnPropertyDescriptor(_w.prototype,"saturation"),_w.prototype),x(_w.prototype,"pcf",[DR,OR,MR],Object.getOwnPropertyDescriptor(_w.prototype,"pcf"),_w.prototype),x(_w.prototype,"maxReceived",[NR,LR],Object.getOwnPropertyDescriptor(_w.prototype,"maxReceived"),_w.prototype),x(_w.prototype,"bias",[BR,FR,zR],Object.getOwnPropertyDescriptor(_w.prototype,"bias"),_w.prototype),x(_w.prototype,"normalBias",[UR,kR,GR],Object.getOwnPropertyDescriptor(_w.prototype,"normalBias"),_w.prototype),x(_w.prototype,"shadowMapSize",[HR,VR,jR],Object.getOwnPropertyDescriptor(_w.prototype,"shadowMapSize"),_w.prototype),x(_w.prototype,"fixedArea",[WR,qR,XR],Object.getOwnPropertyDescriptor(_w.prototype,"fixedArea"),_w.prototype),x(_w.prototype,"near",[YR,KR,QR],Object.getOwnPropertyDescriptor(_w.prototype,"near"),_w.prototype),x(_w.prototype,"far",[ZR,JR,$R],Object.getOwnPropertyDescriptor(_w.prototype,"far"),_w.prototype),x(_w.prototype,"invisibleOcclusionRange",[mc,ew,Ac,tw,nw,iw],Object.getOwnPropertyDescriptor(_w.prototype,"invisibleOcclusionRange"),_w.prototype),x(_w.prototype,"shadowDistance",[mc,rw,Ac,ow,aw,sw],Object.getOwnPropertyDescriptor(_w.prototype,"shadowDistance"),_w.prototype),x(_w.prototype,"orthoSize",[cw,lw,uw],Object.getOwnPropertyDescriptor(_w.prototype,"orthoSize"),_w.prototype),hw=_w))||hw)||hw);T.ShadowsInfo=pI;var mI,vI,gI,yI,xI=new dn(-1024,-1024,-1024),SI=new dn(1024,1024,1024),TI=(Ow=$s("cc.OctreeInfo"),Mw=pc(),Nw=xc(),Lw=xc(),Bw=yc(),Fw=xc(),zw=yc(),Uw=Sc(),kw=Mc(St),Gw=xc(),Ow(Hw=Mw((Yw=function(){function e(){y(this,"_enabled",jw,this),y(this,"_minPos",Ww,this),y(this,"_maxPos",qw,this),y(this,"_depth",Xw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}(),jw=x((Vw=Yw).prototype,"_enabled",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ww=x(Vw.prototype,"_minPos",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dn(xI)}}),qw=x(Vw.prototype,"_maxPos",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dn(SI)}}),Xw=x(Vw.prototype,"_depth",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),x(Vw.prototype,"enabled",[mc,Nw],Object.getOwnPropertyDescriptor(Vw.prototype,"enabled"),Vw.prototype),x(Vw.prototype,"minPos",[mc,Lw,Bw],Object.getOwnPropertyDescriptor(Vw.prototype,"minPos"),Vw.prototype),x(Vw.prototype,"maxPos",[mc,Fw,zw],Object.getOwnPropertyDescriptor(Vw.prototype,"maxPos"),Vw.prototype),x(Vw.prototype,"depth",[mc,Uw,kw,Gw],Object.getOwnPropertyDescriptor(Vw.prototype,"depth"),Vw.prototype),Hw=Vw))||Hw)||Hw),EI=(Kw=$s("cc.SceneGlobals"),Qw=Mc(fI),Kw((rI=function(){function e(){y(this,"ambient",$w,this),y(this,"shadows",eI,this),y(this,"_skybox",tI,this),y(this,"fog",nI,this),y(this,"octree",iI,this)}return e.prototype.activate=function(){var e=T.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},c(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),$w=x((Jw=rI).prototype,"ambient",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _I}}),eI=x(Jw.prototype,"shadows",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new pI}}),tI=x(Jw.prototype,"_skybox",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fI}}),nI=x(Jw.prototype,"fog",[mc,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dI}}),x(Jw.prototype,"skybox",[mc,Qw],Object.getOwnPropertyDescriptor(Jw.prototype,"skybox"),Jw.prototype),iI=x(Jw.prototype,"octree",[mc,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new TI}}),Zw=Jw))||Zw);T.SceneGlobals=EI;var CI=e("Scene",$s("cc.Scene")((x((vI=function(e){u(n,e);var t=n.prototype;function n(t){var n;return y(n=e.call(this,t)||this,"autoReleaseAssets",gI,m(n)),y(n,"_globals",yI,m(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=dn.ZERO,n._rot=Pn.IDENTITY,n._scale=dn.ONE,n._mat=Ln.IDENTITY,n._dirtyFlags=0,n._lpos=dn.ZERO,n._lrot=Pn.IDENTITY,n._lscale=dn.ONE,n._activeInHierarchy=!1,T.director&&T.director.root&&(n._renderScene=T.director.root.createScene({})),n._inited=!T.game||!T.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=Jc.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&T.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(K(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return dn.copy(e||new dn,dn.ZERO)},t.getRotation=function(e){return Pn.copy(e||new Pn,Pn.IDENTITY)},t.getScale=function(e){return dn.copy(e||new dn,dn.ONE)},t.getWorldPosition=function(e){return dn.copy(e||new dn,dn.ZERO)},t.getWorldRotation=function(e){return Pn.copy(e||new Pn,Pn.IDENTITY)},t.getWorldScale=function(e){return dn.copy(e||new dn,dn.ONE)},t.getWorldMatrix=function(e){return Ln.copy(e||new Ln,Ln.IDENTITY)},t.getWorldRS=function(e){return Ln.copy(e||new Ln,Ln.IDENTITY)},t.getWorldRT=function(e){return Ln.copy(e||new Ln,Ln.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(kA(this),zA(this),this._onBatchCreated(false),this._inited=!0),this.walk(XE._setScene)},t._activate=function(e){e=!1!==e,T.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},c(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return dn.ZERO}},{key:"worldPosition",get:function(){return dn.ZERO}},{key:"rotation",get:function(){return Pn.IDENTITY}},{key:"worldRotation",get:function(){return Pn.IDENTITY}},{key:"scale",get:function(){return dn.ONE}},{key:"worldScale",get:function(){return dn.ONE}},{key:"eulerAngles",get:function(){return dn.ZERO}},{key:"worldMatrix",get:function(){return Ln.IDENTITY}}]),n}(XE)).prototype,"globals",[mc],Object.getOwnPropertyDescriptor(vI.prototype,"globals"),vI.prototype),gI=x(vI.prototype,"autoReleaseAssets",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yI=x(vI.prototype,"_globals",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EI}}),mI=vI))||mI);function AI(e,t){if(!t){var n=T.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}T.Scene=CI,T.find=AI;var bI=We.fastRemoveAt,PI=Jc.Flags.IsStartCalled,RI=Jc.Flags.IsOnEnableCalled;function wI(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function II(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}Jc.Flags.IsEditorOnEnableCalled;var DI=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=$;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function OI(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}DI.stableRemoveInactive=II;var MI=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){II(this._zero,e),II(this._neg,e),II(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(OI),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(OI),this._invoke(t),t.array.length=0)},t}(DI),NI=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=wI(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=wI(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(DI);function LI(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",r=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,r){try{t(i,r)}catch(t){T._throw(t);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{e(o[i.i],r)}catch(e){T._throw(e),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}var BI=LI("c.start();c._objFlags|="+PI,!1,PI),FI=LI("c.update(dt)",!0),zI=LI("c.lateUpdate(dt)",!0),UI=function(e){var t=T.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},kI=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new MI(BI),this.updateInvoker=new NI(FI),this.lateUpdateInvoker=new NI(zI),this._updating=!1},t._onEnabled=function(e){T.director.getScheduler().resumeTarget(e),e._objFlags|=RI,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){T.director.getScheduler().pauseTarget(e),e._objFlags&=~RI;var t=this._deferredComps.indexOf(e);t>=0?bI(this._deferredComps,t):(!e.start||e._objFlags&PI||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&RI)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&RI&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&PI||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),GI=Jc.Flags.IsPreloadStarted,HI=Jc.Flags.IsOnLoadStarted,VI=Jc.Flags.IsOnLoadCalled,jI=Jc.Flags.Deactivating,WI=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){DI.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(DI),qI=LI("c.__preload();"),XI=LI("c.onLoad();c._objFlags|="+VI,!1,VI),YI=new je(4);function KI(e,t,n){W(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):We.removeAt(e._components,n)}YI.get=function(){var e=this._get()||{preload:new WI(qI),onLoad:new MI(XI),onEnable:new MI(UI)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var QI,ZI,JI,$I,eD,tD,nD,iD,rD=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=YI.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),YI.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=g(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(GI),o.onLoad.cancelInactive(HI),o.onEnable.cancelInactive()}}e.emit(xE.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,i){if(el(e,!0)&&(e._objFlags&GI||(e._objFlags|=GI,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&HI||(e._objFlags|=HI,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=VI):e._objFlags|=VI),e._enabled)){if(!e.node._activeInHierarchy)return;T.director._compScheduler.enableComp(e,i)}},t.destroyComp=function(e){T.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&VI&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,i){if(e._objFlags&jI)W(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,o=0;o<r;++o){var a=e._components[o];a instanceof T.Component?this.activateComp(a,t,n,i):(KI(e,a,o),--o,--r)}for(var s=0,c=e._children.length;s<c;++s){var l=e._children[s];l._active&&this._activateNodeRecursively(l,t,n,i)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=jI,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(T.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~jI)}for(var r=0,o=e._children.length;r<o;++r){var a=e._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~jI)}e._onPostActivated(!1),e._objFlags&=~jI},e}()),oD=e("SceneAsset",$s("cc.SceneAsset")(($I=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"scene",JI,m(t)),t}u(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new CI("New Scene")},n.validate=function(){return!!this.scene},t}(pu),JI=x((ZI=$I).prototype,"scene",[mc,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QI=ZI))||QI);T.SceneAsset=oD;var aD,sD,cD,lD,uD=e("TextAsset",$s("cc.TextAsset")((iD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"text",nD,m(t)),t}return u(t,e),t.prototype.toString=function(){return this.text},t}(pu),nD=x((tD=iD).prototype,"text",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),eD=tD))||eD);T.TextAsset=uD;var hD=e("JsonAsset",$s("cc.JsonAsset")((lD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"json",cD,m(t)),t}return u(t,e),t}(pu),cD=x((sD=lD).prototype,"json",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aD=sD))||aD);T.JsonAsset=hD;var _D,fD,dD,pD,mD,vD,gD,yD,xD,SD,TD,ED,CD,AD,bD,PD,RD,wD,ID,DD,OD,MD,ND,LD,BD,FD,zD,UD,kD,GD,HD,VD,jD,WD,qD,XD,YD,KD,QD=function(){var e=t.prototype;function t(){this.fog=new KT,this.ambient=new AS,this.skybox=new VS,this.shadows=new Yv,this.octree=new PS,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initOcclusionQuery(),!0},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Nv;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=e.createBuffer(new er(ri.INDEX|ri.TRANSFER_DST,si.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new vr("a_position",ti.RGB32F)],c=new yr(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},c(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(fy.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(),ZD=e("ForwardPipeline",(_D=$s("ForwardPipeline"),fD=Mc([fS]),dD=bc(),_D((gD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",vD,m(t)),t._postRenderPass=null,t}u(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new WT;n.initialize(WT.initInfo),this._flows.push(n);var i=new PT;i.initialize(PT.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new QD,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(W(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(bd,t),this._descriptorSet.bindTexture(bd,rv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Ld,t),this._descriptorSet.bindTexture(Ld,rv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Ed.BINDING).destroy(),this._descriptorSet.getBuffer(Ad.BINDING).destroy(),this._descriptorSet.getBuffer(Cd.BINDING).destroy(),this._descriptorSet.getTexture(bd).destroy(),this._descriptorSet.getTexture(Ld).destroy())},c(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(Ly),vD=x((mD=gD).prototype,"renderTextures",[fD,oc,dD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pD=mD))||pD)),JD=[new Qi(0,0,0,0),new Qi(0,0,0,0),new Qi(0,0,0,0)],$D=e("GbufferStage",(yD=$s("GbufferStage"),xD=Mc([mS]),SD=bc(),yD((bD=AD=function(e){function t(){var t;return y(t=e.call(this)||this,"renderQueues",CD,m(t)),t._renderQueues=[],t._renderArea=new Hi,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=ov("default"),t._batchedQueue=new ES,t._instancedQueue=new CS,t}u(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=xS(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(SS),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===ev.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===ev.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(TS);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&Bi.COLOR&&(t.pipelineSceneData.isHDR?pv(JD[0],e.clearColor):(JD[0].x=e.clearColor.x,JD[0].y=e.clearColor.y,JD[0].z=e.clearColor.z)),JD[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,JD,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(yd.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(_y),AD.initInfo={name:"GbufferStage",priority:Py.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:_S.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:_S.BACK_TO_FRONT,stages:["default"]}]},CD=x((ED=bD).prototype,"renderQueues",[xD,oc,SD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TD=ED))||TD)),eO=[new Qi(0,0,0,1)],tO=e("LightingStage",(PD=$s("LightingStage"),RD=Mc(Nv),wD=bc(),ID=Mc([mS]),DD=bc(),PD((FD=BD=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=Vd.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new Hi,t._uiPhase=void 0,y(t,"_deferredMaterial",ND,m(t)),y(t,"renderQueues",LD,m(t)),t._phaseID=ov("default"),t._renderQueues=[],t._uiPhase=new CT,t}u(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,o=Wo.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=Tn.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(Wo.set(o,_.position.x,_.position.y,_.position.z,_.range),Ka.sphereFrustum(o,e.frustum)){if(dn.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),dn.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}t.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var d=0;d<r.length&&c<this._maxDeferredLights;d++,++c){var p=r[d];if(Wo.set(o,p.position.x,p.position.y,p.position.z,p.range),Ka.sphereFrustum(o,e.frustum)){if(dn.toArray(a,p.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),dn.toArray(a,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=p.luminance*s*this._lightMeterScale:a[3]=p.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=p.size,a[1]=p.range,a[2]=p.spotAngle,this._lightBufferData.set(a,c*l+2*u),dn.toArray(a,p.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=t.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=xS(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new tr(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new wr(pd.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Ir(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(Hd.BINDING,a),this._planarQueue=new ET(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects;this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,i),i.bindDescriptorSet(yd.LOCAL,this._descriptorSet,[0]),t.generateRenderArea(e,this._renderArea),e.clearFlag&Bi.COLOR&&(eO[0].x=e.clearColor.x,eO[0].y=e.clearColor.y,eO[0].z=e.clearColor.z),eO[0].w=0;var a=t.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(c,s,this._renderArea,eO,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(yd.GLOBAL,t.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),i.bindDescriptorSet(yd.MATERIAL,l.descriptorSet);var _=t.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=_&&(f=_v.getOrCreatePipelineState(n,l,u,c,_)),null!=f&&(i.bindPipelineState(f),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(SS);for(var d=0,p=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(d=0;d<y.length;++d){var x=y[d].passes;for(p=0;p<x.length;++p)if(x[p].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,d,p)}}if(o.length>0){this._renderQueues.forEach(TS);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(e,c),i.endRenderPass()},t}(_y),BD.initInfo={name:"LightingStage",priority:Py.LIGHTING,tag:0},ND=x((MD=FD).prototype,"_deferredMaterial",[RD,oc,wD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LD=x(MD.prototype,"renderQueues",[ID,oc,DD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OD=MD))||OD)),nO=[new Qi(0,0,0,1)],iO=e("PostProcessStage",(zD=$s("PostProcessStage"),UD=Mc(Nv),kD=bc(),GD=Mc([mS]),HD=bc(),zD((YD=XD=function(e){function t(){var t;return y(t=e.call(this)||this,"_postProcessMaterial",WD,m(t)),y(t,"renderQueues",qD,m(t)),t._renderArea=new Hi,t._uiPhase=new CT,t}u(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.window.width,this._renderArea.y=o.y*e.window.height,this._renderArea.width=o.width*e.window.width,this._renderArea.height=o.height*e.window.height;var a=t.getPipelineRenderData(),s=e.window.framebuffer,c=t.getRenderPass(e.clearFlag,s);e.clearFlag&Bi.COLOR&&(nO[0].x=e.clearColor.x,nO[0].y=e.clearColor.y,nO[0].z=e.clearColor.z),nO[0].w=e.clearColor.w,r.beginRenderPass(c,s,this._renderArea,nO,e.clearDepth,e.clearStencil),r.bindDescriptorSet(yd.GLOBAL,t.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();t.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update(),r.bindDescriptorSet(yd.MATERIAL,l.descriptorSet);var h=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=_v.getOrCreatePipelineState(n,l,u,c,h));var f=t.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(e,c),Pv(n,c,r,t.profiler,e),r.endRenderPass()},t}(_y),XD.initInfo={name:"PostProcessStage",priority:Cy.POST_PROCESS,tag:0},WD=x((jD=YD).prototype,"_postProcessMaterial",[UD,oc,kD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qD=x(jD.prototype,"renderQueues",[GD,oc,HD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VD=jD))||VD));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(KD||(KD={}));var rO,oO,aO,sO,cO,lO,uO,hO,_O=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=KD.NONE,t}u(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),t.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new Nv;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new Nv;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new Nv;r._uuid="builtin-post-process-material",$e.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=KD.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},c(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new Nv;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(QD),fO=[new Qi(0,0,0,1)],dO=function(){};dO.SIZE=4*(dO.COUNT=4+(dO.TEXTURE_SIZE_OFFSET=0));var pO,mO,vO,gO,yO,xO,SO,TO,EO,CO,AO=e("BloomStage",(rO=$s("BloomStage"),oO=Mc(Nv),aO=bc(),rO((hO=uO=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,y(t,"_bloomMaterial",lO,m(t)),t._renderArea=new Hi,t._bloomUBO=[],t}u(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,dO.SIZE,dO.SIZE));e.clearFlag&Bi.COLOR&&(fO[0].x=e.clearColor.x,fO[0].y=e.clearColor.y,fO[0].z=e.clearColor.z),fO[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(dO.COUNT);a[dO.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,fO,0,0),n.bindDescriptorSet(yd.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(yd.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=_v.getOrCreatePipelineState(t.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,o=new Float32Array(dO.COUNT),a=0;a<this.iterations;++a){o[dO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[dO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,fO,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(yd.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=_v.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,o=new Float32Array(dO.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[dO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[dO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,fO,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(yd.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=_v.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(dO.COUNT);a[dO.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,fO,0,0),n.bindDescriptorSet(yd.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(yd.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=_v.getOrCreatePipelineState(t.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(_y),uO.initInfo={name:"BloomStage",priority:Cy.BLOOM,tag:0},lO=x((cO=hO).prototype,"_bloomMaterial",[oO,oc,aO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sO=cO))||sO)),bO=e("MainFlow",$s("MainFlow")((vO=mO=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new $D;n.initialize($D.initInfo),this._stages.push(n);var i=new tO;i.initialize(tO.initInfo),this._stages.push(i);var r=new AO;r.initialize(AO.initInfo),this._stages.push(r);var o=new iO;o.initialize(iO.initInfo),this._stages.push(o)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(dy),mO.initInfo={name:ud,priority:Ry.MAIN,stages:[]},pO=vO))||pO),PO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return u(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),RO=e("DeferredPipeline",(gO=$s("DeferredPipeline"),yO=Mc([fS]),xO=bc(),gO((CO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,y(t,"renderTextures",EO,m(t)),t}u(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new WT;n.initialize(WT.initInfo),this._flows.push(n);var i=new bO;i.initialize(bO.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new _O,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(W(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(bd,n),this._descriptorSet.bindTexture(bd,rv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Ld,n),this._descriptorSet.bindTexture(Ld,rv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new Ny;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new xr;o.format=ti.RGBA16F,o.loadOp=Si.CLEAR,o.storeOp=Ti.STORE;var a=new xr;a.format=ti.RGBA16F,a.loadOp=Si.CLEAR,a.storeOp=Ti.STORE;var s=new xr;s.format=ti.RGBA16F,s.loadOp=Si.CLEAR,s.storeOp=Ti.STORE;var c=new Sr;c.format=ti.DEPTH_STENCIL,c.depthLoadOp=Si.CLEAR,c.depthStoreOp=Ti.STORE,c.stencilLoadOp=Si.CLEAR,c.stencilStoreOp=Ti.STORE;var l=new Cr([o,a,s],c);this._gbufferRenderPass=t.createRenderPass(l)}if(!this._lightingRenderPass){var u=new xr;u.format=ti.RGBA8,u.loadOp=Si.CLEAR,u.storeOp=Ti.STORE,u.endAccesses=[Ei.COLOR_ATTACHMENT_WRITE];var h=new Sr;h.format=ti.DEPTH_STENCIL,h.depthLoadOp=Si.LOAD,h.depthStoreOp=Ti.DISCARD,h.stencilLoadOp=Si.LOAD,h.stencilStoreOp=Ti.DISCARD,h.beginAccesses=[Ei.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Ei.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new Cr([u],h);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Ed.BINDING).destroy(),this._descriptorSet.getBuffer(Ad.BINDING).destroy(),this._descriptorSet.getBuffer(Cd.BINDING).destroy(),this._descriptorSet.getTexture(bd).destroy(),this._descriptorSet.getTexture(Ld).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new PO,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(t.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED,ti.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new or(ci.TEX2D,li.DEPTH_STENCIL_ATTACHMENT|li.SAMPLED,ti.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new Pr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED,ti.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new Pr(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(fy.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},t}(Ly),EO=x((TO=CO).prototype,"renderTextures",[yO,oc,xO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SO=TO))||SO));function wO(){var e=new ZD;return e.initialize({flows:[]}),e}var IO=new gn,DO=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new Qi(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new Qi(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{T.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?T.view.setDesignResolutionSize(n.width,n.height,n.policy):T.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,T.game.once(T.Game.EVENT_GAME_INITED,(function(){T.director._lateUpdate=performance.now()}),T.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else N("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),T.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new Qi(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new Hi(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=t.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new er(ri.INDEX|ri.TRANSFER_DST,si.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new vr("a_position",ti.RG32F),new vr("a_texCoord",ti.RG32F)],u=new yr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new Ln,Ln.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),T.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,o=e.swapchain;Ln.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=Qh(Qt(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,_=e.logoTexture.height,f=c*i.displayRatio,d=f*h/_,p=f;if(o.surfaceTransform!==$n.ROTATE_90&&o.surfaceTransform!==$n.ROTATE_270||(d=f*a/s,p=f*_/h*s/a),e.logoMat.setProperty("resolution",IO.set(a,s),0),e.logoMat.setProperty("scale",IO.set(d,p),0),e.logoMat.setProperty("translate",IO.set(.5*a,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;o.surfaceTransform!==$n.ROTATE_90&&o.surfaceTransform!==$n.ROTATE_270||(g=.5*m,y=m*a/s*.5),e.watermarkMat.setProperty("resolution",IO.set(a,s),0),e.watermarkMat.setProperty("scale",IO.set(g,y),0),e.watermarkMat.setProperty("translate",IO.set(.5*a,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new Nv,this.logoMat.initialize({effectName:"splash-screen"});var t=new sr;t.addressU=di.CLAMP,t.addressV=di.CLAMP,t.addressW=di.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new or(ci.TEX2D,li.SAMPLED|li.TRANSFER_DST,ti.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new Yi;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new Yi;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new or(ci.TEX2D,li.SAMPLED|li.TRANSFER_DST,ti.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new Nv,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=_v.getOrCreatePipelineState(e,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(yd.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=_v.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(yd.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},c(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();DO._ins=void 0,T.internal.SplashScreen=DO;var OO={topLeft:T.v2(0,0),topRight:T.v2(0,0),top:T.v2(0,0),bottomLeft:T.v2(0,0),bottomRight:T.v2(0,0),bottom:T.v2(0,0),center:T.v2(0,0),left:T.v2(0,0),right:T.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,o=r+n,a=i+t;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+t/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};T.visibleRect=OO;var MO=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());MO.NO_TYPE="no_type",MO.TOUCH="touch",MO.MOUSE="mouse",MO.KEYBOARD="keyboard",MO.ACCELERATION="acceleration",MO.NONE=0,MO.CAPTURING_PHASE=1,MO.AT_TARGET=2,MO.BUBBLING_PHASE=3,T.Event=MO;var NO=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,vb.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return u(t,e),t}(MO));MO.EventAcceleration=NO;var LO=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?vb.KEY_DOWN:vb.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==vb.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return u(t,e),c(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(MO));MO.EventKeyboard=LO;var BO=e("EventMouse",function(e){function t(n,i,r){var o;return(o=e.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=t.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}u(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new gn),gn.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new gn),gn.set(e,this._x,T.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new gn),gn.set(e,this._x,this._y),T.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new gn),gn.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new gn),gn.set(e,this._prevX,this._prevY),T.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new gn),gn.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new gn),gn.set(e,(this._x-this._prevX)/T.view.getScaleX(),(this._y-this._prevY)/T.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/T.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/T.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=T.view.getViewportRect();return(this._x-e.x)/T.view.getScaleX()},n.getUILocationY=function(){var e=T.view.getViewportRect();return(this._y-e.y)/T.view.getScaleY()},c(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(MO));BO.BUTTON_MISSING=-1,BO.BUTTON_LEFT=0,BO.BUTTON_RIGHT=2,BO.BUTTON_MIDDLE=1,BO.BUTTON_4=3,BO.BUTTON_5=4,BO.BUTTON_6=5,BO.BUTTON_7=6,BO.BUTTON_8=7,MO.EventMouse=BO;var FO=new gn,zO=e("EventTouch",function(e){function t(t,n,i,r){var o;return void 0===r&&(r=[]),(o=e.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=t||[],o._allTouches=r,o}u(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new gn},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new gn},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new gn},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new gn},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new gn},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new gn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new gn},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new gn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(FO).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(FO).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(MO));zO.MAX_TOUCHES=5,MO.EventTouch=zO;var UO,kO=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(UO||(UO=e("KeyCode",{})));var GO=new gn,HO=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new gn,this._prevPoint=new gn,this._lastModified=0,this._id=0,this._startPoint=new gn,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new gn),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new gn),e.set(this._point.x,this._point.y),T.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=T.view.getViewportRect();return(this._point.x-e.x)/T.view.getScaleX()},t.getUILocationY=function(){var e=T.view.getViewportRect();return(this._point.y-e.y)/T.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new gn),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new gn),e.set(this._prevPoint.x,this._prevPoint.y),T.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new gn),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new gn),e.set(this._startPoint.x,this._startPoint.y),T.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new gn),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new gn),GO.set(this._point),GO.subtract(this._prevPoint),e.set(T.view.getScaleX(),T.view.getScaleY()),gn.divide(e,GO,e),e},t.getLocationInView=function(e){return e||(e=new gn),e.set(this._point.x,T.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new gn),e.set(this._prevPoint.x,T.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new gn),e.set(this._startPoint.x,T.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new gn(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new gn(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=T.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new gn(e.x,e.y):new gn(e||0,t||0),this._lastModified=T.game.frameStartTime},c(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());T.Touch=HO;var VO,jO,WO=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new zl,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,Jl.browserType===kl.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=e;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(Vu.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),Jl.os===Vl.ANDROID&&Jl.browserType!==kl.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new kO(n,i,r,l),h=new NO(u);this._eventTarget.emit(gb.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),qO={Backspace:UO.BACKSPACE,Tab:UO.TAB,Enter:UO.ENTER,ShiftLeft:UO.SHIFT_LEFT,ControlLeft:UO.CTRL_LEFT,AltLeft:UO.ALT_LEFT,ShiftRight:UO.SHIFT_RIGHT,ControlRight:UO.CTRL_RIGHT,AltRight:UO.ALT_RIGHT,Pause:UO.PAUSE,CapsLock:UO.CAPS_LOCK,Escape:UO.ESCAPE,Space:UO.SPACE,PageUp:UO.PAGE_UP,PageDown:UO.PAGE_DOWN,End:UO.END,Home:UO.HOME,ArrowLeft:UO.ARROW_LEFT,ArrowUp:UO.ARROW_UP,ArrowRight:UO.ARROW_RIGHT,ArrowDown:UO.ARROW_DOWN,Insert:UO.INSERT,Delete:UO.DELETE,Digit0:UO.DIGIT_0,Digit1:UO.DIGIT_1,Digit2:UO.DIGIT_2,Digit3:UO.DIGIT_3,Digit4:UO.DIGIT_4,Digit5:UO.DIGIT_5,Digit6:UO.DIGIT_6,Digit7:UO.DIGIT_7,Digit8:UO.DIGIT_8,Digit9:UO.DIGIT_9,KeyA:UO.KEY_A,KeyB:UO.KEY_B,KeyC:UO.KEY_C,KeyD:UO.KEY_D,KeyE:UO.KEY_E,KeyF:UO.KEY_F,KeyG:UO.KEY_G,KeyH:UO.KEY_H,KeyI:UO.KEY_I,KeyJ:UO.KEY_J,KeyK:UO.KEY_K,KeyL:UO.KEY_L,KeyM:UO.KEY_M,KeyN:UO.KEY_N,KeyO:UO.KEY_O,KeyP:UO.KEY_P,KeyQ:UO.KEY_Q,KeyR:UO.KEY_R,KeyS:UO.KEY_S,KeyT:UO.KEY_T,KeyU:UO.KEY_U,KeyV:UO.KEY_V,KeyW:UO.KEY_W,KeyX:UO.KEY_X,KeyY:UO.KEY_Y,KeyZ:UO.KEY_Z,Numpad0:UO.NUM_0,Numpad1:UO.NUM_1,Numpad2:UO.NUM_2,Numpad3:UO.NUM_3,Numpad4:UO.NUM_4,Numpad5:UO.NUM_5,Numpad6:UO.NUM_6,Numpad7:UO.NUM_7,Numpad8:UO.NUM_8,Numpad9:UO.NUM_9,NumpadMultiply:UO.NUM_MULTIPLY,NumpadAdd:UO.NUM_PLUS,NumpadSubtract:UO.NUM_SUBTRACT,NumpadDecimal:UO.NUM_DECIMAL,NumpadDivide:UO.NUM_DIVIDE,NumpadEnter:UO.NUM_ENTER,F1:UO.F1,F2:UO.F2,F3:UO.F3,F4:UO.F4,F5:UO.F5,F6:UO.F6,F7:UO.F7,F8:UO.F8,F9:UO.F9,F10:UO.F10,F11:UO.F11,F12:UO.F12,NumLock:UO.NUM_LOCK,ScrollLock:UO.SCROLL_LOCK,Semicolon:UO.SEMICOLON,Equal:UO.EQUAL,Comma:UO.COMMA,Minus:UO.DASH,Period:UO.PERIOD,Slash:UO.SLASH,Backquote:UO.BACK_QUOTE,BracketLeft:UO.BRACKET_LEFT,Backslash:UO.BACKSLASH,BracketRight:UO.BRACKET_RIGHT,Quote:UO.QUOTE},XO=function(){function e(){this._eventTarget=new zl,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,gb.KEY_PRESSING);e._eventTarget.emit(gb.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,gb.KEY_DOWN);e._eventTarget.emit(gb.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,gb.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(gb.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,qO[n]||UO.NONE);return new LO(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),YO=function(){function e(){this._canvas=void 0,this._eventTarget=new zl,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new gn,Jl.hasFeature(Wl.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Hn(t.x,t.y,t.width,t.height):new Hn(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=Vu.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new gn(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(gb.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(gb.MOUSE_MOVE));var o=this._createCallback(gb.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),o=n.button;switch(e){case gb.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case gb.MOUSE_UP:t._isPressed=!1;break;case gb.MOUSE_MOVE:t._isPressed||(o=BO.BUTTON_MISSING)}var a=new BO(e,!1,t._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,a)}},t._handleMouseWheel=function(e){var t=gb.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new BO(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),KO=new gn,QO=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(KO);var n=new HO(KO.x,KO.y,t);return e.getLocation(KO),n.setPoint(KO.x,KO.y),e.getPreviousLocation(KO),n.setPrevPoint(KO),n},t._createTouch=function(e,t,n){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var i=new HO(t,n,e);return this._touchMap.set(e,i),this._updateTouch(i,t,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e,t,n){var i=this._touchMap.get(e);return i?this._updateTouch(i,t,n):i=this._createTouch(e,t,n),i?this._cloneTouch(i):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touchMap.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(KO),e.setPrevPoint(KO),e.setPoint(t,n)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var n=$e.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(e){i-e.lastModified>$e.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),n>=this._touchMap.size},e}()),ZO=function(){function e(){this._canvas=void 0,this._eventTarget=new zl,Jl.hasFeature(Wl.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(gb.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(gb.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(gb.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(gb.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=QO.getTouch(l,u.x,u.y);h&&(e!==gb.TOUCH_END&&e!==gb.TOUCH_CANCEL||QO.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===gb.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),o.length>0){var _=new zO(o,!1,e,$e.ENABLE_MULTI_TOUCH?QO.getAllTouches():o);t._eventTarget.emit(e,_)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Hn(t.x,t.y,t.width,t.height):new Hn(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(Vu.isFrameRotated){var r=n;n=t.height-i,i=r}var o=Vu.devicePixelRatio;return new gn(n*=o,i*=o)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(jO||(jO={}));var JO=function(){function e(e){this.priority=jO.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),$O=((VO={})[gb.MOUSE_DOWN]=gb.TOUCH_START,VO[gb.MOUSE_MOVE]=gb.TOUCH_MOVE,VO[gb.MOUSE_UP]=gb.TOUCH_END,VO),eM=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new zl,this._touchInput=new ZO,this._mouseInput=new YO,this._keyboardInput=new XO,this._accelerometerInput=new WO,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new JO(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var t=e.prototype;return t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=$O[e.type],n=QO.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new zO(i,!1,t,i);t===gb.TOUCH_END&&QO.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,n=0;n<t&&this._eventDispatcherList[n].dispatchEvent(e);++n);},t._registerEvent=function(){var e=this;if(qu.hasFeature(qu.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(gb.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(gb.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(gb.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(gb.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(qu.hasFeature(qu.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(gb.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(gb.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(gb.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(gb.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(qu.hasFeature(qu.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(gb.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(gb.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(gb.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(qu.hasFeature(qu.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(gb.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var d=h[_];this._emitEvent(d)}for(var p=this._eventAccelerationList,m=0,v=p.length;m<v;++m){var g=p[m];this._emitEvent(g)}this._clearEvents()},e}());eM.EventType=gb;var tM=e("input",new eM),nM=e("SystemEvent",function(e){function t(){var t;return t=e.call(this)||this,tM.on(gb.MOUSE_DOWN,(function(e){t.emit(vb.MOUSE_DOWN,e)})),tM.on(gb.MOUSE_MOVE,(function(e){t.emit(vb.MOUSE_MOVE,e)})),tM.on(gb.MOUSE_UP,(function(e){t.emit(vb.MOUSE_UP,e)})),tM.on(gb.MOUSE_WHEEL,(function(e){t.emit(vb.MOUSE_WHEEL,e)})),tM.on(gb.TOUCH_START,(function(e){t.emit(vb.TOUCH_START,e.touch,e)})),tM.on(gb.TOUCH_MOVE,(function(e){t.emit(vb.TOUCH_MOVE,e.touch,e)})),tM.on(gb.TOUCH_END,(function(e){t.emit(vb.TOUCH_END,e.touch,e)})),tM.on(gb.TOUCH_CANCEL,(function(e){t.emit(vb.TOUCH_CANCEL,e.touch,e)})),tM.on(gb.KEY_DOWN,(function(e){t.emit(vb.KEY_DOWN,e)})),tM.on(gb.KEY_PRESSING,(function(e){t.emit(vb.KEY_DOWN,e)})),tM.on(gb.KEY_UP,(function(e){t.emit(vb.KEY_UP,e)})),tM.on(gb.DEVICEMOTION,(function(e){t.emit(vb.DEVICEMOTION,e)})),t}u(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){tM.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){tM.setAccelerometerInterval(e)},n.on=function(t,n,i,r){return e.prototype.on.call(this,t,n,i,r),n},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i)},t}(zl));nM.EventType=vb,T.SystemEvent=nM;var iM=e("systemEvent",new nM);T.systemEvent=iM;var rM=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t._onEngineInitedCallback=[],t}u(t,e);var i=t.prototype;return i.setFrameRate=function(e){this.frameRate=e},i.getFrameRate=function(){return this.frameRate},i.step=function(){T.director.tick(this.frameTime/1e3)},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(tM._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},i.isPaused=function(){return this._paused},i.restart=function(){var e=this;return new Promise((function(e){return T.director.once(T.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return T.director.getScene().destroy(),T.Object._deferredDestroy(),T.director.reset(),T.profiler.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},i.end=function(){Jl.close()},i.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},i.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},i.init=function(e){var t=this;if(this._initConfig(e),Wu._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&T.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,r=0;r<i.length;r++){var o=i[r],a=n(o.value);sd.addLayer(o.name,a)}return this._initEngine().then((function(){return t._initEvents(),T.director.root&&T.director.root.dataPoolManager&&T.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},i.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,ql.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},i.addPersistRootNode=function(e){if(T.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=T.director._scene;if(T.isValid(n))if(e.parent){if(!(e.parent instanceof T.Scene))return void V(3801);if(e.parent!==n)return void V(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,T.assetManager._releaseManager._addPersistNodeRef(e)}}else V(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",T.assetManager._releaseManager._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},i.onEngineInitedAsync=function(e){this._onEngineInitedCallback.push(e)},i._initEngine=function(){var e=this;this._initDevice();var n=T.director;return Promise.resolve(n._init()).then((function(){T.view.init(),O("Cocos Creator v"+E),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,T.internal.dynamicAtlasManager&&(T.internal.dynamicAtlasManager.enabled=!$e.CLEANUP_IMAGE_CACHE)})).then((function(){var t=e._onEngineInitedCallback.map((function(e){return e()})).filter(Boolean);return e._onEngineInitedCallback.length=0,Promise.all(t)}))},i._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},i._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},i._ctTime=function(e){window.clearTimeout(e)},i._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},i._updateCallback=function(){var e,t=this,n=T.director;if(30===this._frameRate){var i=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(i=!i)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},i._runMainLoop=function(){if(this._inited){var e=this.config,t=T.director;Z(!!e.showFPS),t.startAnimation(),this.resume()}},i._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=q.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,F(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},i._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(K(3820,n))},i._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new $i(Td),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||qu.browserType===kl.UC)&&(i=!1);var o=[];i&&T.WebGL2Device&&o.push(T.WebGL2Device),T.WebGLDevice&&o.push(T.WebGLDevice),T.EmptyDevice&&o.push(T.EmptyDevice),eo.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(n));a++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&T.EmptyDevice&&(this._gfxDevice=new T.EmptyDevice,this._gfxDevice.initialize(new $i(Td)));if(!this._gfxDevice)return N("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var s=new Ji(this.canvas),c=Wu.windowSize;s.width=c.width,s.height=c.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){Jl.on("show",this._onShow,this),Jl.on("hide",this._onHide,this)},i._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},i._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){T.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof Ly?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){M(n),M("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(T.internal.SplashScreen){var e=T.internal.SplashScreen.instance;return e.main(T.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},i._setRenderPipeline=function(e){T.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},i._safeEmit=function(e){this.emit(e)},c(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(zl));rM.EVENT_HIDE="game_on_hide",rM.EVENT_SHOW="game_on_show",rM.EVENT_LOW_MEMORY="game_on_low_memory",rM.EVENT_GAME_INITED="game_inited",rM.EVENT_ENGINE_INITED="engine_inited",rM.EVENT_RENDERER_INITED="renderer_inited",rM.EVENT_RESTART="game_on_restart",rM.RENDER_TYPE_CANVAS=0,rM.RENDER_TYPE_WEBGL=1,rM.RENDER_TYPE_OPENGL=2,rM.RENDER_TYPE_HEADLESS=3,rM.DEBUG_DT_THRESHOLD=1,T.Game=rM;var oM,aM=e("game",T.game=new rM),sM=new kn,cM=((oM={})[$e.ORIENTATION_AUTO]=zu.AUTO,oM[$e.ORIENTATION_LANDSCAPE]=zu.LANDSCAPE,oM[$e.ORIENTATION_PORTRAIT]=zu.PORTRAIT,oM),lM=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=uM,i=hM;return t._designResolutionSize=new kn(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new Hn(0,0,0,0),t._visibleRect=new Hn(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new _M(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new _M(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new _M(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new _M(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new _M(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}u(t,e);var n=t.prototype;return n.init=function(){var e=Wu.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,sM.width=this._visibleRect.width,sM.height=this._visibleRect.height,OO&&OO.init(this._visibleRect),Vu.on("window-resize",this._updateAdaptResult,this),Vu.on("orientation-change",this._updateAdaptResult,this),Vu.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){Vu.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){Vu.orientation=cM[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&Wu.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){Vu.resolutionScale=1;var n=Vu.devicePixelRatio,i=new kn(e*n,t*n);Wu.windowSize=i},n.getCanvasSize=function(){return Wu.windowSize},n.getFrameSize=function(){var e=Vu.devicePixelRatio,t=Wu.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=Vu.devicePixelRatio;Wu.windowSize=new kn(e*n,t*n)},n.getVisibleSize=function(){return new kn(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new kn(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new gn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new gn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof _M)this._resolutionPolicy=e;else{var t=_M;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=fM.getDesignResolutionSize();fM.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),sM.width=this._visibleRect.width,sM.height=this._visibleRect.height,OO&&OO.init(this._visibleRect),this.emit("design-resolution-changed")}else W(2200)},n.getDesignResolutionSize=function(){return new kn(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return Vu.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new gn);var r=Vu.devicePixelRatio*(e-n.left),o=Vu.devicePixelRatio*(n.top+n.height-t);return Vu.isFrameRotated?(i.x=Wu.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;T.director.root.resize(Wu.windowSize.width,Wu.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(zl));lM.instance=void 0;var uM=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=aM.canvas;if(e){var t=Wu.windowSize;e.width=t.width,e.height=t.height}},e}();uM.EQUAL_TO_FRAME=void 0,uM.PROPORTION_TO_FRAME=void 0;var hM=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,o){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new Hn(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},e}();hM.EXACT_FIT=void 0,hM.SHOW_ALL=void 0,hM.NO_BORDER=void 0,hM.FIXED_HEIGHT=void 0,hM.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return u(t,e),t.prototype.apply=function(){Vu.isProportionalToFrame=!1,this._setupCanvas()},t}(uM),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return u(t,e),t.prototype.apply=function(){Vu.isProportionalToFrame=!0,this._setupCanvas()},t}(uM);uM.EQUAL_TO_FRAME=new e,uM.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return u(t,e),t.prototype.apply=function(e,t){var n=Wu.windowSize,i=n.width,r=n.height,o=i/t.width,a=r/t.height;return this._buildResult(i,r,i,r,o,a)},t}(hM),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return u(t,e),t.prototype.apply=function(e,t){var n,i,r=Wu.windowSize,o=r.width,a=r.height,s=t.width,c=t.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},t}(hM),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return u(t,e),t.prototype.apply=function(e,t){var n,i,r,o=Wu.windowSize,a=o.width,s=o.height,c=t.width,l=t.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},t}(hM),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return u(t,e),t.prototype.apply=function(e,t){var n=Wu.windowSize,i=n.width,r=n.height,o=r/t.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(hM),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return u(t,e),t.prototype.apply=function(e,t){var n=Wu.windowSize,i=n.width,r=n.height,o=i/t.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(hM);hM.EXACT_FIT=new n,hM.SHOW_ALL=new i,hM.NO_BORDER=new r,hM.FIXED_HEIGHT=new o,hM.FIXED_WIDTH=new a}();var _M=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof uM&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof hM&&(this._contentStrategy=e)},c(e,[{key:"canvasSize",get:function(){return Wu.windowSize}}]),e}());_M.EXACT_FIT=0,_M.NO_BORDER=1,_M.SHOW_ALL=2,_M.FIXED_HEIGHT=3,_M.FIXED_WIDTH=4,_M.UNKNOWN=5,_M.ContainerStrategy=uM,_M.ContentStrategy=hM,T.ResolutionPolicy=_M;var fM=e("view",lM.instance=T.view=new lM);T.winSize=sM;var dM=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},c(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());dM.Priority=Ye({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var pM=new oe("Scheduler"),mM=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};mM.get=function(e,t,n,i){var r=mM._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new mM(e,t,n,i),r},mM.put=function(e){mM._listEntries.length<20&&(e.target=null,mM._listEntries.push(e))},mM._listEntries=[];var vM=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};vM.get=function(e,t,n,i){var r=vM._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new vM(e,t,n,i),r},vM.put=function(e){vM._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,vM._hashUpdateEntries.push(e))},vM._hashUpdateEntries=[];var gM=function(e,t,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};gM.get=function(e,t,n,i,r,o){var a=gM._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new gM(e,t,n,i,r,o),a},gM.put=function(e){gM._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,gM._hashTimerEntries.push(e))},gM._hashTimerEntries=[];var yM=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,i,r,o){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===T.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();yM._timers=[],yM.get=function(){return yM._timers.pop()||new yM},yM.put=function(e){yM._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,yM._timers.push(e))};var xM,SM=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=ve(!0),t._hashForTimers=ve(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}u(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?V(1513):e.id=pM.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(o=a[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,i,r,o){if("function"!=typeof e){var a=e;e=t,t=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!i,i=T.macro.REPEAT_FOREVER,r=0),Y(t,1502);var s=t.uuid||t.id;if(s){var c,l,u=this._hashForTimers[s];if(u?u.paused!==o&&V(1511):(u=gM.get(null,t,0,null,null,o),this._arrayForTimers.push(u),this._hashForTimers[s]=u),null==u.timers)u.timers=[];else for(l=0;l<u.timers.length;++l)if((c=u.timers[l])&&e===c._callback)return G(1507,c.getInterval(),n),void(c._interval=n);(c=yM.get()).initWithCallback(this,e,t,n,i,r),u.timers.push(c),this._currentTarget===u&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else W(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return G(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var o,a=mM.get(e,t,n,!1);0===t?(o=this._updates0List,this._appendIn(o,a)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,t)),this._hashForUpdates[i]=vM.get(o,a,e,null)}else W(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),yM.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else W(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else W(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)yM.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else W(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(dM.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){Y(e,1508),Y(t,1509);var n=t.uuid||t.id;if(!n)return W(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(e===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(dM.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,o.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){Y(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else W(1510)},n.resumeTarget=function(e){Y(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else W(1510)},n.isTargetPaused=function(e){Y(e,1505);var t=e.uuid||e.id;if(!t)return W(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}gM.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[t],mM.put(r),vM.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(dM));SM.ID="scheduler",T.Scheduler=SM;var TM=((xM={})[zu.PORTRAIT]=$n.IDENTITY,xM[zu.LANDSCAPE_RIGHT]=$n.ROTATE_90,xM[zu.PORTRAIT_UPSIDE_DOWN]=$n.ROTATE_180,xM[zu.LANDSCAPE_LEFT]=$n.ROTATE_270,xM),EM=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new or(ci.TEX2D,li.COLOR_ATTACHMENT|li.SAMPLED|li.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==ti.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new or(ci.TEX2D,li.DEPTH_STENCIL_ATTACHMENT|li.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new Pr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,TM[Vu.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Pr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=g(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},c(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),CM=function(){var e=t.prototype;function t(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=T.internal.DataPoolManager&&new T.internal.DataPoolManager(e),zS.registerCreateFunc(this),EM.registerCreateFunc(this),this._cameraPool=new Pl((function(){return new Vv(t._device)}),4,(function(e){return e.destroy()}))}return e._init=function(){},e._destroy=function(){},e._setCumulativeTime=function(e){this._cumulativeTime+=e},e._setFrameTime=function(e){this._frameTime=e},e.initialize=function(){this._init();var e=T.game._swapchain,t=new xr;t.format=e.colorTexture.format;var n=new Sr;n.format=e.depthStencilTexture.format,n.depthStoreOp=Ti.DISCARD,n.stencilStoreOp=Ti.DISCARD;var i=new Cr([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:i,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(rv.initBuiltinRes(this._device))},e.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},e.resize=function(e,t){for(var n,i=g(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},e.setRenderPipeline=function(e){e instanceof RO&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=wO(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(ei.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=T.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&T.internal.Batcher2D&&(this._batcher=new T.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},e.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},e.activeWindow=function(e){this._curWindow=e},e.resetCumulativeTime=function(){this._setCumulativeTime(0)},e.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([T.game._swapchain]);var o=this._scenes,a=T.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);T.director.emit(T.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},e.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},e.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},e.destroyWindows=function(){for(var e,t=g(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},e.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},e.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},e.destroyScenes=function(){for(var e,t=g(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},e.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new Pl((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):V(1300,e.constructor.name),e.destroy()},e.createCamera=function(){return this._cameraPool.alloc()},e.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new Pl((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case Ig.SPHERE:e.scene.removeSphereLight(e);break;case Ig.SPOT:e.scene.removeSpotLight(e)}e.destroy()},c(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),t}();T.Root=CM;var AM=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new SM,t._compScheduler=new kI,t._nodeActivator=new rD,t._systems=[],aM.once(rM.EVENT_RENDERER_INITED,t._initOnRendererInitialized,m(t)),t}u(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),T.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),T.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof oD&&(e=e.scene),Y(e instanceof CI,1216),e._load();for(var i=Object.keys(aM._persistRootNodes).map((function(e){return aM._persistRootNodes[e]})),r=0;r<i.length;r++){var o=i[r];o.emit(T.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var a=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),e.insertChild(o,s)}else o.parent=e}var c=this._scene;T.isValid(c)&&c.destroy(),T.assetManager._releaseManager._autoRelease(c,e,aM._persistRootNodes),this._scene=null,Jc._deferredDestroy(),t&&t(),this.emit(T.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(T.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var i=this;e instanceof oD&&(e=e.scene),Y(e,1205),Y(e instanceof CI,1216),e._load(),this.once(T.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var i=this;if(this._loadingScene)return V(1208,e,this._loadingScene),!1;var r=T.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return r?(this.emit(T.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),r.loadScene(e,(function(r,o){console.timeEnd("LoadScene "+e),i._loadingScene="",r?(N(r),t&&t(r)):i.runSceneImmediate(o,n,t)})),!0):(W(1209,e),!1)},n.preloadScene=function(e,t,n){var i=T.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var r='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(r)),N("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return aM.deltaTime},n.getTotalTime=function(){return aM.totalTime},n.getCurrentTime=function(){return aM.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(SM.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(dM.sortByPriority)},n.unregisterSystem=function(e){We.fastRemove(this._systems,e),this._systems.sort(dM.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(T.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=aM._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),tM._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),Jc._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),TA.resetHasChangedFlags(),TA.clearNodeArray(),Al.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(SM.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new CM(aM._gfxDevice),this._root.initialize({}).catch((function(e){return W(1217),Promise.reject(e)}))},c(t,[{key:"root",get:function(){return this._root}}]),t}(zl));AM.EVENT_INIT="director_init",AM.EVENT_RESET="director_reset",AM.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",AM.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",AM.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",AM.EVENT_BEFORE_UPDATE="director_before_update",AM.EVENT_AFTER_UPDATE="director_after_update",AM.EVENT_BEFORE_DRAW="director_before_draw",AM.EVENT_AFTER_DRAW="director_after_draw",AM.EVENT_BEFORE_COMMIT="director_before_commit",AM.EVENT_BEFORE_PHYSICS="director_before_physics",AM.EVENT_AFTER_PHYSICS="director_after_physics",AM.EVENT_BEGIN_FRAME="director_begin_frame",AM.EVENT_END_FRAME="director_end_frame",AM.instance=void 0,T.Director=AM;var bM=e("director",AM.instance=T.director=new AM),PM=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new tl,this.scenes=new tl,this.paths=new tl}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=gl(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var d=t[_];t[_]=h[d]=gl(d)}t=h}for(var p in n){var m=n[p];o[t[p]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var x=e.packs;for(var S in x)for(var T=x[S],E=0;E<T.length;++E)T[E]=t[T[E]];var C=e.versions;if(C)for(var A in C)for(var b=C[A],P=0;P<b.length;P+=2){var R=b[P];b[P]=t[R]||R}var w=e.redirect;if(w)for(var I=0;I<w.length;I+=2)w[I]=t[w[I]],w[I+1]=r[w[I+1]];if(e.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var O in e.extensionMap)D(O)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=Tl(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(qe.isChildClassOf(o.ctor,t))return o}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=Tl(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var o=0,a=n.length;o<a;o++){var s=n[o];t&&!qe.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=qe._getClassById(o),t.has(r)?a?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],o=n.get(r);o.url=i,t.add(i,o)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=t.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];t.get(o).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function RM(e,t){e._uuid&&t.push(e._uuid)}function wM(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=e[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof pu&&RM(s,t)}else if(o.constructor&&o.constructor!==Object)o instanceof pu&&RM(o,t);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof pu&&RM(u,t)}}}}function IM(e,t){for(var n=0;n<e._components.length;n++)wM(e._components[n],t);for(var i=0;i<e._children.length;i++)IM(e._children[i],t)}function DM(e,t,n,i){n.push(e._uuid);for(var r=Om.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s=rl.get(r[o]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||DM(s,t,n,i)}}}var OM=[],MM=new(function(){function e(){this._persistNodeDeps=new tl,this._toDelete=new tl,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];IM(e,t);for(var n=0,i=t.length;n<i;n++){var r=rl.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=rl.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=Om.getDeps(e.uuid),r=0,o=i.length;r<o;r++){var a=rl.get(i[r]);a&&a.decRef(e.autoReleaseAssets)}var s=Om._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=rl.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Om.remove(e.uuid)}var _=Om._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var d,p,m=n[f],v=this._persistNodeDeps.get(m.uuid),y=g(v);!(p=y()).done;){var x=p.value,S=rl.get(x);S&&S.addRef()}_&&(d=_.persistDeps).push.apply(d,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof pu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,lt(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),el(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,DM(e,t,OM,-1),OM.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&DM(rl.get(n),t,OM,1);return OM.length=0,t[e._uuid]}(e)>0)){rl.remove(n);for(var i=Om.getDeps(n),r=0,o=i.length;r<o;r++){var a=rl.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),Om.remove(n)}},e}());function NM(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof pu&&r.content.decRef(!1),r.recycle()}e.input=null}function LM(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function BM(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(o,a){r++,!o||r>t?i&&i(o,a):setTimeout((function(){BM(e,t,n,i,r)}),n)}))}function FM(e,t,n,i,r){try{for(var o=Om.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(l({},o.nativeDep)))}catch(e){N(e.message,e.stack)}}function zM(e,t,n){t&&(n=void 0!==n?n:T.assetManager.cacheAsset,Sl(t)||!n||t.isDefault||rl.add(e,t))}function UM(e,t,n){var i=0,r=[],o=e.length;0===o&&n&&n(r);for(var a=function(e){e&&r.push(e),++i===o&&n&&n(r)},s=0;s<o;s++)t(e[s],a)}function kM(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a="function"==typeof e;t?(o=t,a||(r=null)):void 0===t&&a&&(o=e,i=null,r=null),void 0!==t&&a&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function GM(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a=qe.isChildClassOf(e,pu);t?(o=t,a&&(r=null)):void 0!==t||a||(o=e,r=null,i=null),void 0===t||a||(r=e,i=null)}return{type:i,onProgress:r||null,onComplete:o}}function HM(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,o=Om.getDeps(t);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===e||HM(e,c,n,i)){r=!0;break}}return r}function VM(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof pu&&i.push(e.addRef())})):n instanceof pu&&i.push(n.addRef()),lt((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var jM=function(){function e(){this._config=new PM}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),sl.add(e.name,this)},t.load=function(e,t,n,i){var r=GM(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c={__requestType__:il.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(e)};T.assetManager.loadAny(e,c,a,s)},t.preload=function(e,t,n,i){var r=GM(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;T.assetManager.preloadAny(e,{__requestType__:il.PATH,type:o,bundle:this.name},a,s)},t.loadDir=function(e,t,n,i){var r=GM(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;T.assetManager.loadAny(e,{__requestType__:il.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},t.preloadDir=function(e,t,n,i){var r=GM(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;T.assetManager.preloadAny(e,{__requestType__:il.DIR,type:o,bundle:this.name},a,s)},t.loadScene=function(e,t,n,i){var r=kM(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,T.assetManager.loadAny({scene:e},o,a,(function(e,t){if(e)N(e.message,e.stack);else if(t instanceof oD&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");s&&s(e,t)}))},t.preloadScene=function(e,t,n,i){var r=kM(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,T.assetManager.preloadAny({scene:e},o,a,(function(t){t&&W(1210,e,t.message),s&&s(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&rl.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&MM.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;rl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&MM.tryRelease(t)}))},t.releaseAll=function(){var e=this;rl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&MM.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},c(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),WM=e("resources",new jM);function qM(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(K(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=e,i}function XM(e,t,n,i){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}T.resources=WM;var YM={};function KM(e,t,n){if(YM[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),YM[e]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(K(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var QM=/^(?:\w+:\/\/|\.+\/).+/,ZM=function(e,t,n){(qu.hasFeature(qu.Feature.IMAGE_BITMAP)&&T.assetManager.allowImageBitmap?JM:qM)(e,t,n)},JM=function(e,t,n){t.xhrResponseType="blob",XM(e,t,t.onFileProgress,n)},$M=function(e,t,n){t.xhrResponseType="json",XM(e,t,t.onFileProgress,n)},eN=function(e,t,n){t.xhrResponseType="arraybuffer",XM(e,t,t.onFileProgress,n)},tN=function(e,t,n){$M(e,t,(function(t,i){if(t)n(t);else{var r=Qu(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){eN(""+ru(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new Ku(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},nN=function(e,t,n){eN(e,t,(function(e,t){if(e)n(e);else try{var i=Zu(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},iN=function(e,t,n){t.xhrResponseType="text",XM(e,t,t.onFileProgress,n)},rN=function(e,t,n){var i=ou(e),r=e;QM.test(r)||(r=-1!==oN.remoteBundles.indexOf(i)?oN.remoteServerAddress+"remote/"+i:"assets/"+i);var o=t.version||oN.bundleVers[i],a=0,s=null,c=null;$M(r+"/config."+(o?o+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++a&&n(c,s)})),KM(r+"/index."+(o?o+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},oN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=qM,this.downloadDomAudio=null,this.downloadFile=XM,this.downloadScript=KM,this._downloaders={".png":ZM,".jpg":ZM,".bmp":ZM,".jpeg":ZM,".gif":ZM,".ico":ZM,".tiff":ZM,".webp":ZM,".image":ZM,".pvr":eN,".pkm":eN,".astc":eN,".txt":iN,".xml":iN,".vsh":iN,".fsh":iN,".atlas":iN,".tmx":iN,".tsx":iN,".json":$M,".ExportJson":$M,".plist":iN,".ccon":tN,".cconb":nN,".fnt":iN,".binary":eN,".bin":eN,".dbbin":eN,".skel":eN,".js":KM,bundle:rN,default:iN},this._downloading=new tl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?Re(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var o=this,a=ol.get(e);if(a)r(null,a);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;BM((function(n,a){if(0===n&&o._downloading.add(e,[r]),o.limited){o._updateTime();var s=function(e,t){o._totalNum--,o._handleQueueInNextFrame(h,_),a(e,t)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(LM(t,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(LM(t,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||ol.add(e,n);for(var i=o._downloading.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){T.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=T.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(LM(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(lt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},c(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function aN(e,t,n,i){var r=null,o=null;try{(r=new bm)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}i(o,r)}function sN(e,t,n,i){var r=new hD;r.json=t,i(null,r)}function cN(e,t,n,i){var r=new uD;r.text=t,i(null,r)}function lN(e,t,n,i){var r=new hb;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function uN(e,t,n,i){var r=new pu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function hN(e,n,i,r){var o=sl.get(n.name);o||(o=n.name===hl.RESOURCES?WM:new jM,n.base=n.base||e+"/",o.init(n)),t.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var _N=new(function(){function e(){this._creating=new tl,this._producers={".png":aN,".jpg":aN,".bmp":aN,".jpeg":aN,".gif":aN,".ico":aN,".tiff":aN,".webp":aN,".image":aN,".pvr":aN,".pkm":aN,".txt":cN,".xml":cN,".vsh":cN,".fsh":cN,".atlas":cN,".tmx":cN,".tsx":cN,".fnt":cN,".json":sN,".ExportJson":sN,".binary":lN,".bin":lN,".dbbin":lN,".skel":lN,bundle:hN,default:uN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?qe.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=rl.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),a(e,t,i,(function(t,n){!t&&n instanceof pu&&(n._uuid=e,zM(e,n,i.cacheAsset));for(var r=o._creating.remove(e),a=0,s=r.length;a<s;a++)r[a](t,n)})))}else r(null,s)},e}()),fN=new(function(){function e(){this._loading=new tl,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=qe.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(K(5304,e[0]));vh(e,!0,void 0,yh.reportMissingClass),gh(e);for(var t=new xh(e[0]),n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,r,o);return a}(t)).length!==e.length&&W(4915);for(var a=0;a<e.length;a++)r[e[a]+"@import"]=t[a]}else{var s=qe._getClassId(Km),c=qe._getClassId(bm);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&W(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=Sh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&W(4915);for(var _=0;_<e.length;_++)r[e[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?qe.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(ol.has(e.id))n(null,ol.get(e.id));else{var r=e.info.packs,o=r.find((function(e){return i._loading.has(e.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:e.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:e.id}]);var a=El(o.uuid,{ext:o.ext,bundle:e.config.name});oN.download(o.uuid,a,o.ext,e.options,(function(t,n){ol.remove(o.uuid),t&&N(t.message,t.stack),i.unpack(o.packedUuids,n,o.ext,e.options,(function(e,n){if(!e)for(var r in n)ol.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else oN.download(e.id,e.url,e.ext,e.options,n)},e}());function dN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress,o=[],a=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],UM(e.input,(function(i,c){if(!i.isNative&&rl.has(i.uuid)){var l=rl.get(i.uuid);return i.content=l.addRef(),e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i),void c()}fN.load(i,e.options,(function(l,u){l?e.isFinish||(!T.assetManager.force||n?(N(l.message,l.stack),r.canInvoke=!1,t(l)):(e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i))):e.isFinish||(i.file=u,e.output.push(i),i.isNative||(s[i.uuid]=!0,FM(i.uuid,u,s,o,i.config),r.total=a+o.length),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i)),c()}))}),(function(){if(e.isFinish)return NM(e,!0),void e.dispatch("error");if(o.length>0){var a=fl.create({input:o,progress:r,options:i,onProgress:e.onProgress,onError:fl.prototype.recycle,onComplete:function(i){var r;i||((r=e.output).push.apply(r,a.output),a.recycle()),n&&pN(e),t(i)}});ll.async(a)}else n&&pN(e),t()}))}function pN(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var mN=new(function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return V(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function vN(e,t){return e[t]<<8|e[t+1]}var gN=new(function(){function e(){this._parsing=new tl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=vN(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=vN(a,12),l=vN(a,14);vN(a,8),vN(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?im.RGBA_ASTC_4x4:5===e?4===t?im.RGBA_ASTC_5x4:im.RGBA_ASTC_5x5:6===e?5===t?im.RGBA_ASTC_6x5:im.RGBA_ASTC_6x6:8===e?5===t?im.RGBA_ASTC_8x5:6===t?im.RGBA_ASTC_8x6:im.RGBA_ASTC_8x8:10===e?5===t?im.RGBA_ASTC_10x5:6===t?im.RGBA_ASTC_10x6:8===t?im.RGBA_ASTC_10x8:im.RGBA_ASTC_10x10:10===t?im.RGBA_ASTC_12x10:im.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=mN.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=Im(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?Re(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var o=this,a=al.get(e);if(a)r(null,a);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?ol.remove(e):Sl(n)||al.add(e,n);for(var i=o._parsing.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))):r(null,t)}}},e}());function yN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],UM(e.input,(function(o,a){var s=fl.create({input:o,onProgress:e.onProgress,options:i,progress:r,onComplete:function(i,c){i&&!e.isFinish&&(!T.assetManager.force||n?(N(i.message,i.stack),r.canInvoke=!1,t(i)):r.canInvoke&&e.dispatch("progress",++r.finish,r.total,o)),e.output.push(c),s.recycle(),a(null)}});xN.async(s)}),(function(){if(i.__exclude__=null,e.isFinish)return NM(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),NM(e,!0),t()}))}var xN=new nl("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&rl.has(o)?t():fN.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)gN.parse(o,a,n.ext,s,(function(r,a){r?t(r):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),ol.remove(o),al.remove(o),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||HM(c,c,r)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&rl.has(c)){var d=rl.get(c);n.content=d.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,gN.parse(o,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),FM(a,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var _=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=fl.create({input:h,options:e.options,onProgress:e.onProgress,onError:fl.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=g(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof pu?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=Pm.get(t);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(N("The asset "+a.uuid+" is missing!"),a.type&&a.type!==pu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}Pm.delete(t)}Rm.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Rm.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||wm.has(t)||Rm.has(t)||(t.onLoaded(),wm.add(t))}catch(e){N("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}ol.remove(s),al.remove(s),zM(a,t,u),f.recycle()}for(var l=_.callbacks,h=0,d=l.length;h<d;h++){var p=l[h];t.addRef&&t.addRef(),p.item.content=t,p.done(e)}l.length=0}});cl.async(f)}(e,i,t)}))}}]);function SN(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case il.PATH:case il.UUID:case il.DIR:case il.SCENE:case il.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}e.options=r;var a=fl.create({input:e.input,options:i}),s=null;try{e.output=e.source=ul.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var TN=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},c(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();TN.MAX_DEAD_NUM=500,TN._deadPool=[];var EN=[];function CN(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,o=n[i],a=TN.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||il.UUID]=n[i]),"object"==typeof o)for(var l in Pe(o,t),o.preset&&Pe(o,_l[o.preset]),o){switch(l){case il.UUID:if("break"===function(){var e,t=a.uuid=gl(o.uuid);if(!o.bundle){var n=sl.find((function(e){return!!e.getAssetInfo(t)}));o.bundle=n&&n.name}if(sl.has(o.bundle)){if(s=sl.get(o.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!sl.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=sl.get(c.redirect).config,c=s.getAssetInfo(t)}a.config=s,a.info=c}return a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case il.DIR:if(sl.has(o.bundle)){sl.get(o.bundle).config.getDirWithPath(o.dir,o.type,EN);for(var u,h=g(EN);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}EN.length=0}a.recycle(),a=null;break;case il.PATH:if(sl.has(o.bundle)){if(s=sl.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!sl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=sl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case il.SCENE:if(!o.bundle){var f=sl.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(sl.has(o.bundle)){if(s=sl.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!sl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=sl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case il.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||iu(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function AN(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var r,o,a=i.config;o=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:T.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:T.assetManager.generalImportBase;var s=i.uuid,c="";i.info&&(c=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?o+"/"+s.slice(0,2)+"/"+s+c+"/"+i.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+c+i.ext,i.url=r}}return null}var bN,PN,RN,wN,IN,DN,ON,MN,NN,LN,BN,FN,zN,UN,kN=e("AssetManager",function(){function e(){this.pipeline=cl.append(SN).append(yN),this.fetchPipeline=ll.append(SN).append(dN),this.transformPipeline=ul.append(CN).append(AN),this.bundles=sl,this.assets=rl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Om,this.force=!1,this.allowImageBitmap=!qu.isMobile,this.utils=Cl,this.downloader=oN,this.parser=gN,this.packManager=fN,this.cacheAsset=!0,this.cacheManager=null,this.presets=_l,this.factory=_N,this.preprocessPipe=SN,this.fetchPipe=dN,this.loadPipe=yN,this.references=null,this._releaseManager=MM,this._files=ol,this._parsed=al,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return sl.get(e)||null},t.removeBundle=function(e){e._destroy(),sl.remove(e.name)},t.loadAny=function(e,t,n,i){var r=kM(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",e=Array.isArray(e)?e.slice():e;var c=fl.create({input:e,onProgress:a,onComplete:VM(s),options:o});cl.async(c)},t.preloadAny=function(e,t,n,i){var r=kM(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=fl.create({input:e,onProgress:a,onComplete:VM(s),options:o});ll.async(c)},t.loadRemote=function(e,t,n){var i=kM(t,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(N(t.message,t.stack),o&&o(t,n)):_N.create(e,n,r.ext||iu(e),r,(function(e,t){o&&o(e,t)}))}))):VM(o)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=kM(t,void 0,n),r=i.options,o=i.onComplete,a=ou(e);this.bundles.has(a)?VM(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(N(t.message,t.stack),o&&o(t,n)):_N.create(e,n,"bundle",r,(function(e,t){o&&o(e,t)}))})))},t.releaseAsset=function(e){MM.tryRelease(e,!0)},t.releaseUnusedAssets=function(){rl.forEach((function(e){MM.tryRelease(e)}))},t.releaseAll=function(){rl.forEach((function(e){MM.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},c(e,[{key:"main",get:function(){return sl.get(hl.MAIN)||null}},{key:"resources",get:function(){return sl.get(hl.RESOURCES)||null}}]),e}());kN.Pipeline=nl,kN.Task=fl,kN.Cache=tl,kN.RequestItem=TN,kN.Bundle=jM,kN.BuiltinBundleName=hl,e("assetManager",T.assetManager=new kN),T.AssetManager=kN;var GN,HN,VN,jN,WN,qN,XN,YN,KN,QN,ZN,JN,$N,eL,tL,nL,iL,rL,oL,aL,sL,cL,lL,uL,hL,_L,fL,dL,pL,mL,vL,gL,yL,xL,SL,TL,EL,CL,AL,bL,PL,RL,wL,IL,DL,OL,ML,NL,LL,BL,FL,zL,UL,kL,GL,HL,VL,jL,WL,qL,XL,YL,KL,QL,ZL,JL,$L,eB=e("EventHandler",(bN=$s("cc.ClickEvent"),PN=Mc(T.Node),RN=xc(),wN=xc(),IN=xc(),DN=xc(),bN((UN=function(){function e(){y(this,"target",NN,this),y(this,"component",LN,this),y(this,"_componentId",BN,this),y(this,"handler",FN,this),y(this,"customEventData",zN,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=t.length;o<a;o++){var s=t[o];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(T.isValid(t)){this._genCompIdIfNeeded();var n=T.js._getClassById(this._componentId),i=t.getComponent(n);if(T.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(i,e))}}},t._compName2Id=function(e){var t=T.js.getClassByName(e);return T.js._getClassId(t)},t._compId2Name=function(e){var t=T.js._getClassById(e);return T.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},c(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),NN=x((MN=UN).prototype,"target",[oc,PN,oc,RN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LN=x(MN.prototype,"component",[oc,mc,wN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),BN=x(MN.prototype,"_componentId",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),FN=x(MN.prototype,"handler",[oc,mc,IN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zN=x(MN.prototype,"customEventData",[oc,mc,DN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ON=MN))||ON));T.Component.EventHandler=eB;var tB,nB,iB,rB,oB,aB,sB,cB,lB,uB,hB=new dn,_B=Ye(wv),fB=Ye(Rv),dB=Ye(Iv),pB=Ye(Ov),mB=Ye(Dv),vB=Ye({SKYBOX:Gv|Bi.DEPTH_STENCIL,SOLID_COLOR:Bi.ALL,DEPTH_ONLY:Bi.DEPTH_STENCIL,DONT_CLEAR:Bi.NONE}),gB=e("Camera",(GN=$s("cc.Camera"),HN=pc(),VN=hc(),jN=bc(),WN=xc(),qN=Mc(sd.BitMask),XN=bc(),YN=xc(),KN=Mc(vB),QN=bc(),ZN=xc(),JN=bc(),$N=xc(),eL=bc(),tL=xc(),nL=bc(),iL=xc(),rL=Mc(_B),oL=bc(),aL=xc(),sL=Mc(fB),cL=bc(),lL=xc(),uL=bc(),hL=xc(),_L=bc(),fL=xc(),dL=bc(),pL=xc(),mL=bc(),vL=xc(),gL=Mc(dB),yL=bc(),xL=xc(),SL=Mc(pB),TL=bc(),EL=xc(),CL=Mc(mB),AL=bc(),bL=xc(),PL=bc(),RL=xc(),wL=Mc(hS),IL=bc(),DL=xc(),GN(OL=HN(OL=VN(OL=uc(($L=JL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_projection",NL,m(t)),y(t,"_priority",LL,m(t)),y(t,"_fov",BL,m(t)),y(t,"_fovAxis",FL,m(t)),y(t,"_orthoHeight",zL,m(t)),y(t,"_near",UL,m(t)),y(t,"_far",kL,m(t)),y(t,"_color",GL,m(t)),y(t,"_depth",HL,m(t)),y(t,"_stencil",VL,m(t)),y(t,"_clearFlags",jL,m(t)),y(t,"_rect",WL,m(t)),y(t,"_aperture",qL,m(t)),y(t,"_shutter",XL,m(t)),y(t,"_iso",YL,m(t)),y(t,"_screenScale",KL,m(t)),y(t,"_visibility",QL,m(t)),y(t,"_targetTexture",ZL,m(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}u(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=wg.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=zo.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new dn),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new dn),!this._camera)return n;this.worldToScreen(e,hB);var i=t.getComponent("cc.UITransform"),r=fM.getVisibleSize(),o=hB.x-.5*this._camera.width,a=hB.y-.5*this._camera.height;return hB.x=o/T.view.getScaleX()+.5*r.width,hB.y=a/T.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(hB,n),n},n._createCamera=function(){this._camera||(this._camera=T.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?T.director.root&&T.director.root.mainWindow:T.director.root&&T.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=Jt(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},c(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Rv.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=Jt(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?T.director.root&&T.director.root.mainWindow:T.director.root&&T.director.root.tempWindow)}}]),t}(Bu),JL.ProjectionType=_B,JL.FOVAxis=fB,JL.ClearFlag=vB,JL.Aperture=dB,JL.Shutter=pB,JL.ISO=mB,JL.TARGET_TEXTURE_CHANGE="tex-change",NL=x((ML=$L).prototype,"_projection",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _B.PERSPECTIVE}}),LL=x(ML.prototype,"_priority",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BL=x(ML.prototype,"_fov",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),FL=x(ML.prototype,"_fovAxis",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fB.VERTICAL}}),zL=x(ML.prototype,"_orthoHeight",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),UL=x(ML.prototype,"_near",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kL=x(ML.prototype,"_far",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),GL=x(ML.prototype,"_color",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn("#333333")}}),HL=x(ML.prototype,"_depth",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),VL=x(ML.prototype,"_stencil",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jL=x(ML.prototype,"_clearFlags",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vB.SOLID_COLOR}}),WL=x(ML.prototype,"_rect",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hn(0,0,1,1)}}),qL=x(ML.prototype,"_aperture",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dB.F16_0}}),XL=x(ML.prototype,"_shutter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pB.D125}}),YL=x(ML.prototype,"_iso",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mB.ISO100}}),KL=x(ML.prototype,"_screenScale",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),QL=x(ML.prototype,"_visibility",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tp}}),ZL=x(ML.prototype,"_targetTexture",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x(ML.prototype,"priority",[jN,WN],Object.getOwnPropertyDescriptor(ML.prototype,"priority"),ML.prototype),x(ML.prototype,"visibility",[qN,XN,YN],Object.getOwnPropertyDescriptor(ML.prototype,"visibility"),ML.prototype),x(ML.prototype,"clearFlags",[KN,QN,ZN],Object.getOwnPropertyDescriptor(ML.prototype,"clearFlags"),ML.prototype),x(ML.prototype,"clearColor",[JN,$N],Object.getOwnPropertyDescriptor(ML.prototype,"clearColor"),ML.prototype),x(ML.prototype,"clearDepth",[eL,tL],Object.getOwnPropertyDescriptor(ML.prototype,"clearDepth"),ML.prototype),x(ML.prototype,"clearStencil",[nL,iL],Object.getOwnPropertyDescriptor(ML.prototype,"clearStencil"),ML.prototype),x(ML.prototype,"projection",[rL,oL,aL],Object.getOwnPropertyDescriptor(ML.prototype,"projection"),ML.prototype),x(ML.prototype,"fovAxis",[sL,cL,lL],Object.getOwnPropertyDescriptor(ML.prototype,"fovAxis"),ML.prototype),x(ML.prototype,"fov",[uL,hL],Object.getOwnPropertyDescriptor(ML.prototype,"fov"),ML.prototype),x(ML.prototype,"orthoHeight",[_L,fL],Object.getOwnPropertyDescriptor(ML.prototype,"orthoHeight"),ML.prototype),x(ML.prototype,"near",[dL,pL],Object.getOwnPropertyDescriptor(ML.prototype,"near"),ML.prototype),x(ML.prototype,"far",[mL,vL],Object.getOwnPropertyDescriptor(ML.prototype,"far"),ML.prototype),x(ML.prototype,"aperture",[gL,yL,xL],Object.getOwnPropertyDescriptor(ML.prototype,"aperture"),ML.prototype),x(ML.prototype,"shutter",[SL,TL,EL],Object.getOwnPropertyDescriptor(ML.prototype,"shutter"),ML.prototype),x(ML.prototype,"iso",[CL,AL,bL],Object.getOwnPropertyDescriptor(ML.prototype,"iso"),ML.prototype),x(ML.prototype,"rect",[PL,RL],Object.getOwnPropertyDescriptor(ML.prototype,"rect"),ML.prototype),x(ML.prototype,"targetTexture",[wL,IL,DL],Object.getOwnPropertyDescriptor(ML.prototype,"targetTexture"),ML.prototype),OL=ML))||OL)||OL)||OL)||OL));T.Camera=gB;var yB,xB,SB,TB,EB,CB,AB,bB,PB={parent:null,owner:null,subModelIdx:0},RB=e("RenderableComponent",(tB=$s("cc.RenderableComponent"),nB=Mc([Nv]),iB=Mc(Nv),rB=bc(),oB=yc(),tB((uB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_materials",cB,m(t)),y(t,"_visFlags",lB,m(t)),t._materialInstances=[],t._models=[],t}u(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof kS&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){PB.parent=this._materials[e],PB.owner=this,PB.subModelIdx=e;var t=new kS(PB);PB.parent=null,PB.owner=null,PB.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){V(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},c(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(e[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}}]),t}(Bu),cB=x((sB=uB).prototype,"_materials",[nB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lB=x(sB.prototype,"_visFlags",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sd.Enum.NONE}}),x(sB.prototype,"sharedMaterials",[iB,rB,oB],Object.getOwnPropertyDescriptor(sB.prototype,"sharedMaterials"),sB.prototype),aB=sB))||aB));function wB(e){return"string"==typeof e||"number"==typeof e}T.RenderableComponent=RB;var IB,DB,OB,MB,NB,LB,BB,FB,zB,UB,kB,GB,HB,VB,jB,WB,qB,XB,YB,KB,QB,ZB,JB=$s("cc.animation.HierarchyPath")((TB=function(){function e(e){y(this,"path",SB,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof TA?e.getChildByPath(this.path)||(V(3926,e.name,this.path),null):(V(3925),null)},e}(),SB=x((xB=TB).prototype,"path",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yB=xB))||yB,$B=$s("cc.animation.ComponentPath")((bB=function(){function e(e){y(this,"component",AB,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof TA?e.getComponent(this.component)||(V(3928,e.name,this.component),null):(V(3927),null)},e}(),AB=x((CB=bB).prototype,"component",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),EB=CB))||EB,eF=$s("cc.animation.UniformProxyFactory")((LB=function(){function e(e,t){y(this,"passIndex",OB,this),y(this,"uniformName",MB,this),y(this,"channelIndex",NB,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(hv.getTypeFromHandle(n)<ii.SAMPLER1D){var i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,ii.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=g(e.shaderInfo.blocks);!(n=i()).done;)for(var r,o=g(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(i,e)}}:{set:function(e){t.setUniform(i,e)}}}var r=hv.getBindingFromHandle(n),o=t.properties[this.uniformName],a=o&&o.value?o.value+"-texture":zp(o.type),s=rv.get(a);return s||(M("Illegal texture default value: "+a+"."),s=rv.get("default-texture")),{set:function(e){e||(e=s);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(r,n),e instanceof Cm&&t.bindSampler(r,T.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),OB=x((DB=LB).prototype,"passIndex",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MB=x(DB.prototype,"uniformName",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),NB=x(DB.prototype,"channelIndex",[Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),IB=DB))||IB,tF=$s("cc.animation.MorphWeightValueProxy")((kB=function(){function e(){y(this,"subMeshIndex",zB,this),y(this,"shapeIndex",UB,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),zB=x((FB=kB).prototype,"subMeshIndex",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UB=x(FB.prototype,"shapeIndex",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BB=FB))||BB,nF=$s("cc.animation.MorphWeightsValueProxy")((jB=function(){function e(){y(this,"subMeshIndex",VB,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),VB=x((HB=jB).prototype,"subMeshIndex",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GB=HB))||GB,iF=$s("cc.animation.MorphWeightsAllValueProxy")(WB=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)e.setWeights(t,o)}}},e}())||WB;function rF(e,t,n,i){var r,o,a,s,c,l,u=new t,h=new t,_=new t,f=$s(e)((l=function(){function e(e,n,i){y(this,"dataPoint",a,this),y(this,"inTangent",s,this),y(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var o=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,r),_=n(_,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,d=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,d)},r.getNoLerp=function(){return this.dataPoint},e}(),a=x((o=l).prototype,"dataPoint",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=x(o.prototype,"inTangent",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=x(o.prototype,"outTangent",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=o))||r;if(t===Pn){var d=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=d.call(this,e,t,n);return Pn.normalize(i,i),i}}return f}var oF=e("CubicSplineVec2Value",rF("cc.CubicSplineVec2Value",gn,gn.multiplyScalar,gn.scaleAndAdd));T.CubicSplineVec2Value=oF;var aF=e("CubicSplineVec3Value",rF("cc.CubicSplineVec3Value",dn,dn.multiplyScalar,dn.scaleAndAdd));T.CubicSplineVec3Value=aF;var sF=e("CubicSplineVec4Value",rF("cc.CubicSplineVec4Value",Tn,Tn.multiplyScalar,Tn.scaleAndAdd));T.CubicSplineVec4Value=sF;var cF=e("CubicSplineQuatValue",rF("cc.CubicSplineQuatValue",Pn,Pn.multiplyScalar,Pn.scaleAndAdd));T.CubicSplineQuatValue=cF;var lF=e("CubicSplineNumberValue",$s("cc.CubicSplineNumberValue")((ZB=function(){function e(e,t,n){y(this,"dataPoint",YB,this),y(this,"inTangent",KB,this),y(this,"outTangent",QB,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*n*(o-a)},t.getNoLerp=function(){return this.dataPoint},e}(),YB=x((XB=ZB).prototype,"dataPoint",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KB=x(XB.prototype,"inTangent",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QB=x(XB.prototype,"outTangent",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qB=XB))||qB);T.CubicSplineNumberValue=lF;var uF,hF,_F,fF,dF,pF,mF,vF,gF,yF,xF,SF,TF,EF,CF,AF,bF,PF,RF,wF,IF,DF,OF,MF,NF,LF,BF,FF=Symbol("CreateEval"),zF=Symbol("NormalizedFollow"),UF=Symbol("ConvertAsTrsPath"),kF=Symbol("TrackBinding"),GF=$s("cc.animation.TrackPath")((fF=function(){function e(){y(this,"_paths",_F,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new JB(e)),this},t.toComponent=function(e){var t=new $B("string"==typeof e?e:qe.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof JB},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof $B},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[zF](e,t,n)},t[UF]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var o=t[i];if(!(o instanceof JB))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[zF]=function(e,t,n){for(var i=this._paths,r=e,o=t;o<n;++o){var a=i[o];if(wB(a)){if(!(a in r))return V(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},c(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),_F=x((hF=fF).prototype,"_paths",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uF=hF))||uF,HF=$s("cc.animation.TrackBinding")(dF=lc((gF=function(){function e(){y(this,"path",mF,this),y(this,"proxy",vF,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[UF]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[zF](e,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return W(3921),null}var h,_=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),f=i[zF](e,0,o-1);return null===f?null:t&&f instanceof TA&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?t.createPoseWriter(f,_,n):{setValue:function(e){f[_]=e},getValue:function(){return f[_]}}},e}(),mF=x((pF=gF).prototype,"path",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GF}}),vF=x(pF.prototype,"proxy",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dF=pF))||dF)||dF,VF=$s("cc.animation.Track")((TF=function(){function e(){y(this,"_binding",SF,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=g(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},c(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:kF,get:function(){return this._binding}}]),e}(),SF=x((xF=TF).prototype,"_binding",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HF}}),yF=xF))||yF,jF=$s("cc.animation.Channel")((bF=function(){function e(e){this.name="",y(this,"_curve",AF,this),this._curve=e}return c(e,[{key:"curve",get:function(){return this._curve}}]),e}(),AF=x((CF=bF).prototype,"_curve",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),EF=CF))||EF,WF=$s("cc.animation.SingleChannelTrack")((IF=function(e){function t(){var t;return y(t=e.call(this)||this,"_channel",wF,m(t)),t._channel=new jF(t.createCurve()),t}u(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[FF]=function(){var e=this._channel.curve;return new qF(e)},c(t,[{key:"channel",get:function(){return this._channel}}]),t}(VF),wF=x((RF=IF).prototype,"_channel",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),PF=RF))||PF,qF=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),XF=$s("cc.animation.RealTrack")(DF=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.createCurve=function(){return new Z_},t}(WF))||DF;function YF(e){return 0===e.keyFramesCount?void 0:e}var KF,QF,ZF,JF,$F,ez,tz,nz,iz,rz,oz=["X","Y","Z","W"],az=$s("cc.animation.VectorTrack")((BF=function(e){function t(){var t;y(t=e.call(this)||this,"_channels",NF,m(t)),y(t,"_nComponents",LF,m(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new jF(new Z_);i.name=oz[n],t._channels[n]=i}return t}u(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[FF]=function(){switch(this._nComponents){default:case 2:return new sz(YF(this._channels[0].curve),YF(this._channels[1].curve));case 3:return new cz(YF(this._channels[0].curve),YF(this._channels[1].curve),YF(this._channels[2].curve));case 4:return new lz(YF(this._channels[0].curve),YF(this._channels[1].curve),YF(this._channels[2].curve),YF(this._channels[3].curve))}},c(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(VF),NF=x((MF=BF).prototype,"_channels",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),LF=x(MF.prototype,"_nComponents",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),OF=MF))||OF,sz=function(){function e(e,t){this._result=new gn,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||gn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),cz=function(){function e(e,t,n){this._result=new dn,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||dn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),lz=function(){function e(e,t,n,i){this._result=new Tn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Tn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),uz=$s("cc.animation.QuatTrack")(KF=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.createCurve=function(){return new zf},n[FF]=function(){return new hz(this.channels()[0].curve)},t}(WF))||KF,hz=function(){function e(e){this._result=new Pn,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),_z=["Red","Green","Blue","Alpha"],fz=$s("cc.animation.ColorTrack")(($F=function(e){function t(){var t;y(t=e.call(this)||this,"_channels",JF,m(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new jF(new Z_);i.name=_z[n],t._channels[n]=i}return t}u(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[FF]=function(){return new dz(YF(this._channels[0].curve),YF(this._channels[1].curve),YF(this._channels[2].curve),YF(this._channels[3].curve))},t}(VF),JF=x((ZF=$F).prototype,"_channels",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QF=ZF))||QF,dz=function(){function e(e,t,n,i){this._result=new Wn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Wn.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),pz=["Width","Height"],mz=$s("cc.animation.SizeTrack")((iz=function(e){function t(){var t;y(t=e.call(this)||this,"_channels",nz,m(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new jF(new Z_);i.name=pz[n],t._channels[n]=i}return t}u(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[FF]=function(){return new vz(YF(this._channels[0].curve),YF(this._channels[1].curve))},t}(VF),nz=x((tz=iz).prototype,"_channels",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ez=tz))||ez,vz=function(){function e(e,t){this._result=new kn,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),gz=$s("cc.animation.ObjectTrack")(rz=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t.prototype.createCurve=function(){return new $f},t}(WF))||rz;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:eF,MorphWeightValueProxy:tF,MorphWeightsValueProxy:nF,MorphWeightsAllValueProxy:iF,Track:VF,TrackPath:GF,RealTrack:XF,VectorTrack:az,QuatTrack:uz,ColorTrack:fz,SizeTrack:mz,ObjectTrack:gz,isPropertyPath:wB,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:JB,ComponentPath:$B,CubicSplineVec2Value:oF,CubicSplineVec3Value:aF,CubicSplineVec4Value:sF,CubicSplineQuatValue:cF,CubicSplineNumberValue:lF}));var yz=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,o=e.length;r<o;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?Ez:js}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());T.RatioSampler=yz;var xz=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(t.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=Oz(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-n,s=(e-n)/a;if(o&&(s=Tz(s,o)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function Sz(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function Tz(e,t){if("string"==typeof t){var n=F_[t];n?e=n(e):W(3906,t)}else Array.isArray(t)&&(e=Nf(t,e));return e}function Ez(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var o=(t=(t-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}xz.Linear=null,T.AnimCurve=xz,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),T.sampleAnimationCurve=Sz;var Cz,Az,bz,Pz,Rz,wz,Iz,Dz,Oz=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return Zt;if("object"==typeof t&&t.constructor){if(t instanceof Pn)return n=new Pn,function(e,t,i){return Pn.slerp(n,e,t,i)};if(t instanceof Je)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return Zt;if("function"==typeof t.lerp)return e}var n}}}(),Mz=Symbol("BakeNodeCurves"),Nz=e("SkelAnimDataHub",function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&T.director.root.dataPoolManager.releaseAnimationClip(t);var i=Math.ceil(t.sample*t.duration)+1,r=t.sample;n=t[Mz](0,r,i),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}());Nz.pool=new Map;var Lz=$s("cc.animation.UntypedTrackChannel")((Pz=function(e){function t(){var t;return y(t=e.call(this,new Z_)||this,"property",bz,m(t)),t}return u(t,e),t}(jF),bz=x((Az=Pz).prototype,"property",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Cz=Az))||Cz,Bz=$s("cc.animation.UntypedTrack")((Dz=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_channels",Iz,m(t)),t}u(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[FF]=function(e){var t=this;if(!e.getValue)throw new Error(K(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(K(3931));case i instanceof gn:return new sz(n("x"),n("y"));case i instanceof dn:return new cz(n("x"),n("y"),n("z"));case i instanceof Tn:return new lz(n("x"),n("y"),n("z"),n("w"));case i instanceof Wn:return new dz(n("r"),n("g"),n("b"),n("a"));case i instanceof kn:return new vz(n("width"),n("height"))}},n.addChannel=function(e){var t=new Lz;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new az;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new fz,h=u.channels(),_=h[0],f=h[1],d=h[2],p=h[3];return n("r",_),n("g",f),n("b",d),n("a",p),n("x",_),n("y",f),n("z",d),n("w",p),u;case"size":}return null},t}(VF),Iz=x((wz=Dz).prototype,"_channels",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rz=wz))||Rz,Fz=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(e,t,n){for(var i,r=new GF,o=g(t);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof JB?r.toHierarchy(a.path):a instanceof $B?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=n},a=r.map((function(e){var n=new Bz;return o(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new Uz(s,l.length),f=function(e){o(e,r.modifiers,r.valueAdapter)},d=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return V(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return V(3933),"continue";var p=r.modifiers[0],m=a[r.commonTarget].addChannel(p).curve;d=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void V(3934);var e;if(d)e=d;else{var n=new XF;f(n),t.push(n),e=n.channel.curve}var i=h?kc.LINEAR:kc.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void _.convert(e)}if("object"==typeof u)switch(!0){default:break;case zz(c,gn):case zz(c,dn):case zz(c,Tn):var r=u instanceof gn?2:u instanceof dn?3:4,o=new az;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,p=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?kc.LINEAR:kc.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),_.convert(s),p.assignSorted(l,c.map((function(e){return y(e.y)}))),_.convert(p)}return void t.push(o);case zz(c,Pn):var x=new uz;f(x);var S=h?Pf.SLERP:Pf.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(e){return{value:Pn.clone(e),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void t.push(x);case zz(c,Wn):var T=new fz;f(T);var E=T.channels(),C=E[0].curve,A=E[1].curve,b=E[2].curve,P=E[3].curve,R=h?kc.LINEAR:kc.CONSTANT,w=function(e){return{value:e,interpolationMode:R}};return C.assignSorted(l,c.map((function(e){return w(e.r)}))),_.convert(C),A.assignSorted(l,c.map((function(e){return w(e.g)}))),_.convert(A),b.assignSorted(l,c.map((function(e){return w(e.b)}))),_.convert(b),P.assignSorted(l,c.map((function(e){return w(e.a)}))),_.convert(P),void t.push(T);case zz(c,kn):var I=new mz;f(I);var D=I.channels(),O=D[0].curve,M=D[1].curve,N=h?kc.LINEAR:kc.CONSTANT,L=function(e){return{value:e,interpolationMode:N}};return O.assignSorted(l,c.map((function(e){return L(e.width)}))),_.convert(O),M.assignSorted(l,c.map((function(e){return L(e.height)}))),_.convert(M),void t.push(I);case zz(c,lF):var B=new XF;f(B);var F=h?kc.CUBIC:kc.CONSTANT;return B.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:F}}))),void t.push(B);case zz(c,oF):case zz(c,aF):case zz(c,sF):var z=u instanceof oF?2:u instanceof aF?3:4,U=new az;f(U),U.componentsCount=z;var k=U.channels(),G=k[0],H=k[1],j=k[2],W=k[3],q=h?kc.LINEAR:kc.CONSTANT,X=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:q}};switch(z){case 4:W.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:G.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),H.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(U);case c.every((function(e){return e instanceof cF})):V(3935)}var Y=new gz;f(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=g(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new yz(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new xz(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},c(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function zz(e,t){return e.every((function(e){return e instanceof t}))}var Uz=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S,T,E=this._easingMethods;if(E){var C=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(E)&&E.length;for(var A=C-1,b=0;b<A;++b){var P=E[b];P&&(Array.isArray(P)?(t=P,n=e.getKeyframeTime(b),i=e.getKeyframeValue(b),r=e.getKeyframeTime(b+1),o=e.getKeyframeValue(b+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,d=void 0,p=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,T=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(p=c*f)/(d=s*_),x=Math.sqrt(d*d+p*p)*g,S=v/m,T=Math.sqrt(m*m+v*v)*g,i.interpolationMode=kc.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===Hc.NONE?Hc.RIGHT:a===Hc.LEFT?Hc.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(e){return e===Hc.NONE?Hc.LEFT:e===Hc.RIGHT?Hc.BOTH:e}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=T):kz(P,e,b))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var o=t[r];o&&(Array.isArray(o)?e.getKeyframeValue(r).easingMethod=o.slice():Gz(o,e,r))}}}},c(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function kz(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=vU[e];r===B_.CONSTANT?i.interpolationMode=kc.CONSTANT:(i.interpolationMode=kc.LINEAR,i.easingMethod=r)}function Gz(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=vU[e];i.easingMethod=r}var Hz,Vz,jz,Wz,qz,Xz,Yz,Kz,Qz,Zz,Jz,$z,eU,tU,nU,iU,rU,oU,aU,sU,cU,lU,uU,hU,_U,fU,dU,pU,mU,vU={constant:B_.CONSTANT,linear:B_.LINEAR,quadIn:B_.QUAD_IN,quadOut:B_.QUAD_OUT,quadInOut:B_.QUAD_IN_OUT,quadOutIn:B_.QUAD_OUT_IN,cubicIn:B_.CUBIC_IN,cubicOut:B_.CUBIC_OUT,cubicInOut:B_.CUBIC_IN_OUT,cubicOutIn:B_.CUBIC_OUT_IN,quartIn:B_.QUART_IN,quartOut:B_.QUART_OUT,quartInOut:B_.QUART_IN_OUT,quartOutIn:B_.QUART_OUT_IN,quintIn:B_.QUINT_IN,quintOut:B_.QUINT_OUT,quintInOut:B_.QUINT_IN_OUT,quintOutIn:B_.QUINT_OUT_IN,sineIn:B_.SINE_IN,sineOut:B_.SINE_OUT,sineInOut:B_.SINE_IN_OUT,sineOutIn:B_.SINE_OUT_IN,expoIn:B_.EXPO_IN,expoOut:B_.EXPO_OUT,expoInOut:B_.EXPO_IN_OUT,expoOutIn:B_.EXPO_OUT_IN,circIn:B_.CIRC_IN,circOut:B_.CIRC_OUT,circInOut:B_.CIRC_IN_OUT,circOutIn:B_.CIRC_OUT_IN,elasticIn:B_.ELASTIC_IN,elasticOut:B_.ELASTIC_OUT,elasticInOut:B_.ELASTIC_IN_OUT,elasticOutIn:B_.ELASTIC_OUT_IN,backIn:B_.BACK_IN,backOut:B_.BACK_OUT,backInOut:B_.BACK_IN_OUT,backOutIn:B_.BACK_OUT_IN,bounceIn:B_.BOUNCE_IN,bounceOut:B_.BOUNCE_OUT,bounceInOut:B_.BOUNCE_IN_OUT,bounceOutIn:B_.BOUNCE_OUT_IN,smooth:B_.SMOOTH,fade:B_.FADE};function gU(){throw new Error("split() only valid in Editor.")}$s("cc.animation.ExoticAnimation")((jz=function(){function e(){y(this,"_nodeAnimations",Vz,this)}var t=e.prototype;return t.createEvaluator=function(e){return new RU(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new yU(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return gU()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),Vz=x((Hz=jz).prototype,"_nodeAnimations",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hz));var yU=$s("cc.animation.ExoticNodeAnimation")((Zz=function(){function e(e){y(this,"_path",Xz,this),y(this,"_position",Yz,this),y(this,"_rotation",Kz,this),y(this,"_scale",Qz,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new AU(e,new EU(t))},t.createRotation=function(e,t){this._rotation=new AU(e,new CU(t))},t.createScale=function(e,t){this._scale=new AU(e,new EU(t))},t.createEvaluator=function(e){return new wU(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return gU()},t.toHashString=function(){var e,t,n,i,r,o;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},c(e,[{key:"path",get:function(){return this._path}}]),e}(),Xz=x((qz=Zz).prototype,"_path",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yz=x(qz.prototype,"_position",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kz=x(qz.prototype,"_rotation",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qz=x(qz.prototype,"_scale",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wz=qz))||Wz;function xU(e){return e.toPrecision(2)}function SU(e){return e.map(xU).join(" ")}var TU=$s("cc.animation.ExoticVectorLikeTrackValues")((nU=function(){function e(e){y(this,"_values",eU,this),y(this,"_isQuantized",tU,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=DU[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),o=Math.max(e,o)}));var a=o-r,s=n.from(e,(function(e){return(e-r)/a*i}));return new qU(OU(e),s,a,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():SU(t))},c(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:OU(this._values)}}]),e}(),eU=x(($z=nU).prototype,"_values",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),tU=x($z.prototype,"_isQuantized",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Jz=$z))||Jz,EU=$s("cc.animation.ExoticVec3TrackValues")(iU=function(e){function t(){return e.apply(this,arguments)||this}u(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?KU(n,e,t):dn.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(KU(a,e,i),KU(a,t,r)):(dn.fromArray(i,a,3*e),dn.fromArray(r,a,3*t)),dn.lerp(o,i,r,n)},t}(TU))||iU,CU=$s("cc.animation.ExoticQuatTrackValues")(rU=function(e){function t(){return e.apply(this,arguments)||this}u(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?QU(n,e,t):Pn.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(QU(a,e,i),QU(a,t,r)):(Pn.fromArray(i,a,4*e),Pn.fromArray(r,a,4*t)),Pn.slerp(o,i,r,n)},t}(TU))||rU,AU=$s("cc.animation.ExoticTrack")((lU=function(){function e(e,t){y(this,"times",sU,this),y(this,"values",cU,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+SU(e)+"; values: "+t.toHashString()},e}(),sU=x((aU=lU).prototype,"times",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cU=x(aU.prototype,"values",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),oU=aU))||oU;function bU(e,t){e.length,e.length;var n=0,i=0,r=js(e,t);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=e[o],c=e[a];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],o=e[i-1],a=Kt(t,r,o),s=Kt(n,r,o);this._timeOffset=a;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=bU(e,t),o=r.index,a=r.ratio,s=bU(e,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(e,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,d=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,d||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},c(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var PU,RU=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),wU=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=YU(t.times,t.values,dn,e,"position",r)),n&&(this._rotation=YU(n.times,n.values,Pn,e,"rotation",r)),i&&(this._scale=YU(i.times,i.values,dn,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),IU=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],o=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>o)n.just=!0,n.index=i-1;else{var a=js(e,t);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),DU={uint8:Uint8Array,uint16:Uint16Array};function OU(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return PU.FLOAT_32;case 8:return PU.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(PU||(PU={}));var MU,NU,LU,BU,FU,zU,UU,kU,GU,HU,VU,jU,WU,qU=$s("cc.animation.QuantizedFloatArray")((mU=function(){function e(e,t,n,i){void 0===i&&(i=0),y(this,"originalPrecision",_U,this),y(this,"min",fU,this),y(this,"extent",dU,this),y(this,"values",pU,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+xU(t)+" "+xU(n)+" "+i.join(" ")},c(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),_U=x((hU=mU).prototype,"originalPrecision",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fU=x(hU.prototype,"min",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dU=x(hU.prototype,"extent",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pU=x(hU.prototype,"values",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uU=hU))||uU;function XU(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function YU(e,t,n,i,r,o){var a=new HF;a.path=(new GF).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new IU(e,t,n)}:null}function KU(e,t,n){dn.set(n,XU(e,3*t+0),XU(e,3*t+1),XU(e,3*t+2))}function QU(e,t,n){Pn.set(n,XU(e,4*t+0),XU(e,4*t+1),XU(e,4*t+2),XU(e,4*t+3))}var ZU=Symbol("SearchForRootBonePath"),JU=Symbol("ExoticAnimation"),$U=e("AnimationClip",$s("cc.AnimationClip")((WU=jU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"sample",LU,m(t)),y(t,"speed",BU,m(t)),y(t,"wrapMode",FU,m(t)),y(t,"enableTrsBlending",zU,m(t)),y(t,"_duration",UU,m(t)),y(t,"_hash",kU,m(t)),t.frameRate=0,y(t,"_tracks",GU,m(t)),y(t,"_exoticAnimation",HU,m(t)),t._legacyData=void 0,t._legacyDataDirty=!1,y(t,"_events",VU,m(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}u(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,o=new gz;return o.path=(new GF).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(o),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new sk(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=T.director.root)||void 0===t?void 0:t.dataPoolManager)&&T.director.root.dataPoolManager.releaseAnimationClip(this),Nz.destroy(this),e.prototype.destroy.call(this)},n[Mz]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Ln}))};var c=r.reduce((function(e,t){return e[t]=new nk,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var d=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return ak(n,t.property)}}),void 0),p=0;p<n;++p){var m=e+i*p;d.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Ln.copy(a[g].transforms[p],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:t,frames:n,joints:a}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof Bz){var s=a.upgrade(e);s&&(t.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)We.remove(i,n[l]);i.push.apply(i,t)},n[ZU]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[kF]);if(h){var _=u[FF](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new ek(a,o,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof TA){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var o=new tk,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[kF].parseTrsPath();if(h&&h.node===i){n.push(u);var _=ak(o,h.property);if(_){var f=u[FF](_);a.push({binding:_,trackEval:f})}}}return new rk(r,this._duration,o,a)}V(3924)}else V(3923)}else W(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[kF].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,o=t+1;o<n;++o){var a=e[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new Fz(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][kF].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},c(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=oo(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),o=r.length,a=function(e){var o=r[e],a=o.frame/t._duration,s=n.findIndex((function(e){return e===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:JU,get:function(){return this._exoticAnimation}},{key:JU,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(pu),jU.WrapMode=zs,LU=x((NU=WU).prototype,"sample",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),BU=x(NU.prototype,"speed",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FU=x(NU.prototype,"wrapMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zs.Normal}}),zU=x(NU.prototype,"enableTrsBlending",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UU=x(NU.prototype,"_duration",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kU=x(NU.prototype,"_hash",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GU=x(NU.prototype,"_tracks",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HU=x(NU.prototype,"_exoticAnimation",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VU=x(NU.prototype,"_events",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MU=NU))||MU);T.AnimationClip=$U;var ek=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var o=t[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),tk=function(){function e(){this.position=new dn,this.scale=new dn(1,1,1),this.rotation=new Pn,this.eulerAngles=new dn}return e.prototype.getTransform=function(e){Ln.fromRTS(e,this.rotation,this.position,this.scale)},e}(),nk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new Ln,t}return u(t,e),t.prototype.invalidate=function(){this._dirty=!0},c(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,Ln.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&Ln.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(tk),ik=new Ln,rk=function(){function e(e,t,n,i){this._initialTransformCache=new Ln,this._clipEndTransformCache=new Ln,this._startTransformCache=new Ln,this._endTransformCache=new Ln,this._motionTransformCache=new Ln,this._translationMotionCache=new dn,this._rotationMotionCache=new Pn,this._scaleMotionCache=new dn,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Ln.toRTS(n,r,i,o),dn.add(i,i,a.position),a.setPosition(i),Pn.multiply(r,r,a.rotation),a.setRotation(r),dn.multiply(o,o,a.scale),a.setScale(o)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);ok(n,o,a)}else{Ln.identity(n);var s=function(e,t){ok(ik,e,t),Ln.multiply(n,n,ik)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),ok(ik,h,_);for(var d=0;d<l;++d)Ln.multiply(n,n,ik);s(h,f)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function ok(e,t,n){Ln.invert(e,t),Ln.multiply(e,n,e)}function ak(e,t){switch(t){default:return;case"position":return{setValue:function(t){dn.copy(e.position,t)}};case"rotation":return{setValue:function(t){Pn.copy(e.rotation,t)}};case"scale":return{setValue:function(t){dn.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){dn.copy(e.eulerAngles,t)}}}}var sk=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=lk(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=lk(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var o=this._wrapMode,a=ck(n),s=ck(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((o&Fs.PingPong)===Fs.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((o&Fs.PingPong)===Fs.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?T.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},e}();function ck(e){return e-(0|e)==0&&(e-=1),0|e}function lk(e,t){return js(t,e)}var uk,hk,_k,fk=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new dk(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=new gk,this._nodeBlendStates.set(e,n)),n.refProperty(t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),dk=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},c(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}(),pk=function(e){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=e},mk=function(e){function t(){return e.call(this,new dn)||this}u(t,e);var n=t.prototype;return n.blend=function(e,t){var n=this.blendedValue;1===t?dn.copy(n,e):dn.scaleAndAdd(n,n,e,t),this.blendedWeight+=t},n.reset=function(){this.blendedWeight=0,dn.zero(this.blendedValue)},t}(pk),vk=function(e){function t(){return e.call(this,new Pn)||this}u(t,e);var n=t.prototype;return n.blend=function(e,t){if(0!==t){var n=this.blendedValue,i=this.blendedWeight;if(1===t)Pn.copy(n,e);else{var r=t/(i+t);Pn.slerp(n,n,e,r)}this.blendedWeight+=t}},n.reset=function(){this.blendedWeight=0,Pn.identity(this.blendedValue)},t}(pk),gk=function(){function e(){this._properties={}}var t=e.prototype;return t.refProperty=function(e){var t,n,i,r=this._properties;switch(e){default:case"position":case"scale":case"eulerAngles":i=null!==(t=r[e])&&void 0!==t?t:r[e]=new mk;break;case"rotation":i=null!==(n=r[e])&&void 0!==n?n:r[e]=new vk}return++i.refCount,i},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(e.position,1-o.blendedWeight),t=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(e.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(e.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(e.rotation,1-s.blendedWeight),i=s.blendedValue),(i||t||n)&&e.setRTS(i,t,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),_&&c.reset()},c(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),yk=[],xk=new Map;function Sk(e,t){for(var n=0,i=Ln.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,yk[n++]=e,e=e.parent}for(;n>0;){e=yk[--n],yk[n]=null;var r=e.node;Ln.fromRTS(e.local,r.rotation,r.position,r.scale),i=Ln.multiply(e.world,i,e.local)}return i}function Tk(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(xk.has(o)){i=xk.get(o);break}i={node:e,local:new Ln,world:new Ln,stamp:-1,parent:null},xk.set(o,i),yk[r++]=i,e=e.parent,i=null}for(;r>0;)n=yk[--r],yk[r]=null,n.parent=i,i=n;return i}function Ek(e){for(var t=xk.get(e.uuid)||null;t;)xk.delete(t.node.uuid),t=t.parent}var Ck=e("AnimationManager",$s((_k=hk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new $([]),t._crossFades=new $([]),t._delayEvents=[],t._blendStateBuffer=new fk,t._sockets=[],t}u(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):W(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(e);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(e)}this._blendStateBuffer.apply();for(var c=T.director.getTotalFrames(),l=0,u=i.length;l<u;l++){var h=i[l],_=h.target,f=h.transform;_.matrix=Sk(f,c)}for(var d=0,p=t.length;d<p;d++){var m=t[d];m.fn.apply(m.thisArg,m.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):W(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var o=e.getChildByPath(r.path),a=r.target&&o&&Tk(o,e);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){Ek(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},c(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(dM),hk.ID="animation",uk=_k))||uk);bM.on(AM.EVENT_INIT,(function(){var e=new Ck;bM.registerSystem(Ck.ID,e,dM.Priority.HIGH)})),T.AnimationManager=Ck;var Ak,bk=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(K(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},c(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),Pk=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(Ak||(Ak={})),Ze(Ak);var Rk=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=zs.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new Vs,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||B("Clip "+t.name+" has zero duration."),i}u(t,e);var n=t.prototype;return n.initialize=function(e,t){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Fs.Loop)===Fs.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,r,o,a=null!==(i=null!=t?t:null===(r=T.director.getAnimationManager())||void 0===r?void 0:r.blendState)&&void 0!==i?i:null;a&&(this._poseOutput=new Pk(a)),this._clipEval=n.createEvaluator({target:e,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||T.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];T.director.getAnimationManager().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(Ak.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(Ak.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(Ak.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(Ak.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Vs(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(Ak.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(Ak.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(Ak.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&Fs.PingPong)===Fs.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&Fs.Reverse)===Fs.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new Vs;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(e-=n)>0?e/i:-e/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&Fs.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){T.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){T.director.getAnimationManager().removeAnimation(this)},c(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&Fs.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&Fs.ShouldWrap,n=(this.wrapMode&Fs.Reverse)===Fs.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(bk));T.AnimationState=Rk;var wk,Ik,Dk,Ok,Mk,Nk,Lk,Bk,Fk,zk,Uk,kk,Gk,Hk,Vk,jk,Wk,qk=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:T.director.getAnimationManager(),n}u(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:Qt(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),ne(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(bk),Xk=e("Animation",(wk=$s("cc.Animation"),Ik=pc(),Dk=tc(99),Ok=hc(),Mk=Mc([$U]),Nk=xc(),Lk=Mc($U),Bk=xc(),Fk=xc(),zk=Mc([$U]),wk(Uk=Ik(Uk=Dk(Uk=uc(Uk=Ok((Wk=jk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",Gk,m(t)),t._crossFade=new qk,t._nameToState=ve(!0),y(t,"_clips",Hk,m(t)),y(t,"_defaultClip",Vk,m(t)),t._hasBeenPlayed=!1,t}u(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=ve(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&this.doPlayOrCrossFade(n,t)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(e){return this.getState(e)},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return ie(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void V(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void V(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return t===Ak.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===Ak.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===Ak.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new Rk(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(Ak.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];Yk(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(Ak.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(Ak.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},c(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=g(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=g(e);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=e.find((function(e){return Yk(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return Yk(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(Fl(Bu)),jk.EventType=Ak,x((kk=Wk).prototype,"clips",[Mk,Nk],Object.getOwnPropertyDescriptor(kk.prototype,"clips"),kk.prototype),x(kk.prototype,"defaultClip",[Lk,Bk],Object.getOwnPropertyDescriptor(kk.prototype,"defaultClip"),kk.prototype),Gk=x(kk.prototype,"playOnLoad",[oc,Fk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hk=x(kk.prototype,"_clips",[zk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vk=x(kk.prototype,"_defaultClip",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uk=kk))||Uk)||Uk)||Uk)||Uk)||Uk));function Yk(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}T.Animation=Xk;var Kk,Qk,Zk,Jk,$k=new Ln;function eG(e,t,n){for(Ln.identity(n);e!==t;)Ln.fromRTS($k,e.rotation,e.position,e.scale),Ln.multiply(n,$k,n),e=e.parent;return n}T.easing=F_;var tG=e("HierachyModifier",$s("cc.HierachyModifier")(Kk=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(JB))||Kk);T.HierachyModifier=tG;var nG=e("ComponentModifier",$s("cc.ComponentModifier")(Qk=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}($B))||Qk);T.ComponentModifier=nG;var iG=e("CurveValueAdapter",$s("cc.CurveValueAdapter")(Zk=function(){function e(){}return e.prototype.forTarget=function(){return{set:function(){}}},e}())||Zk);T.CurveValueAdapter=iG;var rG=e("UniformCurveValueAdapter",$s("cc.UniformCurveValueAdapter")(Jk=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(eF))||Jk);function oG(e){return"string"==typeof e}function aG(e){return"number"==typeof e}function sG(e,t){return e instanceof t}T.UniformCurveValueAdapter=rG,T.isPropertyModifier=oG,T.isElementModifier=aG,T.isCustomTargetModifier=sG,T.math=Kn,T.geometry=od;var cG=new dn,lG=new Ln;function uG(e,t,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;e.getWorldMatrix(lG);for(var c=0,l=0;l<s;l++){var u=o[l];dn.set(cG,u.x,u.y,0),dn.transformMat4(cG,cG,lG),a[c++]=cG.x,a[c++]=cG.y,a[c++]=cG.z,Wn.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),d=r.vertexAccessor.getIndexBuffer(h),p=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;d[p++]=g,d[p++]=g+1,d[p++]=g+2,d[p++]=g+1,d[p++]=g+3,d[p++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}var hG=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new _G;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,i=this._innerTextureInfos[n.getId()],r=t.x,o=t.y;if(i)r+=i.x,o+=i.y;else{var a=n.width,s=n.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;T.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var c={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(e),c},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),_G=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=im.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new Yi;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(Km),fG=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new hG(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==om.LINEAR||t.magFilter!==om.LINEAR||t.mipFilter!==om.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],qe.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),T.director.on(T.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),T.director.off(T.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();fG.instance=void 0;var dG,pG,mG,vG=e("dynamicAtlasManager",fG.instance=new fG);T.internal.dynamicAtlasManager=vG;var gG,yG,xG,SG,TG=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],EG=e("SpriteFrame",$s("cc.SpriteFrame")((mG=pG=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.unbiasUV=[],t.uvSliced=[],t._rect=new Hn,t._offset=new gn,t._originalSize=new kn,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}u(t,e),t.createWithImage=function(e){var n=e instanceof bm?e:new bm(e),i=new Km;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(W(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(W(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&vG&&vG.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=e.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=e.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){TG[0].u=e.x/i,TG[1].u=(e.x+l)/i,TG[2].u=(e.x+l+u)/i,TG[3].u=(e.x+e.height)/i,TG[3].v=e.y/r,TG[2].v=(e.y+o)/r,TG[1].v=(e.y+o+s)/r,TG[0].v=(e.y+e.width)/r;for(var _=0;_<4;++_)for(var f=TG[_],d=0;d<4;++d){var p=TG[3-d];h.push({u:f.u,v:p.v})}}else{TG[0].u=e.x/i,TG[1].u=(e.x+o)/i,TG[2].u=(e.x+o+s)/i,TG[3].u=(e.x+e.width)/i,TG[3].v=e.y/r,TG[2].v=(e.y+c)/r,TG[1].v=(e.y+c+u)/r,TG[0].v=(e.y+e.height)/r;for(var m=0;m<4;++m)for(var v=TG[m],g=0;g<4;++g){var y=TG[g];h.push({u:y.u,v:v.v})}}this.emit(t.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===o?0:e.y/o,l=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=a,t[5]=l,t[6]=a,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=a,t[5]=c,t[6]=a,t[7]=l):this._isFlipUVY?(t[0]=a,t[1]=l,t[2]=a,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,_=0===o?0:e.y/o,f=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var d=0===r?0:e.x/r,p=0===r?1:(e.x+e.width)/r,m=0===o?1:(e.y+e.height)/o,v=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):this._isFlipUVX?(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v):this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,x=0===o?1:(e.y+e.height)/o,S=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var T=this.vertices;if(T){T.nu.length=0,T.nv.length=0;for(var E=0;E<T.u.length;E++)T.nu[E]=T.u[E]/r,T.nv[E]=T.v[E]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=vG;if(e){var t=this._texture;if(t instanceof Km&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new Hn(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new gn(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new kn(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var o=t.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,o,a,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new Hn(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new kn(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Km;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},c(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(pu),pG.EVENT_UV_UPDATED="uv_updated",dG=mG))||dG);T.SpriteFrame=EG;var CG,AG=e("SpriteAtlas",$s("cc.SpriteAtlas")((SG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",xG,m(t)),t}u(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=ve();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],Ve(EG))},t}(pu),xG=x((yG=SG).prototype,"spriteFrames",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ve()}}),gG=yG))||gG);T.SpriteAtlas=AG;var bG,PG,RG,wG,IG=e("Font",$s("cc.Font")(CG=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(pu))||CG);T.Font=IG;var DG,OG,MG,NG,LG,BG,FG,zG,UG,kG=e("TTFFont",$s("cc.TTFFont")((wG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",RG,m(t)),t}return u(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},c(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:iu(this._native),__isNative__:!0}}}]),t}(IG),RG=x((PG=wG).prototype,"_fontFamily",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x(PG.prototype,"_nativeAsset",[Vc,Oc],Object.getOwnPropertyDescriptor(PG.prototype,"_nativeAsset"),PG.prototype),x(PG.prototype,"_nativeDep",[Vc],Object.getOwnPropertyDescriptor(PG.prototype,"_nativeDep"),PG.prototype),bG=PG))||bG);T.TTFFont=kG;var GG,HG=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},VG=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new HG;Re(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),jG=e("BitmapFont",(DG=$s("cc.BitmapFont"),OG=Mc(EG),DG((UG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",LG,m(t)),y(t,"spriteFrame",BG,m(t)),y(t,"fontSize",FG,m(t)),y(t,"fntConfig",zG,m(t)),t}return u(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new VG(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new HG,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else M("The fnt config is not exists!")},t}(IG),LG=x((NG=UG).prototype,"fntDataStr",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),BG=x(NG.prototype,"spriteFrame",[OG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FG=x(NG.prototype,"fontSize",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),zG=x(NG.prototype,"fntConfig",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MG=NG))||MG));T.BitmapFont=jG;var WG=e("LabelAtlas",$s("cc.LabelAtlas")(GG=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(jG))||GG);T.LabelAtlas=WG;var qG=e("BASELINE_RATIO",.26),XG=e("MIDDLE_RATIO",(qG+1)/2-qG);var YG=new je(2);YG.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var KG,QG=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=YG.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,YG.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),ZG=/([a-zA-Z0-9--]+|\S)/,JG=/^[!,.:;'}\]%\?>]/,$G=/([a-zA-Z0-9--]+|\S)$/,eH=/[a-zA-Z0-9--]+$/,tH=/^[a-zA-Z0-9--]/;function nH(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function iH(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function rH(e,t,n){var i=(n||e.font)+""+t,r=QG.get(i);if(null!==r)return r;var o=e.measureText(t),a=o&&o.width||0;return QG.put(i,a),a}function oH(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}function aH(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var o=e;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=oH(o,a),c=t-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=t-i(s=oH(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var _=ZG.exec(s);u=_?_[0].length:1,l=s}c=t-i(s=oH(o,a+=u))}0==(a-=u)?(a=1,l=oH(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=oH(o,2));var f=oH(o,0,a),d=void 0;JG.test(l||s)&&(0==(a-=(d=$G.exec(f))?d[0].length:0)&&(a=1),l=oH(o,a),f=oH(o,0,a)),tH.test(l)&&(d=eH.exec(f))&&f!==d[0]&&(l=oH(o,a-=d[0].length),f=oH(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var sH=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return KG||(KG=new e),KG};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=$e.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),cH=Wn.WHITE.clone(),lH=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},uH="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",hH=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=sH.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=rH(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+qG)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*qG/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new bm),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=uH,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,o=n/2,a=i/2+r*XG+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||cH;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,o,a)}e.fillText(this.char,o,a)}},e}(),_H=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=im.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new Yi;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(Km),fH=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new _H;n.initWithSize(e,t),this.fontDefDictionary=new VG(n),this._halfBleed=1,this._width=e,this._height=t,bM.on(AM.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=bM.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return V(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var o=new lH;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new _H;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new hH(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},c(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),dH={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Wn.WHITE.clone(),isOutlined:!1,out:Wn.WHITE.clone(),margin:0},pH=[new vr(zi.ATTR_POSITION,ti.RGB32F)],mH=[new vr(zi.ATTR_POSITION,ti.RGB32F),new vr(zi.ATTR_COLOR,ti.RGBA32F)],vH=[new vr(zi.ATTR_POSITION,ti.RGB32F),new vr(zi.ATTR_TEX_COORD,ti.RG32F),new vr(zi.ATTR_COLOR,ti.RGBA32F)],gH=[new vr(zi.ATTR_POSITION,ti.RGB32F),new vr(zi.ATTR_TEX_COORD,ti.RG32F),new vr(zi.ATTR_COLOR,ti.RGBA32F),new vr(zi.ATTR_COLOR2,ti.RGBA32F)];function yH(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=Gr[i.format].count}return t}function xH(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=Gr[i.format].size}return t}T.internal.vfmtPosUvColor=vH,T.internal.vfmtPosUvTwoColor=gH;var SH,TH,EH,CH,AH,bH,PH,RH,wH,IH,DH,OH,MH,NH,LH,BH=xH(vH)>>2,FH=new Pl((function(){return{x:0,y:0,z:0,u:0,v:0,color:Wn.WHITE.clone()}}),128),zH=null,UH=e("BaseRenderData",function(){function e(e){void 0===e&&(e=vH),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=vH,this._floatStride=e===vH?BH:xH(e)>>2,this._vertexFormat=e}return e.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},c(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),e}()),kH=e("RenderData",function(e){function t(t,n){var i;return void 0===t&&(t=vH),(i=e.call(this,t)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=bM.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}u(t,e),t.add=function(e,n){void 0===e&&(e=vH),zH||(zH=new Rl((function(){return new t}),32));var i=zH.add();return i._floatStride=e===vH?BH:xH(e)>>2,i._vertexFormat=e,n||(n=bM.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},t.remove=function(e){var t=zH.data.indexOf(e);-1!==t&&(e.clear(),e._accessor=null,zH.removeAt(t))};var n=t.prototype;return n.resize=function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())},n.resizeAndCopy=function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var n=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=oo(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},c(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)FH.free(t[i]);for(i=n;i<e;i++)t[i]=FH.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(UH)),GH=e("MeshRenderData",function(e){function t(t){var n;return void 0===t&&(t=vH),(n=e.call(this,t)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}u(t,e),t.add=function(e){void 0===e&&(e=vH);var t=HH.add();return t._floatStride=e===vH?BH:xH(e)>>2,t._vertexFormat=e,t},t.remove=function(e){var t=HH.data.indexOf(e);-1!==t&&(HH.data[t].clear(),HH.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(e,t){var n=this._byteLength+e*this.stride,i=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(e,t){var n=e*this.stride;e>=0&&t>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=n,this.updateRange(0,e,0,t)},n.updateRange=function(e,t,n,i){t>=0&&i>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=n,this.vertexRange=t,this.indexRange=i},n.requestIA=function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,e),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(e){var t=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(e.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new er(ri.INDEX|ri.TRANSFER_DST,si.DEVICE,r,r))),this._iaInfo=new yr(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Rl((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),i&&this.iData.set(i,0)},c(t,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),t}(UH)),HH=new Rl((function(){return new GH}),32),VH=new gn,jH=new gn,WH=(new dn,new Ln),qH=new Ln,XH=new Ln,YH=new Ln(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),KH=new Hn,QH=e("UITransform",(SH=$s("cc.UITransform"),TH=pc(),EH=tc(110),CH=hc(),AH=bc(),bH=xc(),PH=bc(),RH=xc(),SH(wH=TH(wH=EH(wH=CH(wH=nc(wH=uc((NH=MH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._priority=0,y(t,"_contentSize",DH,m(t)),y(t,"_anchorPoint",OH,m(t)),t}u(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(xE.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(xE.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit(xE.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(xE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t,n=this._contentSize.width,i=this._contentSize.height,r=VH,o=jH,a=null===(t=this.node)||void 0===t?void 0:t.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(WH);var u=WH.m12,h=WH.m13,_=OO.center;if(WH.m12=_.x-(WH.m00*u+WH.m04*h),WH.m13=_.y-(WH.m01*u+WH.m05*h),Ln.invert(WH,WH),gn.transformMat4(r,e,WH),this.node.getWorldMatrix(XH),Ln.invert(WH,XH),!Ln.strictEquals(WH,YH)){gn.transformMat4(o,r,WH),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var f=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(f=!0,a&&a.maskList))for(var d=a.maskList,p=this.node,m=d?d.length:0,v=0,g=0;p&&g<m;++v,p=p.parent){var y=d[g];if(v===y.index){if(p!==y.comp.node){d.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){f=!1;break}g++}else if(v>y.index){d.length=g;break}}if(f)return!0}}}return!1},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(XH),Ln.invert(WH,XH),t||(t=new dn),dn.transformMat4(t,e,WH)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(XH),t||(t=new dn),dn.transformMat4(t,e,XH)},n.getBoundingBox=function(){Ln.fromRTS(qH,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new Hn(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(qH),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(XH),this.getBoundingBoxTo(XH)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){Ln.fromRTS(qH,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new Hn(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Ln.multiply(XH,e,qH),r.transformMat4(XH),!this.node.children)return r;for(var o,a=g(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&Hn.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;KH.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),KH.transformMat4(this.node.worldMatrix);var i=KH.x+.5*KH.width,r=KH.y+.5*KH.height,o=this.node.worldPosition.z,a=KH.width/2,s=KH.height/2;return null!=e?(Is.set(e,i,r,o,a,s,.001),e):new Is(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},c(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(xE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(xE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(xE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(xE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(xE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(xE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?V(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=bM.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=bM.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(Bu),MH.EventType=xE,MH.priorityChangeNodeMap=new Map,x((IH=NH).prototype,"contentSize",[AH,bH],Object.getOwnPropertyDescriptor(IH.prototype,"contentSize"),IH.prototype),x(IH.prototype,"anchorPoint",[PH,RH],Object.getOwnPropertyDescriptor(IH.prototype,"anchorPoint"),IH.prototype),DH=x(IH.prototype,"_contentSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kn(100,100)}}),OH=x(IH.prototype,"_anchorPoint",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gn(.5,.5)}}),wH=IH))||wH)||wH)||wH)||wH)||wH)||wH));bM.on(AM.EVENT_AFTER_UPDATE,QH._sortSiblings),bM.on(AM.EVENT_BEFORE_SCENE_LAUNCH,QH._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(LH||(LH={}));var ZH,JH,$H,eV,tV,nV,iV,rV,oV,aV,sV,cV,lV,uV,hV,_V,fV,dV,pV,mV,vV=e("StencilManager",function(){function e(){this.stage=LH.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:pi.ALWAYS,stencilMask:65535,writeMask:65535,failOp:mi.KEEP,zFailOp:mi.KEEP,passOp:mi.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?LH.CLEAR_INVERTED:LH.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?LH.ENTER_LEVEL_INVERTED:LH.ENTER_LEVEL},t.enableMask=function(){this.stage=LH.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=LH.DISABLED:this.stage=LH.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=LH.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,o=pi.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(e);var u=new ho(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===LH.DISABLED?(t.stencilTest=!1,t.func=pi.ALWAYS,t.failOp=mi.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===LH.ENABLED?(t.func=pi.EQUAL,t.failOp=mi.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===LH.CLEAR?(t.func=pi.NEVER,t.failOp=mi.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===LH.CLEAR_INVERTED||e===LH.ENTER_LEVEL?(t.func=pi.NEVER,t.failOp=mi.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===LH.ENTER_LEVEL_INVERTED&&(t.func=pi.NEVER,t.failOp=mi.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},c(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());vV.sharedManager=null,vV.sharedManager=new vV,Ze(vi),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(mV||(mV=e("InstanceMaterialType",{})));var gV,yV,xV,SV,TV,EV,CV,AV,bV,PV,RV,wV,IV,DV,OV,MV,NV,LV,BV,FV,zV,UV,kV,GV,HV,VV,jV,WV,qV,XV,YV,KV,QV,ZV,JV,$V,ej,tj,nj,ij,rj,oj,aj,sj,cj,lj,uj,hj,_j,fj,dj,pj,mj,vj,gj,yj,xj,Sj,Tj,Ej,Cj,Aj,bj,Pj,Rj,wj,Ij,Dj,Oj,Mj,Nj=e("Renderable2D",(ZH=$s("cc.Renderable2D"),JH=ec(QH),$H=vc(),eV=Mc(Nv),tV=Mc(Nv),nV=bc(),iV=xc(),rV=yc(),oV=bc(),aV=xc(),ZH(sV=JH(sV=nc(sV=uc((pV=dV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_materials",lV,m(t)),y(t,"_customMaterial",uV,m(t)),t.stencilStage=LH.DISABLED,y(t,"_srcBlendFactor",hV,m(t)),y(t,"_dstBlendFactor",_V,m(t)),y(t,"_color",fV,m(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new fo,t._blendHash=0,t._lastParent=null,t}u(t,e);var n=t.prototype;return n.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(xE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(xE.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(xE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(xE.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else this._renderDataFlag=e},n.requestRenderData=function(){var e=kH.add();return this._renderData=e,e},n.destroyRenderData=function(){this._renderData&&(kH.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this,e),this._renderDataFlag=!1),this._renderFlag&&this._render(e)},n.postUpdateAssembler=function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new _o,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=vi.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}},n._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},n._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case mV.ADD_COLOR:e=rv.get("ui-base-material");break;case mV.GRAYSCALE:e=rv.get("ui-sprite-gray-material");break;case mV.USE_ALPHA_SEPARATED:e=rv.get("ui-sprite-alpha-sep-material");break;case mV.USE_ALPHA_SEPARATED_AND_GRAY:e=rv.get("ui-sprite-gray-alpha-sep-material");break;default:e=rv.get("ui-sprite-material")}return e},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},c(t,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&V(12001),this._srcBlendFactor},set:function(e){this._customMaterial?V(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&V(12001),this._dstBlendFactor},set:function(e){this._customMaterial?V(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}}]),t}(RB),dV.BlendState=vi,dV.Assembler=null,dV.PostAssembler=null,lV=x((cV=pV).prototype,"_materials",[Vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),x(cV.prototype,"sharedMaterials",[Vc,$H],Object.getOwnPropertyDescriptor(cV.prototype,"sharedMaterials"),cV.prototype),uV=x(cV.prototype,"_customMaterial",[eV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x(cV.prototype,"customMaterial",[tV,nV,iV,rV],Object.getOwnPropertyDescriptor(cV.prototype,"customMaterial"),cV.prototype),x(cV.prototype,"color",[oV,aV],Object.getOwnPropertyDescriptor(cV.prototype,"color"),cV.prototype),hV=x(cV.prototype,"_srcBlendFactor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.SRC_ALPHA}}),_V=x(cV.prototype,"_dstBlendFactor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.ONE_MINUS_SRC_ALPHA}}),fV=x(cV.prototype,"_color",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.WHITE.clone()}}),sV=cV))||sV)||sV)||sV)||sV));T.internal.Renderable2D=Nj,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(Ij||(Ij=e("HorizontalTextAlignment",{}))),Ze(Ij),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(Dj||(Dj=e("VerticalTextAlignment",{}))),Ze(Dj),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(Oj||(Oj=e("Overflow",{}))),Ze(Oj),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(Mj||(Mj=e("CacheMode",{}))),Ze(Mj);var Lj=e("Label",(gV=$s("cc.Label"),yV=pc(),xV=tc(110),SV=hc(),TV=bc(),EV=xc(),CV=Mc(Ij),AV=bc(),bV=xc(),PV=Mc(Dj),RV=bc(),wV=xc(),IV=bc(),DV=xc(),OV=bc(),MV=vc(),NV=xc(),LV=bc(),BV=xc(),FV=vc(),zV=bc(),UV=xc(),kV=Mc(Oj),GV=bc(),HV=xc(),VV=bc(),jV=xc(),WV=Mc(IG),qV=bc(),XV=vc(),YV=xc(),KV=bc(),QV=xc(),ZV=Mc(Mj),JV=bc(),$V=xc(),ej=bc(),tj=xc(),nj=bc(),ij=xc(),rj=bc(),oj=xc(),aj=vc(),sj=bc(),cj=xc(),gV(lj=yV(lj=xV(lj=SV((wj=Rj=function(e){function t(){var t;return y(t=e.call(this)||this,"_string",hj,m(t)),y(t,"_horizontalAlign",_j,m(t)),y(t,"_verticalAlign",fj,m(t)),y(t,"_actualFontSize",dj,m(t)),y(t,"_fontSize",pj,m(t)),y(t,"_fontFamily",mj,m(t)),y(t,"_lineHeight",vj,m(t)),y(t,"_overflow",gj,m(t)),y(t,"_enableWrapText",yj,m(t)),y(t,"_font",xj,m(t)),y(t,"_isSystemFontUsed",Sj,m(t)),y(t,"_spacingX",Tj,m(t)),y(t,"_isItalic",Ej,m(t)),y(t,"_isBold",Cj,m(t)),y(t,"_isUnderline",Aj,m(t)),y(t,"_underlineHeight",bj,m(t)),y(t,"_cacheMode",Pj,m(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}u(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){e.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof jG){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof jG){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===Mj.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new EG,this._assemblerData=this._assembler.getAssemblerData();var n=new bm(this._assemblerData.canvas),i=new Km;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==Mj.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==Mj.CHAR){var t=this._texture.texture;if(t instanceof Cm){var n=t.getPixelFormat();e=n===im.RGBA_ETC1||n===im.RGB_A_PVRTC_4BPPV1||n===im.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?mV.USE_ALPHA_SEPARATED:mV.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},c(t,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==Mj.BITMAP||this._font instanceof jG||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===Mj.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof jG?this._font.fontSize:-1}}]),t}(Nj),Rj.HorizontalAlign=Ij,Rj.VerticalAlign=Dj,Rj.Overflow=Oj,Rj.CacheMode=Mj,Rj._canvasPool=sH.getInstance(),x((uj=wj).prototype,"string",[TV,EV,Pc],Object.getOwnPropertyDescriptor(uj.prototype,"string"),uj.prototype),x(uj.prototype,"horizontalAlign",[CV,AV,bV],Object.getOwnPropertyDescriptor(uj.prototype,"horizontalAlign"),uj.prototype),x(uj.prototype,"verticalAlign",[PV,RV,wV],Object.getOwnPropertyDescriptor(uj.prototype,"verticalAlign"),uj.prototype),x(uj.prototype,"fontSize",[IV,DV],Object.getOwnPropertyDescriptor(uj.prototype,"fontSize"),uj.prototype),x(uj.prototype,"fontFamily",[OV,MV,NV],Object.getOwnPropertyDescriptor(uj.prototype,"fontFamily"),uj.prototype),x(uj.prototype,"lineHeight",[LV,BV],Object.getOwnPropertyDescriptor(uj.prototype,"lineHeight"),uj.prototype),x(uj.prototype,"spacingX",[FV,zV,UV],Object.getOwnPropertyDescriptor(uj.prototype,"spacingX"),uj.prototype),x(uj.prototype,"overflow",[kV,GV,HV],Object.getOwnPropertyDescriptor(uj.prototype,"overflow"),uj.prototype),x(uj.prototype,"enableWrapText",[VV,jV],Object.getOwnPropertyDescriptor(uj.prototype,"enableWrapText"),uj.prototype),x(uj.prototype,"font",[WV,qV,XV,YV],Object.getOwnPropertyDescriptor(uj.prototype,"font"),uj.prototype),x(uj.prototype,"useSystemFont",[KV,QV],Object.getOwnPropertyDescriptor(uj.prototype,"useSystemFont"),uj.prototype),x(uj.prototype,"cacheMode",[ZV,JV,$V],Object.getOwnPropertyDescriptor(uj.prototype,"cacheMode"),uj.prototype),x(uj.prototype,"isBold",[ej,tj],Object.getOwnPropertyDescriptor(uj.prototype,"isBold"),uj.prototype),x(uj.prototype,"isItalic",[nj,ij],Object.getOwnPropertyDescriptor(uj.prototype,"isItalic"),uj.prototype),x(uj.prototype,"isUnderline",[rj,oj],Object.getOwnPropertyDescriptor(uj.prototype,"isUnderline"),uj.prototype),x(uj.prototype,"underlineHeight",[aj,mc,sj,cj],Object.getOwnPropertyDescriptor(uj.prototype,"underlineHeight"),uj.prototype),hj=x(uj.prototype,"_string",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),_j=x(uj.prototype,"_horizontalAlign",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ij.CENTER}}),fj=x(uj.prototype,"_verticalAlign",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dj.CENTER}}),dj=x(uj.prototype,"_actualFontSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pj=x(uj.prototype,"_fontSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),mj=x(uj.prototype,"_fontFamily",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),vj=x(uj.prototype,"_lineHeight",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),gj=x(uj.prototype,"_overflow",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oj.NONE}}),yj=x(uj.prototype,"_enableWrapText",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xj=x(uj.prototype,"_font",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sj=x(uj.prototype,"_isSystemFontUsed",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Tj=x(uj.prototype,"_spacingX",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ej=x(uj.prototype,"_isItalic",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cj=x(uj.prototype,"_isBold",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Aj=x(uj.prototype,"_isUnderline",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bj=x(uj.prototype,"_underlineHeight",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Pj=x(uj.prototype,"_cacheMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mj.NONE}}),lj=uj))||lj)||lj)||lj)||lj));T.Label=Lj;var Bj,Fj,zj=0,Uj={};function kj(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function Gj(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(Bj||(Bj={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(Fj||(Fj={}));var Hj,Vj,jj,Wj=function(){function e(e){this._device=void 0,this._format=ti.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Yi,this._region1=new Yi,this._region2=new Yi,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=Gr[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=Qr(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=Gj(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,kj(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;B("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new or(ci.TEX2D,li.SAMPLED|li.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=Gj(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,kj(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}(),qj=function(e){if(void 0===Uj[e]){var t=1<<zj;Uj[e]=t,zj+=1}},Xj=Object.freeze({__proto__:null,addStage:qj,scene:JS,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[];o.push(new vr(zi.ATTR_POSITION,ti.RGB32F)),t.normals&&o.push(new vr(zi.ATTR_NORMAL,ti.RGB32F)),t.uvs&&o.push(new vr(zi.ATTR_TEX_COORD,ti.RG32F)),t.colors&&o.push(new vr(zi.ATTR_COLOR,ti.RGB32F));var a=e.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new er(ri.INDEX|ri.TRANSFER_DST,si.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new yr(o,[a],s))},get RenderQueue(){return Bj},get PassStage(){return Fj},genHandle:wp,getTypeFromHandle:Ip,getBindingFromHandle:Dp,getCountFromHandle:Op,getOffsetFromHandle:Mp,customizeType:Np,type2reader:Lp,type2writer:Bp,getDefaultFromType:zp,overrideMacros:Up,get BatchingSchemes(){return ev},Pass:hv,getDeviceShaderVersion:qp,programLib:tm,nearestPOT:kj,TextureBufferPool:Wj,MaterialInstance:kS,PassInstance:US,get PoolType(){return us},NULL_HANDLE:0,get NodeView(){return hs},NodePool:ms,get PassView(){return fs},PassPool:xs,get AABBView(){return vs},AABBPool:Es});e("renderer",Xj),function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(Hj||(Hj={})),Ze(Hj),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(Vj||(Vj={})),Ze(Vj),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(jj||(jj={})),Ze(jj);var Yj=Math.PI,Kj=Math.min,Qj=Math.max,Zj=Math.cos,Jj=Math.sin,$j=Math.abs,eW=Math.sign,tW=.5522847493;function nW(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*tW,t-i*tW,n+r,t,n+r),e.bezierCurveTo(t+i*tW,n+r,t+i,n+r*tW,t+i,n),e.bezierCurveTo(t+i,n-r*tW,t+i*tW,n-r,t,n-r),e.bezierCurveTo(t-i*tW,n-r,t-i,n-r*tW,t-i,n),e.close()}function iW(e,t,n,i,r,o,a,s,c,l,u){var h,_,f,d,p,m,v,g,y,x,S,T,E,C,A,b;l>10||(p=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(t+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(d=.5*(r+a))),((A=$j((i-s)*(C=c-n)-(r-c)*(E=s-t)))+(b=$j((o-s)*C-(a-c)*E)))*(A+b)<e.tessTol*(E*E+C*C)?e.addPoint(s,c,0===u?u|jj.PT_BEVEL:u):(iW(e,t,n,h,_,v,g,S=.5*(v+(y=.5*(f+p))),T=.5*(g+(x=.5*(d+m))),l+1,0),iW(e,S,T,y,x,p,m,s,c,l+1,u)))}var rW,oW,aW,sW,cW,lW,uW,hW,_W,fW,dW,pW,mW,vW,gW,yW,xW,SW,TW,EW,CW,AW,bW,PW,RW,wW,IW,DW,OW,MW,NW,LW,BW,FW,zW,UW,kW,GW,HW,VW,jW,WW,qW,XW,YW,KW,QW,ZW=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return u(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(gn),JW=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),$W=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Wn.WHITE.clone(),this.lineCap=Hj.BUTT,this.strokeColor=Wn.BLACK.clone(),this.lineJoin=Vj.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,jj.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,jj.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==o?(iW(this,s.x,s.y,e,t,n,i,r,o,0,jj.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,o){!function(e,t,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,g=0,y=0,x=0,S=0,T=0;if(u=o-r,a=a||!1)if($j(u)>=2*Yj)u=2*Yj;else for(;u<0;)u+=2*Yj;else if($j(u)>=2*Yj)u=2*-Yj;else for(;u>0;)u-=2*Yj;for(c=0|Qj(1,Kj($j(u)/(.5*Yj)+.5,5)),h=$j(4/3*(1-Zj(s=u/c/2))/Jj(s)),a||(h=-h),T=0;T<=c;T++)d=t+(_=Zj(l=r+u*(T/c)))*i,p=n+(f=Jj(l))*i,m=-f*i*h,v=_*i*h,0===T?e.moveTo(d,p):e.bezierCurveTo(g+x,y+S,d-m,p-v,d,p),g=d,y=p,x=m,S=v}(this,e,t,n,i,r,o)},t.ellipse=function(e,t,n,i){nW(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){nW(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,o){if(o<.1)e.rect(t,n,i,r);else{var a=Kj(o,.5*$j(i))*eW(i),s=Kj(o,.5*$j(r))*eW(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-tW),t+a*(1-tW),n+r,t+a,n+r),e.lineTo(t+i-a,n+r),e.bezierCurveTo(t+i-a*(1-tW),n+r,t+i,n+r-s*(1-tW),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-tW),t+i-a*(1-tW),n,t+i-a,n),e.lineTo(t+a,n),e.bezierCurveTo(t+a*(1-tW),n,t,n+s*(1-tW),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&GH.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=GH.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new ZW(e,t),r.push(a)),a.flags=n,o.push(a)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new JW,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),eq=mH.concat([new vr("a_dist",ti.R32F)]),tq=yH(eq),nq=xH(eq),iq=e("Graphics",(rW=$s("cc.Graphics"),oW=pc(),aW=tc(110),sW=hc(),cW=xc(),lW=Mc(Vj),uW=xc(),hW=Mc(Hj),_W=xc(),fW=xc(),dW=xc(),pW=xc(),mW=vc(),rW(vW=oW(vW=aW(vW=sW((bW=AW=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,y(t,"_lineWidth",yW,m(t)),y(t,"_strokeColor",xW,m(t)),y(t,"_lineJoin",SW,m(t)),y(t,"_lineCap",TW,m(t)),y(t,"_fillColor",EW,m(t)),y(t,"_miterLimit",CW,m(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=mV.ADD_COLOR,t.impl=new $W,t}u(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=bM.root.createModel(FS),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(bM.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),e.prototype.onDestroy.call(this)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,o){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,o)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,o){this.impl&&this.impl.arc(e,t,n,i,r,o)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=rv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=T.director.root.device,n=t.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE,65535*nq,nq)),i=t.createBuffer(new er(ri.INDEX|ri.TRANSFER_DST,si.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new yb([n],eq,bi.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(e,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else V(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*tq);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},c(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(Nj),AW.LineJoin=Vj,AW.LineCap=Hj,x((gW=bW).prototype,"lineWidth",[mc,cW],Object.getOwnPropertyDescriptor(gW.prototype,"lineWidth"),gW.prototype),x(gW.prototype,"lineJoin",[lW,uW],Object.getOwnPropertyDescriptor(gW.prototype,"lineJoin"),gW.prototype),x(gW.prototype,"lineCap",[hW,_W],Object.getOwnPropertyDescriptor(gW.prototype,"lineCap"),gW.prototype),x(gW.prototype,"strokeColor",[fW],Object.getOwnPropertyDescriptor(gW.prototype,"strokeColor"),gW.prototype),x(gW.prototype,"fillColor",[dW],Object.getOwnPropertyDescriptor(gW.prototype,"fillColor"),gW.prototype),x(gW.prototype,"miterLimit",[pW],Object.getOwnPropertyDescriptor(gW.prototype,"miterLimit"),gW.prototype),x(gW.prototype,"color",[Vc,mW],Object.getOwnPropertyDescriptor(gW.prototype,"color"),gW.prototype),yW=x(gW.prototype,"_lineWidth",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),xW=x(gW.prototype,"_strokeColor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.BLACK.clone()}}),SW=x(gW.prototype,"_lineJoin",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vj.MITER}}),TW=x(gW.prototype,"_lineCap",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hj.BUTT}}),EW=x(gW.prototype,"_fillColor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.WHITE.clone()}}),CW=x(gW.prototype,"_miterLimit",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),vW=gW))||vW)||vW)||vW)||vW));T.Graphics=iq;var rq,oq=new Ln,aq=new gn,sq=new Ln,cq=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(rq||(rq={})),Ze(rq);var lq=e("Mask",(PW=$s("cc.Mask"),RW=pc(),wW=tc(110),IW=hc(),DW=Mc(rq),OW=xc(),MW=bc(),NW=xc(),LW=vc(),BW=Mc(EG),FW=vc(),zW=vc(),UW=Sc(),kW=vc(),GW=vc(),PW(HW=RW(HW=wW(HW=IW((QW=KW=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,y(t,"_type",jW,m(t)),y(t,"_inverted",WW,m(t)),y(t,"_segments",qW,m(t)),y(t,"_spriteFrame",XW,m(t)),y(t,"_alphaThreshold",YW,m(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=mV.ADD_COLOR,t}u(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(bM.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),e.prototype.onDestroy.call(this)},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,o=aq;this.node.getWorldMatrix(oq),Ln.invert(sq,oq),gn.transformMat4(o,e,sq);var a=t.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===rq.RECT||this.type===rq.GRAPHICS_STENCIL||this.type===rq.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===rq.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==rq.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new iq;e._objFlags|=Jc.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=Wn.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===rq.RECT||this._type===rq.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,o=e.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===rq.RECT)t.rect(a,s,i,r);else if(this._type===rq.ELLIPSE){for(var c=function(e,t,n){cq.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)cq.push(new dn(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return cq}(new dn(a+i/2,s+r/2,0),new dn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=rv.get("default-clear-stencil");this._clearStencilMtl=new kS({parent:e,owner:this,subModelIdx:0}),this._clearModel=bM.root.createModel(FS),this._clearModel.node=this._clearModel.transform=this.node;var t=xH(pH),n=T.director.root.device,i=n.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.DEVICE,4*t,t)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var o=n.createBuffer(new er(ri.INDEX|ri.TRANSFER_DST,si.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new yb([i],pH,bi.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=LH.DISABLED,this._type===rq.IMAGE_STENCIL?(e=rv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=rv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==rq.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},c(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==rq.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=LH.DISABLED,this._graphics&&(this._graphics.stencilStage=LH.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=Kt(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===rq.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===rq.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(Nj),KW.Type=rq,x((VW=QW).prototype,"type",[DW,OW],Object.getOwnPropertyDescriptor(VW.prototype,"type"),VW.prototype),x(VW.prototype,"inverted",[MW,NW],Object.getOwnPropertyDescriptor(VW.prototype,"inverted"),VW.prototype),x(VW.prototype,"segments",[LW],Object.getOwnPropertyDescriptor(VW.prototype,"segments"),VW.prototype),x(VW.prototype,"spriteFrame",[BW,FW],Object.getOwnPropertyDescriptor(VW.prototype,"spriteFrame"),VW.prototype),x(VW.prototype,"alphaThreshold",[zW,UW,Ac],Object.getOwnPropertyDescriptor(VW.prototype,"alphaThreshold"),VW.prototype),x(VW.prototype,"color",[Vc,kW],Object.getOwnPropertyDescriptor(VW.prototype,"color"),VW.prototype),x(VW.prototype,"customMaterial",[Vc,GW],Object.getOwnPropertyDescriptor(VW.prototype,"customMaterial"),VW.prototype),jW=x(VW.prototype,"_type",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rq.RECT}}),WW=x(VW.prototype,"_inverted",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qW=x(VW.prototype,"_segments",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),XW=x(VW.prototype,"_spriteFrame",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YW=x(VW.prototype,"_alphaThreshold",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),HW=VW))||HW)||HW)||HW)||HW));oI._maskComp=lq,T.Mask=lq;var uq,hq,_q,fq,dq,pq,mq,vq,gq,yq,xq,Sq,Tq,Eq,Cq,Aq,bq,Pq,Rq,wq,Iq,Dq,Oq,Mq,Nq,Lq,Bq,Fq,zq,Uq,kq,Gq,Hq,Vq,jq,Wq,qq,Xq,Yq,Kq,Qq,Zq,Jq,$q,eX,tX,nX,iX,rX,oX,aX,sX,cX,lX,uX,hX,_X,fX,dX,pX,mX,vX,gX=/^(click)(\s)*=|(param)(\s)*=/,yX=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,xX=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var o=e.substring(t,r),a=e.substring(r+1,i);""===a&&(o=e.substring(t,i+1)),this._processResult(o),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,o="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(o=e.substring(r+1).trim(),t.event=this._processEventHandler(o)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=yX.exec(e);for(var c=!1;n;){if(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}t.isImage=!0,t.src=s}else if("height"===i)t.imageHeight=parseInt(s);else if("width"===i)t.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}t.imageAlign=s.toLowerCase()}else"offset"===i?t.imageOffset=s:"click"===i&&(t.event=this._processEventHandler(i+"="+s));t.event&&"param"===i&&(t.event[i]=s.replace(/^"|"$/g,"")),n=yX.exec(e)}return c&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var l={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),t.event&&"param"===i&&(t.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(e)}t.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=gX.exec(e);r;){var o=r[0],a="";if(i=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(a=s?s[0]:"").length}i&&(t[o=o.substring(0,o.length-1).trim()]=a),e=e.substring(n).trim(),r=gX.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=g(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],o=i[1];e=e.replace(r,o)}return e},e}()),SX=e("LabelOutline",(uq=$s("cc.LabelOutline"),hq=pc(),_q=tc(110),fq=hc(),dq=ec(Lj),pq=xc(),mq=xc(),uq(vq=hq(vq=_q(vq=fq(vq=dq(vq=uc((Sq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_color",yq,m(t)),y(t,"_width",xq,m(t)),t}u(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(Lj);e&&e.updateRenderData(!0)},c(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(Bu),yq=x((gq=Sq).prototype,"_color",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(0,0,0,255)}}),xq=x(gq.prototype,"_width",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),x(gq.prototype,"color",[pq],Object.getOwnPropertyDescriptor(gq.prototype,"color"),gq.prototype),x(gq.prototype,"width",[mq],Object.getOwnPropertyDescriptor(gq.prototype,"width"),gq.prototype),vq=gq))||vq)||vq)||vq)||vq)||vq)||vq));T.LabelOutline=SX,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(dX||(dX={})),Ze(dX),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(pX||(pX={})),Ze(pX),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(mX||(mX={})),Ze(mX),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(vX||(vX={}));var TX,EX=e("Sprite",(Tq=$s("cc.Sprite"),Eq=pc(),Cq=tc(110),Aq=hc(),bq=Mc(AG),Pq=bc(),Rq=xc(),wq=Mc(EG),Iq=bc(),Dq=xc(),Oq=Mc(dX),Mq=bc(),Nq=xc(),Lq=Mc(pX),Bq=bc(),Fq=xc(),zq=bc(),Uq=xc(),kq=Sc(),Gq=bc(),Hq=xc(),Vq=Sc(),jq=bc(),Wq=xc(),qq=vc(),Xq=bc(),Yq=xc(),Kq=bc(),Qq=xc(),Zq=Mc(mX),Jq=bc(),$q=xc(),Tq(eX=Eq(eX=Cq(eX=Aq((fX=_X=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_spriteFrame",nX,m(t)),y(t,"_type",iX,m(t)),y(t,"_fillType",rX,m(t)),y(t,"_sizeMode",oX,m(t)),y(t,"_fillCenter",aX,m(t)),y(t,"_fillStart",sX,m(t)),y(t,"_fillRange",cX,m(t)),y(t,"_isTrimmedMode",lX,m(t)),y(t,"_useGrayscale",uX,m(t)),y(t,"_atlas",hX,m(t)),t}u(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial();var t=this._spriteFrame;t&&(this._updateUVs(),this._type===dX.SLICED&&t.on(EG.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===dX.SLICED&&this._spriteFrame.off(EG.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof Cm){var i=e.getPixelFormat();n=i===im.RGBA_ETC1||i===im.RGB_A_PVRTC_4BPPV1||i===im.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=mV.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=mV.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=mV.GRAYSCALE:this._instanceMaterialType=mV.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof hS){var n=l({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new Nv;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===dX.SLICED?this._spriteFrame.on(EG.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(EG.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(mX.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(mX.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(e){var t=this._spriteFrame;e&&this._type===dX.SLICED&&e.off(EG.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===dX.SLICED&&t.on(EG.EVENT_UV_UPDATED,this._updateUVs,this))},c(t,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===pX.RADIAL||this._fillType===pX.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===dX.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=Kt(e,0,1),this._type===dX.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=Kt(e,-1,1),this._type===dX.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===dX.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==mX.CUSTOM&&this._applySpriteSize())}}]),t}(Nj),_X.FillType=pX,_X.Type=dX,_X.SizeMode=mX,_X.EventType=vX,x((tX=fX).prototype,"spriteAtlas",[bq,Pq,Rq],Object.getOwnPropertyDescriptor(tX.prototype,"spriteAtlas"),tX.prototype),x(tX.prototype,"spriteFrame",[wq,Iq,Dq],Object.getOwnPropertyDescriptor(tX.prototype,"spriteFrame"),tX.prototype),x(tX.prototype,"type",[Oq,Mq,Nq],Object.getOwnPropertyDescriptor(tX.prototype,"type"),tX.prototype),x(tX.prototype,"fillType",[Lq,Bq,Fq],Object.getOwnPropertyDescriptor(tX.prototype,"fillType"),tX.prototype),x(tX.prototype,"fillCenter",[zq,Uq],Object.getOwnPropertyDescriptor(tX.prototype,"fillCenter"),tX.prototype),x(tX.prototype,"fillStart",[kq,Gq,Hq],Object.getOwnPropertyDescriptor(tX.prototype,"fillStart"),tX.prototype),x(tX.prototype,"fillRange",[Vq,jq,Wq],Object.getOwnPropertyDescriptor(tX.prototype,"fillRange"),tX.prototype),x(tX.prototype,"trim",[qq,Xq,Yq],Object.getOwnPropertyDescriptor(tX.prototype,"trim"),tX.prototype),x(tX.prototype,"grayscale",[mc,Kq,Qq],Object.getOwnPropertyDescriptor(tX.prototype,"grayscale"),tX.prototype),x(tX.prototype,"sizeMode",[Zq,Jq,$q],Object.getOwnPropertyDescriptor(tX.prototype,"sizeMode"),tX.prototype),nX=x(tX.prototype,"_spriteFrame",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iX=x(tX.prototype,"_type",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dX.SIMPLE}}),rX=x(tX.prototype,"_fillType",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pX.HORIZONTAL}}),oX=x(tX.prototype,"_sizeMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mX.TRIMMED}}),aX=x(tX.prototype,"_fillCenter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gn(0,0)}}),sX=x(tX.prototype,"_fillStart",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cX=x(tX.prototype,"_fillRange",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lX=x(tX.prototype,"_isTrimmedMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uX=x(tX.prototype,"_useGrayscale",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hX=x(tX.prototype,"_atlas",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eX=tX))||eX)||eX)||eX)||eX));T.Sprite=EX;var CX,AX,bX,PX,RX,wX,IX,DX,OX,MX,NX,LX,BX,FX=e("RenderRoot2D",$s("cc.RenderRoot2D")(TX=tc(100)(TX=hc()(TX=ec(QH)(TX=nc(TX=uc(TX=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.onEnable=function(){T.director.root.batcher2D.addScreen(this)},n.onDisable=function(){T.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){T.director.root.batcher2D.removeScreen(this)},t}(Bu))||TX)||TX)||TX)||TX)||TX)||TX),zX=new dn,UX=Ye({OVERLAY:0,INTERSPERSE:1}),kX=e("Canvas",(CX=$s("cc.Canvas"),AX=pc(),bX=tc(100),PX=hc(),RX=Mc(gB),wX=xc(),IX=xc(),DX=Mc(gB),CX(OX=AX(OX=bX(OX=PX(OX=uc(OX=nc((x((MX=function(e){function t(){var t;return y(t=e.call(this)||this,"_cameraComponent",NX,m(t)),y(t,"_alignCanvasWithScreen",LX,m(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new dn,t._renderMode=UX.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(m(t)),t}u(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(gB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(xE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(gB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(gB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(xE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=OO.height/2;else{var e=Wu.windowSize;this._cameraComponent.orthoHeight=e.height/fM.getScaleY()/2}this.node.getWorldPosition(zX),this._cameraComponent.node.setWorldPosition(zX.x,zX.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===UX.OVERLAY?t|1<<30:t&~(1<<30)}return 0},c(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(FX)).prototype,"cameraComponent",[RX,wX],Object.getOwnPropertyDescriptor(MX.prototype,"cameraComponent"),MX.prototype),x(MX.prototype,"alignCanvasWithScreen",[IX],Object.getOwnPropertyDescriptor(MX.prototype,"alignCanvasWithScreen"),MX.prototype),NX=x(MX.prototype,"_cameraComponent",[DX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LX=x(MX.prototype,"_alignCanvasWithScreen",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),OX=MX))||OX)||OX)||OX)||OX)||OX)||OX));T.Canvas=kX,e("UIComponent",$s("cc.UIComponent")(BX=ec(QH)(BX=tc(110)(BX=nc(BX=uc(BX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=LH.DISABLED,t}u(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(Bu))||BX)||BX)||BX)||BX)||BX);var GX,HX,VX,jX,WX,qX,XX,YX,KX,QX,ZX,JX,$X,eY,tY,nY,iY,rY,oY,aY,sY,cY,lY,uY,hY,_Y,fY,dY,pY,mY,vY,gY,yY,xY,SY,TY,EY=new xX,CY="RICHTEXT_CHILD",AY="RICHTEXT_Image_CHILD",bY=new je((function(e){if(!T.isValid(e.node))return!1;var t=e.node.getComponent(SX);return t&&(t.width=0),!0}),20),PY=new je((function(e){return T.isValid(e.node)}),10);function RY(e){return{node:new TA(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function wY(e,t){var n;e===CY?n=bY._get():e===AY&&(n=PY._get());var i=(n=n||RY(e)).node;return i||(i=new TA(e)),i.hideFlags|=Jc.Flags.DontSave|Jc.Flags.HideInHierarchy,e===AY?(n.comp=i.getComponent(EX)||i.addComponent(EX),n.comp.spriteFrame=t,n.comp.type=EX.Type.SLICED,n.comp.sizeMode=EX.SizeMode.CUSTOM):(n.comp=i.getComponent(Lj)||i.addComponent(Lj),n.comp.string=t,n.comp.horizontalAlign=Ij.LEFT,n.comp.verticalAlign=Dj.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var IY,DY=e("RichText",(GX=$s("cc.RichText"),HX=pc(),VX=tc(110),jX=hc(),WX=xc(),qX=Mc(Ij),XX=xc(),YX=xc(),KX=xc(),QX=Mc(IG),ZX=xc(),JX=xc(),$X=bc(),eY=Mc(Mj),tY=xc(),nY=xc(),iY=xc(),rY=Mc(AG),oY=xc(),aY=xc(),GX(sY=HX(sY=VX(sY=jX(sY=uc((TY=SY=function(e){function t(){var t;return y(t=e.call(this)||this,"_lineHeight",lY,m(t)),y(t,"_string",uY,m(t)),y(t,"_horizontalAlign",hY,m(t)),y(t,"_fontSize",_Y,m(t)),y(t,"_maxWidth",fY,m(t)),y(t,"_fontFamily",dY,m(t)),y(t,"_font",pY,m(t)),y(t,"_isSystemFontUsed",mY,m(t)),y(t,"_userDefinedFont",vY,m(t)),y(t,"_cacheMode",gY,m(t)),y(t,"_imageAtlas",yY,m(t)),y(t,"_handleTouchEvent",xY,m(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._updateRichTextStatus=t._updateRichText,t}u(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(xE.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(xE.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=g(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===CY?bY.put(n):n.type===AY&&PY.put(n)}this.node.off(xE.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(xE.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(xE.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(xE.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return wY(CY,e)},n._createImage=function(e){return wY(AY,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(e,t){var n=this,i=function(t){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(t),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(Lj).string=t,i.styleIndex=e,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return t?i(t):i},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(Bu),r=function(){var r=t.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[o];t.enabledInHierarchy&&n&&n.call(t,e,a)})),e.propagationStopped=!0)},o=g(this._segments);!(t=o()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(QH);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===CY||n.name===AY){n.parent===this.node?n.parent=null:e.splice(t,1);var i=RY(n.name);i.node=n,n.name===CY?(i.comp=n.getComponent(Lj),bY.put(i)):(i.comp=n.getComponent(EX),PY.put(i))}}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==CY&&n.name!==AY||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(Lj);i&&(i.string=e)}return n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(e,r,e.length),a=e.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=aH(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else V(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=EY.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+qG)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(nH(i)||iH(i))return 1;for(var r=1,o=t+1;o<n&&!iH(i=e.charAt(o))&&!nH(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case Ij.LEFT:break;case Ij.CENTER:l-=this._linesWidth[c-1]/2;break;case Ij.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(EX)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+qG);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var d=s.imageOffset.split(",");if(1===d.length&&d[0]){var p=parseFloat(d[0]);Number.isInteger(p)&&(h.y+=p)}else if(2===d.length){var m=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(SX);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return Wn[t]?Wn[t]:(new Wn).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(Lj);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(SX);r||(r=e.node.addComponent(SX)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var o=n.event;o&&(e.clickHandler=o.click||"",e.clickParam=o.param||"")}t.cacheMode=this._cacheMode,this._font instanceof IG&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var a=t._assembler;a&&a.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=g(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=Wn.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},c(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(Bu),SY.HorizontalAlign=Ij,SY.VerticalAlign=Dj,x((cY=TY).prototype,"string",[Pc,WX],Object.getOwnPropertyDescriptor(cY.prototype,"string"),cY.prototype),x(cY.prototype,"horizontalAlign",[qX,XX],Object.getOwnPropertyDescriptor(cY.prototype,"horizontalAlign"),cY.prototype),x(cY.prototype,"fontSize",[YX],Object.getOwnPropertyDescriptor(cY.prototype,"fontSize"),cY.prototype),x(cY.prototype,"fontFamily",[KX],Object.getOwnPropertyDescriptor(cY.prototype,"fontFamily"),cY.prototype),x(cY.prototype,"font",[QX,ZX],Object.getOwnPropertyDescriptor(cY.prototype,"font"),cY.prototype),x(cY.prototype,"useSystemFont",[JX,$X],Object.getOwnPropertyDescriptor(cY.prototype,"useSystemFont"),cY.prototype),x(cY.prototype,"cacheMode",[eY,tY],Object.getOwnPropertyDescriptor(cY.prototype,"cacheMode"),cY.prototype),x(cY.prototype,"maxWidth",[nY],Object.getOwnPropertyDescriptor(cY.prototype,"maxWidth"),cY.prototype),x(cY.prototype,"lineHeight",[iY],Object.getOwnPropertyDescriptor(cY.prototype,"lineHeight"),cY.prototype),x(cY.prototype,"imageAtlas",[rY,oY],Object.getOwnPropertyDescriptor(cY.prototype,"imageAtlas"),cY.prototype),x(cY.prototype,"handleTouchEvent",[aY],Object.getOwnPropertyDescriptor(cY.prototype,"handleTouchEvent"),cY.prototype),lY=x(cY.prototype,"_lineHeight",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),uY=x(cY.prototype,"_string",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),hY=x(cY.prototype,"_horizontalAlign",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ij.LEFT}}),_Y=x(cY.prototype,"_fontSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),fY=x(cY.prototype,"_maxWidth",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dY=x(cY.prototype,"_fontFamily",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),pY=x(cY.prototype,"_font",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mY=x(cY.prototype,"_isSystemFontUsed",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vY=x(cY.prototype,"_userDefinedFont",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gY=x(cY.prototype,"_cacheMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mj.NONE}}),yY=x(cY.prototype,"_imageAtlas",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xY=x(cY.prototype,"_handleTouchEvent",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sY=cY))||sY)||sY)||sY)||sY)||sY));T.RichText=DY;var OY=e("UIMeshRenderer",$s("cc.UIMeshRenderer")(IY=pc()(IY=tc(110)(IY=hc()(IY=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._models=null,t._modelComponent=null,t.stencilStage=LH.DISABLED,t}u(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(e){if(this._models){this._modelComponent._detachFromScene();for(var t,n=g(this._models);!(t=n()).done;){var i=t.value;e.commitModel.call(e,this,i,this._modelComponent.material)}return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=ld.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},c(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(Bu))||IY)||IY)||IY)||IY);T.UIMeshRenderer=OY;var MY,NY,LY,BY,FY,zY,UY,kY,GY,HY,VY,jY,WY,qY,XY,YY,KY,QY,ZY,JY,$Y,eK,tK,nK,iK,rK,oK,aK,sK,cK=sd.Enum.NONE|sd.Enum.UI_3D,lK=function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=cK,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=cK,this.renderScene=null},t.fillPasses=function(e,t,n,i,r,o){if(e){var a=e.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var c=0;c<a.length;c++){this._passes[c]||(this._passes[c]=new hv(T.director.root));var l=a[c],u=this._passes[c];l.update(),t||(t=l.depthStencilState,n=0),i||(i=l.blendState,r=0),-1===r&&(r=0),s=n<<16|r,u._initPassFromTarget(l,t,i,s),this._shaders[c]=u.getShaderVariant(o)}}},c(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}(),uK=(e("UIStaticBatch",(MY=$s("cc.UIStaticBatch"),NY=pc(),LY=hc(),BY=tc(110),FY=vc(),MY(zY=NY(zY=LY(zY=BY((x((UY=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._bufferAccessor=null,t._dirty=!0,t._uiDrawBatchList=[],t}u(t,e);var n=t.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var e=new lK;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return bM.root&&bM.root.batcher2D?bM.root.batcher2D:(V(9301),null)},c(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(Nj)).prototype,"color",[Vc,FY],Object.getOwnPropertyDescriptor(UY.prototype,"color"),UY.prototype),zY=UY))||zY)||zY)||zY)||zY)),e("LabelShadow",(kY=$s("cc.LabelShadow"),GY=pc(),HY=tc(110),VY=hc(),jY=ec(Lj),WY=xc(),qY=xc(),XY=xc(),kY(YY=GY(YY=HY(YY=VY(YY=jY(YY=uc(($Y=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_color",QY,m(t)),y(t,"_offset",ZY,m(t)),y(t,"_blur",JY,m(t)),t}u(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(Lj);e&&e.updateRenderData(!0)},c(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(Bu),QY=x((KY=$Y).prototype,"_color",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(0,0,0,255)}}),ZY=x(KY.prototype,"_offset",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gn(2,2)}}),JY=x(KY.prototype,"_blur",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),x(KY.prototype,"color",[WY],Object.getOwnPropertyDescriptor(KY.prototype,"color"),KY.prototype),x(KY.prototype,"offset",[qY],Object.getOwnPropertyDescriptor(KY.prototype,"offset"),KY.prototype),x(KY.prototype,"blur",[XY],Object.getOwnPropertyDescriptor(KY.prototype,"blur"),KY.prototype),YY=KY))||YY)||YY)||YY)||YY)||YY)||YY))),hK=(e("UIOpacity",(eK=$s("cc.UIOpacity"),tK=pc(),nK=tc(110),iK=hc(),rK=xc(),eK(oK=tK(oK=nK(oK=iK(oK=uc((x((aK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_opacity",sK,m(t)),t}u(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},c(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=ht(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(Bu)).prototype,"opacity",[mc,rK],Object.getOwnPropertyDescriptor(aK.prototype,"opacity"),aK.prototype),sK=x(aK.prototype,"_opacity",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),oK=aK))||oK)||oK)||oK)||oK)||oK)),function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n});function _K(e,t,n,i,r){var o=0,a=null;if(r===function(e,t,n,i){for(var r=0,o=t,a=n-i;o<n;o+=i)r+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return r}(e,t,n,i)>0)for(o=t;o<n;o+=i)a=IK(o,e[o],e[o+1],a);else for(o=n-i;o>=t;o-=i)a=IK(o,e[o],e[o+1],a);return a&&bK(a,a.next)&&(DK(a),a=a.next),a}function fK(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!bK(n,n.next)&&0!==AK(n.prev,n,n.next))n=n.next;else{if(DK(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function dK(e,t,n,i,r,o,a){if(void 0===a&&(a=0),e){!a&&o&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=SK(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(e,i,r,o);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,o?mK(e,i,r,o):pK(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),DK(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?dK(e=vK(e,t,n),t,n,i,r,o,2):2===a&&gK(e,t,n,i,r,o):dK(fK(e),t,n,i,r,o,1);break}}}function pK(e){var t=e.prev,n=e,i=e.next;if(AK(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(EK(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&AK(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function mK(e,t,n,i){var r=e.prev,o=e,a=e.next;if(AK(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=SK(s,c,t,n,i),_=SK(l,u,t,n,i),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&EK(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&AK(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&EK(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&AK(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function vK(e,t,n){var i=e;do{var r=i.prev,o=i.next.next;!bK(r,o)&&PK(r,i,i.next,o)&&RK(r,o)&&RK(o,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(o.i/n),DK(i),DK(i.next),i=e=o),i=i.next}while(i!==e);return i}function gK(e,t,n,i,r,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&CK(a,s)){var c=wK(a,s);return a=fK(a,a.next),c=fK(c,c.next),dK(a,t,n,i,r,o),void dK(c,t,n,i,r,o)}s=s.next}a=a.next}while(a!==e)}function yK(e,t){return e.x-t.x}function xK(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&EK(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&RK(n,e)&&(a=n,_=c),n=n.next;return a}(e,t)){var n=wK(t,e);fK(n,n.next)}}function SK(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function TK(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function EK(e,t,n,i,r,o,a,s){return(r-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(i-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function CK(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&PK(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&RK(e,t)&&RK(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function AK(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function bK(e,t){return e.x===t.x&&e.y===t.y}function PK(e,t,n,i){return!!(bK(e,t)&&bK(n,i)||bK(e,i)&&bK(n,t))||AK(e,t,n)>0!=AK(e,t,i)>0&&AK(n,i,e)>0!=AK(n,i,t)>0}function RK(e,t){return AK(e.prev,e,e.next)<0?AK(e,t,e.next)>=0&&AK(e,e.prev,t)>=0:AK(e,t,e.prev)<0||AK(e,e.next,t)<0}function wK(e,t){var n=new hK(e.i,e.x,e.y),i=new hK(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function IK(e,t,n,i){var r=new hK(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function DK(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function OK(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,o=_K(e,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(e,t,n,i){var r,o=[],a=0,s=null;for(a=0,r=t.length;a<r;a++)(s=_K(e,t[a]*i,a<r-1?t[a+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(TK(s)));if(o.sort(yK),!n)return n;for(a=0;a<o.length;a++)xK(o[a],n),n=fK(n,n.next);return n}(e,t,o,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var d=n;d<r;d+=n)(h=e[d])<s&&(s=h),(_=e[d+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return dK(o,a,n,s,c,f),a}for(var MK=Math.PI,NK=Math.min,LK=Math.max,BK=Math.ceil,FK=Math.acos,zK=Math.cos,UK=Math.sin,kK=Math.atan2,GK=null,HK=null,VK=new Wn,jK=[],WK=0;WK<4;WK++)jK.push(new dn);function qK(e,t,n){return e<t?t:e>n?n:e}var XK={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!HK)return null;var n=HK.getRenderDataList(),i=n[HK.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+t:0;return(o>65535||3*o>131070)&&(++HK.dataOffset,HK.dataOffset<n.length?i=n[HK.dataOffset]:(i=HK.requestRenderData(),n[HK.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(t,3*t),i},stroke:function(e){Wn.copy(VK,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){Wn.copy(VK,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t=.5*e.lineWidth,n=e.lineCap,i=e.lineJoin,r=e.miterLimit;if(HK=e.impl){var o=function(e,t,n){var i=2*FK(e/(e+n));return LK(2,BK(t/i))}(t,MK,HK.tessTol);this._calculateJoins(HK,t,i,r);for(var a=HK.paths,s=0,c=HK.pathOffset,l=HK.pathLength;c<l;c++){var u=a[c],h=u.points.length;i===Vj.ROUND?s+=2*(h+u.bevel*(o+2)+1):s+=2*(h+5*u.bevel+1),u.closed||(n===Hj.ROUND?s+=2*(2*o+2):s+=12)}var _=GK=this.getRenderData(e,s);if(_){for(var f=_.vData,d=_.iData,p=HK.pathOffset,m=HK.pathLength;p<m;p++){var v=a[p],g=v.points,y=g.length,x=_.vertexStart,S=void 0,T=void 0,E=0,C=0,A=v.closed;if(A?(S=g[y-1],T=g[0],E=0,C=y):(S=g[0],T=g[1],E=1,C=y-1),T=T||S,!A){var b=new ZW(T.x,T.y);b.subtract(S),b.normalize();var P=b.x,R=b.y;n===Hj.BUTT?this._buttCapStart(S,P,R,t,0):n===Hj.SQUARE?this._buttCapStart(S,P,R,t,t):n===Hj.ROUND&&this._roundCapStart(S,P,R,t,o)}for(var w=E;w<C;++w)i===Vj.ROUND?this._roundJoin(S,T,t,t,o):0!=(T.flags&(jj.PT_BEVEL|jj.PT_INNERBEVEL))?this._bevelJoin(S,T,t,t):(this._vSet(T.x+T.dmx*t,T.y+T.dmy*t,1),this._vSet(T.x-T.dmx*t,T.y-T.dmy*t,-1)),S=T,T=g[w+1];if(A){var I=8*x;this._vSet(f[I],f[I+1],1),this._vSet(f[I+8],f[I+8+1],-1)}else{var D=new ZW(T.x,T.y);D.subtract(S),D.normalize();var O=D.x,M=D.y;n===Hj.BUTT?this._buttCapEnd(T,O,M,t,0):n===Hj.SQUARE?this._buttCapEnd(T,O,M,t,t):n===Hj.ROUND&&this._roundCapEnd(T,O,M,t,o)}for(var N=_.indexStart,L=x+2,B=_.vertexStart;L<B;L++)d[N++]=L-2,d[N++]=L-1,d[N++]=L;_.indexStart=N}GK=null,HK=null}}},_expandFill:function(e){if(HK=e.impl){for(var t=HK.paths,n=0,i=HK.pathOffset,r=HK.pathLength;i<r;i++)n+=t[i].points.length;var o=GK=this.getRenderData(e,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=HK.pathOffset,u=HK.pathLength;l<u;l++){var h=t[l],_=h.points,f=_.length;if(0!==f){for(var d=o.vertexStart,p=0;p<f;++p)this._vSet(_[p].x,_[p].y);var m=o.indexStart;if(h.complex){for(var v=[],g=d,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=OK(v,null,3);if(!S||0===S.length)continue;for(var T=0,E=S.length;T<E;T++)c[m++]=S[T]+d}else for(var C=d,A=d+2,b=a.vertexStart;A<b;A++)c[m++]=C,c[m++]=A-1,c[m++]=A;a.indexStart=m}}GK=null,HK=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var d,p,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(d=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/d;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=jj.PT_LEFT),d*(p=LK(11,NK(h.len,_.len)*r))*p<1&&(_.flags|=jj.PT_INNERBEVEL),_.flags&jj.PT_CORNER&&(d*i*i<1||n===Vj.BEVEL||n===Vj.ROUND)&&(_.flags|=jj.PT_BEVEL),0!=(_.flags&(jj.PT_BEVEL|jj.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new ZW(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*i,s=o-t.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(e,t,n,i,r){var o=e.x-t*r,a=e.y-n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var o=e.x+t*r,a=e.y+n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var o=e.x,a=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*MK,h=zK(u)*i,_=UK(u)*i;this._vSet(o-s*h-t*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var o=e.x,a=e.y,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*MK,h=zK(u)*i,_=UK(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+t*_,a-c*h+n*_,1)}},_roundJoin:function(e,t,n,i,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&jj.PT_LEFT)){var h=this._chooseBevel(t.flags&jj.PT_INNERBEVEL,e,t,n),_=h[0],f=h[1],d=h[2],p=h[3],m=kK(-a,-o),v=kK(-c,-s);v>m&&(v-=2*MK),this._vSet(_,f,1),this._vSet(l-o*i,t.y-a*i,-1);for(var g=qK(BK((m-v)/MK)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+zK(x)*i,T=u+UK(x)*i;this._vSet(l,u,0),this._vSet(S,T,-1)}this._vSet(d,p,1),this._vSet(l-s*i,u-c*i,-1)}else{var E=this._chooseBevel(t.flags&jj.PT_INNERBEVEL,e,t,-i),C=E[0],A=E[1],b=E[2],P=E[3],R=kK(a,o),w=kK(c,s);w<R&&(w+=2*MK),this._vSet(l+o*i,u+a*i,1),this._vSet(C,A,-1);for(var I=qK(BK((w-R)/MK)*r,2,r),D=0;D<I;D++){var O=R+D/(I-1)*(w-R),M=l+zK(O)*n,N=u+UK(O)*n;this._vSet(M,N,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(b,P,-1)}},_bevelJoin:function(e,t,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=e.dy,f=-e.dx,d=t.dy,p=-t.dx;if(t.flags&jj.PT_LEFT){var m=this._chooseBevel(t.flags&jj.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-_*i,t.y-f*i,-1),this._vSet(u,h,1),this._vSet(t.x-d*i,t.y-p*i,-1)}else{var v=this._chooseBevel(t.flags&jj.PT_INNERBEVEL,e,t,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(t.x+_*n,t.y+f*n,1),this._vSet(r,o,-1),this._vSet(t.x+d*n,t.y+p*n,1),this._vSet(a,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),GK){var i=GK,r=8*i.vertexStart,o=i.vData;o[r++]=e,o[r++]=t,o[r++]=0,Wn.toArray(o,VK,r),r+=4,o[r++]=n,i.vertexStart++}}},YK=e("graphicsAssembler",{getAssembler:function(){return XK}});iq.Assembler=YK;var KK=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},QK=new Hn,ZK=null,JK=null,$K=[],eQ=[],tQ=[],nQ=[],iQ=new kn,rQ=new kn,oQ=new gn,aQ=null,sQ=0,cQ=0,lQ=0,uQ=0,hQ=0,_Q=1,fQ=null,dQ="",pQ=0,mQ=0,vQ=0,gQ=0,yQ=0,xQ=0,SQ=0,TQ=!1,EQ=0,CQ=0,AQ=0,bQ={updateRenderData:function(e){e.renderData&&ZK!==e&&(e.renderData.vertDirty&&(JK=(ZK=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),ZK.actualFontSize=pQ,JK.setContentSize(rQ),this.updateUVs(e),ZK.renderData.vertDirty=!1,ZK.markForUpdateRenderData(!1),ZK=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.vertexCount,r=t.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){_Q=pQ/mQ},_updateFontFamily:function(e){var t=e.font;fQ=t.spriteFrame,aQ=t.fntConfig,dH.fontAtlas=t.fontDefDictionary,vG.packToDynamicAtlas(e,fQ)},_updateLabelInfo:function(){dH.hash="",dH.margin=0},_updateProperties:function(e){dQ=e.string.toString(),pQ=e.fontSize,mQ=aQ?aQ.fontSize:e.fontSize,vQ=e.horizontalAlign,gQ=e.verticalAlign,yQ=e.spacingX,SQ=e.overflow,xQ=e._lineHeight;var t=JK.contentSize;rQ.width=t.width,rQ.height=t.height,SQ===Oj.NONE?(TQ=!1,rQ.width+=2*dH.margin,rQ.height+=2*dH.margin):SQ===Oj.RESIZE_HEIGHT?(TQ=!0,rQ.height+=2*dH.margin):TQ=e.enableWrapText,dH.lineHeight=xQ,dH.fontSize=pQ,this._setupBMFontOverflowMetrics()},_resetProperties:function(){aQ=null,fQ=null,dH.hash="",dH.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=dQ,t=e.length,n=aQ.kerningDict,i=$K,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t=dQ.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<t;){var h=dQ.charAt(u);if("\n"!==h){for(var _=e(dQ,u,t),f=s,d=c,p=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=dQ.charAt(y)))if(l=dH.fontAtlas.getLetterDefinitionForChar(h,dH)){var x=m+l.offsetX*_Q-dH.margin;if(TQ&&AQ>0&&i>0&&x+l.w*_Q>AQ&&!iH(h)){tQ.push(a),a=0,n++,i=0,r-=xQ*this._getFontScale()+0,v=!0;break}oQ.x=x,oQ.y=r-l.offsetY*_Q,this._recordLetterInfo(oQ,h,y,n),y+1<$K.length&&y<t-1&&(m+=$K[y+1]),m+=l.xAdvance*_Q+yQ,p=oQ.x+l.w*_Q,f<oQ.y&&(f=oQ.y),d>oQ.y-l.h*_Q&&(d=oQ.y-l.h*_Q)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+aQ.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>d&&(c=d),o<(a=p)&&(o=a),u+=_)}else tQ.push(a),a=0,n++,i=0,r-=xQ*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return tQ.push(a),cQ=(sQ=n+1)*xQ*this._getFontScale(),sQ>1&&(cQ+=0*(sQ-1)),rQ.width=EQ,rQ.height=CQ,EQ<=0&&(rQ.width=parseFloat(o.toFixed(2))+2*dH.margin),CQ<=0&&(rQ.height=parseFloat(cQ.toFixed(2))+2*dH.margin),uQ=rQ.height,hQ=0,s>0&&(uQ=rQ.height+s),c<-cQ&&(hQ=cQ+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return SQ===Oj.SHRINK?_Q:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(nH(i)||"\n"===i||iH(i))return 1;var r=1,o=dH.fontAtlas.getLetterDefinitionForChar(i,dH);if(!o)return r;for(var a=o.xAdvance*_Q+yQ,s=t+1;s<n&&(i=e.charAt(s),o=dH.fontAtlas.getLetterDefinitionForChar(i,dH));++s){if(a+o.offsetX*_Q+o.w*_Q>AQ&&!iH(i)&&AQ>0)return r;if(a+=o.xAdvance*_Q+yQ,"\n"===i||iH(i)||nH(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=eQ.length){var n=new KK;eQ.push(n)}eQ[e].char=t,eQ[e].hash=""+t.charCodeAt(0)+dH.hash,eQ[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=eQ.length){var r=new KK;eQ.push(r)}var o=""+t.charCodeAt(0)+dH.hash;eQ[n].line=i,eQ[n].char=t,eQ[n].hash=o,eQ[n].valid=dH.fontAtlas.getLetter(o).valid,eQ[n].x=e.x,eQ[n].y=e.y},_alignText:function(){cQ=0,tQ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),SQ===Oj.SHRINK&&pQ>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||SQ===Oj.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),pQ=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|pQ,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;_Q=r/mQ,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return cQ>rQ.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=dQ.length;t<n;++t){var i=eQ[t];if(i.valid){var r=dH.fontAtlas.getLetterDefinitionForChar(i.char,dH);if(!r)continue;var o=i.x+r.w*_Q,a=i.line;if(EQ>0)if(TQ){if(tQ[a]>rQ.width&&(o>rQ.width||o<0)){e=!0;break}}else if(o>rQ.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=tQ[t],i=e>rQ.width||e<0;return TQ?n>rQ.width&&i:i},_updateQuads:function(){if(!ZK)return!1;var e=fQ?fQ.texture:dH.fontAtlas.getTexture(),t=ZK.renderData;t.dataLength=0,t.resize(0,0);for(var n=JK.anchorPoint,i=rQ,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=dQ.length;s<c;++s){var l=eQ[s];if(l.valid){var u=dH.fontAtlas.getLetter(l.hash);if(u){QK.height=u.h,QK.width=u.w,QK.x=u.u,QK.y=u.v;var h=l.y+lQ;if(CQ>0){if(h>uQ){var _=h-uQ;QK.y+=_,QK.height-=_,h-=_}h-u.h*_Q<hQ&&SQ===Oj.CLAMP&&(QK.height=h<hQ?0:(h-hQ)/_Q)}var f=l.line,d=l.x+u.w/2*_Q+nQ[f];if(EQ>0&&this._isHorizontalClamped(d,f))if(SQ===Oj.CLAMP)QK.width=0;else if(SQ===Oj.SHRINK){if(rQ.width>u.w){a=!1;break}QK.width=0}if(QK.height>0&&QK.width>0){var p=this._determineRect(),m=l.x+nQ[l.line];this.appendQuad(ZK,e,QK,p,m-r,h-o,_Q)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var e=fQ.isRotated(),t=fQ.getOriginalSize(),n=fQ.getRect(),i=fQ.getOffset(),r=i.x+(t.width-n.width)/2,o=i.y-(t.height-n.height)/2;if(e){var a=QK.x;QK.x=n.x+n.height-QK.y-QK.height-o,QK.y=a+n.y-r,QK.y<0&&(QK.height+=o)}else QK.x+=n.x-r,QK.y+=n.y+o;return e},_computeAlignmentOffset:function(){switch(nQ.length=0,vQ){case Ij.LEFT:for(var e=0;e<sQ;++e)nQ.push(0);break;case Ij.CENTER:for(var t=0,n=tQ.length;t<n;t++)nQ.push((rQ.width-tQ[t])/2);break;case Ij.RIGHT:for(var i=0,r=tQ.length;i<r;i++)nQ.push(rQ.width-tQ[i])}if(lQ=rQ.height,gQ!==Dj.TOP){var o=rQ.height-cQ+xQ*this._getFontScale()-mQ*_Q;gQ===Dj.BOTTOM?lQ-=o:lQ-=o/2}},_setupBMFontOverflowMetrics:function(){var e=rQ.width,t=rQ.height;SQ===Oj.RESIZE_HEIGHT&&(t=0),SQ===Oj.NONE&&(e=0,t=0),EQ=e,CQ=t,iQ.width=e,iQ.height=t,AQ=e}},PQ=new Wn(255,255,255,255),RQ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;PQ.set(e.color),PQ.a=255*t._uiProps.opacity,uG(t,0,e.renderData,PQ)},appendQuad:function(e,t,n,i,r,o,a){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=t.width,h=t.height,_=n.width,f=n.height,d=0,p=0,m=0,v=0;i?(d=n.x/u,v=(n.x+f)/u,p=(n.y+_)/h,m=n.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=p,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=p):(d=n.x/u,v=(n.x+_)/u,p=(n.y+f)/h,m=n.y/h,l[c].u=d,l[c].v=p,l[c+1].u=v,l[c+1].v=p,l[c+2].u=d,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}},updateColor:function(){}};Pe(RQ,bQ);var wQ=null,IQ=Re(bQ,{getAssemblerData:function(){return wQ||(wQ=new fH(1024,1024)),wQ.getTexture()},_updateFontFamily:function(e){dH.fontAtlas=wQ,dH.fontFamily=this._getFontFamily(e);var t=e.getComponent(SX);t&&t.enabled?(dH.isOutlined=!0,dH.margin=t.width,dH.out=t.color.clone(),dH.out.a=t.color.a*e.color.a/255):(dH.isOutlined=!1,dH.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){dH.fontDesc=this._getFontDesc(),dH.color=e.color,dH.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(dH)},_getFontDesc:function(){return dH.fontSize.toString()+"px "+dH.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),DQ=new Wn(255,255,255,255),OQ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){if(e.renderData){var t=e.node;DQ.a=255*t._uiProps.opacity,uG(t,0,e.renderData,DQ)}},updateColor:function(){},appendQuad:RQ.appendQuad};Pe(OQ,IQ);var MQ=Lj.Overflow,NQ=(1/255).toFixed(3),LQ=null,BQ=null,FQ=null,zQ="",UQ="",kQ=0,GQ=0,HQ=[],VQ=new kn,jQ=0,WQ=0,qQ=0,XQ=new Wn,YQ="",KQ=MQ.NONE,QQ=!1,ZQ=null,JQ=Wn.BLACK.clone(),$Q=null,eZ=Wn.BLACK.clone(),tZ=new Hn,nZ=kn.ZERO.clone(),iZ=kn.ZERO.clone(),rZ=gn.ZERO.clone(),oZ=gn.ZERO.clone(),aZ=0,sZ=0,cZ=!1,lZ=!1,uZ=!1,hZ=["left","center","right"],_Z={getAssemblerData:function(){return Lj._canvasPool.get()},resetAssemblerData:function(e){e&&Lj._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=kQ,t.setContentSize(VQ),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),LQ=null,BQ=null,FQ=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){YQ=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(LQ=n.context,BQ=n.canvas,FQ=e.spriteFrame,UQ=e.string.toString(),kQ=e.fontSize,GQ=kQ,KQ=e.overflow,iZ.width=VQ.width=t.width,iZ.height=VQ.height=t.height,sZ=e.underlineHeight,jQ=e.lineHeight,WQ=e.horizontalAlign,qQ=e.verticalAlign,XQ=e.color,e.node._uiProps.opacity,cZ=e.isBold,lZ=e.isItalic,uZ=e.isUnderline,QQ=KQ!==MQ.NONE&&(KQ===MQ.RESIZE_HEIGHT||e.enableWrapText),(ZQ=(ZQ=SX&&e.getComponent(SX))&&ZQ.enabled&&ZQ.width>0?ZQ:null)&&JQ.set(ZQ.color),($Q=($Q=uK&&e.getComponent(uK))&&$Q.enabled?$Q:null)&&eZ.set($Q.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(nZ.width=nZ.height=0,ZQ&&(e=t=n=i=r=ZQ.width,nZ.width=nZ.height=2*r),$Q){var o=$Q.blur+r,a=$Q.offset.x,s=$Q.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),e=Math.max(e,s+o),t=Math.max(t,-s+o)}if(lZ){var c=GQ*Math.tan(.20943951);i+=c,nZ.width+=c}tZ.x=n,tZ.y=e,tZ.width=n+i,tZ.height=e+t},_calculateFillTextStartPosition:function(){var e=0;WQ===Ij.RIGHT?e=VQ.width-tZ.width:WQ===Ij.CENTER&&(e=(VQ.width-tZ.width)/2);var t=this._getLineHeight()*(HQ.length-1),n=kQ*(1-qG/2);if(qQ!==Dj.TOP){var i=t+tZ.height+kQ-VQ.height;qQ===Dj.BOTTOM?n-=i+=qG/2*kQ:n-=i/2}n+=0*kQ,rZ.set(e+tZ.x,n+tZ.y)},_updateTexture:function(e){if(LQ&&BQ){LQ.clearRect(0,0,BQ.width,BQ.height),LQ.font=zQ,this._calculateFillTextStartPosition();var t=this._getLineHeight();LQ.lineJoin="round",ZQ?(LQ.fillStyle="rgba("+JQ.r+", "+JQ.g+", "+JQ.b+", "+NQ+")",LQ.fillRect(0,0,BQ.width,BQ.height)):e._srcBlendFactor===vi.SRC_ALPHA&&(LQ.fillStyle="rgba("+XQ.r+", "+XQ.g+", "+XQ.b+", "+NQ+")",LQ.fillRect(0,0,BQ.width,BQ.height)),LQ.fillStyle="rgb("+XQ.r+", "+XQ.g+", "+XQ.b+")";var n=rZ.x,i=0;this._drawTextEffect(rZ,t);for(var r=0;r<HQ.length;++r)i=rZ.y+r*t,ZQ&&LQ.strokeText(HQ[r],n,i),LQ.fillText(HQ[r],n,i);$Q&&(LQ.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===Lj.CacheMode.BITMAP){var t=e.ttfSpriteFrame;vG.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;FQ&&BQ&&(n=FQ instanceof EG?FQ.texture:FQ,0!==BQ.width&&0!==BQ.height&&(n.reset({width:BQ.width,height:BQ.height,mipmapLevel:1}),n.uploadData(BQ),FQ instanceof EG&&(FQ.rect=new Hn(0,0,BQ.width,BQ.height),FQ._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),T.director.root&&T.director.root.batcher2D&&T.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==Lj.CacheMode.BITMAP||!BQ||BQ.width<=0||BQ.height<=0)){var t=e.ttfSpriteFrame;vG.packToDynamicAtlas(e,t)}},_setupOutline:function(){LQ.strokeStyle="rgba("+JQ.r+", "+JQ.g+", "+JQ.b+", "+JQ.a/255+")",LQ.lineWidth=2*ZQ.width},_setupShadow:function(){LQ.shadowColor="rgba("+eZ.r+", "+eZ.g+", "+eZ.b+", "+eZ.a/255+")",LQ.shadowBlur=$Q.blur,LQ.shadowOffsetX=$Q.offset.x,LQ.shadowOffsetY=-$Q.offset.y},_drawTextEffect:function(e,t){if($Q||ZQ||uZ){var n=HQ.length>1&&$Q,i=this._measureText(LQ,zQ),r=0,o=0;$Q&&this._setupShadow(),ZQ&&this._setupOutline();for(var a=0;a<HQ.length;++a)r=e.x,o=e.y+a*t,n&&(ZQ&&LQ.strokeText(HQ[a],r,o),LQ.fillText(HQ[a],r,o)),uZ&&(aZ=i(HQ[a]),WQ===Ij.RIGHT?oZ.x=e.x-aZ:WQ===Ij.CENTER?oZ.x=e.x-aZ/2:oZ.x=e.x,oZ.y=o+GQ/8,LQ.fillRect(oZ.x,oZ.y,aZ,sZ));n&&(LQ.shadowColor="transparent")}},_updateLabelDimensions:function(){VQ.width=Math.min(VQ.width,2048),VQ.height=Math.min(VQ.height,2048);var e=!1;BQ.width!==VQ.width&&(BQ.width=VQ.width,e=!0),BQ.height!==VQ.height&&(BQ.height=VQ.height,e=!0),e&&(LQ.font=zQ),LQ.textAlign=hZ[WQ],LQ.textBaseline="alphabetic"},_getFontDesc:function(){var e=kQ.toString()+"px ";return e+=YQ,cZ&&(e="bold "+e),lZ&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===jQ?kQ:jQ*kQ/GQ)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=g(e);!(n=r()).done;){var o=rH(t,n.value,zQ);i.push(o)}return i},_measureText:function(e,t){return function(n){return rH(e,n,t)}},_calculateShrinkFont:function(e){if(LQ){var t=this._calculateParagraphLength(e,LQ),n=0,i=0,r=0;if(QQ){var o=iZ.width,a=iZ.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|kQ+1,l=0;s<c;){if((l=s+c+1>>1)<=0){G(4003);break}kQ=l,zQ=this._getFontDesc(),LQ.font=zQ;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=rH(LQ,e[n],zQ);i+=aH(e[n],h,o,this._measureText(LQ,zQ)).length*u}i>a?c=l-1:s=l}0===s?G(4003):(kQ=s,zQ=this._getFontDesc(),LQ.font=zQ)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var _=(VQ.width-tZ.width)/r,f=VQ.height/i;kQ=GQ*Math.min(1,_,f)|0,zQ=this._getFontDesc(),LQ.font=zQ}}},_calculateWrapText:function(e){if(QQ&&LQ){HQ=[];for(var t=iZ.width,n=0;n<e.length;++n){var i=rH(LQ,e[n],zQ),r=aH(e[n],i,t,this._measureText(LQ,zQ));HQ=HQ.concat(r)}}},_calculateLabelFont:function(){if(LQ){var e=UQ.split("\n");switch(HQ=e,zQ=this._getFontDesc(),LQ.font=zQ,KQ){case MQ.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=rH(LQ,e[i],zQ);t=t>r?t:r}n=(HQ.length+qG)*this._getLineHeight();var o=parseFloat(t.toFixed(2)),a=parseFloat(n.toFixed(2));VQ.width=o+tZ.width,VQ.height=a+tZ.height,iZ.width=o+nZ.width,iZ.height=a+nZ.height;break;case MQ.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case MQ.CLAMP:this._calculateWrapText(e);break;case MQ.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(HQ.length+qG)*this._getLineHeight();VQ.height=s+tZ.height,iZ.height=s+nZ.height}}}},fZ=Wn.WHITE.clone(),dZ={createData:function(e){var t=e.requestRenderData();t.dataLength=2,t.resize(4,6);var n=t.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)Wn.toArray(n,fZ,i),i+=9;return t},fillBuffers:function(e){var t=e.renderData.chunk,n=e.renderData.data,i=e.node,r=t.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,_=o.y*l.y,f=a.y*l.y,d=c.x,p=c.y,m=c.z,v=c.w,g=d*p,y=m*v,x=d*d-p*p,S=v*v-m*m,T=S+x,E=2*(g-y),C=S-x,A=2*(g+y),b=s.x,P=s.y;r[0]=T*u+E*_+b,r[1]=C*_+A*u+P,r[9]=T*h+E*_+b,r[10]=C*_+A*h+P,r[18]=T*u+E*f+b,r[19]=C*f+A*u+P,r[27]=T*h+E*f+b,r[28]=C*f+A*h+P;var R=t.bufferId,w=t.vertexOffset,I=t.vertexAccessor.getMeshBuffer(t.bufferId),D=t.vertexAccessor.getIndexBuffer(R),O=I.indexOffset;D[O++]=w,D[O++]=w+1,D[O++]=w+2,D[O++]=w+2,D[O++]=w+1,D[O++]=w+3,I.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var n=t.chunk.vb,i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Pe(dZ,_Z);var pZ=e("labelAssembler",{getAssembler:function(e){var t=dZ;return e.font instanceof jG?t=RQ:e.cacheMode===Lj.CacheMode.CHAR&&(t=OQ),t}});Lj.Assembler=pZ;var mZ=EX.FillType,vZ=new Ln,gZ=new dn,yZ={updateRenderData:function(e){var t=e.spriteFrame;vG.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.updateRenderData(e,t),!n.vertDirty)return;var i=e.fillStart,r=e.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(e,i,o),this.updateVertexData(e,i,o)}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=_=c,d=m=(s.x+s.height)/o,f=v=l,h=p=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=d=c,_=m=(s.x+s.width)/o,h=f=l,p=v=s.y/a),e.fillType){case mZ.HORIZONTAL:r[3]=u+(_-u)*t,r[4]=h+(f-h)*t,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=d+(m-d)*t,r[22]=p+(v-p)*t,r[30]=d+(m-d)*n,r[31]=p+(v-p)*n;break;case mZ.VERTICAL:r[3]=u+(d-u)*t,r[4]=h+(p-h)*t,r[12]=_+(m-_)*t,r[13]=f+(v-f)*t,r[21]=u+(d-u)*n,r[22]=h+(p-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:W(2626)}},updateVertexData:function(e,t,n){var i=e.renderData.data,r=e.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,_=a-c,f=0;switch(e.fillType){case mZ.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*t,h=f;break;case mZ.VERTICAL:f=u+(_-u)*n,u+=(_-u)*t,_=f;break;default:W(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);for(var n,i=g(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(vZ);for(var n=e.renderData.floatStride,i=e.renderData.data,r=t.vb,o=0,a=0;a<4;a++){var s=i[a];dn.transformMat4(gZ,s,vZ),r[o=a*n]=gZ.x,r[o+1]=gZ.y,r[o+2]=gZ.z}},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},xZ=2*Math.PI,SZ=1e-6,TZ=new Ln,EZ=new dn,CZ=[new gn,new gn,new gn,new gn],AZ=new Array(4),bZ=new Array(8),PZ=[new gn,new gn,new gn,new gn],RZ=[new gn,new gn,new gn,new gn],wZ=new gn,IZ=[new gn,new gn,new gn,new gn];function DZ(e,t,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>SZ?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>SZ?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);a[0].x=e,a[0].y=h}if((t-r.x)*c>0){var _=r.y+l*(t-r.x);a[2].x=t,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var d=r.x+u*(n-r.y);a[1].x=d,a[1].y=n}}}function OZ(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function MZ(e,t,n,i,r){var o=AZ,a=o[0],s=o[1],c=o[2],l=o[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,NZ((n.x-a)/(c-a),(n.y-s)/(l-s),e,t),NZ((i.x-a)/(c-a),(i.y-s)/(l-s),e,t+1),NZ((r.x-a)/(c-a),(r.y-s)/(l-s),e,t+2)}function NZ(e,t,n,i){var r=bZ,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=o+(a-o)*t,l.v=s+(c-s)*t}for(var LZ={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;vG.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;if(n&&t){if(!n.vertDirty)return;var i=n.data,r=e.fillStart,o=e.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=xZ)+(o*=xZ);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,o=t.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=AZ;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,_=wZ.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=wZ.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;CZ[0].x=CZ[3].x=a,CZ[1].x=CZ[2].x=c,CZ[0].y=CZ[1].y=s,CZ[2].y=CZ[3].y=l;for(var d,p=g(IZ);!(d=p()).done;){var m=d.value;gn.set(m,0,0)}_!==u[0]&&gn.set(IZ[0],3,0),_!==u[2]&&gn.set(IZ[2],1,2),f!==u[1]&&gn.set(IZ[1],0,1),f!==u[3]&&gn.set(IZ[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,o=0,a=0,s=0,c=bZ;e.isRotated()?(r=i.x/t,o=(i.x+i.height)/t,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/t,o=(i.x+i.width)/t,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(t),DZ(AZ[0],AZ[2],AZ[1],AZ[3],wZ,r,PZ),DZ(AZ[0],AZ[2],AZ[1],AZ[3],wZ,r+o,RZ);for(var s=0,c=0;c<4;++c){var l=IZ[c];if(l)if(o>=xZ)n.dataLength=s+3,MZ(i,s,wZ,CZ[l.x],CZ[l.y]),s+=3;else{var u=OZ(wZ,CZ[l.x]),h=OZ(wZ,CZ[l.y]);h<u&&(h+=xZ),u-=xZ,h-=xZ;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,MZ(i,s,wZ,CZ[l.x],h>=a?RZ[c]:CZ[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,MZ(i,s,wZ,PZ[c],CZ[l.y]),s+=3):(n.dataLength=s+3,MZ(i,s,wZ,PZ[c],RZ[c]),s+=3))),u+=xZ,h+=xZ}}n.resize(s,s),n.updateRenderData(e,t)}},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(TZ);for(var n=e.renderData,i=n.floatStride,r=e.renderData.data,o=t.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];dn.set(EZ,l.x,l.y,0),dn.transformMat4(EZ,EZ,TZ),o[s+0]=EZ.x,o[s+1]=EZ.y,o[s+2]=EZ.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},BZ=[],FZ=0;FZ<4;FZ++)BZ.push(new dn);for(var zZ={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){var t=e.spriteFrame;vG.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData,i=t.vb,r=n.data,o=e.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,d=c.m12,p=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(f){var x=m+d,S=v+d,T=g+p,E=y+p;i[0]=x,i[1]=T,i[9]=S,i[10]=T,i[18]=x,i[19]=E,i[27]=S,i[28]=E}else{var C=l*m,A=l*v,b=u*m,P=u*v,R=h*g+d,w=h*y+d,I=_*g+p,D=_*y+p;i[0]=C+R,i[1]=b+I,i[9]=A+R,i[10]=P+I,i[18]=C+w,i[19]=b+D,i[27]=A+w,i[28]=P+D}},fillBuffers:function(e){if(null!==e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(i),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=e.spriteFrame,f=_.getOriginalSize(),d=_.getRect(),p=f.width,m=f.height,v=d.width,g=d.height,y=_.getOffset(),x=r/p,S=o/m,T=y.x+(p-v)/2,E=y.x-(p-v)/2;c=T*x-a,l=(y.y+(m-g)/2)*S-s,u=r+E*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,n=e.spriteFrame.uv;t[3]=n[0],t[4]=n[1],t[12]=n[2],t[13]=n[3],t[21]=n[4],t[22]=n[5],t[30]=n[6],t[31]=n[7]}},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=5,r=e.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=t.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},UZ=new dn,kZ=new Ln,GZ={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,54),t},updateRenderData:function(e){var t=e.spriteFrame;vG.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,d=i/(c+l),p=r/(u+h);d=Number.isNaN(d)||d>1?1:d,p=Number.isNaN(p)||p>1?1:p,_=_<0?0:_,f=f<0?0:f,t[0].x=-o,t[0].y=-a,t[1].x=c*d-o,t[1].y=h*p-a,t[2].x=t[1].x+_,t[2].y=t[1].y+f,t[3].x=i-o,t[3].y=r-a},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(kZ);for(var n=e.renderData,i=n.floatStride,r=n.data,o=t.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];dn.set(UZ,u.x,c.y,0),dn.transformMat4(UZ,UZ,kZ),a=(4*s+l)*i,o[a++]=UZ.x,o[a++]=UZ.y,o[a++]=UZ.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=e.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},HZ=[],VZ=0;VZ<4;VZ++)HZ.push(new dn);var jZ=new Ln,WZ={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,d=o-u-h;f=f>0?f:0,d=d>0?d:0;var p=0===l?f:f/l,m=0===_?d:d/_,v=Math.ceil(m+2),g=Math.ceil(p+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,f,d,v,g),t.resize(v*g*4,v*g*6)}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(e,t){var n=e.node;n.getWorldMatrix(jZ);var i=e.renderData,r=i.floatStride,o=i.data,a=t.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=e.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,d=u.rect,p=u.insetLeft,m=u.insetRight,v=d.width-p-m,g=u.insetTop,y=u.insetBottom,x=d.height-g-y,S=c-p-m,T=l-g-y;S=S>0?S:0,T=T>0?T:0;for(var E=0===v?S:S/v,C=0===x?T:T/x,A=Math.ceil(C+2),b=Math.ceil(E+2),P=0,R=0,w=0,I=0,D=0,O=0,M=A;O<M;++O){I=o[O].y,D=o[O+1].y;for(var N=0,L=b;N<L;++N){R=o[N].x,w=o[N+1].x,dn.set(HZ[0],R,I,0),dn.set(HZ[1],w,I,0),dn.set(HZ[2],R,D,0),dn.set(HZ[3],w,D,0);for(var B=0;B<4;B++){var F=HZ[B];dn.transformMat4(F,F,jZ);var z=B*r;a[P+z]=F.x,a[P+z+1]=F.y,a[P+z+2]=F.z}P+=4*r}}P=0;for(var U=r,k=2*r,G=3*r,H=4*r,V=0,j=0,W=[],q=[],X=0,Y=A;X<Y;++X){j=T>x?T>=X*x?1:C%1:C;for(var K=0,Q=b;K<Q;++K){V=S>v?S>=K*v?1:E%1:E;var Z=P+3,J=Z+1;h?(0===X?(W[0]=f[0].u,W[1]=f[0].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X<A-1?(W[0]=f[4].u,W[1]=f[4].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X===A-1&&(W[0]=f[8].u,W[1]=f[8].u,W[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*V,q[2]=f[0].v):K<b-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*V,q[2]=f[1].v):K===b-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=f[0].u,W[1]=f[1].u+(f[2].u-f[1].u)*V,W[2]=_[0]):K<b-1?(W[0]=f[1].u,W[1]=f[1].u+(f[2].u-f[1].u)*V,W[2]=f[1].u):K===b-1&&(W[0]=f[2].u,W[1]=f[3].u,W[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X<A-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X===A-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),W[3]=W[1],q[3]=q[2]),a[Z]=W[0],a[J]=q[0],a[Z+U]=W[1],a[J+U]=q[1],a[Z+k]=W[2],a[J+k]=q[2],a[Z+G]=W[3],a[J+G]=q[3],P+=H}}},updateVerts:function(e,t,n,i,r){var o,a,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,d=s.anchorY*_,p=l.insetLeft,m=l.insetRight,v=u.width-p-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(p+m)>1?1:s.width/(p+m),T=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var E=0;E<=r;E++)0===E?c[E].x=-f:E>0&&E<r?c[E].x=1===E?p*S+Math.min(v,t)-f:v>0?E===r-1?p+o+v*(E-2)-f:p+Math.min(v,t)+v*(E-2)-f:p+t-f:E===r&&(c[E].x=Math.min(p+t+m,h)-f);for(var C=0;C<=i;C++)0===C?c[C].y=-d:C>0&&C<i?c[C].y=1===C?y*T+Math.min(x,n)-d:x>0?C===i-1?y+a+(C-2)*x-d:y+Math.min(x,n)+(C-2)*x-d:y+n-d:C===i&&(c[C].y=Math.min(y+n+g,_)-d)},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},qZ=EX.Type,XZ=EX.FillType,YZ=e("spriteAssembler",{getAssembler:function(e){var t=zZ,n=e;switch(n.type){case qZ.SLICED:t=GZ;break;case qZ.TILED:t=WZ;break;case qZ.FILLED:t=n.fillType===XZ.RADIAL?LZ:yZ}return t}});EX.Assembler=YZ;var KZ=vV.sharedManager,QZ={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){e.type===rq.IMAGE_STENCIL&&(zZ.updateRenderData(e),zZ.updateColor(e))},fillBuffers:function(e,t){(e.type!==rq.IMAGE_STENCIL||e.spriteFrame)&&(KZ.pushMask(e),t.finishMergeBatches(),function(e,t){KZ.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(KZ.enterLevel(e),e.type===rq.IMAGE_STENCIL){zZ.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),KZ.enableMask())}},ZZ={fillBuffers:function(){KZ.exitMask()}},JZ={getAssembler:function(){return QZ}},$Z={getAssembler:function(){return ZZ}};lq.Assembler=JZ,lq.PostAssembler=$Z;var eJ=e("MeshBuffer",function(){function e(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var t=e.prototype;return t.initialize=function(e,t,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=t,this._floatsPerVertex=yH(t),this._initVDataCount,this._floatsPerVertex,K(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},t.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},t.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0},t.setDirty=function(){this._dirty=!0},t.request=function(){return V(9002),!1},t.requireFreeIA=function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia},t.recycleIA=function(e){for(var t=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===t[n].ia){var i=t[n];return t[n]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=i)}},t.checkCapacity=function(e,t){var n=this.vertexOffset+e,i=this.indexOffset+t;return!(n>this._initVDataCount||i>this._initIDataCount)},t.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var e=qu.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,n=this.indexOffset,i=0;i<e;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,t>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},t.createNewIA=function(e){var t,n,i;if(qu.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=e.createBuffer(new er(ri.VERTEX|ri.TRANSFER_DST,si.HOST|si.DEVICE,r,r));i=e.createBuffer(new er(ri.INDEX|ri.TRANSFER_DST,si.HOST|si.DEVICE,o,o)),n=[a],this._iaInfo=new yr(this._attributes,n,i),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:n,indexBuffer:i}},c(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),e}()),tJ=[eM.EventType.MOUSE_DOWN,eM.EventType.MOUSE_MOVE,eM.EventType.MOUSE_UP,eM.EventType.MOUSE_WHEEL],nJ=[eM.EventType.TOUCH_START,eM.EventType.TOUCH_MOVE,eM.EventType.TOUCH_END,eM.EventType.TOUCH_CANCEL],iJ=(new(function(){function e(){this.priority=jO.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],tM._registerEventDispatcher(this),oI.callbacksInvoker.on(xb.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),oI.callbacksInvoker.on(xb.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),oI.callbacksInvoker.on(xb.MARK_LIST_DIRTY,this._markListDirty,this)}var t=e.prototype;return t.dispatchEvent=function(e){var t=e.type;return nJ.includes(t)?this.dispatchEventTouch(e):!tJ.includes(t)||this.dispatchEventMouse(e)},t.addPointerEventProcessor=function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),qe.array.remove(this._processorListToRemove,e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(qe.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),qe.array.remove(this._processorListToAdd,e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var o=t[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(e)){if(i=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,o=0;o<n;++o){var a=t[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===gb.TOUCH_START){if(a._handleEventTouch(e)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(e),e.type!==gb.TOUCH_END&&e.type!==gb.TOUCH_CANCEL||qe.array.removeAt(a.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;i.cachedCameraPriority=o.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,d=o?o.getSiblingIndex():0;return a?f-d:d-f},t._markListDirty=function(){this._isListDirty=!0},e}()),function(){function e(e,t){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=e,this._attributes=t,this._floatsPerVertex=yH(t),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var t=e.prototype;return t.initialize=function(){},t.reset=function(){},t.request=function(){},t.appendBuffers=function(){},t.uploadBuffers=function(){},t.destroy=function(){this._attributes.length=0},c(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),e}()),rJ=new Pl((function(){return{offset:0,length:0}}),32),oJ=function(e,t,n,i){this.vertexAccessor=e,this.bufferId=t,this.vertexOffset=n,this.vb=i},aJ=function(e){function t(n,i,r,o){var a;return(a=e.call(this,n,i)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*$e.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*t.IB_SCALE,a._allocateBuffer(),a}u(t,e);var n=t.prototype;return n.destroy=function(){for(var t=0;t<this._buffers.length;++t){this._buffers[t].destroy();for(var n=this._freeLists[t],i=0;i<n.length;++i)rJ.free(n[i])}this._buffers.length=0,this._freeLists.length=0,e.prototype.destroy.call(this)},n.reset=function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}},n.getVertexBuffer=function(e){return this._buffers[e].vData},n.getIndexBuffer=function(e){return this._buffers[e].iData},n.getMeshBuffer=function(e){return this._buffers[e]},n.uploadBuffers=function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],n=this._buffers[e];(!t||t.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(e,t){var n=this._buffers[e];t.length&&(n.iData.set(t,n.indexOffset),n.indexOffset+=t.length)},n.allocateChunk=function(e,t){for(var n,i=e*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(e,t)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new oJ(this,o,u,h,t)}return V(9004,i),null},n.recycleChunk=function(e){var t=this._freeLists[e.bufferId],n=this._buffers[e.bufferId],i=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=t[a];c&&c.offset<i;)s=c,c=t[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,t.splice(a,1),rJ.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=rJ.alloc();l.offset=i,l.length=r,t.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=rJ.alloc();u.offset=i,u.length=r,t.push(u)}}},n._allocateChunkFromEntry=function(e,t,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[e];a.byteOffset<o&&(a.byteOffset=o),Y(r>=0,9004,e,n.offset,n.length),0===r?(this._freeLists[e].splice(t,1),rJ.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){Y(this._buffers.length===this._freeLists.length,9003);var e=new eJ,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var n=rJ.alloc();n.offset=0,n.length=e.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},t}(iJ);aJ.IB_SCALE=4;var sJ=new Ir(null),cJ=new Ln,lJ=function(){function e(e){var t=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new Nv,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new hJ,this._meshDataArray=[],this._root=e,this.device=e.device,this._batches=new wl(64),this._drawBatchPool=new Pl((function(){return new lK}),128,(function(e){return e.destroy(t)}))}var t=e.prototype;return t.initialize=function(){return!0},t.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(e){e.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),vV.sharedManager.destroy()},t.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},t.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},t.sortScreens=function(){this._screens.sort(this._screenSort)},t.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},t.update=function(){for(var e=this._screens,t=0,n=0;n<e.length;++n){var i=e[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var a=this._batches.array[t];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},t.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(e){e.uploadBuffers()})),this._bufferAccessors.forEach((function(e){e.uploadBuffers(),e.reset()})),this._descriptorSetCache.update())},t.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach((function(e){e.reset()})),this._meshDataArray.forEach((function(e){e.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),vV.sharedManager.reset()},t.switchBufferAccessor=function(e){void 0===e&&(e=vH);var t=e===vH?36:xH(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var n=this._bufferAccessors.get(t);n||(n=new aJ(this.device,e),this._bufferAccessors.set(t,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},t.registerBufferAccessor=function(e,t){this._bufferAccessors.set(e,t)},t.updateBuffer=function(e,t){var n=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=n.getMeshBuffer(t).indexOffset)},t.commitComp=function(e,t,n,i,r){var o,a=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;a=t.dataHash,o=t.material,s=t.chunk.bufferId}e.stencilStage=vV.sharedManager.stage;var c=e.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(e,this)},t.commitIA=function(e,t,n,i,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;e&&(o=-1===e.blendHash?null:e.getBlendState(),c=e.blendHash,e.stencilStage=vV.sharedManager.stage,a=null!==e.customMaterial?vV.sharedManager.getStencilStage(e.stencilStage,i):vV.sharedManager.getStencilStage(e.stencilStage),s=vV.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=e.node.layer,l.inputAssembler=t,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,a,s,o,c,null,this),this._batches.push(l)},t.commitModel=function(e,t,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(e.stencilStage!==LH.ENABLED&&e.stencilStage!==LH.DISABLED||(e.stencilStage=vV.sharedManager.stage),i=vV.sharedManager.getStencilStage(e.stencilStage,n),r=vV.sharedManager.getStencilHash(e.stencilStage));var o=T.director.getTotalFrames();t&&(t.updateTransform(o),t.updateUBOs(o));for(var a=0;a<t.subModels.length;a++){var s=this._drawBatchPool.alloc(),c=t.subModels[a];s.visFlags=e.node.layer,s.model=t,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}},t.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},t.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},t.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},t.autoMergeBatches=function(e){var t=this._currMaterial;if(t){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;e&&(c=-1===e.blendHash?null:e.getBlendState(),h=e.blendHash,l=null!==e.customMaterial?vV.sharedManager.getStencilStage(e.stencilStage,t):vV.sharedManager.getStencilStage(e.stencilStage),u=vV.sharedManager.getStencilHash(e.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(t,l,u,c,h,null,this),this._batches.push(_)}}},t.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},t.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},t.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},t.flushMaterial=function(e){this._currMaterial=e},t.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var n=e.children,i=e._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0){!function(e,t){for(var n,i,r,o=e.vertexFormat,a=e.chunk.vb,s=0,c=0;c<o.length;++c){if(n=o[c],(i=Gr[n.format]).hasAlpha)if(r=e.floatStride,i.size/i.count==1)for(var l=~~Kt(Math.round(255*t),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=t;s+=i.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!e._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,t)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),t+=1}},t._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},t._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},c(e,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),e}(),uJ=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=T.director.root.device;this._localData=new Float32Array(zd.COUNT),this._localBuffer=e.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,zd.SIZE,zd.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=T.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,sJ.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(sJ),this._descriptorSet.bindBuffer(zd.BINDING,this._localBuffer);var n=md.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.isValid=function(){return this._transform&&this._transform.isValid},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;Ln.toArray(this._localData,t,zd.MAT_WORLD_OFFSET),Ln.inverseTranspose(cJ,t);var n=Ln.determinant(cJ),i=1/Math.sqrt(n);Ln.multiplyScalar(cJ,cJ,i),Ln.toArray(this._localData,cJ,zd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},c(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),hJ=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Pl((function(){return new uJ}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=T.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,r=0,o=i.length;r<o;r++){var a=i[r];if(a.equals(e.useLocalData,e.textureHash,e.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(e),this._localDescriptorSetCache.push(s),s.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);sJ.layout=e.passes[0].localSetLayout;var c=n.device.createDescriptorSet(sJ),l=md.SAMPLER_SPRITE;return c.bindTexture(l,e.texture),c.bindSampler(l,e.sampler),c.update(),this._descriptorSetCache.set(t,c),this._dsCacheHashByTexture.set(e.textureHash,t),c},t.update=function(){var e=this._localDescriptorSetCache,t=[];e.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=e.indexOf(n);t.push(i)}}));for(var n=t.length-1;n>=0;n--)e.splice(t[n],1)},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();T.internal.Batcher2D=lJ;var _J,fJ,dJ=null,pJ=-1,mJ="BES bswy:->@123",vJ=Object.create(null),gJ=[],yJ=3e3;function xJ(){for(var e=!0,t=Date.now(),n=gJ.length-1;n>=0;n--){var i=gJ[n],r=i.fontFamilyName;if(t-i.startTime>yJ)V(4933,r),i.onComplete(null,r),gJ.splice(n,1);else{var o=i.refWidth,a="40px "+r;dJ.font=a,o!==rH(dJ,mJ,a)?(gJ.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(pJ),pJ=-1)}function SJ(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(vJ[i])n(null,i);else{if(!dJ){var r=document.createElement("canvas");r.width=100,r.height=100,dJ=r.getContext("2d")}var o=rH(dJ,mJ,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',a.textContent=s+"}",document.body.appendChild(a);var c,l,u,h,_,f,d=document.createElement("div"),p=d.style;if(p.fontFamily=i,d.innerHTML=".",p.position="absolute",p.left="-100px",p.top="-100px",document.body.appendChild(d),function(){if(void 0===_J)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);_J=e?parseInt(e[1],10)>42:!t}else _J=!1;return _J}())c=Date.now(),l=i,u=n,h=new Promise((function(e,t){!function n(){Date.now()-c>=yJ?t():document.fonts.load("40px "+l).then((function(t){t.length>=1?e():setTimeout(n,100)}),(function(){t()}))}()})),_=null,f=new Promise((function(e,t){_=setTimeout(t,yJ)})),Promise.race([f,h]).then((function(){_&&(clearTimeout(_),_=null),u(null,l)}),(function(){V(4933,l),u(null,l)}));else{var m={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};gJ.push(m),-1===pJ&&(pJ=setInterval(xJ,100))}vJ[i]=a}}function TJ(e,t,n,i){var r=new kG;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}oN.register({".font":SJ,".eot":SJ,".ttf":SJ,".woff":SJ,".svg":SJ,".ttc":SJ}),_N.register({".font":TJ,".eot":TJ,".ttf":TJ,".woff":TJ,".svg":TJ,".ttc":TJ}),T.UI={MeshBuffer:eJ,spriteAssembler:YZ,graphicsAssembler:YK,labelAssembler:pZ,RenderData:kH,MeshRenderData:GH},function(e){e[e.positions=zi.ATTR_POSITION]="positions",e[e.normals=zi.ATTR_NORMAL]="normals",e[e.uvs=zi.ATTR_TEX_COORD]="uvs",e[e.colors=zi.ATTR_COLOR]="colors"}(fJ||(fJ={}));var EJ,CJ,AJ,bJ,PJ,RJ=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer},e}(),wJ=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>Yd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new DJ(this._mesh,i,this._mesh.struct.morph,t):this._subMeshRenderings[i]=new IJ(this._mesh,i,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(zi.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(zi.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(zi.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=g(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}},e}(),IJ=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[t];this._subMeshMorph=r,LJ(e,t,i);var o=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=NJ(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(t,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(t,i){for(var r=t.displacements[n],s=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:t,morphTexture:i}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=g(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new MJ(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=g(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case zi.ATTR_POSITION:a=$d;break;case zi.ATTR_NORMAL:a=np;break;case zi.ATTR_TANGENT:a=op;break;default:M("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(Yd.BINDING,t.buffer),n.update()},destroy:function(){}}},e}(),DJ=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[t];LJ(e,t,i),this._attributes=r.attributes.map((function(t,n){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[n].offset,t.displacements[n].count)}}))}}))}return e.prototype.createInstance=function(){return new OJ(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},c(e,[{key:"data",get:function(){return this._attributes}}]),e}(),OJ=function(){function e(e,t,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new MJ(n,0);var i=NJ(n,t);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=i.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=e[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,n=g(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case zi.ATTR_POSITION:r=$d;break;case zi.ATTR_NORMAL:r=np;break;case zi.ATTR_TANGENT:r=op;break;default:M("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(Yd.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}(),MJ=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(Yd.SIZE)),this._remoteBuffer=e.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,Yd.SIZE,Yd.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Yd.OFFSET_OF_WEIGHTS+4*t,e[t],T.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,T.sys.isLittleEndian),this._localBuffer.setFloat32(Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,T.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(Yd.OFFSET_OF_VERTICES_COUNT,e,T.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},c(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function NJ(e,t){var i,o,a,s;e.hasFeature(ei.TEXTURE_FLOAT)?(i=t,a=16,o=Km.PixelFormat.RGBA32F,s=Float32Array):(i=4*t,a=4,o=Km.PixelFormat.RGBA8888,s=Uint8Array);var c=function(e){e<5&&(e=5);var t=n(r(e)),i=t>>1;return{width:1<<(1&t?i+1:i),height:1<<i}}(i),l=c.width,u=c.height;return{width:l,height:u,create:function(){var t=new ArrayBuffer(l*u*a),n=new Float32Array(t),i=s===Float32Array?n:new s(t),r=new bm({width:l,height:u,_data:i,_compressed:!1,format:o}),c=new Km;c.setFilters(Km.Filter.NEAREST,Km.Filter.NEAREST),c.setMipFilter(Km.Filter.NONE),c.setWrapMode(Km.WrapMode.CLAMP_TO_EDGE,Km.WrapMode.CLAMP_TO_EDGE,Km.WrapMode.CLAMP_TO_EDGE),c.image=r,c.getGFXTexture()||M("Unexpected: failed to create morph texture?");var h=e.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(i)}}}}}function LJ(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function BJ(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var FJ=new dn,zJ=new dn,UJ=new Uint8Array,kJ=e("Mesh",$s("cc.Mesh")((PJ=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,y(t,"_struct",AJ,m(t)),y(t,"_hash",bJ,m(t)),t._data=UJ,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t}u(t,e);var n=t.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=T.director.root.device,n=this._createVertexBuffers(t,e),i=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var c=o.indexView,l=c.stride,u=c.length;if(4===l&&!t.hasFeature(ei.ELEMENT_INDEX_UINT)){var h=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(h>=65536){V(10001,h,65536);continue}l>>=1,u>>=1}a=t.createBuffer(new er(ri.INDEX,si.DEVICE,u,l)),s=new(BJ(c.stride))(e,c.offset,c.count),c.stride!==l&&(s=BJ(l).from(s)),a.update(s)}var _=o.vertexBundelIndices.map((function(e){return n[e]})),f=[];if(o.vertexBundelIndices.length>0)for(var d=o.vertexBundelIndices[0],p=this._struct.vertexBundles[d].attributes,m=0;m<p.length;++m){var v=p[m];f[m]=new vr(v.name,v.format,v.isNormalized,v.stream,v.isInstanced,v.location)}var g=new yb(_,f,o.primitiveMode,a);g.mesh=this,g.subMeshIdx=r,i.push(g)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(e,t){return new wJ(e,t)}(this,t))}},n.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(e,t){this.reset({struct:e,data:t})},n.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},n.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new Is(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,zi.ATTR_JOINTS),c=this.readAttribute(a,zi.ATTR_WEIGHTS),l=this.readAttribute(a,zi.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){dn.set(FJ,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,d=s[f];if(!(0===c[f]||d>=i.length)){dn.transformMat4(zJ,FJ,i[d]),n[d]=!0;var p=t[d];dn.min(p.center,p.center,zJ),dn.max(p.halfExtents,p.halfExtents,zJ)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?Is.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t},n.merge=function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new dn,r=t&&new Pn,o=t&&new Is;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(dn.add(o.center,a.maxPosition,a.minPosition),dn.multiplyScalar(o.center,o.center,.5),dn.subtract(o.halfExtents,a.maxPosition,a.minPosition),dn.multiplyScalar(o.halfExtents,o.halfExtents,.5),Is.transform(o,o,t),dn.add(a.maxPosition,o.center,o.halfExtents),dn.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===zi.ATTR_POSITION||l.attributes[u].name===zi.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+GJ(l.attributes,u)),f=jJ(_,h),d=WJ(_,h);if(!f||!d)continue;for(var p=l.view.count,m=l.view.stride,v=VJ(h),y=0;y<p;y++){var x=y*m,S=x+v,T=S+v;switch(i.set(f(x),f(S),f(T)),l.attributes[u].name){case zi.ATTR_POSITION:i.transformMat4(t);break;case zi.ATTR_NORMAL:dn.transformQuat(i,i,r)}d(x,i.x),d(S,i.y),d(T,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var E,C,A,b,P,R=new RJ,w=0,I=0,D=0,O=0,M=0,N=0,L=0,B=0,F=!1,z=new Array(this._struct.vertexBundles.length),U=0;U<this._struct.vertexBundles.length;++U){var k=this._struct.vertexBundles[U],G=e._struct.vertexBundles[U];D=k.view.offset,O=G.view.offset,I=k.view.stride,w=k.view.count+G.view.count,E=new ArrayBuffer(w*I),C=new Uint8Array(E),D+=(A=this._data.subarray(D,D+k.view.length)).length,O+=(b=e._data.subarray(O,O+G.view.length)).length,C.set(A),M=0;for(var H,V=g(k.attributes);!(H=V()).done;){var j=H.value;L=0,F=!1;for(var W,q=g(G.attributes);!(W=q()).done;){var X=W.value;if(j.name===X.name&&j.format===X.format){F=!0;break}L+=Gr[X.format].size}if(F){B=Gr[j.format].size,N=k.view.length+M;for(var Y=0;Y<G.view.count;++Y){if(P=b.subarray(L,L+B),C.set(P,N),(j.name===zi.ATTR_POSITION||j.name===zi.ATTR_NORMAL)&&t){var K=new Float32Array(C.buffer,N,3);switch(i.set(K[0],K[1],K[2]),j.name){case zi.ATTR_POSITION:i.transformMat4(t);break;case zi.ATTR_NORMAL:dn.transformQuat(i,i,r)}K[0]=i.x,K[1]=i.y,K[2]=i.z}N+=k.view.stride,L+=G.view.stride}}M+=Gr[j.format].size}z[U]={attributes:k.attributes,view:{offset:R.getLength(),length:E.byteLength,count:w,stride:I}},R.addBuffer(E)}for(var Q,Z,J,$=0,ee=2,te=0,ne=new Array(this._struct.primitives.length),ie=0;ie<this._struct.primitives.length;++ie){var re=this._struct.primitives[ie],oe=e._struct.primitives[ie];ne[ie]={primitiveMode:re.primitiveMode,vertexBundelIndices:re.vertexBundelIndices};for(var ae,se=g(re.vertexBundelIndices);!(ae=se()).done;){var ce=ae.value;te=Math.max(te,this._struct.vertexBundles[ce].view.count)}if(re.indexView&&oe.indexView){$=re.indexView.count,$+=oe.indexView.count,D=re.indexView.offset,O=oe.indexView.offset,ee=$<256?1:$<65536?2:4;var le=new ArrayBuffer($*ee);if(Q=2===ee?new Uint16Array(le):1===ee?new Uint8Array(le):new Uint32Array(le),Z=2===re.indexView.stride?new Uint16Array(this._data.buffer,D,re.indexView.count):1===re.indexView.stride?new Uint8Array(this._data.buffer,D,re.indexView.count):new Uint32Array(this._data.buffer,D,re.indexView.count),ee===re.indexView.stride)Q.set(Z);else for(var ue=0;ue<re.indexView.count;++ue)Q[ue]=Z[ue];D+=re.indexView.length,J=2===oe.indexView.stride?new Uint16Array(e._data.buffer,O,oe.indexView.count):1===oe.indexView.stride?new Uint8Array(e._data.buffer,O,oe.indexView.count):new Uint32Array(e._data.buffer,O,oe.indexView.count);for(var he=0;he<oe.indexView.count;++he)Q[re.indexView.count+he]=te+J[he];O+=oe.indexView.length,ne[ie].indexView={offset:R.getLength(),length:le.byteLength,count:$,stride:ee},R.setNextAlignment(ee),R.addBuffer(le)}}var _e={vertexBundles:z,primitives:ne,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _e.minPosition&&e._struct.minPosition&&_e.maxPosition&&e._struct.maxPosition&&(t?(dn.add(o.center,e._struct.maxPosition,e._struct.minPosition),dn.multiplyScalar(o.center,o.center,.5),dn.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),dn.multiplyScalar(o.halfExtents,o.halfExtents,.5),Is.transform(o,o,t),dn.add(i,o.center,o.halfExtents),dn.max(_e.maxPosition,_e.maxPosition,i),dn.subtract(i,o.center,o.halfExtents),dn.min(_e.minPosition,_e.minPosition,i)):(dn.min(_e.minPosition,_e.minPosition,e._struct.minPosition),dn.max(_e.maxPosition,_e.maxPosition,e._struct.maxPosition))),this.reset({struct:_e,data:new Uint8Array(R.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=Qr(Gr[o]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+GJ(e.attributes,t)),c=Gr[o],l=jJ(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=e.view.stride,f=0;f<r;++f)for(var d=0;d<u;++d)h[u*f+d]=l(_*f+h.BYTES_PER_ELEMENT*d);i=h}}})),i},n.copyAttribute=function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+GJ(e.attributes,t)),u=new DataView(n,r),h=Gr[c],_=jJ(l,c),f=WJ(u,c);if(_&&f){for(var d=h.count,p=e.view.stride,m=VJ(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<d;++x)f(v*y+g*x,_(p*y+m*x));a=!0}}else a=!0})),a},n.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},n.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?ti.R8UI:2===n.indexView.stride?ti.R16UI:ti.R32UI,o=jJ(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+Gr[r].size*a);return!0},n._accessAttribute=function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=g(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new er(ri.VERTEX,si.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.reset({struct:{vertexBundles:[],primitives:[]},data:UJ})},c(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=oo(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(pu),AJ=x((CJ=PJ).prototype,"_struct",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),bJ=x(CJ.prototype,"_hash",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EJ=CJ))||EJ);function GJ(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=Gr[r.format].size}return n}T.Mesh=kJ;var HJ=qu.isLittleEndian;function VJ(e){var t=Gr[e];return t.size/t.count}function jJ(e,t){var n=Gr[t],i=n.size/n.count;switch(n.type){case ni.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,HJ)};case 4:return function(t){return e.getUint32(t,HJ)}}break;case ni.SNORM:case ni.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,HJ)};case 4:return function(t){return e.getInt32(t,HJ)}}break;case ni.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,HJ)};case 4:return function(t){return e.getUint32(t,HJ)}}break;case ni.FLOAT:return function(t){return e.getFloat32(t,HJ)}}return null}function WJ(e,t){var n=Gr[t],i=n.size/n.count;switch(n.type){case ni.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,HJ)};case 4:return function(t,n){return e.setUint32(t,n,HJ)}}break;case ni.SNORM:case ni.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,HJ)};case 4:return function(t,n){return e.setInt32(t,n,HJ)}}break;case ni.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,HJ)};case 4:return function(t,n){return e.setUint32(t,n,HJ)}}break;case ni.FLOAT:return function(t,n){return e.setFloat32(t,n,HJ)}}return null}var qJ=[new vr(zi.ATTR_POSITION,ti.RGB32F),new vr(zi.ATTR_NORMAL,ti.RGB32F),new vr(zi.ATTR_TEX_COORD,ti.RG32F),new vr(zi.ATTR_TANGENT,ti.RGBA32F),new vr(zi.ATTR_COLOR,ti.RGBA32F)],XJ=new dn;function YJ(e,t,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=g(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===zi.ATTR_POSITION){i=h;break}}i||(i=qJ[0]),r.push(i);var _=Gr[i.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:i}),o+=_.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var f,d=g(e.attributes);!(f=d()).done;){var p=f.value;if(p.name===zi.ATTR_NORMAL){i=p;break}}i||(i=qJ[1]);var m=Gr[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,y=g(e.attributes);!(v=y()).done;){var x=v.value;if(x.name===zi.ATTR_TEX_COORD){i=x;break}}i||(i=qJ[2]);var S=Gr[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/S.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=S.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var T,E=g(e.attributes);!(T=E()).done;){var C=T.value;if(C.name===zi.ATTR_TANGENT){i=C;break}}i||(i=qJ[3]);var A=Gr[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/A.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=A.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var b,P=g(e.attributes);!(b=P()).done;){var R=b.value;if(R.name===zi.ATTR_COLOR){i=R;break}}i||(i=qJ[4]);var w=Gr[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/w.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=w.size}if(e.customAttributes)for(var I,D=g(e.customAttributes);!(I=D()).done;){var O=I.value,M=Gr[O.attr.format];r.push(O.attr),s=Math.max(s,Math.floor(O.values.length/M.count)),a.push({offset:o,data:O.values,attribute:O.attr}),o+=M.size}for(var N=new RJ,L=new ArrayBuffer(s*o),B=new DataView(L),F=0,z=a;F<z.length;F++){var U=z[F];db(B,U.data,U.attribute.format,U.offset,o)}N.setNextAlignment(0);var k={attributes:r,view:{offset:N.getLength(),length:L.byteLength,count:s,stride:o}};N.addBuffer(L);var G=null,H=0;if(e.indices){var V=e.indices;H=V.length,G=new ArrayBuffer(2*H),db(new DataView(G),V,ti.R16UI)}var j={primitiveMode:e.primitiveMode||bi.TRIANGLE_LIST,vertexBundelIndices:[0]};G&&(N.setNextAlignment(2),j.indexView={offset:N.getLength(),length:G.byteLength,count:H,stride:2},N.addBuffer(G));var W=e.minPos;if(!W&&n.calculateBounds){W=dn.set(new dn,1/0,1/0,1/0);for(var q=0;q<s;++q)dn.set(XJ,c[3*q+0],c[3*q+1],c[3*q+2]),dn.min(W,W,XJ)}var X=e.maxPos;if(!X&&n.calculateBounds){X=dn.set(new dn,-1/0,-1/0,-1/0);for(var Y=0;Y<s;++Y)dn.set(XJ,c[3*Y+0],c[3*Y+1],c[3*Y+2]),dn.max(X,X,XJ)}var K={vertexBundles:[k],primitives:[j]};return W&&(K.minPosition=new dn(W.x,W.y,W.z)),X&&(K.maxPosition=new dn(X.x,X.y,X.z)),t||(t=new kJ),t.reset({struct:K,data:new Uint8Array(N.getCombined())}),t}var KJ=Object.freeze({__proto__:null,find:AI,toPPM:function(e,t,n){return"P3 "+t+" "+n+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:function(e,t){void 0===t&&(t=0);for(var n,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),o=e.struct,a=o.primitives[t],s=g(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,_=u.view,f=_.length,d=_.stride,p=g(u.attributes);!(c=p()).done;){var m=c.value,v=fJ[m.name];v&&(i[v]=(i[v]||[]).concat(pb(r,m.format,h,f,d))),h+=Gr[m.format].size}var y=a.indexView;return i.indices=pb(r,ti["R"+8*y.stride+"UI"],y.offset,y.length),i},createMesh:YJ,readBuffer:pb,writeBuffer:db,mapBuffer:mb});e("utils",KJ);var QJ,ZJ,JJ,$J,e$,t$,n$,i$,r$,o$,a$,s$,c$,l$,u$,h$,_$,f$,d$,p$,m$,v$,g$,y$,x$,S$,T$,E$,C$,A$,b$,P$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}u(t,e);var n=t.prototype;return n.getMacroPatches=function(t){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(t):e.prototype.getMacroPatches.call(this,t)},n.initSubModel=function(t,n,i){return e.prototype.initSubModel.call(this,t,n,this._launderMaterial(i))},n.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(t,n){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(n))},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,n)},n._launderMaterial=function(e){return e},n.setMorphRendering=function(e){this._morphRenderingInstance=e},t}(FS),R$=Ye({OFF:0,ON:1}),w$=Ye({OFF:0,ON:1}),I$=(QJ=$s("cc.ModelLightmapSettings"),ZJ=ac("_recieveShadow"),QJ((a$=function(){function e(){y(this,"texture",e$,this),y(this,"uvParam",t$,this),y(this,"_bakeable",n$,this),y(this,"_castShadow",i$,this),y(this,"_receiveShadow",r$,this),y(this,"_lightmapSize",o$,this)}return c(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),e$=x(($J=a$).prototype,"texture",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),t$=x($J.prototype,"uvParam",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn}}),n$=x($J.prototype,"_bakeable",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i$=x($J.prototype,"_castShadow",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),r$=x($J.prototype,"_receiveShadow",[ZJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o$=x($J.prototype,"_lightmapSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),x($J.prototype,"bakeable",[mc],Object.getOwnPropertyDescriptor($J.prototype,"bakeable"),$J.prototype),x($J.prototype,"castShadow",[mc],Object.getOwnPropertyDescriptor($J.prototype,"castShadow"),$J.prototype),x($J.prototype,"receiveShadow",[mc],Object.getOwnPropertyDescriptor($J.prototype,"receiveShadow"),$J.prototype),x($J.prototype,"lightmapSize",[mc],Object.getOwnPropertyDescriptor($J.prototype,"lightmapSize"),$J.prototype),JJ=$J))||JJ),D$=e("MeshRenderer",(s$=$s("cc.MeshRenderer"),c$=pc(),l$=tc(100),u$=hc(),h$=Mc(R$),_$=xc(),f$=Mc(w$),d$=xc(),p$=Mc(kJ),m$=xc(),v$=vc(),s$(g$=c$(g$=l$(g$=u$(g$=uc((b$=A$=function(e){function t(){var t;return y(t=e.call(this)||this,"lightmapSettings",x$,m(t)),y(t,"_mesh",S$,m(t)),y(t,"_shadowCastingMode",T$,m(t)),y(t,"_shadowReceivingMode",E$,m(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,y(t,"_enableMorph",C$,m(t)),t._modelType=FS,t}u(t,e);var n=t.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(T.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]},n.setWeights=function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},n.setWeight=function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}},n.setInstancedAttribute=function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===e){r[o].set(t);break}},n._updateLightmap=function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===FS?P$:this._modelType,t=this._model=T.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof P$&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=wg.POSITION,this._model.transform.hasChangedFlags|=wg.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return rv.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===R$.OFF?this._model.castShadow=!1:(this._shadowCastingMode,R$.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===w$.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof P$&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,o=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},c(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),t}(RB),A$.ShadowCastingMode=R$,A$.ShadowReceivingMode=w$,x$=x((y$=b$).prototype,"lightmapSettings",[oc,mc,Rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new I$}}),S$=x(y$.prototype,"_mesh",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T$=x(y$.prototype,"_shadowCastingMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return R$.OFF}}),E$=x(y$.prototype,"_shadowReceivingMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w$.ON}}),x(y$.prototype,"shadowCastingMode",[h$,_$,Rc],Object.getOwnPropertyDescriptor(y$.prototype,"shadowCastingMode"),y$.prototype),x(y$.prototype,"receiveShadow",[f$,d$,Rc],Object.getOwnPropertyDescriptor(y$.prototype,"receiveShadow"),y$.prototype),x(y$.prototype,"mesh",[p$,m$],Object.getOwnPropertyDescriptor(y$.prototype,"mesh"),y$.prototype),x(y$.prototype,"enableMorph",[v$,Rc],Object.getOwnPropertyDescriptor(y$.prototype,"enableMorph"),y$.prototype),C$=x(y$.prototype,"_enableMorph",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),g$=y$))||g$)||g$)||g$)||g$)||g$));function O$(e,t){var n=e.sharedMaterials.length;if(n!==t.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(e.getRenderMaterial(i)!==t.getRenderMaterial(i))return!1;return!0}e("BatchingUtility",function(){function e(){}return e.batchStaticModel=function(e,t){var n=e.getComponentsInChildren(D$);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!O$(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new kJ,o=new Ln,a=new Ln;e.getWorldMatrix(a),Ln.invert(a,a);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(o),Ln.multiply(o,a,o),r.merge(n[s].mesh,o),c.enabled=!1}var l=t.addComponent(D$);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var n=e.getComponentsInChildren(D$),i=0;i<n.length;i++)n[i].enabled=!0;var r=t.getComponent(D$);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}());var M$,N$,L$,B$,F$,z$,U$,k$,G$,H$,V$,j$,W$,q$,X$,Y$,K$,Q$,Z$,J$,$$,e0,t0,n0,i0,r0,o0,a0,s0,c0,l0,u0=e("Skeleton",(M$=$s("cc.Skeleton"),N$=Mc([Ct]),L$=Mc([Ln]),M$((G$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_joints",z$,m(t)),y(t,"_bindposes",U$,m(t)),y(t,"_hash",k$,m(t)),t._invBindposes=null,t}u(t,e);var n=t.prototype;return n.destroy=function(){var t,n;return null===(t=null===(n=T.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===t||t.releaseSkeleton(this),e.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},c(t,[{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new Ln;Ln.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=oo(e,666)}return this._hash}}]),t}(pu),z$=x((F$=G$).prototype,"_joints",[N$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),U$=x(F$.prototype,"_bindposes",[L$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),k$=x(F$.prototype,"_hash",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B$=F$))||B$));T.Skeleton=u0;var h0,_0,f0,d0,p0,m0,v0,g0,y0,x0,S0,T0,E0,C0,A0,b0,P0,R0,w0,I0,D0,O0,M0,N0,L0,B0,F0,z0,U0,k0,G0,H0,V0,j0,W0,q0,X0,Y0,K0,Q0,Z0,J0,$0,e1,t1,n1,i1,r1,o1,a1,s1,c1,l1,u1,h1,_1=Ye({LUMINOUS_FLUX:0,LUMINANCE:1}),f1=new dn,d1=$s("cc.StaticLightSettings")((Y$=function(){function e(){y(this,"_baked",j$,this),y(this,"_editorOnly",W$,this),y(this,"_bakeable",q$,this),y(this,"_castShadow",X$,this)}return c(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),j$=x((V$=Y$).prototype,"_baked",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),W$=x(V$.prototype,"_editorOnly",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q$=x(V$.prototype,"_bakeable",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X$=x(V$.prototype,"_castShadow",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x(V$.prototype,"editorOnly",[mc],Object.getOwnPropertyDescriptor(V$.prototype,"editorOnly"),V$.prototype),x(V$.prototype,"bakeable",[mc],Object.getOwnPropertyDescriptor(V$.prototype,"bakeable"),V$.prototype),x(V$.prototype,"castShadow",[mc],Object.getOwnPropertyDescriptor(V$.prototype,"castShadow"),V$.prototype),H$=V$))||H$,p1=e("Light",(K$=$s("cc.Light"),Q$=xc(),Z$=xc(),J$=Sc(),$$=xc(),e0=Mc(d1),t0=bc(),K$((l0=c0=function(e){function t(){var t;return y(t=e.call(this)||this,"_color",r0,m(t)),y(t,"_useColorTemperature",o0,m(t)),y(t,"_colorTemperature",a0,m(t)),y(t,"_staticSettings",s0,m(t)),t._type=Ig.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=qg,t}u(t,e);var n=t.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=T.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(T.director.root.destroyLight(this),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case Ig.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case Ig.SPHERE:e.addSphereLight(this._light);break;case Ig.SPOT:e.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case Ig.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case Ig.SPHERE:e.removeSphereLight(this._light);break;case Ig.SPOT:e.removeSpotLight(this._light)}}},c(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(f1.x=e.r/255,f1.y=e.g/255,f1.z=e.b/255,this._light.color=f1)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}}]),t}(Bu),c0.Type=Ig,c0.PhotometricTerm=_1,r0=x((i0=l0).prototype,"_color",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.WHITE.clone()}}),o0=x(i0.prototype,"_useColorTemperature",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a0=x(i0.prototype,"_colorTemperature",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),s0=x(i0.prototype,"_staticSettings",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d1}}),x(i0.prototype,"color",[Q$],Object.getOwnPropertyDescriptor(i0.prototype,"color"),i0.prototype),x(i0.prototype,"useColorTemperature",[Z$],Object.getOwnPropertyDescriptor(i0.prototype,"useColorTemperature"),i0.prototype),x(i0.prototype,"colorTemperature",[Ac,J$,$$],Object.getOwnPropertyDescriptor(i0.prototype,"colorTemperature"),i0.prototype),x(i0.prototype,"staticSettings",[e0,t0],Object.getOwnPropertyDescriptor(i0.prototype,"staticSettings"),i0.prototype),n0=i0))||n0)),m1=(e("DirectionalLight",(h0=$s("cc.DirectionalLight"),_0=pc(),f0=hc(),d0=ac("_illuminance"),p0=xc(),h0(m0=_0(m0=f0(m0=uc((x0=function(e){function t(){var t;return y(t=e.call(this)||this,"_illuminanceHDR",g0,m(t)),y(t,"_illuminanceLDR",y0,m(t)),t._type=Ig.DIRECTIONAL,t._light=null,t._lightType=IS,t}return u(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*Vv.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},c(t,[{key:"illuminance",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),t}(p1),g0=x((v0=x0).prototype,"_illuminanceHDR",[ic,d0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),y0=x(v0.prototype,"_illuminanceLDR",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),x(v0.prototype,"illuminance",[p0],Object.getOwnPropertyDescriptor(v0.prototype,"illuminance"),v0.prototype),m0=v0))||m0)||m0)||m0)||m0)),e("SphereLight",(S0=$s("cc.SphereLight"),T0=pc(),E0=hc(),C0=ac("_luminance"),A0=bc(),b0=xc(),P0=bc(),R0=xc(),w0=Mc(_1),I0=bc(),D0=xc(),O0=xc(),M0=xc(),S0(N0=T0(N0=E0(N0=uc((G0=function(e){function t(){var t;return y(t=e.call(this)||this,"_size",B0,m(t)),y(t,"_luminanceHDR",F0,m(t)),y(t,"_luminanceLDR",z0,m(t)),y(t,"_term",U0,m(t)),y(t,"_range",k0,m(t)),t._type=Ig.SPHERE,t._light=null,t._lightType=jS,t}return u(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,T.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*Vv.standardExposureValue*Vv.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/Vv.standardExposureValue/Vv.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},c(t,[{key:"luminousFlux",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Wg(this._size):this._luminanceLDR},set:function(e){var t=0;T.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Wg(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(p1),B0=x((L0=G0).prototype,"_size",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),F0=x(L0.prototype,"_luminanceHDR",[oc,C0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Wg(.15)}}),z0=x(L0.prototype,"_luminanceLDR",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),U0=x(L0.prototype,"_term",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _1.LUMINOUS_FLUX}}),k0=x(L0.prototype,"_range",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),x(L0.prototype,"luminousFlux",[A0,b0],Object.getOwnPropertyDescriptor(L0.prototype,"luminousFlux"),L0.prototype),x(L0.prototype,"luminance",[P0,R0],Object.getOwnPropertyDescriptor(L0.prototype,"luminance"),L0.prototype),x(L0.prototype,"term",[w0,I0,D0],Object.getOwnPropertyDescriptor(L0.prototype,"term"),L0.prototype),x(L0.prototype,"size",[O0],Object.getOwnPropertyDescriptor(L0.prototype,"size"),L0.prototype),x(L0.prototype,"range",[M0],Object.getOwnPropertyDescriptor(L0.prototype,"range"),L0.prototype),N0=L0))||N0)||N0)||N0)||N0)),e("SpotLight",(H0=$s("cc.SpotLight"),V0=pc(),j0=hc(),W0=ac("_luminance"),q0=xc(),X0=bc(),Y0=xc(),K0=bc(),Q0=Mc(_1),Z0=bc(),J0=xc(),$0=xc(),e1=xc(),t1=Sc(),n1=xc(),H0(i1=V0(i1=j0(i1=uc((h1=function(e){function t(){var t;return y(t=e.call(this)||this,"_size",o1,m(t)),y(t,"_luminanceHDR",a1,m(t)),y(t,"_luminanceLDR",s1,m(t)),y(t,"_term",c1,m(t)),y(t,"_range",l1,m(t)),y(t,"_spotAngle",u1,m(t)),t._type=Ig.SPOT,t._light=null,t._lightType=ZS,t}return u(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,T.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*Vv.standardExposureValue*Vv.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/Vv.standardExposureValue/Vv.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},c(t,[{key:"luminousFlux",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Wg(this._size):this._luminanceLDR},set:function(e){var t=0;T.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Wg(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return T.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){T.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=Jt(e))}}]),t}(p1),o1=x((r1=h1).prototype,"_size",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),a1=x(r1.prototype,"_luminanceHDR",[oc,W0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Wg(.15)}}),s1=x(r1.prototype,"_luminanceLDR",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c1=x(r1.prototype,"_term",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _1.LUMINOUS_FLUX}}),l1=x(r1.prototype,"_range",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),u1=x(r1.prototype,"_spotAngle",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),x(r1.prototype,"luminousFlux",[q0,X0],Object.getOwnPropertyDescriptor(r1.prototype,"luminousFlux"),r1.prototype),x(r1.prototype,"luminance",[Y0,K0],Object.getOwnPropertyDescriptor(r1.prototype,"luminance"),r1.prototype),x(r1.prototype,"term",[Q0,Z0,J0],Object.getOwnPropertyDescriptor(r1.prototype,"term"),r1.prototype),x(r1.prototype,"size",[$0],Object.getOwnPropertyDescriptor(r1.prototype,"size"),r1.prototype),x(r1.prototype,"range",[e1],Object.getOwnPropertyDescriptor(r1.prototype,"range"),r1.prototype),x(r1.prototype,"spotAngle",[Ac,t1,n1],Object.getOwnPropertyDescriptor(r1.prototype,"spotAngle"),r1.prototype),i1=r1))||i1)||i1)||i1)||i1)),function(e,t,n){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14});function v1(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*n,e)/12)}new Pn,new Pn,new dn,new Pn,new dn;var g1=new sr(fi.POINT,fi.POINT,fi.NONE,di.CLAMP,di.CLAMP,di.CLAMP),y1=new dn,x1=new dn,S1=new dn,T1=new dn,E1=new Ln,C1=new Ln,A1=new Is,b1=Number.MAX_SAFE_INTEGER,P1=function(){function e(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=function(e){return e.hasFeature(ei.TEXTURE_FLOAT)?ti.RGBA32F:ti.RGBA8}(this._device);this._formatSize=Gr[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Wj(e),this._pool.initialize({format:t,roundUpFn:v1}),this._customPool=new Wj(e),this._customPool.initialize({format:t,roundUpFn:v1})}var t=e.prototype;return t.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},t.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},t.getDefaultPoseTexture=function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),_=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!_)return r;r={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:_},s=new Float32Array(u),c=!0}dn.set(S1,b1,b1,b1),dn.set(T1,-b1,-b1,-b1);for(var f=t.getBoneSpaceBounds(e),d=0,p=0;d<l;d++,p+=12){var m=n.getChildByPath(o[d]),v=m?eG(m,n,E1):e.inverseBindposes[d],g=f[d];g&&(Is.transform(A1,g,v),A1.getBoundary(y1,x1),dn.min(S1,S1,y1),dn.max(T1,T1,x1)),c&&(m&&Ln.multiply(v,v,a[d]),m1(s,p,m?v:Ln.IDENTITY))}var y=[new Is];return r.bounds.set(t.hash,y),Is.fromPoints(y[0],S1,T1),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},t.getSequencePoseTexture=function(e,t,n,i){var r=e.hash^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=e.joints,s=e.bindposes,c=Nz.getOrExtract(t).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var _=12*h*c,f=this._chunkIdxMap.get(r),d=void 0!==f?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,f):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!d)return null;var p=this._createAnimInfos(e,t,i);o={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:d,animInfos:p},l=new Float32Array(_),u=!0}var m=n.getBoneSpaceBounds(e),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new Is(b1,b1,b1,-b1,-b1,-b1));for(var y=0,x=0;y<c;y++){for(var S=v[y],T=0;T<h;T++,x+=12){var E=o.animInfos[T],C=E.curveData,A=E.downstream,b=E.bindposeIdx,P=E.bindposeCorrection,R=void 0,w=!0;C&&A?R=Ln.multiply(E1,C[y],A):C?R=C[y]:A?R=A:(R=e.inverseBindposes[b],w=!1);var I=m[T];if(I){var D=P?Ln.multiply(C1,R,P):R;Is.transform(A1,I,D),A1.getBoundary(y1,x1),dn.min(S.center,S.center,y1),dn.max(S.halfExtents,S.halfExtents,x1)}u&&(w&&Ln.multiply(E1,R,s[b]),m1(l,x,w?E1:Ln.IDENTITY))}Is.fromPoints(S,S.center,S.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},t.releaseHandle=function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}},t.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t._createAnimInfos=function(e,t,n){for(var i=[],r=e.joints,o=e.bindposes,a=r.length,s=Nz.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),_=void 0,f=void 0;!u;){var d=l.lastIndexOf("/");if(l=l.substring(0,d),u=s.joints[l],h?(_||(_=new Ln),Ln.fromRTS(E1,h.rotation,h.position,h.scale),Ln.multiply(_,E1,_),h=h.parent):f=l,d<0)break}var p=c,m=void 0;if(void 0!==f&&u){p=c-1;for(var v=0;v<a;v++)if(r[v]===f){p=v,m=new Ln,Ln.multiply(m,o[v],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:_,bindposeIdx:p,bindposeCorrection:m})}return i},c(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),e}(),R1=function(){function e(e){this._pool=new Map,this._device=void 0,this._device=e}var t=e.prototype;return t.getData=function(e){void 0===e&&(e="-1");var t=this._pool.get(e);if(t)return t;var n=this._device.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,Wd.SIZE,Wd.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1,currentClip:null};return this._setAnimInfoDirty(r,!1),this._pool.set(e,r),r},t.destroy=function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))},t._setAnimInfoDirty=function(e,t){e.dirty=t},t.switchClip=function(e,t){return e.currentClip=t,e.data[0]=-1,e.buffer.update(e.data),this._setAnimInfoDirty(e,!1),e},t.clear=function(){for(var e,t=g(this._pool.values());!(e=t()).done;)e.value.buffer.destroy();this._pool.clear()},e}(),w1=function(){function e(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new P1(e),this.jointAnimationInfo=new R1(e)}var t=e.prototype;return t.releaseSkeleton=function(e){this.jointTexturePool.releaseSkeleton(e)},t.releaseAnimationClip=function(e){this.jointTexturePool.releaseAnimationClip(e)},t.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},e}();T.internal.DataPoolManager=w1;var I1=[{name:"CC_USE_SKINNING",value:!0}];function D1(e,t,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(t.push(r),e.push(a))}}var O1,M1,N1,L1,B1,F1,z1,U1,k1,G1,H1,V1,j1,W1,q1,X1,Y1,K1,Q1,Z1,J1,$1,e2,t2,n2,i2,r2,o2,a2,s2,c2,l2,u2,h2,_2,f2,d2,p2,m2,v2,g2,y2,x2,S2,T2,E2,C2,A2,b2,P2,R2,w2,I2,D2,O2,M2,N2,L2,B2,F2,z2,U2,k2,G2,H2,V2=new dn,j2=new dn,W2=new dn,q2=new dn,X2=new Ln,Y2=new Is,K2=function(e){function t(){var t;return(t=e.call(this)||this).uploadAnimation=null,t._buffers=[],t._dataArray=[],t._joints=[],t._bufferIndices=null,t.type=bS.SKINNING,t}u(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)Ek(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=Tk(c,t),u=e.bindposes[a],h=[],_=[];o?D1(h,_,o,a):(h.push(a),_.push(0)),this._joints.push({indices:h,buffers:_,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0),dn.set(V2,1/0,1/0,1/0),dn.set(j2,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=Sk(i.transform,e);Is.transform(Y2,r,o),Y2.getBoundary(W2,q2),dn.min(V2,V2,W2),dn.max(j2,j2,q2)}var a=this._worldBounds;this._modelBounds&&a&&(Is.fromPoints(this._modelBounds,V2,j2),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;Ln.multiply(X2,a.world,s);for(var c=0;c<o.length;c++)m1(this._dataArray[o[c]],12*r[c],X2)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(t,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,e.prototype.initSubModel.call(this,t,n,i),o.vertexBuffers=r},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?I1.concat(n):I1},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._buffers[this._bufferIndices[t]];i&&n.bindBuffer(Xd.BINDING,i)},n._updateInstancedAttributes=function(t,n){n.batchingScheme!==ev.NONE&&V(3936,this.node.name),e.prototype._updateInstancedAttributes.call(this,t,n)},n._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.HOST|si.DEVICE,Xd.SIZE,Xd.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(Xd.COUNT))},t}(P$),Q2=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],Z2=function(e){function t(){var t;(t=e.call(this)||this).uploadedAnim=void 0,t._jointsMedium=void 0,t._skeleton=null,t._mesh=null,t._dataPoolManager=void 0,t._instAnimInfoIdx=-1,t.type=bS.BAKED_SKINNING,t._dataPoolManager=T.director.root.dataPoolManager;var n=new Float32Array(4),i=t._dataPoolManager.jointAnimationInfo.getData();return t._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:i,texture:null,boundsInfo:null},t}u(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),this._skeleton=e,this._mesh=n,e&&t&&n){this.transform=t;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new er(ri.UNIFORM|ri.TRANSFER_DST,si.DEVICE,jd.SIZE,jd.SIZE)))}},n.updateTransform=function(t){if(e.prototype.updateTransform.call(this,t),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(e){this._modelBounds=e},n.uploadAnimation=function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,n=null;e?(n=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=e.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Qd,o)}},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?n.concat(Q2):Q2},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(jd.BINDING,r),n.bindBuffer(Wd.BINDING,a.buffer),o){var s=this._device.getSampler(g1);n.bindTexture(Qd,o.handle.texture),n.bindSampler(Qd,s)}},n._setInstAnimInfoIdx=function(e){this._instAnimInfoIdx=e},n._updateInstancedAttributes=function(t,n){e.prototype._updateInstancedAttributes.call(this,t,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(qd)),this.updateInstancedJointTextureInfo()},n.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,n=e.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=t[1],r[2]=t[2]}},t}(P$),J2=e("SkinnedMeshRenderer",(O1=$s("cc.SkinnedMeshRenderer"),M1=pc(),N1=tc(100),L1=hc(),B1=Mc(u0),F1=Mc(TA),z1=Mc(u0),U1=Mc(TA),k1=xc(),O1(G1=M1(G1=N1(G1=uc(G1=L1((W1=function(e){function t(){var t;return y(t=e.call(this)||this,"_skeleton",V1,m(t)),y(t,"_skinningRoot",j1,m(t)),t._clip=null,t.associatedAnimation=null,t._modelType=Z2,t}u(t,e);var n=t.prototype;return n.onLoad=function(){this._tryBindAnimation()},n.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),e.prototype.onDestroy.call(this)},n.uploadAnimation=function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)},n.setUseBakedAnimation=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1);var n=e?Z2:K2;(t||this._modelType!==n)&&(this._modelType=n,this._model&&(T.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(t,n){e.prototype.setMaterial.call(this,t,n),this._modelType===K2&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),e.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var e=this._skinningRoot;if(e){for(var t=!1,n=this.node;n;n=n.parent)if(n===e){t=!0;break}if(t){var i=e.getComponent("cc.SkeletalAnimation");i?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},c(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._tryBindAnimation(),e!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),t}(D$),V1=x((H1=W1).prototype,"_skeleton",[B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j1=x(H1.prototype,"_skinningRoot",[F1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x(H1.prototype,"skeleton",[z1],Object.getOwnPropertyDescriptor(H1.prototype,"skeleton"),H1.prototype),x(H1.prototype,"skinningRoot",[U1,k1],Object.getOwnPropertyDescriptor(H1.prototype,"skinningRoot"),H1.prototype),G1=H1))||G1)||G1)||G1)||G1)||G1)),$2=new vr(zi.ATTR_BATCH_ID,ti.R32F),e4=new vr(zi.ATTR_BATCH_UV,ti.RG32F),t4=Gr[$2.format].size+Gr[e4.format].size,n4=e("SkinnedMeshUnit",(q1=$s("cc.SkinnedMeshUnit"),X1=Mc(kJ),Y1=Mc(u0),K1=Mc(Nv),Q1=Mc(J2),q1((o2=function(){function e(){y(this,"mesh",$1,this),y(this,"skeleton",e2,this),y(this,"material",t2,this),y(this,"_localTransform",n2,this),y(this,"_offset",i2,this),y(this,"_size",r2,this)}return c(e,[{key:"offset",get:function(){return this._offset},set:function(e){gn.copy(this._offset,e)}},{key:"size",get:function(){return this._size},set:function(e){gn.copy(this._size,e)}},{key:"copyFrom",get:function(){return null},set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&eG(e.node,e.skinningRoot,this._localTransform))}}]),e}(),$1=x((J1=o2).prototype,"mesh",[X1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e2=x(J1.prototype,"skeleton",[Y1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),t2=x(J1.prototype,"material",[K1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n2=x(J1.prototype,"_localTransform",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln}}),i2=x(J1.prototype,"_offset",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gn(0,0)}}),r2=x(J1.prototype,"_size",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gn(1,1)}}),x(J1.prototype,"offset",[mc],Object.getOwnPropertyDescriptor(J1.prototype,"offset"),J1.prototype),x(J1.prototype,"size",[mc],Object.getOwnPropertyDescriptor(J1.prototype,"size"),J1.prototype),x(J1.prototype,"copyFrom",[Q1],Object.getOwnPropertyDescriptor(J1.prototype,"copyFrom"),J1.prototype),Z1=J1))||Z1)),i4=new Ln,r4=(new Ln,new dn),o4=(e("SkinnedMeshBatchRenderer",(a2=$s("cc.SkinnedMeshBatchRenderer"),s2=pc(),c2=tc(100),l2=hc(),u2=xc(),h2=Mc([Ct]),_2=xc(),f2=Mc([n4]),d2=xc(),p2=vc(),m2=vc(),a2(v2=s2(v2=c2(v2=uc(v2=l2((T2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"atlasSize",y2,m(t)),y(t,"batchableTextureNames",x2,m(t)),y(t,"units",S2,m(t)),t._textures={},t._batchMaterial=null,t}u(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),e.prototype.onDestroy.call(this)},n._onMaterialModified=function(t){this.cookMaterials(),e.prototype._onMaterialModified.call(this,t,this.getMaterialInstance(t))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var n=t.effectAsset.techniques[t.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=ii.SAMPLER1D){var o=null;e.batchableTextureNames.find((function(e){return e===n}))?((o=e._textures[n])||(o=e.createTexture(n)),e.cookTextures(o,n,i)):e.units.some((function(e){return o=e.material&&e.material.getProperty(n,i)})),o&&t.setProperty(n,o,i)}else{for(var a=[],s=0;s<e.units.length;s++){var c=e.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}t.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var e=[],t=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;Ln.invert(i4,i._localTransform);for(var o=function(n){var i=r.joints[n];if(e.findIndex((function(e){return e===i}))>=0)return"continue";e.push(i),t.push(Ln.multiply(new Ln,r.bindposes[n]||Ln.IDENTITY,i4))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(e.length).keys()).sort((function(t,n){return e[t]>e[n]?1:e[t]<e[n]?-1:0})),c=new u0;c.joints=e.map((function(e,t,n){return n[s[t]]})),c.bindposes=t.map((function(e,t,n){return n[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var e=this,t=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){t=!0;break}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new kJ;for(var i=0,r=ti.UNKNOWN,o=0,a=ti.UNKNOWN,s=0,c=ti.UNKNOWN,l=0,u=ti.UNKNOWN,h=0,_=ti.UNKNOWN,f=new Array(this.units.length),d=this.units.length,p=0;p<d;p++){var m=this.units[p];m&&m.skeleton&&(f[p]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var n=e.units[t];if(!n||!n.mesh||!n.mesh.data)return"continue";var d=e._createUnitMesh(t,n.mesh),p=new DataView(d.data.buffer);Ln.inverseTranspose(i4,n._localTransform);for(var m=n.offset,v=n.size,g=function(e){var g=d.struct.vertexBundles[e];i=g.view.offset,r=ti.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var x=g.attributes[y];if(x.name===zi.ATTR_POSITION){r=x.format;break}i+=Gr[x.format].size}if(r){for(var S=pb(p,r,i,g.view.length,g.view.stride),T=0;T<S.length;T+=3)dn.fromArray(r4,S,T),dn.transformMat4(r4,r4,n._localTransform),dn.toArray(S,r4,T);db(p,S,r,i,g.view.stride)}o=g.view.offset,a=ti.UNKNOWN;for(var E=0;E<g.attributes.length;E++){var C=g.attributes[E];if(C.name===zi.ATTR_NORMAL){a=C.format;break}o+=Gr[C.format].size}if(a){for(var A=pb(p,a,o,g.view.length,g.view.stride),b=0;b<A.length;b+=3)dn.fromArray(r4,A,b),dn.transformMat4Normal(r4,r4,i4),dn.toArray(A,r4,b);db(p,A,a,o,g.view.stride)}s=g.view.offset,c=ti.UNKNOWN;for(var P=0;P<g.attributes.length;P++){var R=g.attributes[P];if(R.name===zi.ATTR_TANGENT){c=R.format;break}s+=Gr[R.format].size}if(c){for(var w=pb(p,c,s,g.view.length,g.view.stride),I=0;I<w.length;I+=3)dn.fromArray(r4,w,I),dn.transformMat4Normal(r4,r4,i4),dn.toArray(w,r4,I);db(p,w,c,s,g.view.stride)}l=g.view.offset,u=ti.UNKNOWN;for(var D=0;D<g.attributes.length;D++){var O=g.attributes[D];if(O.name===zi.ATTR_BATCH_UV){u=O.format;break}l+=Gr[O.format].size}u&&mb(p,(function(e,t){var n,i=0===t?"x":"y";return(e=(n=e)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,p);var M=f[t];if(!M)return"continue";h=g.view.offset,_=ti.UNKNOWN;for(var N=0;N<g.attributes.length;N++){var L=g.attributes[N];if(L.name===zi.ATTR_JOINTS){_=L.format;break}h+=Gr[L.format].size}_&&mb(p,(function(e){return M[e]}),_,h,g.view.length,g.view.stride,p)},y=0;y<d.struct.vertexBundles.length;y++)g(y);e._mesh.merge(d)},g=0;g<d;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(e,t,n){for(var i=[],r=[],o=[],a=[],s=0;s<this.units.length;s++){var c=this.units[s];if(c.material){var l=c.material.getProperty(t,n);if(l&&l.image&&l.image.data){var u=new Yi;u.texOffset.x=c.offset.x*this.atlasSize,u.texOffset.y=c.offset.y*this.atlasSize,u.texExtent.width=c.size.x*this.atlasSize,u.texExtent.height=c.size.y*this.atlasSize;var h=l.image.data;ArrayBuffer.isView(h)?(o.push(h),a.push(u)):(i.push(h),r.push(u))}}}var _=e.getGFXTexture(),f=T.director.root.device;o.length>0&&f.copyBuffersToTexture(o,_,a),i.length>0&&f.copyTexImagesToTexture(i,_,r)},n.createTexture=function(e){var t=new Km;return t.setFilters(om.LINEAR,om.LINEAR),t.setMipFilter(om.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:im.RGBA8888}),this._textures[e]=t,t},n.resizeAtlases=function(){for(var e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:im.RGBA8888})},n._createUnitMesh=function(e,t){for(var n=JSON.parse(JSON.stringify(t.struct)),i={},r=0;r<t.struct.primitives.length;r++){for(var o=t.struct.primitives[r],a=0,s=ti.UNKNOWN,c=0;c<o.vertexBundelIndices.length;c++){var l=t.struct.vertexBundles[o.vertexBundelIndices[c]];a=l.view.offset,s=ti.UNKNOWN;for(var u=0;u<l.attributes.length;u++){var h=l.attributes[u];if(h.name===zi.ATTR_TEX_COORD){s=h.format;break}a+=Gr[h.format].size}if(s)break}if(void 0===i[c]){i[c]=[s,a];var _=n.vertexBundles[c];_.attributes.push($2),_.attributes.push(e4),_.view.offset=0,_.view.length+=_.view.count*t4,_.view.stride+=t4}}for(var f=0,d=0;d<n.vertexBundles.length;d++)f+=n.vertexBundles[d].view.length;for(var p=0;p<n.primitives.length;p++){var m=n.primitives[p];m.indexView&&(m.indexView.offset=f,f+=m.indexView.length)}var v=new Uint8Array(f),g=t.data,y=new DataView(v.buffer),x=new DataView(g.buffer),S=T.sys.isLittleEndian;for(var E in i)for(var C=n.vertexBundles[E],A=t.struct.vertexBundles[E],b=i[E],P=pb(x,b[0],b[1],A.view.length,A.view.stride),R=A.view,w=C.view,I=R.stride,D=w.stride,O=R.offset,M=w.offset,N=0;N<w.count;N++){var L=g.subarray(O,O+I);v.set(L,M),y.setFloat32(M+I,e),y.setFloat32(M+I+4,P[2*N],S),y.setFloat32(M+I+8,P[2*N+1],S),M+=D,O+=I}for(var B=0;B<n.primitives.length;B++){var F=t.struct.primitives[B],z=n.primitives[B];if(F.indexView&&z.indexView)for(var U=F.indexView.stride,k=z.indexView.stride,G=F.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var j=g.subarray(G,G+U);v.set(j,H),H+=k,G+=U}}var W=new kJ;return W.reset({struct:n,data:v}),W},c(t,[{key:"mesh",get:function(){return e.prototype.mesh},set:function(e){this.mesh=e}},{key:"skeleton",get:function(){return e.prototype.skeleton},set:function(e){this.skeleton=e}}]),t}(J2),y2=x((g2=T2).prototype,"atlasSize",[oc,u2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),x2=x(g2.prototype,"batchableTextureNames",[h2,oc,_2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),S2=x(g2.prototype,"units",[f2,oc,d2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),x(g2.prototype,"mesh",[Vc,p2],Object.getOwnPropertyDescriptor(g2.prototype,"mesh"),g2.prototype),x(g2.prototype,"skeleton",[Vc,m2],Object.getOwnPropertyDescriptor(g2.prototype,"skeleton"),g2.prototype),v2=g2))||v2)||v2)||v2)||v2)||v2)),new Ln),a4=new Ln,s4=e("SkeletalAnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this,t,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._parent=null,i._curvesInited=!1,i._animInfoMgr=T.director.root.dataPoolManager.jointAnimationInfo,i}u(t,e);var n=t.prototype;return n.initialize=function(t){if(!this._curveLoaded){this._parent=t.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,e.prototype.initialize.call(this,t),this._curvesInited=!n;var i=Nz.getOrExtract(this.clip),r=i.frames,o=i.samples;this._frames=r-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/o,this.setUseBaked(n)}},n.setUseBaked=function(t){t?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=e.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,e.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(e){if(this._sockets.length=0,this._targetNode)for(var t=this._targetNode,n=0;n<e.length;++n){var i=e[n],r=t.getChildByPath(i.path);if(i.target){for(var o=Nz.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=Ln.identity(a4)),Ln.fromRTS(o4,c.rotation,c.position,c.scale),Ln.multiply(l,o4,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,_=o.frames,f=[],d=0;d<_;d++){var p;p=h&&l?Ln.multiply(o4,h[d],l):h?h[d]:l||new Ln;var m={pos:new dn,rot:new Pn,scale:new dn};Ln.toRTS(p,m.rot,m.pos,m.scale),f.push(m)}this._sockets.push({target:i.target,frames:f})}}},n._setAnimInfoDirty=function(e,t){e.dirty=t},n._sampleCurvesBaked=function(e){var t=e/this.duration,n=this._animInfo,i=this.clip;n.currentClip!==i&&(this._animInfoMgr.switchClip(this._animInfo,i),this._parent.getUsers().forEach((function(e){e.uploadAnimation(i)})));var r=t*this._frames+.5|0;if(r!==n.data[0]){n.data[0]=r,this._setAnimInfoDirty(n,!0);for(var o=0;o<this._sockets.length;++o){var a=this._sockets[o],s=a.target,c=a.frames[r],l=c.pos,u=c.rot,h=c.scale;s.setRTS(u,l,h)}}},t}(Rk)),c4=e("Socket",(E2=$s("cc.SkeletalAnimation.Socket"),C2=Mc(TA),E2((P2=x((b2=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),y(this,"path",P2,this),y(this,"target",R2,this),this.path=e,this.target=t}).prototype,"path",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),R2=x(b2.prototype,"target",[C2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A2=b2))||A2));qe.setClassAlias(c4,"cc.SkeletalAnimationComponent.Socket");var l4,u4,h4,_4=new Ln,f4=new Ln;function d4(e,t,n){void 0===t&&(t=""),void 0===n&&(n=[]);for(var i=0;i<e.children.length;i++){var r=e.children[i];if(r){var o=t?t+"/"+r.name:r.name;n.push(o),d4(r,o,n)}}return n}e("SkeletalAnimation",(w2=$s("cc.SkeletalAnimation"),I2=pc(),D2=tc(99),O2=hc(),M2=Mc([c4]),N2=xc(),L2=xc(),B2=Mc([c4]),w2(F2=I2(F2=D2(F2=uc(F2=O2((H2=G2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_useBakedAnimation",U2,m(t)),y(t,"_sockets",k2,m(t)),t._users=new Set,t._currentBakedState=null,t}u(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this);for(var t=this.node.getComponentsInChildren(J2),n=0;n<t.length;++n){var i=t[n];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}},n.onDestroy=function(){e.prototype.onDestroy.call(this),T.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),T.director.getAnimationManager().removeSockets(this.node,this._sockets),this._removeAllUsers()},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,e.prototype.start.call(this)},n.pause=function(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.pause():e.prototype.pause.call(this)},n.resume=function(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.resume():e.prototype.resume.call(this)},n.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):e.prototype.stop.call(this)},n.querySockets=function(){var e=this._defaultClip&&Object.keys(Nz.getOrExtract(this._defaultClip).joints).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e}),[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],n=0;n<e.length;n++){var i=e[n],r=this.node.getChildByPath(i);r&&(t.push(i),d4(r,i,t))}return t},n.rebuildSocketAnimations=function(){for(var e,t=g(this._sockets);!(e=t()).done;){var n=e.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,eG(i,this.node,_4),Ln.fromRTS(f4,r.rotation,r.position,r.scale),Ln.equals(f4,_4)||(r.matrix=_4))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var n=new TA;return n.parent=this.node,this._sockets.push(new c4(e,n)),this.rebuildSocketAnimations(),n},n.notifySkinnedMeshAdded=function(e){var t=this._useBakedAnimation,n=e.associatedAnimation;if(n&&n._users.delete(e),e.associatedAnimation=this,e.setUseBakedAnimation(t,!0),t){var i=this._currentBakedState;i&&e.uploadAnimation(i.clip)}this._users.add(e)},n.notifySkinnedMeshRemoved=function(e){e.associatedAnimation,e.setUseBakedAnimation(!1),e.associatedAnimation=null,this._users.delete(e)},n.getUsers=function(){return this._users},n._createState=function(e,t){return new s4(e,t)},n._doCreateState=function(t,n){var i=e.prototype._doCreateState.call(this,t,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(t,n){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var i=t;this._currentBakedState=i,i.play()}else e.prototype.doPlayOrCrossFade.call(this,t,n)},n._removeAllUsers=function(){var e=this;Array.from(this._users).forEach((function(t){e.notifySkinnedMeshRemoved(t)}))},c(t,[{key:"sockets",get:function(){return this._sockets},set:function(e){if(!this._useBakedAnimation){var t=T.director.getAnimationManager();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){for(var t in this._useBakedAnimation=e,this._nameToState)this._nameToState[t].setUseBaked(e);this._users.forEach((function(t){t.setUseBakedAnimation(e)})),this._useBakedAnimation?T.director.getAnimationManager().removeSockets(this.node,this._sockets):(T.director.getAnimationManager().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),t}(Xk),G2.Socket=c4,x((z2=H2).prototype,"sockets",[M2,N2],Object.getOwnPropertyDescriptor(z2.prototype,"sockets"),z2.prototype),x(z2.prototype,"useBakedAnimation",[L2],Object.getOwnPropertyDescriptor(z2.prototype,"useBakedAnimation"),z2.prototype),U2=x(z2.prototype,"_useBakedAnimation",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),k2=x(z2.prototype,"_sockets",[B2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),F2=z2))||F2)||F2)||F2)||F2)||F2)),T.utils=KJ,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(l4||(l4={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(u4||(u4={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(h4||(h4={}));var p4,m4=0;function v4(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(t.args)).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&v4(e,n)})).catch((function(){})))}function g4(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=m4++,o=e;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),t),v4(o,o._operationQueue[0])}))}}function y4(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var x4,S4,T4=function(){function e(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=e,e.volume=t}var t=e.prototype;return t.play=function(){var e=this;y4(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))},t.stop=function(){this._domAudio.pause()},c(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}}]),e}(),E4=(x((p4=function(){function e(e){var t=this;this._domAudio=void 0,this._state=h4.INIT,this._onEnded=void 0,this._eventTarget=new zl,this._operationQueue=[],this._domAudio=e,Jl.on("hide",this._onHide,this),Jl.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch((function(){})),t._state=h4.INIT,t._eventTarget.emit(l4.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var t=e.prototype;return t.destroy=function(){Jl.off("hide",this._onHide,this),Jl.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";Jl.os===Vl.IOS?r="loadedmetadata":Jl.browserType===kl.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),t(i)},c=function(){a(),n("load audio failure - "+e)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new T4(e,n);i(t)})).catch(r)}))},t._onHide=function(){var e=this;this._state===h4.PLAYING&&this.pause().then((function(){e._state=h4.INTERRUPTED,e._eventTarget.emit(l4.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===h4.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(l4.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){return e=Kt(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},t.play=function(){var e=this;return new Promise((function(t){y4(e._domAudio).then((function(){e._state=h4.PLAYING,t()})).catch((function(){}))}))},t.pause=function(){return this._domAudio.pause(),this._state=h4.PAUSED,Promise.resolve()},t.stop=function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=h4.STOPPED,t()}))},t.onInterruptionBegin=function(e){this._eventTarget.on(l4.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(l4.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(l4.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(l4.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(l4.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(l4.ENDED,e)},c(e,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return u4.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=Qt(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),e}()).prototype,"seek",[g4],Object.getOwnPropertyDescriptor(p4.prototype,"seek"),p4.prototype),x(p4.prototype,"play",[g4],Object.getOwnPropertyDescriptor(p4.prototype,"play"),p4.prototype),x(p4.prototype,"pause",[g4],Object.getOwnPropertyDescriptor(p4.prototype,"pause"),p4.prototype),x(p4.prototype,"stop",[g4],Object.getOwnPropertyDescriptor(p4.prototype,"stop"),p4.prototype),p4),C4=function(){function e(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e}var t=e.prototype;return t.destroy=function(){this._nativeAudio=void 0},t._now=function(){return performance.now()/1e3},t._calculateCurrentTime=function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration},t.start=function(){this._isPaused=!1,this._startTime=this._now()},t.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},t.stop=function(){this._isPaused=!0,this._startOffset=0},t.seek=function(e){this._startTime=this._now(),this._startOffset=Kt(e,0,this.duration)},c(e,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),e}(),A4=new(function(){function e(){this._audioBufferDataMap={}}var t=e.prototype;return t.addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},t.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},t.getCache=function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer},t.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},e}()),b4=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,P4=function(){function e(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var t=e.prototype;return t.decodeAudioData=function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))},t.runContext=function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))},t.createBufferSource=function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n},t.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},t.setGainValue=function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t},t.connectContext=function(e){this._context&&e.connect(this._context.destination)},c(e,[{key:"currentTime",get:function(){return this._context.currentTime}}]),e}();P4.support=!!b4,P4.support&&(S4=new P4);var R4,w4,I4,D4,O4,M4=function(){function e(e,t,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=n,this._bufferSourceNode=S4.createBufferSource(e,!1);var i=S4.createGain(t);this._bufferSourceNode.connect(i),S4.connectContext(i)}var t=e.prototype;return t.play=function(){var e=this;this._bufferSourceNode.start(),S4.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;A4.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))},t.stop=function(){clearTimeout(this._currentTimer),A4.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},c(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]),e}(),N4=(x((x4=function(){function e(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=h4.INIT,this._audioTimer=void 0,this._eventTarget=new zl,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new C4(e),this._gainNode=S4.createGain(),S4.connectContext(this._gainNode),this._src=t,Jl.on("hide",this._onHide,this),Jl.on("show",this._onShow,this)}var t=e.prototype;return t.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),A4.tryReleasingCache(this._src),Jl.off("hide",this._onHide,this),Jl.off("show",this._onShow,this)},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=A4.getCache(e);if(i)return A4.retainCache(e),void t(i);var r=new XMLHttpRequest,o="load audio failed: "+e+", status: ";r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?S4.decodeAudioData(r.response).then((function(n){A4.addCache(e,n),t(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new M4(e,n,t);i(r)})).catch(r)}))},t._onHide=function(){var e=this;this._state===h4.PLAYING&&this.pause().then((function(){e._state=h4.INTERRUPTED,e._eventTarget.emit(l4.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===h4.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(l4.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===h4.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))},t.play=function(){return this._doPlay()},t._doPlay=function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=S4.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),S4.runContext().then((function(){e._state=h4.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(l4.ENDED),e._state=h4.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))},t._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}},t.pause=function(){return this._state===h4.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=h4.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=h4.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.onInterruptionBegin=function(e){this._eventTarget.on(l4.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(l4.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(l4.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(l4.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(l4.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(l4.ENDED,e)},c(e,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return u4.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=Qt(e),this._volume=e,S4.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),e}()).prototype,"seek",[g4],Object.getOwnPropertyDescriptor(x4.prototype,"seek"),x4.prototype),x(x4.prototype,"play",[g4],Object.getOwnPropertyDescriptor(x4.prototype,"play"),x4.prototype),x(x4.prototype,"pause",[g4],Object.getOwnPropertyDescriptor(x4.prototype,"pause"),x4.prototype),x(x4.prototype,"stop",[g4],Object.getOwnPropertyDescriptor(x4.prototype,"stop"),x4.prototype),x4),L4=function(){function e(e){this._audio=void 0,this._audio=e}var t=e.prototype;return t.play=function(){this._audio.play()},t.stop=function(){this._audio.stop()},c(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),e}(),B4=function(){function e(e){this._player=void 0,this._player=e}e.load=function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==u4.DOM_AUDIO&&P4.support?N4.load(t).then((function(t){i(new e(t))})).catch((function(){})):(P4.support||V(5201),E4.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))};var t=e.prototype;return t.destroy=function(){this._player.destroy()},e.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==u4.DOM_AUDIO&&P4.support?N4.loadNative(e):(P4.support||V(5201),E4.loadNative(e))},e.loadOneShotAudio=function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==u4.DOM_AUDIO&&P4.support?N4.loadOneShotAudio(e,t).then((function(e){i(new L4(e))})).catch(r):(P4.support||V(5201),E4.loadOneShotAudio(e,t).then((function(e){i(new L4(e))})).catch(r))}))},t.seek=function(e){return this._player.seek(e)},t.play=function(){return this._player.play()},t.pause=function(){return this._player.pause()},t.stop=function(){return this._player.stop()},t.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},t.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},t.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},t.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},t.onEnded=function(e){this._player.onEnded(e)},t.offEnded=function(e){this._player.offEnded(e)},c(e,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),e}();B4.maxAudioChannel=24;var F4=e("AudioClip",$s("cc.AudioClip")((O4=D4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_duration",I4,m(t)),t._loadMode=u4.UNKNOWN_AUDIO,t._meta=null,t._player=null,t}u(t,e);var n=t.prototype;return n.destroy=function(){var t,n=e.prototype.destroy.call(this);return null===(t=this._player)||void 0===t||t.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))},n.setVolume=function(e){this._player&&(this._player.volume=e)},n.setLoop=function(e){this._player&&(this._player.loop=e)},n.play=function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))},n.pause=function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))},n.stop=function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))},n.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&B4.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))},c(t,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=u4.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:h4.INIT}}]),t}(pu),D4.AudioType=u4,I4=x((w4=O4).prototype,"_duration",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x(w4.prototype,"_nativeDep",[Vc],Object.getOwnPropertyDescriptor(w4.prototype,"_nativeDep"),w4.prototype),R4=w4))||R4);function z4(e,t,n){B4.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function U4(e,t,n,i){var r=new F4;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}T.AudioClip=F4,oN.register({".mp3":z4,".ogg":z4,".wav":z4,".m4a":z4}),_N.register({".mp3":U4,".ogg":U4,".wav":U4,".m4a":U4});var k4,G4,H4,V4,j4,W4,q4,X4,Y4,K4,Q4,Z4,J4,$4,e3,t3,n3,i3,r3,o3=new(function(){function e(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var t=e.prototype;return t._findIndex=function(e,t){return e.findIndex((function(e){return e.audio===t}))},t._tryAddPlaying=function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},t.addPlaying=function(e){if(e instanceof B4){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)},t._tryRemovePlaying=function(e,t){var n=this._findIndex(e,t);return-1!==n&&(te(e,n),!0)},t.removePlaying=function(e){if(e instanceof B4){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)},t.discardOnePlayingIfNeeded=function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<B4.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))},e}());!function(e){e.STARTED="started",e.ENDED="ended"}(r3||(r3={}));var a3,s3=(k4=$s("cc.AudioSource"),G4=pc(),H4=hc(),V4=Mc(F4),j4=Mc(F4),W4=xc(),q4=xc(),X4=xc(),Y4=Sc(),K4=xc(),a3=k4(Q4=G4(Q4=H4((i3=n3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_clip",J4,m(t)),t._player=null,y(t,"_loop",$4,m(t)),y(t,"_playOnAwake",e3,m(t)),y(t,"_volume",t3,m(t)),t._cachedCurrentTime=0,t._operationsBeforeLoading=[],t._isLoaded=!1,t._lastSetClip=null,t}u(t,e);var n=t.prototype;return n._syncPlayer=function(){var e=this,t=this._clip;this._isLoaded=!1,this._lastSetClip!==t&&(t?t._nativeAsset?(this._lastSetClip=t,B4.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t?(e._isLoaded=!0,e._player&&(e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){o3.removePlaying(n),e.node.emit(r3.ENDED,e)})),n.onInterruptionBegin((function(){o3.removePlaying(n)})),n.onInterruptionEnd((function(){o3.addPlaying(n)})),e._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()},n.onDestroy=function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy(),this._player=null},n._getRootNode=function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var e,t,n=this;this._isLoaded?(o3.discardOnePlayingIfNeeded(),this.state===h4.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){o3.addPlaying(n._player),n.node.emit(r3.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){o3.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){o3.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?B4.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){o3.discardOnePlayingIfNeeded(),e.onPlay=function(){o3.addPlaying(e)},e.onEnd=function(){o3.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))},c(t,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=Kt(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=Kt(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:h4.INIT}},{key:"playing",get:function(){return this.state===t.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return B4.maxAudioChannel}}]),t}(Bu),n3.AudioState=h4,n3.EventType=r3,J4=x((Z4=i3).prototype,"_clip",[V4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$4=x(Z4.prototype,"_loop",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),e3=x(Z4.prototype,"_playOnAwake",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),t3=x(Z4.prototype,"_volume",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),x(Z4.prototype,"clip",[j4,W4],Object.getOwnPropertyDescriptor(Z4.prototype,"clip"),Z4.prototype),x(Z4.prototype,"loop",[q4],Object.getOwnPropertyDescriptor(Z4.prototype,"loop"),Z4.prototype),x(Z4.prototype,"playOnAwake",[X4],Object.getOwnPropertyDescriptor(Z4.prototype,"playOnAwake"),Z4.prototype),x(Z4.prototype,"volume",[Y4,K4],Object.getOwnPropertyDescriptor(Z4.prototype,"volume"),Z4.prototype),Q4=Z4))||Q4)||Q4)||Q4,e({AudioSource:a3,AudioSourceComponent:a3}),a3);T.AudioSourceComponent=s3,qe.setClassAlias(s3,"cc.AudioSourceComponent"),T.log=O,T.warn=M,T.error=N,T.assert=L,T._throw=z,T.logID=G,T.warnID=V,T.errorID=W,T.assertID=Y,T.debug=J,T.path={join:nu,extname:iu,mainFileName:ru,basename:ou,dirname:au,changeExtname:su,changeBasename:cu,_normalize:lu,stripSep:uu,get sep(){return hu()}};var c3=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},e}());T.NodePool=c3,T.renderer=Xj;var l3,u3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&Hr){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&Vr&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},c(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(so);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(l3||(l3={}));var h3=function(){function e(){}return e.setInstance=function(t){e._instance=t},c(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function _3(e,t){switch(e){case ti.R8:return t.UNSIGNED_BYTE;case ti.R8SN:return t.BYTE;case ti.R8UI:return t.UNSIGNED_BYTE;case ti.R8I:return t.BYTE;case ti.R16F:return l3.HALF_FLOAT_OES;case ti.R16UI:return t.UNSIGNED_SHORT;case ti.R16I:return t.SHORT;case ti.R32F:return t.FLOAT;case ti.R32UI:return t.UNSIGNED_INT;case ti.R32I:return t.INT;case ti.RG8:return t.UNSIGNED_BYTE;case ti.RG8SN:return t.BYTE;case ti.RG8UI:return t.UNSIGNED_BYTE;case ti.RG8I:return t.BYTE;case ti.RG16F:return l3.HALF_FLOAT_OES;case ti.RG16UI:return t.UNSIGNED_SHORT;case ti.RG16I:return t.SHORT;case ti.RG32F:return t.FLOAT;case ti.RG32UI:return t.UNSIGNED_INT;case ti.RG32I:return t.INT;case ti.RGB8:case ti.SRGB8:return t.UNSIGNED_BYTE;case ti.RGB8SN:return t.BYTE;case ti.RGB8UI:return t.UNSIGNED_BYTE;case ti.RGB8I:return t.BYTE;case ti.RGB16F:return l3.HALF_FLOAT_OES;case ti.RGB16UI:return t.UNSIGNED_SHORT;case ti.RGB16I:return t.SHORT;case ti.RGB32F:return t.FLOAT;case ti.RGB32UI:return t.UNSIGNED_INT;case ti.RGB32I:return t.INT;case ti.BGRA8:case ti.RGBA8:case ti.SRGB8_A8:return t.UNSIGNED_BYTE;case ti.RGBA8SN:return t.BYTE;case ti.RGBA8UI:return t.UNSIGNED_BYTE;case ti.RGBA8I:return t.BYTE;case ti.RGBA16F:return l3.HALF_FLOAT_OES;case ti.RGBA16UI:return t.UNSIGNED_SHORT;case ti.RGBA16I:return t.SHORT;case ti.RGBA32F:return t.FLOAT;case ti.RGBA32UI:return t.UNSIGNED_INT;case ti.RGBA32I:return t.INT;case ti.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case ti.R11G11B10F:return t.FLOAT;case ti.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case ti.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case ti.RGB10A2:return t.UNSIGNED_BYTE;case ti.RGB10A2UI:return t.UNSIGNED_INT;case ti.RGB9E5:return t.UNSIGNED_BYTE;case ti.DEPTH:return t.UNSIGNED_INT;case ti.DEPTH_STENCIL:return l3.UNSIGNED_INT_24_8_WEBGL;case ti.BC1:case ti.BC1_SRGB:case ti.BC2:case ti.BC2_SRGB:case ti.BC3:case ti.BC3_SRGB:case ti.BC4:return t.UNSIGNED_BYTE;case ti.BC4_SNORM:return t.BYTE;case ti.BC5:return t.UNSIGNED_BYTE;case ti.BC5_SNORM:return t.BYTE;case ti.BC6H_SF16:case ti.BC6H_UF16:return t.FLOAT;case ti.BC7:case ti.BC7_SRGB:case ti.ETC_RGB8:case ti.ETC2_RGB8:case ti.ETC2_SRGB8:case ti.ETC2_RGB8_A1:case ti.ETC2_SRGB8_A1:case ti.EAC_R11:return t.UNSIGNED_BYTE;case ti.EAC_R11SN:return t.BYTE;case ti.EAC_RG11:return t.UNSIGNED_BYTE;case ti.EAC_RG11SN:return t.BYTE;case ti.PVRTC_RGB2:case ti.PVRTC_RGBA2:case ti.PVRTC_RGB4:case ti.PVRTC_RGBA4:case ti.PVRTC2_2BPP:case ti.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case ti.ASTC_RGBA_4X4:case ti.ASTC_RGBA_5X4:case ti.ASTC_RGBA_5X5:case ti.ASTC_RGBA_6X5:case ti.ASTC_RGBA_6X6:case ti.ASTC_RGBA_8X5:case ti.ASTC_RGBA_8X6:case ti.ASTC_RGBA_8X8:case ti.ASTC_RGBA_10X5:case ti.ASTC_RGBA_10X6:case ti.ASTC_RGBA_10X8:case ti.ASTC_RGBA_10X10:case ti.ASTC_RGBA_12X10:case ti.ASTC_RGBA_12X12:case ti.ASTC_SRGBA_4X4:case ti.ASTC_SRGBA_5X4:case ti.ASTC_SRGBA_5X5:case ti.ASTC_SRGBA_6X5:case ti.ASTC_SRGBA_6X6:case ti.ASTC_SRGBA_8X5:case ti.ASTC_SRGBA_8X6:case ti.ASTC_SRGBA_8X8:case ti.ASTC_SRGBA_10X5:case ti.ASTC_SRGBA_10X6:case ti.ASTC_SRGBA_10X8:case ti.ASTC_SRGBA_10X10:case ti.ASTC_SRGBA_12X10:case ti.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function f3(e,t){switch(e){case ii.BOOL:return t.BOOL;case ii.BOOL2:return t.BOOL_VEC2;case ii.BOOL3:return t.BOOL_VEC3;case ii.BOOL4:return t.BOOL_VEC4;case ii.INT:return t.INT;case ii.INT2:return t.INT_VEC2;case ii.INT3:return t.INT_VEC3;case ii.INT4:return t.INT_VEC4;case ii.UINT:return t.UNSIGNED_INT;case ii.FLOAT:return t.FLOAT;case ii.FLOAT2:return t.FLOAT_VEC2;case ii.FLOAT3:return t.FLOAT_VEC3;case ii.FLOAT4:return t.FLOAT_VEC4;case ii.MAT2:return t.FLOAT_MAT2;case ii.MAT3:return t.FLOAT_MAT3;case ii.MAT4:return t.FLOAT_MAT4;case ii.SAMPLER2D:return t.SAMPLER_2D;case ii.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),ii.UNKNOWN}}function d3(e){switch(e){case ii.BOOL:case ii.BOOL2:case ii.BOOL3:case ii.BOOL4:case ii.INT:case ii.INT2:case ii.INT3:case ii.INT4:case ii.UINT:return Int32Array;case ii.FLOAT:case ii.FLOAT2:case ii.FLOAT3:case ii.FLOAT4:case ii.MAT2:case ii.MAT3:case ii.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function p3(e,t){switch(e){case t.BOOL:return ii.BOOL;case t.BOOL_VEC2:return ii.BOOL2;case t.BOOL_VEC3:return ii.BOOL3;case t.BOOL_VEC4:return ii.BOOL4;case t.INT:return ii.INT;case t.INT_VEC2:return ii.INT2;case t.INT_VEC3:return ii.INT3;case t.INT_VEC4:return ii.INT4;case t.UNSIGNED_INT:return ii.UINT;case t.FLOAT:return ii.FLOAT;case t.FLOAT_VEC2:return ii.FLOAT2;case t.FLOAT_VEC3:return ii.FLOAT3;case t.FLOAT_VEC4:return ii.FLOAT4;case t.FLOAT_MAT2:return ii.MAT2;case t.FLOAT_MAT3:return ii.MAT3;case t.FLOAT_MAT4:return ii.MAT4;case t.SAMPLER_2D:return ii.SAMPLER2D;case t.SAMPLER_CUBE:return ii.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),ii.UNKNOWN}}function m3(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function v3(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}h3._instance=null;var g3,y3=[512,513,514,515,516,517,518,519],x3=[0,7680,7681,7682,7683,5386,34055,34056],S3=[32774,32778,32779,32775,32776],T3=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(g3||(g3={}));var E3=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},C3=function(e){function t(){var t;return(t=e.call(this,g3.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new Hi,t.clearFlag=Bi.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return u(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(E3),A3=function(e){function t(){var t;return(t=e.call(this,g3.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new Ur,t}return u(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(E3),b3=function(e){function t(){var t;return(t=e.call(this,g3.DRAW)||this).drawInfo=new nr,t}return u(t,e),t.prototype.clear=function(){},t}(E3),P3=function(e){function t(){var t;return(t=e.call(this,g3.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return u(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(E3),R3=function(e){function t(){var t;return(t=e.call(this,g3.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return u(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(E3),w3=function(){function e(){this.cmds=new wl(1),this.beginRenderPassCmds=new wl(1),this.bindStatesCmds=new wl(1),this.drawCmds=new wl(1),this.updateBufferCmds=new wl(1),this.copyBufferToTextureCmds=new wl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function I3(e,t,n,i,r){if(t.usage&ri.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&ri.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),D3.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),D3.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var D3={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function O3(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=t.colorAttachments[h];if(_.format!==ti.UNKNOWN)switch(_.loadOp){case Si.LOAD:break;case Si.CLEAR:c.bs.targets[0].blendColorMask!==yi.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case Si.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==ti.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Si.LOAD:break;case Si.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Si.DISCARD:}if(Gr[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Si.LOAD:break;case Si.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Si.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var d=c.bs.targets[0].blendColorMask;if(d!==yi.ALL){var p=(d&yi.R)!==yi.NONE,m=(d&yi.G)!==yi.NONE,v=(d&yi.B)!==yi.NONE,g=(d&yi.A)!==yi.NONE;s.colorMask(p,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function M3(e,t,n,i,r,o){var a,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,_=!1;if(t&&D3.gpuPipelineState!==t){if(D3.gpuPipelineState=t,D3.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var d=t.rs;if(d){if(u.rs.cullMode!==d.cullMode){switch(d.cullMode){case wi.NONE:l.disable(l.CULL_FACE);break;case wi.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case wi.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=d.cullMode}var p=d.isFrontFaceCCW;u.rs.isFrontFaceCCW!==p&&(l.frontFace(p?l.CCW:l.CW),u.rs.isFrontFaceCCW=p),u.rs.depthBias===d.depthBias&&u.rs.depthBiasSlop===d.depthBiasSlop||(l.polygonOffset(d.depthBias,d.depthBiasSlop),u.rs.depthBias=d.depthBias,u.rs.depthBiasSlop=d.depthBiasSlop),u.rs.lineWidth!==d.lineWidth&&(l.lineWidth(d.lineWidth),u.rs.lineWidth=d.lineWidth)}var m=t.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(y3[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,y3[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,x3[m.stencilFailOpFront],x3[m.stencilZFailOpFront],x3[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,y3[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,x3[m.stencilFailOpBack],x3[m.stencilZFailOpBack],x3[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=t.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(S3[g.blendEq],S3[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(T3[g.blendSrc],T3[g.blendDst],T3[g.blendSrcAlpha],T3[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&yi.R)!==yi.NONE,(g.blendColorMask&yi.G)!==yi.NONE,(g.blendColorMask&yi.B)!==yi.NONE,(g.blendColorMask&yi.A)!==yi.NONE),y.blendColorMask=g.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var x=h.glBlocks.length,S=t.gpuPipelineLayout.dynamicOffsetIndices,T=0;T<x;T++){var E=h.glBlocks[T],C=i[E.set],A=C&&C.descriptorIndices[E.binding],b=A>=0&&C.gpuDescriptors[A],P=null,R=0;if(b&&b.gpuBuffer){var w=b.gpuBuffer,I=S[E.set],D=I&&I[E.binding];D>=0&&(R=r[D]),"vf32"in w?P=w.vf32:(R+=w.offset,P=w.gpuBuffer.vf32),R>>=2}if(P)for(var O=E.glActiveUniforms.length,M=0;M<O;M++){var L=E.glActiveUniforms[M];switch(L.glType){case l.BOOL:case l.INT:for(var B=0;B<L.array.length;++B){var F=L.offset+R+B;if(P[F]!==L.array[B]){for(var z=B,U=F;z<L.array.length;++z,++U)L.array[z]=P[U];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<L.array.length;++k){var G=L.offset+R+k;if(P[G]!==L.array[k]){for(var H=k,V=G;H<L.array.length;++H,++V)L.array[H]=P[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<L.array.length;++j){var W=L.offset+R+j;if(P[W]!==L.array[j]){for(var q=j,X=W;q<L.array.length;++q,++X)L.array[q]=P[X];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+R+Y;if(P[K]!==L.array[Y]){for(var Q=Y,Z=K;Q<L.array.length;++Q,++Z)L.array[Q]=P[Z];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var J=0;J<L.array.length;++J){var $=L.offset+R+J;if(P[$]!==L.array[J]){for(var ee=J,te=$;ee<L.array.length;++ee,++te)L.array[ee]=P[te];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<L.array.length;++ne){var ie=L.offset+R+ne;if(P[ie]!==L.array[ne]){for(var re=ne,oe=ie;re<L.array.length;++re,++oe)L.array[re]=P[oe];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var ae=0;ae<L.array.length;++ae){var se=L.offset+R+ae;if(P[se]!==L.array[ae]){for(var ce=ae,le=se;ce<L.array.length;++ce,++le)L.array[ce]=P[le];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<L.array.length;++ue){var he=L.offset+R+ue;if(P[he]!==L.array[ue]){for(var _e=ue,fe=he;_e<L.array.length;++_e,++fe)L.array[_e]=P[fe];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var de=0;de<L.array.length;++de){var pe=L.offset+R+de;if(P[pe]!==L.array[de]){for(var me=de,ve=pe;me<L.array.length;++me,++ve)L.array[me]=P[ve];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<L.array.length;++ge){var ye=L.offset+R+ge;if(P[ye]!==L.array[ge]){for(var xe=ge,Se=ye;xe<L.array.length;++xe,++Se)L.array[xe]=P[Se];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var Te=0;Te<L.array.length;++Te){var Ee=L.offset+R+Te;if(P[Ee]!==L.array[Te]){for(var Ce=Te,Ae=Ee;Ce<L.array.length;++Ce,++Ae)L.array[Ce]=P[Ae];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else N("Buffer binding '"+E.name+"' at set "+E.set+" binding "+E.binding+" is not bounded")}for(var be=h.glSamplerTextures.length,Pe=0;Pe<be;Pe++)for(var Re=h.glSamplerTextures[Pe],we=i[Re.set],Ie=we&&we.descriptorIndices[Re.binding],De=Ie>=0&&we.gpuDescriptors[Ie],Oe=Re.units.length,Me=0;Me<Oe;Me++){var Ne=Re.units[Me];if(De&&De.gpuSampler){if(De.gpuTexture&&De.gpuTexture.size>0){var Le=De.gpuTexture,Be=u.glTexUnits[Ne];Be.glTexture!==Le.glTexture&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),Le.glTexture?l.bindTexture(Le.glTarget,Le.glTexture):l.bindTexture(Le.glTarget,e.nullTex2D.gpuTexture.glTexture),Be.glTexture=Le.glTexture);var Fe=De.gpuSampler;Le.isPowerOf2?(a=Fe.glWrapS,s=Fe.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Le.isPowerOf2?Le.mipLevel<=1&&(Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Fe.glMinFilter:Fe.glMinFilter===l.LINEAR||Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Le.glWrapS!==a&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_S,a),Le.glWrapS=a),Le.glWrapT!==s&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_T,s),Le.glWrapT=s),Le.glMinFilter!==c&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_MIN_FILTER,c),Le.glMinFilter=c),Le.glMagFilter!==Fe.glMagFilter&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_MAG_FILTER,Fe.glMagFilter),Le.glMagFilter=Fe.glMagFilter)}De=we.gpuDescriptors[++Ie]}else N("Sampler binding '"+Re.name+"' at set "+Re.set+" binding "+Re.binding+" index "+Me+" is not bounded")}}if(n&&h&&(_||D3.gpuInputAssembler!==n)){D3.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ue=e.extensions.OES_vertex_array_object,ke=n.glVAOs.get(h.glProgram);if(!ke){var Ge;ke=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,ke),Ue.bindVertexArrayOES(ke),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var je=h.glInputs[Ve];Ge=null;for(var We=n.glAttribs.length,qe=0;qe<We;qe++){var Xe=n.glAttribs[qe];if(Xe.name===je.name){Ge=Xe;break}}if(Ge){u.glArrayBuffer!==Ge.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ge.glBuffer),u.glArrayBuffer=Ge.glBuffer);for(var Ye=0;Ye<Ge.componentCount;++Ye){var Ke=je.glLoc+Ye,Qe=Ge.offset+Ge.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,Ge.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==ke&&(Ue.bindVertexArrayOES(ke),u.glVAO=ke)}else{for(var Je=0;Je<e.capabilities.maxVertexAttributes;++Je)u.glCurrentAttribLocs[Je]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var ot=n.glAttribs[rt];if(ot.name===tt.name){nt=ot;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var at=0;at<nt.componentCount;++at){var st=tt.glLoc+at,ct=nt.offset+nt.size*at;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,_t=0;_t<ht;_t++)switch(t.dynamicStates[_t]){case Ii.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Ii.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Ii.BLEND_CONSTANTS:var ft=o.blendConstant;u.bs.blendColor.x===ft.x&&u.bs.blendColor.y===ft.y&&u.bs.blendColor.z===ft.z&&u.bs.blendColor.w===ft.w||(l.blendColor(ft.x,ft.y,ft.z,ft.w),u.bs.blendColor.copy(ft));break;case Ii.STENCIL_WRITE_MASK:var dt=o.stencilStatesFront,pt=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==dt.writeMask&&(l.stencilMaskSeparate(l.FRONT,dt.writeMask),u.dss.stencilWriteMaskFront=dt.writeMask),u.dss.stencilWriteMaskBack!==pt.writeMask&&(l.stencilMaskSeparate(l.BACK,pt.writeMask),u.dss.stencilWriteMaskBack=pt.writeMask);break;case Ii.STENCIL_COMPARE_MASK:var mt=o.stencilStatesFront,vt=o.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,y3[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,y3[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function N3(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=D3.gpuInputAssembler,s=D3.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var f=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,a.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var d=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,a.glIndexType,d)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var L3=new Array(g3.COUNT);function B3(e,t){L3.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=L3[i]++;switch(i){case g3.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];O3(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case g3.BIND_STATES:var a=t.bindStatesCmds.array[r];M3(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case g3.DRAW:N3(e,t.drawCmds.array[r].drawInfo);break;case g3.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];I3(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case g3.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];F3(e,c.buffers,c.gpuTexture,c.regions)}}}function F3(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Gr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt===l3.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[a++];u?n.glInternalFmt===l3.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&ui.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var z3=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=r(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),U3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&ri.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new z3,glTarget:0,glBuffer:null},this._usage&ri.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&si.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&ri.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),D3.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&ri.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),D3.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&ri.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&ri.INDIRECT||t.usage&ri.TRANSFER_DST||t.usage&ri.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(h3.instance,this._gpuBuffer),h3.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),D3.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),D3.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(h3.instance,this._gpuBuffer),h3.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&si.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&ri.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),D3.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&ri.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),D3.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&ri.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&ri.INDIRECT||t.usage&ri.TRANSFER_DST||t.usage&ri.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(h3.instance,this._gpuBuffer),h3.instance.memoryStatus.bufferSize-=t,h3.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&ri.INDIRECT?0:e.byteLength,I3(h3.instance,this._gpuBuffer,e,0,n))},c(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(Jr),k3=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new wl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),G3=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new k3(C3,1),this.bindStatesCmdPool=new k3(A3,1),this.drawCmdPool=new k3(b3,1),this.updateBufferCmdPool=new k3(P3,1),this.copyBufferToTextureCmdPool=new k3(R3,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),H3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new w3,t._cmdAllocator=new G3,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new Ur,t._isStateInvalied=!1,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=h3.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(C3);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(g3.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Di.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Di.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Di.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Di.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Li.PRIMARY&&this._isInRenderPass||this._type===Li.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(b3);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(g3.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Li.PRIMARY&&!this._isInRenderPass||this._type===Li.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(P3),a=0;e.usage&ri.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(g3.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Li.PRIMARY&&!this._isInRenderPass||this._type===Li.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(R3);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(g3.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(A3);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(g3.BIND_STATES),this._isStateInvalied=!1)},t}($r),V3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;++n){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=Gr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(h3.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=h3.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},c(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(no),j3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=_3(o.format,n),l=Gr[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Gr[o.format].count,stride:s.stride,componentCount:v3(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(h3.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=h3.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.extensions.OES_vertex_array_object,o=e.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();e.stateCache.glVAO=o,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},c(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(ao),W3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&jr)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},c(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(co),q3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},c(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(lo),X3=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],Y3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:X3[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},c(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(mo),K3=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){O3(h3.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;N3(h3.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=h3.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=h3.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&ri.INDIRECT?0:t.byteLength,I3(h3.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&F3(h3.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];B3(h3.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){M3(h3.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(H3),Q3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(vo),Z3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},c(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(go),J3=[10497,33648,33071,33071],$3=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===fi.LINEAR||a===fi.ANISOTROPIC?c===fi.LINEAR||c===fi.ANISOTROPIC?9987:c===fi.POINT?9985:9729:c===fi.LINEAR||c===fi.ANISOTROPIC?9986:c===fi.POINT?9984:9728,o=s===fi.LINEAR||s===fi.ANISOTROPIC?9729:9728;var l=J3[i._info.addressU],u=J3[i._info.addressV],h=J3[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return u(t,e),c(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(yo),e5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case xi.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case xi.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));B("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(t.glProgram,d),v=p3(f.type,n),g=m3(f.type,n);t.glInputs[_]={binding:m,name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var y=0;y<t.blocks.length;++y){var x=t.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};t.glBlocks[y]=S;for(var T=0;T<x.members.length;++T){var E=x.members[T],C=f3(E.type,n),A=m3(C,n),b=A*E.count;S.glUniforms[T]={binding:-1,name:E.name,type:E.type,stride:A,count:E.count,size:b,offset:0,glType:C,glLoc:null,array:null}}}}for(var P=0;P<t.subpassInputs.length;++P){var R=t.subpassInputs[P];t.samplerTextures.push(new ur(R.set,R.binding,R.name,ii.SAMPLER2D,R.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var w=0;w<t.samplerTextures.length;++w){var I=t.samplerTextures[w];t.glSamplerTextures[w]={set:I.set,binding:I.binding,name:I.name,type:I.type,count:I.count,units:[],glUnits:null,glType:f3(I.type,n),glLoc:null}}}for(var D=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),O=0;O<D;++O){var M=n.getActiveUniform(t.glProgram,O);if(M&&M.type!==n.SAMPLER_2D&&M.type!==n.SAMPLER_CUBE){var N=n.getUniformLocation(t.glProgram,M.name);if(e.extensions.isLocationActive(N)){var L,F=M.name.indexOf("[");L=-1!==F?M.name.substr(0,F):M.name;for(var z=0;z<t.glBlocks.length;z++)for(var U=t.glBlocks[z],k=0;k<U.glUniforms.length;k++){var G=U.glUniforms[k];if(G.name===L){G.glLoc=N,G.count=M.size,G.size=G.stride*G.count,G.array=new(d3(G.type))(G.size/4),U.glActiveUniforms.push(G);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],j=0;j<V.glUniforms.length;j++){var W=V.glUniforms[j];W.offset=V.size/4,V.size+=W.size}for(var q=[],X=[],Y=e.bindingMappingInfo,K=e.stateCache.texUnitCacheMap,Q=0,Z=0;Z<t.blocks.length;++Z)t.blocks[Z].set===Y.flexibleSet&&Q++;for(var J=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(q.push(t.glSamplerTextures[$]),X.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerOffsets[ee.set]+J;ee.set===Y.flexibleSet&&(ne-=Q),K[ee.name]=ne%e.capabilities.maxTextureUnits,J+=ee.count-1}}if(q.length){for(var ie=[],re=0;re<q.length;++re){var oe=q[re],ae=K[oe.name];if(void 0!==ae){oe.glLoc=X[re];for(var se=0;se<oe.count;++se){for(;ie[ae];)ae=(ae+1)%e.capabilities.maxTextureUnits;oe.units.push(ae),ie[ae]=!0}}}for(var ce=0,le=0;le<q.length;++le){var ue=q[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=X[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var _e=0;_e<q.length;_e++){var fe=q[_e];fe.glUnits=new Int32Array(fe.units),n.uniform1iv(fe.glLoc,fe.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var de=0;de<t.glBlocks.length;)t.glBlocks[de].glActiveUniforms.length?de++:(t.glBlocks[de]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}(h3.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(h3.instance,this._gpuShader),this._gpuShader=null)},c(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(xo),t5=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new Ki,this.scissorRect=new Hi(0,0,0,0),this.rs=new uo,this.dss=new ho,this.bs=new fo,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),n5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=Wr(this._width)&&Wr(this._height),this._size=Xr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case ti.A8:return t.ALPHA;case ti.L8:return t.LUMINANCE;case ti.LA8:return t.LUMINANCE_ALPHA;case ti.RGB8:case ti.RGB16F:case ti.RGB32F:return t.RGB;case ti.BGRA8:case ti.RGBA8:case ti.SRGB8_A8:case ti.RGBA16F:case ti.RGBA32F:return t.RGBA;case ti.R5G6B5:return t.RGB;case ti.RGB5A1:case ti.RGBA4:return t.RGBA;case ti.DEPTH:return t.DEPTH_COMPONENT;case ti.DEPTH_STENCIL:return t.DEPTH_STENCIL;case ti.BC1:return l3.COMPRESSED_RGB_S3TC_DXT1_EXT;case ti.BC1_ALPHA:return l3.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ti.BC1_SRGB:return l3.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ti.BC1_SRGB_ALPHA:return l3.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ti.BC2:return l3.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ti.BC2_SRGB:return l3.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ti.BC3:return l3.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ti.BC3_SRGB:return l3.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ti.ETC_RGB8:return l3.COMPRESSED_RGB_ETC1_WEBGL;case ti.ETC2_RGB8:return l3.COMPRESSED_RGB8_ETC2;case ti.ETC2_SRGB8:return l3.COMPRESSED_SRGB8_ETC2;case ti.ETC2_RGB8_A1:return l3.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ti.ETC2_SRGB8_A1:return l3.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ti.ETC2_RGBA8:return l3.COMPRESSED_RGBA8_ETC2_EAC;case ti.ETC2_SRGB8_A8:return l3.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ti.EAC_R11:return l3.COMPRESSED_R11_EAC;case ti.EAC_R11SN:return l3.COMPRESSED_SIGNED_R11_EAC;case ti.EAC_RG11:return l3.COMPRESSED_RG11_EAC;case ti.EAC_RG11SN:return l3.COMPRESSED_SIGNED_RG11_EAC;case ti.PVRTC_RGB2:return l3.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ti.PVRTC_RGBA2:return l3.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ti.PVRTC_RGB4:return l3.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ti.PVRTC_RGBA4:return l3.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case ti.ASTC_RGBA_4X4:return l3.COMPRESSED_RGBA_ASTC_4x4_KHR;case ti.ASTC_RGBA_5X4:return l3.COMPRESSED_RGBA_ASTC_5x4_KHR;case ti.ASTC_RGBA_5X5:return l3.COMPRESSED_RGBA_ASTC_5x5_KHR;case ti.ASTC_RGBA_6X5:return l3.COMPRESSED_RGBA_ASTC_6x5_KHR;case ti.ASTC_RGBA_6X6:return l3.COMPRESSED_RGBA_ASTC_6x6_KHR;case ti.ASTC_RGBA_8X5:return l3.COMPRESSED_RGBA_ASTC_8x5_KHR;case ti.ASTC_RGBA_8X6:return l3.COMPRESSED_RGBA_ASTC_8x6_KHR;case ti.ASTC_RGBA_8X8:return l3.COMPRESSED_RGBA_ASTC_8x8_KHR;case ti.ASTC_RGBA_10X5:return l3.COMPRESSED_RGBA_ASTC_10x5_KHR;case ti.ASTC_RGBA_10X6:return l3.COMPRESSED_RGBA_ASTC_10x6_KHR;case ti.ASTC_RGBA_10X8:return l3.COMPRESSED_RGBA_ASTC_10x8_KHR;case ti.ASTC_RGBA_10X10:return l3.COMPRESSED_RGBA_ASTC_10x10_KHR;case ti.ASTC_RGBA_12X10:return l3.COMPRESSED_RGBA_ASTC_12x10_KHR;case ti.ASTC_RGBA_12X12:return l3.COMPRESSED_RGBA_ASTC_12x12_KHR;case ti.ASTC_SRGBA_4X4:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case ti.ASTC_SRGBA_5X4:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case ti.ASTC_SRGBA_5X5:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case ti.ASTC_SRGBA_6X5:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case ti.ASTC_SRGBA_6X6:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case ti.ASTC_SRGBA_8X5:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case ti.ASTC_SRGBA_8X6:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case ti.ASTC_SRGBA_8X8:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case ti.ASTC_SRGBA_10X5:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case ti.ASTC_SRGBA_10X6:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case ti.ASTC_SRGBA_10X8:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case ti.ASTC_SRGBA_10X10:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case ti.ASTC_SRGBA_12X10:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case ti.ASTC_SRGBA_12X12:return l3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=_3(t.format,n);var i=t.width,r=t.height;switch(t.type){case ci.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&W(9100,o,e.capabilities.maxTextureSize),!e.extensions.WEBGL_depth_texture&&Gr[t.format].hasDepth)t.glInternalFmt=function(e,t){switch(e){case ti.R5G6B5:return t.RGB565;case ti.RGB5A1:return t.RGB5_A1;case ti.RGBA4:return t.RGBA4;case ti.RGBA16F:return l3.RGBA16F_EXT;case ti.RGBA32F:return l3.RGBA32F_EXT;case ti.SRGB8_A8:return l3.SRGB8_ALPHA8_EXT;case ti.DEPTH:return t.DEPTH_COMPONENT16;case ti.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));else if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),Gr[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=qr(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;case ci.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&W(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),Gr[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=qr(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=ci.TEX2D,t.glTarget=n.TEXTURE_2D}}(h3.instance,this._gpuTexture),h3.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(function(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(t.glTarget,null),i[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}(h3.instance,this._gpuTexture),h3.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=Xr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case ci.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&W(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),Gr[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=qr(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case ci.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&W(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),Gr[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=qr(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=ci.TEX2D,t.glTarget=n.TEXTURE_2D}}}(h3.instance,this._gpuTexture),h3.instance.memoryStatus.textureSize-=n,h3.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new or;t.format=e.format,t.usage=Gr[e.format].hasDepth?li.DEPTH_STENCIL_ATTACHMENT:li.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},c(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(So),i5="webglcontextlost";function r5(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function o5(e){var t={EXT_texture_filter_anisotropic:r5(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:r5(e,"EXT_blend_minmax"),EXT_frag_depth:r5(e,"EXT_frag_depth"),EXT_shader_texture_lod:r5(e,"EXT_shader_texture_lod"),EXT_sRGB:r5(e,"EXT_sRGB"),OES_vertex_array_object:r5(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:r5(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:r5(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:r5(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:r5(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:r5(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:r5(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:r5(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:r5(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:r5(e,"WEBGL_draw_buffers"),WEBGL_lose_context:r5(e,"WEBGL_lose_context"),WEBGL_depth_texture:r5(e,"WEBGL_depth_texture"),OES_texture_half_float:r5(e,"OES_texture_half_float"),OES_texture_half_float_linear:r5(e,"OES_texture_half_float_linear"),OES_texture_float:r5(e,"OES_texture_float"),OES_texture_float_linear:r5(e,"OES_texture_float_linear"),OES_standard_derivatives:r5(e,"OES_standard_derivatives"),OES_element_index_uint:r5(e,"OES_element_index_uint"),ANGLE_instanced_arrays:r5(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:r5(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return Jl.os===Vl.IOS&&14===Jl.osMainVersion&&Jl.isBrowser||(t.WEBGL_compressed_texture_astc=r5(e,"WEBGL_compressed_texture_astc")),Jl.os!==Vl.ANDROID&&Jl.os!==Vl.IOS&&(t.WEBGL_multi_draw=r5(e,"WEBGL_multi_draw")),Jl.browserType===kl.UC&&(t.ANGLE_instanced_arrays=null),Jl.os===Vl.IOS&&Jl.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var a5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new t5,t.cmdAllocator=new G3,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(i5,this._onWebGLContextLost);var t=h3.instance.gl;this.stateCache.initialize(h3.instance.capabilities.maxTextureUnits,h3.instance.capabilities.maxVertexAttributes),this._extensions=o5(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=ti.RGBA8,i=ti.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=ti.DEPTH_STENCIL:r&&(i=ti.DEPTH),this._colorTexture=new n5,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new n5,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=h3.instance.createTexture(new or(ci.TEX2D,li.SAMPLED,ti.RGBA8,2,2,ui.GEN_MIPMAP)),this.nullTexCube=h3.instance.createTexture(new or(ci.CUBE,li.SAMPLED,ti.RGBA8,2,2,ui.GEN_MIPMAP,6));var a=new Yi;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),h3.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,h3.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(i5,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(B("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){V(11e3),M(e)},c(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(to),s5=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){h3.setInstance(this),this._gfxAPI=Jn.WEBGL,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:$e.ENABLE_TRANSPARENT_CANVAS,antialias:$e.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(eo.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Nr(Mi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Mr(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=t.getSupportedExtensions(),i="";if(n)for(var r,o=g(n);!(r=o()).done;)i+=r.value+" ";var a=o5(t);a.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[ei.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[ei.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[ei.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[ei.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[ei.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[ei.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[ei.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[ei.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[ei.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[ei.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[ei.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[ei.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[ei.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[ei.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[ei.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[ei.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[ei.FORMAT_ASTC]=!0,c+="astc "),B("WebGL device initialized."),B("RENDERER: "+this._renderer),B("VENDOR: "+this._vendor),B("VERSION: "+s),B("COMPRESSED_FORMAT: "+c),B("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===Li.PRIMARY?K3:H3);return t.initialize(e),t},n.createSwapchain=function(e){var t=new a5;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new U3;return t.initialize(e),t},n.createTexture=function(e){var t=new n5;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new u3;return t.initialize(e),t},n.createShader=function(e){var t=new e5;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new j3;return t.initialize(e),t},n.createRenderPass=function(e){var t=new Z3;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new V3;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new W3;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new q3;return t.initialize(e),t},n.createPipelineState=function(e){var t=new Y3;return t.initialize(e),t},n.createQueue=function(e){var t=new Q3;return t.initialize(e),t},n.getSampler=function(e){var t=yo.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new $3(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=To.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new To(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Eo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Eo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){F3(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&ui.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},c(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(eo));T.WebGLDevice=s5;var c5,l5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&Hr?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&Vr&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},c(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(so);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(c5||(c5={}));var u5=function(){function e(){}return e.setInstance=function(t){e._instance=t},c(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();u5._instance=null;var h5=[10497,33648,33071,33071],_5=new Float32Array(4);function f5(e,t){switch(e){case ti.R8:return t.UNSIGNED_BYTE;case ti.R8SN:return t.BYTE;case ti.R8UI:return t.UNSIGNED_BYTE;case ti.R8I:return t.BYTE;case ti.R16F:return t.HALF_FLOAT;case ti.R16UI:return t.UNSIGNED_SHORT;case ti.R16I:return t.SHORT;case ti.R32F:return t.FLOAT;case ti.R32UI:return t.UNSIGNED_INT;case ti.R32I:return t.INT;case ti.RG8:return t.UNSIGNED_BYTE;case ti.RG8SN:return t.BYTE;case ti.RG8UI:return t.UNSIGNED_BYTE;case ti.RG8I:return t.BYTE;case ti.RG16F:return t.HALF_FLOAT;case ti.RG16UI:return t.UNSIGNED_SHORT;case ti.RG16I:return t.SHORT;case ti.RG32F:return t.FLOAT;case ti.RG32UI:return t.UNSIGNED_INT;case ti.RG32I:return t.INT;case ti.RGB8:case ti.SRGB8:return t.UNSIGNED_BYTE;case ti.RGB8SN:return t.BYTE;case ti.RGB8UI:return t.UNSIGNED_BYTE;case ti.RGB8I:return t.BYTE;case ti.RGB16F:return t.HALF_FLOAT;case ti.RGB16UI:return t.UNSIGNED_SHORT;case ti.RGB16I:return t.SHORT;case ti.RGB32F:return t.FLOAT;case ti.RGB32UI:return t.UNSIGNED_INT;case ti.RGB32I:return t.INT;case ti.BGRA8:case ti.RGBA8:case ti.SRGB8_A8:return t.UNSIGNED_BYTE;case ti.RGBA8SN:return t.BYTE;case ti.RGBA8UI:return t.UNSIGNED_BYTE;case ti.RGBA8I:return t.BYTE;case ti.RGBA16F:return t.HALF_FLOAT;case ti.RGBA16UI:return t.UNSIGNED_SHORT;case ti.RGBA16I:return t.SHORT;case ti.RGBA32F:return t.FLOAT;case ti.RGBA32UI:return t.UNSIGNED_INT;case ti.RGBA32I:return t.INT;case ti.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case ti.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case ti.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case ti.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case ti.RGB10A2:case ti.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case ti.RGB9E5:case ti.DEPTH:return t.FLOAT;case ti.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case ti.BC1:case ti.BC1_SRGB:case ti.BC2:case ti.BC2_SRGB:case ti.BC3:case ti.BC3_SRGB:case ti.BC4:return t.UNSIGNED_BYTE;case ti.BC4_SNORM:return t.BYTE;case ti.BC5:return t.UNSIGNED_BYTE;case ti.BC5_SNORM:return t.BYTE;case ti.BC6H_SF16:case ti.BC6H_UF16:return t.FLOAT;case ti.BC7:case ti.BC7_SRGB:case ti.ETC_RGB8:case ti.ETC2_RGB8:case ti.ETC2_SRGB8:case ti.ETC2_RGB8_A1:case ti.ETC2_SRGB8_A1:case ti.EAC_R11:return t.UNSIGNED_BYTE;case ti.EAC_R11SN:return t.BYTE;case ti.EAC_RG11:return t.UNSIGNED_BYTE;case ti.EAC_RG11SN:return t.BYTE;case ti.PVRTC_RGB2:case ti.PVRTC_RGBA2:case ti.PVRTC_RGB4:case ti.PVRTC_RGBA4:case ti.PVRTC2_2BPP:case ti.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case ti.ASTC_RGBA_4X4:case ti.ASTC_RGBA_5X4:case ti.ASTC_RGBA_5X5:case ti.ASTC_RGBA_6X5:case ti.ASTC_RGBA_6X6:case ti.ASTC_RGBA_8X5:case ti.ASTC_RGBA_8X6:case ti.ASTC_RGBA_8X8:case ti.ASTC_RGBA_10X5:case ti.ASTC_RGBA_10X6:case ti.ASTC_RGBA_10X8:case ti.ASTC_RGBA_10X10:case ti.ASTC_RGBA_12X10:case ti.ASTC_RGBA_12X12:case ti.ASTC_SRGBA_4X4:case ti.ASTC_SRGBA_5X4:case ti.ASTC_SRGBA_5X5:case ti.ASTC_SRGBA_6X5:case ti.ASTC_SRGBA_6X6:case ti.ASTC_SRGBA_8X5:case ti.ASTC_SRGBA_8X6:case ti.ASTC_SRGBA_8X8:case ti.ASTC_SRGBA_10X5:case ti.ASTC_SRGBA_10X6:case ti.ASTC_SRGBA_10X8:case ti.ASTC_SRGBA_10X10:case ti.ASTC_SRGBA_12X10:case ti.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function d5(e,t){switch(e){case ii.BOOL:return t.BOOL;case ii.BOOL2:return t.BOOL_VEC2;case ii.BOOL3:return t.BOOL_VEC3;case ii.BOOL4:return t.BOOL_VEC4;case ii.INT:return t.INT;case ii.INT2:return t.INT_VEC2;case ii.INT3:return t.INT_VEC3;case ii.INT4:return t.INT_VEC4;case ii.UINT:return t.UNSIGNED_INT;case ii.FLOAT:return t.FLOAT;case ii.FLOAT2:return t.FLOAT_VEC2;case ii.FLOAT3:return t.FLOAT_VEC3;case ii.FLOAT4:return t.FLOAT_VEC4;case ii.MAT2:return t.FLOAT_MAT2;case ii.MAT2X3:return t.FLOAT_MAT2x3;case ii.MAT2X4:return t.FLOAT_MAT2x4;case ii.MAT3X2:return t.FLOAT_MAT3x2;case ii.MAT3:return t.FLOAT_MAT3;case ii.MAT3X4:return t.FLOAT_MAT3x4;case ii.MAT4X2:return t.FLOAT_MAT4x2;case ii.MAT4X3:return t.FLOAT_MAT4x3;case ii.MAT4:return t.FLOAT_MAT4;case ii.SAMPLER2D:return t.SAMPLER_2D;case ii.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case ii.SAMPLER3D:return t.SAMPLER_3D;case ii.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),ii.UNKNOWN}}function p5(e,t){switch(e){case t.BOOL:return ii.BOOL;case t.BOOL_VEC2:return ii.BOOL2;case t.BOOL_VEC3:return ii.BOOL3;case t.BOOL_VEC4:return ii.BOOL4;case t.INT:return ii.INT;case t.INT_VEC2:return ii.INT2;case t.INT_VEC3:return ii.INT3;case t.INT_VEC4:return ii.INT4;case t.UNSIGNED_INT:return ii.UINT;case t.UNSIGNED_INT_VEC2:return ii.UINT2;case t.UNSIGNED_INT_VEC3:return ii.UINT3;case t.UNSIGNED_INT_VEC4:return ii.UINT4;case t.FLOAT:return ii.FLOAT;case t.FLOAT_VEC2:return ii.FLOAT2;case t.FLOAT_VEC3:return ii.FLOAT3;case t.FLOAT_VEC4:return ii.FLOAT4;case t.FLOAT_MAT2:return ii.MAT2;case t.FLOAT_MAT2x3:return ii.MAT2X3;case t.FLOAT_MAT2x4:return ii.MAT2X4;case t.FLOAT_MAT3x2:return ii.MAT3X2;case t.FLOAT_MAT3:return ii.MAT3;case t.FLOAT_MAT3x4:return ii.MAT3X4;case t.FLOAT_MAT4x2:return ii.MAT4X2;case t.FLOAT_MAT4x3:return ii.MAT4X3;case t.FLOAT_MAT4:return ii.MAT4;case t.SAMPLER_2D:return ii.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return ii.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return ii.SAMPLER3D;case t.SAMPLER_CUBE:return ii.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),ii.UNKNOWN}}function m5(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function v5(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var g5,y5=[512,513,514,515,516,517,518,519],x5=[0,7680,7681,7682,7683,5386,34055,34056],S5=[32774,32778,32779,32775,32776],T5=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(g5||(g5={}));var E5=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},C5=function(e){function t(){var t;return(t=e.call(this,g5.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new Hi,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return u(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(E5),A5=function(e){function t(){var t;return(t=e.call(this,g5.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new Ur,t}return u(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},t}(E5),b5=function(e){function t(){var t;return(t=e.call(this,g5.DRAW)||this).drawInfo=new nr,t}return u(t,e),t.prototype.clear=function(){},t}(E5),P5=function(e){function t(){var t;return(t=e.call(this,g5.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return u(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(E5),R5=function(e){function t(){var t;return(t=e.call(this,g5.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return u(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(E5),w5=function(){function e(){this.cmds=new wl(1),this.beginRenderPassCmds=new wl(1),this.bindStatesCmds=new wl(1),this.drawCmds=new wl(1),this.updateBufferCmds=new wl(1),this.copyBufferToTextureCmds=new wl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function I5(e,t,n,i,r){if(t.usage&ri.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),M5.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),M5.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function D5(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case ti.A8:return t.ALPHA;case ti.L8:return t.LUMINANCE;case ti.LA8:return t.LUMINANCE_ALPHA;case ti.R8:return t.R8;case ti.R8SN:return t.R8_SNORM;case ti.R8UI:return t.R8UI;case ti.R8I:return t.R8I;case ti.RG8:return t.RG8;case ti.RG8SN:return t.RG8_SNORM;case ti.RG8UI:return t.RG8UI;case ti.RG8I:return t.RG8I;case ti.RGB8:return t.RGB8;case ti.RGB8SN:return t.RGB8_SNORM;case ti.RGB8UI:return t.RGB8UI;case ti.RGB8I:return t.RGB8I;case ti.BGRA8:case ti.RGBA8:return t.RGBA8;case ti.RGBA8SN:return t.RGBA8_SNORM;case ti.RGBA8UI:return t.RGBA8UI;case ti.RGBA8I:return t.RGBA8I;case ti.R16I:return t.R16I;case ti.R16UI:return t.R16UI;case ti.R16F:return t.R16F;case ti.RG16I:return t.RG16I;case ti.RG16UI:return t.RG16UI;case ti.RG16F:return t.RG16F;case ti.RGB16I:return t.RGB16I;case ti.RGB16UI:return t.RGB16UI;case ti.RGB16F:return t.RGB16F;case ti.RGBA16I:return t.RGBA16I;case ti.RGBA16UI:return t.RGBA16UI;case ti.RGBA16F:return t.RGBA16F;case ti.R32I:return t.R32I;case ti.R32UI:return t.R32UI;case ti.R32F:return t.R32F;case ti.RG32I:return t.RG32I;case ti.RG32UI:return t.RG32UI;case ti.RG32F:return t.RG32F;case ti.RGB32I:return t.RGB32I;case ti.RGB32UI:return t.RGB32UI;case ti.RGB32F:return t.RGB32F;case ti.RGBA32I:return t.RGBA32I;case ti.RGBA32UI:return t.RGBA32UI;case ti.RGBA32F:return t.RGBA32F;case ti.R5G6B5:return t.RGB565;case ti.RGB5A1:return t.RGB5_A1;case ti.RGBA4:return t.RGBA4;case ti.SRGB8:return t.SRGB8;case ti.SRGB8_A8:return t.SRGB8_ALPHA8;case ti.RGB10A2:return t.RGB10_A2;case ti.RGB10A2UI:return t.RGB10_A2UI;case ti.R11G11B10F:return t.R11F_G11F_B10F;case ti.DEPTH:return t.DEPTH_COMPONENT32F;case ti.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case ti.BC1:return c5.COMPRESSED_RGB_S3TC_DXT1_EXT;case ti.BC1_ALPHA:return c5.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ti.BC1_SRGB:return c5.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ti.BC1_SRGB_ALPHA:return c5.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ti.BC2:return c5.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ti.BC2_SRGB:return c5.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ti.BC3:return c5.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ti.BC3_SRGB:return c5.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ti.ETC_RGB8:return c5.COMPRESSED_RGB_ETC1_WEBGL;case ti.ETC2_RGB8:return c5.COMPRESSED_RGB8_ETC2;case ti.ETC2_SRGB8:return c5.COMPRESSED_SRGB8_ETC2;case ti.ETC2_RGB8_A1:return c5.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ti.ETC2_SRGB8_A1:return c5.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ti.ETC2_RGBA8:return c5.COMPRESSED_RGBA8_ETC2_EAC;case ti.ETC2_SRGB8_A8:return c5.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ti.EAC_R11:return c5.COMPRESSED_R11_EAC;case ti.EAC_R11SN:return c5.COMPRESSED_SIGNED_R11_EAC;case ti.EAC_RG11:return c5.COMPRESSED_RG11_EAC;case ti.EAC_RG11SN:return c5.COMPRESSED_SIGNED_RG11_EAC;case ti.PVRTC_RGB2:return c5.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ti.PVRTC_RGBA2:return c5.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ti.PVRTC_RGB4:return c5.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ti.PVRTC_RGBA4:return c5.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case ti.ASTC_RGBA_4X4:return c5.COMPRESSED_RGBA_ASTC_4x4_KHR;case ti.ASTC_RGBA_5X4:return c5.COMPRESSED_RGBA_ASTC_5x4_KHR;case ti.ASTC_RGBA_5X5:return c5.COMPRESSED_RGBA_ASTC_5x5_KHR;case ti.ASTC_RGBA_6X5:return c5.COMPRESSED_RGBA_ASTC_6x5_KHR;case ti.ASTC_RGBA_6X6:return c5.COMPRESSED_RGBA_ASTC_6x6_KHR;case ti.ASTC_RGBA_8X5:return c5.COMPRESSED_RGBA_ASTC_8x5_KHR;case ti.ASTC_RGBA_8X6:return c5.COMPRESSED_RGBA_ASTC_8x6_KHR;case ti.ASTC_RGBA_8X8:return c5.COMPRESSED_RGBA_ASTC_8x8_KHR;case ti.ASTC_RGBA_10X5:return c5.COMPRESSED_RGBA_ASTC_10x5_KHR;case ti.ASTC_RGBA_10X6:return c5.COMPRESSED_RGBA_ASTC_10x6_KHR;case ti.ASTC_RGBA_10X8:return c5.COMPRESSED_RGBA_ASTC_10x8_KHR;case ti.ASTC_RGBA_10X10:return c5.COMPRESSED_RGBA_ASTC_10x10_KHR;case ti.ASTC_RGBA_12X10:return c5.COMPRESSED_RGBA_ASTC_12x10_KHR;case ti.ASTC_RGBA_12X12:return c5.COMPRESSED_RGBA_ASTC_12x12_KHR;case ti.ASTC_SRGBA_4X4:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case ti.ASTC_SRGBA_5X4:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case ti.ASTC_SRGBA_5X5:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case ti.ASTC_SRGBA_6X5:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case ti.ASTC_SRGBA_6X6:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case ti.ASTC_SRGBA_8X5:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case ti.ASTC_SRGBA_8X6:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case ti.ASTC_SRGBA_8X8:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case ti.ASTC_SRGBA_10X5:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case ti.ASTC_SRGBA_10X6:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case ti.ASTC_SRGBA_10X8:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case ti.ASTC_SRGBA_10X10:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case ti.ASTC_SRGBA_12X10:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case ti.ASTC_SRGBA_12X12:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=function(e,t){switch(e){case ti.A8:return t.ALPHA;case ti.L8:return t.LUMINANCE;case ti.LA8:return t.LUMINANCE_ALPHA;case ti.R8:case ti.R8SN:return t.RED;case ti.R8UI:case ti.R8I:return t.RED;case ti.RG8:case ti.RG8SN:case ti.RG8UI:case ti.RG8I:return t.RG;case ti.RGB8:case ti.RGB8SN:case ti.RGB8UI:case ti.RGB8I:return t.RGB;case ti.BGRA8:case ti.RGBA8:case ti.RGBA8SN:case ti.RGBA8UI:case ti.RGBA8I:return t.RGBA;case ti.R16UI:case ti.R16I:case ti.R16F:return t.RED;case ti.RG16UI:case ti.RG16I:case ti.RG16F:return t.RG;case ti.RGB16UI:case ti.RGB16I:case ti.RGB16F:return t.RGB;case ti.RGBA16UI:case ti.RGBA16I:case ti.RGBA16F:return t.RGBA;case ti.R32UI:case ti.R32I:case ti.R32F:return t.RED;case ti.RG32UI:case ti.RG32I:case ti.RG32F:return t.RG;case ti.RGB32UI:case ti.RGB32I:case ti.RGB32F:return t.RGB;case ti.RGBA32UI:case ti.RGBA32I:case ti.RGBA32F:case ti.RGB10A2:return t.RGBA;case ti.R11G11B10F:case ti.R5G6B5:return t.RGB;case ti.RGB5A1:case ti.RGBA4:return t.RGBA;case ti.SRGB8:return t.RGB;case ti.SRGB8_A8:return t.RGBA;case ti.DEPTH:return t.DEPTH_COMPONENT;case ti.DEPTH_STENCIL:return t.DEPTH_STENCIL;case ti.BC1:return c5.COMPRESSED_RGB_S3TC_DXT1_EXT;case ti.BC1_ALPHA:return c5.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ti.BC1_SRGB:return c5.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ti.BC1_SRGB_ALPHA:return c5.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ti.BC2:return c5.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ti.BC2_SRGB:return c5.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ti.BC3:return c5.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ti.BC3_SRGB:return c5.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ti.ETC_RGB8:return c5.COMPRESSED_RGB_ETC1_WEBGL;case ti.ETC2_RGB8:return c5.COMPRESSED_RGB8_ETC2;case ti.ETC2_SRGB8:return c5.COMPRESSED_SRGB8_ETC2;case ti.ETC2_RGB8_A1:return c5.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ti.ETC2_SRGB8_A1:return c5.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ti.ETC2_RGBA8:return c5.COMPRESSED_RGBA8_ETC2_EAC;case ti.ETC2_SRGB8_A8:return c5.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ti.EAC_R11:return c5.COMPRESSED_R11_EAC;case ti.EAC_R11SN:return c5.COMPRESSED_SIGNED_R11_EAC;case ti.EAC_RG11:return c5.COMPRESSED_RG11_EAC;case ti.EAC_RG11SN:return c5.COMPRESSED_SIGNED_RG11_EAC;case ti.PVRTC_RGB2:return c5.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ti.PVRTC_RGBA2:return c5.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ti.PVRTC_RGB4:return c5.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ti.PVRTC_RGBA4:return c5.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case ti.ASTC_RGBA_4X4:return c5.COMPRESSED_RGBA_ASTC_4x4_KHR;case ti.ASTC_RGBA_5X4:return c5.COMPRESSED_RGBA_ASTC_5x4_KHR;case ti.ASTC_RGBA_5X5:return c5.COMPRESSED_RGBA_ASTC_5x5_KHR;case ti.ASTC_RGBA_6X5:return c5.COMPRESSED_RGBA_ASTC_6x5_KHR;case ti.ASTC_RGBA_6X6:return c5.COMPRESSED_RGBA_ASTC_6x6_KHR;case ti.ASTC_RGBA_8X5:return c5.COMPRESSED_RGBA_ASTC_8x5_KHR;case ti.ASTC_RGBA_8X6:return c5.COMPRESSED_RGBA_ASTC_8x6_KHR;case ti.ASTC_RGBA_8X8:return c5.COMPRESSED_RGBA_ASTC_8x8_KHR;case ti.ASTC_RGBA_10X5:return c5.COMPRESSED_RGBA_ASTC_10x5_KHR;case ti.ASTC_RGBA_10X6:return c5.COMPRESSED_RGBA_ASTC_10x6_KHR;case ti.ASTC_RGBA_10X8:return c5.COMPRESSED_RGBA_ASTC_10x8_KHR;case ti.ASTC_RGBA_10X10:return c5.COMPRESSED_RGBA_ASTC_10x10_KHR;case ti.ASTC_RGBA_12X10:return c5.COMPRESSED_RGBA_ASTC_12x10_KHR;case ti.ASTC_RGBA_12X12:return c5.COMPRESSED_RGBA_ASTC_12x12_KHR;case ti.ASTC_SRGBA_4X4:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case ti.ASTC_SRGBA_5X4:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case ti.ASTC_SRGBA_5X5:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case ti.ASTC_SRGBA_6X5:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case ti.ASTC_SRGBA_6X6:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case ti.ASTC_SRGBA_8X5:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case ti.ASTC_SRGBA_8X6:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case ti.ASTC_SRGBA_8X8:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case ti.ASTC_SRGBA_10X5:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case ti.ASTC_SRGBA_10X6:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case ti.ASTC_SRGBA_10X8:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case ti.ASTC_SRGBA_10X10:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case ti.ASTC_SRGBA_12X10:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case ti.ASTC_SRGBA_12X12:return c5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=f5(t.format,n);var i=t.width,r=t.height;switch(t.type){case ci.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&W(9100,o,e.capabilities.maxTextureSize),t.samples===hi.ONE){if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),Gr[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=qr(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r)}}else t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case ci.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>e.capabilities.maxCubeMapTextureSize&&W(9100,u,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),Gr[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){for(var f=qr(t.format,i,r,1),d=new Uint8Array(f),p=0;p<6;++p)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,_,t.glInternalFmt,i,r,0,d);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=ci.TEX2D,t.glTarget=n.TEXTURE_2D}}function O5(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var o=0;o<i.length;++o)i[o].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(t.glTarget,null),i[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}var M5={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function N5(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),M5.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==ti.UNKNOWN)switch(h.loadOp){case Si.LOAD:break;case Si.CLEAR:if(c.bs.targets[0].blendColorMask!==yi.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)_5[0]=r[u].x,_5[1]=r[u].y,_5[2]=r[u].z,_5[3]=r[u].w,s.clearBufferfv(s.COLOR,u,_5);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case Si.DISCARD:M5.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==ti.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Si.LOAD:break;case Si.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Si.DISCARD:M5.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(Gr[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Si.LOAD:break;case Si.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Si.DISCARD:M5.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&M5.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,M5.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==yi.ALL){var d=(f&yi.R)!==yi.NONE,p=(f&yi.G)!==yi.NONE,m=(f&yi.B)!==yi.NONE,v=(f&yi.A)!==yi.NONE;s.colorMask(d,p,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function L5(e,t,n,i,r,o){var a=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&M5.gpuPipelineState!==t){if(M5.gpuPipelineState=t,M5.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case wi.NONE:a.disable(a.CULL_FACE);break;case wi.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case wi.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}e.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==_&&(a.frontFace(_?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=_),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var f=t.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(a.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(a.depthFunc(y5[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,y5[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,x5[f.stencilFailOpFront],x5[f.stencilZFailOpFront],x5[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,y5[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,x5[f.stencilFailOpBack],x5[f.stencilZFailOpBack],x5[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var d=t.bs;if(d){s.bs.isA2C!==d.isA2C&&(d.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=d.isA2C),s.bs.blendColor.x===d.blendColor.x&&s.bs.blendColor.y===d.blendColor.y&&s.bs.blendColor.z===d.blendColor.z&&s.bs.blendColor.w===d.blendColor.w||(a.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),s.bs.blendColor.x=d.blendColor.x,s.bs.blendColor.y=d.blendColor.y,s.bs.blendColor.z=d.blendColor.z,s.bs.blendColor.w=d.blendColor.w);var p=d.targets[0],m=s.bs.targets[0];m.blend!==p.blend&&(p.blend?a.enable(a.BLEND):a.disable(a.BLEND),m.blend=p.blend),m.blendEq===p.blendEq&&m.blendAlphaEq===p.blendAlphaEq||(a.blendEquationSeparate(S5[p.blendEq],S5[p.blendAlphaEq]),m.blendEq=p.blendEq,m.blendAlphaEq=p.blendAlphaEq),m.blendSrc===p.blendSrc&&m.blendDst===p.blendDst&&m.blendSrcAlpha===p.blendSrcAlpha&&m.blendDstAlpha===p.blendDstAlpha||(a.blendFuncSeparate(T5[p.blendSrc],T5[p.blendDst],T5[p.blendSrcAlpha],T5[p.blendDstAlpha]),m.blendSrc=p.blendSrc,m.blendDst=p.blendDst,m.blendSrcAlpha=p.blendSrcAlpha,m.blendDstAlpha=p.blendDstAlpha),m.blendColorMask!==p.blendColorMask&&(a.colorMask((p.blendColorMask&yi.R)!==yi.NONE,(p.blendColorMask&yi.G)!==yi.NONE,(p.blendColorMask&yi.B)!==yi.NONE,(p.blendColorMask&yi.A)!==yi.NONE),m.blendColorMask=p.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var v=c.glBlocks.length,g=t.gpuPipelineLayout.dynamicOffsetIndices,y=0;y<v;y++){var x=c.glBlocks[y],S=i[x.set],T=S&&S.descriptorIndices[x.binding],E=T>=0&&S.gpuDescriptors[T];if(E&&E.gpuBuffer){var C=g[x.set],A=C&&C[x.binding],b=E.gpuBuffer.glOffset;A>=0&&(b+=r[A]),s.glBindUBOs[x.glBinding]===E.gpuBuffer.glBuffer&&s.glBindUBOOffsets[x.glBinding]===b||(b?a.bindBufferRange(a.UNIFORM_BUFFER,x.glBinding,E.gpuBuffer.glBuffer,b,E.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,x.glBinding,E.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[x.glBinding]=E.gpuBuffer.glBuffer,s.glBindUBOOffsets[x.glBinding]=b)}else N("Buffer binding '"+x.name+"' at set "+x.set+" binding "+x.binding+" is not bounded")}for(var P=c.glSamplerTextures.length,R=0;R<P;R++)for(var w=c.glSamplerTextures[R],I=i[w.set],D=I&&I.descriptorIndices[w.binding],O=D>=0&&I.gpuDescriptors[D],M=0;M<w.units.length;M++){var L=w.units[M],B=s.glTexUnits[L];if(O&&O.gpuTexture&&O.gpuSampler){if(O.gpuTexture&&O.gpuTexture.size>0){var F=O.gpuTexture;B.glTexture!==F.glTexture&&(s.texUnit!==L&&(a.activeTexture(a.TEXTURE0+L),s.texUnit=L),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,e.nullTex2D.gpuTexture.glTexture),B.glTexture=F.glTexture);var z=O.gpuSampler;s.glSamplerUnits[L]!==z.glSampler&&(a.bindSampler(L,z.glSampler),s.glSamplerUnits[L]=z.glSampler)}O=I.gpuDescriptors[++D]}else N("Sampler binding '"+w.name+"' at set "+w.set+" binding "+w.binding+" index "+M+" is not bounded")}}if(n&&c&&(l||M5.gpuInputAssembler!==n))if(M5.gpuInputAssembler=n,e.extensions.useVAO){var U=n.glVAOs.get(c.glProgram);if(!U){var k;U=a.createVertexArray(),n.glVAOs.set(c.glProgram,U),a.bindVertexArray(U),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var G=0;G<c.glInputs.length;G++){var H=c.glInputs[G];k=null;for(var V=0;V<n.glAttribs.length;V++){var j=n.glAttribs[V];if(j.name===H.name){k=j;break}}if(k){s.glArrayBuffer!==k.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,k.glBuffer),s.glArrayBuffer=k.glBuffer);for(var W=0;W<k.componentCount;++W){var q=H.glLoc+W,X=k.offset+k.size*W;a.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,a.vertexAttribPointer(q,k.count,k.glType,k.isNormalized,k.stride,X),a.vertexAttribDivisor(q,k.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==U&&(a.bindVertexArray(U),s.glVAO=U)}else{for(var K=0;K<e.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var Q=0;Q<c.glInputs.length;Q++){for(var Z=c.glInputs[Q],J=null,$=0;$<n.glAttribs.length;$++){var ee=n.glAttribs[$];if(ee.name===Z.name){J=ee;break}}if(J){s.glArrayBuffer!==J.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,J.glBuffer),s.glArrayBuffer=J.glBuffer);for(var te=0;te<J.componentCount;++te){var ne=Z.glLoc+te,ie=J.offset+J.size*te;!s.glEnabledAttribLocs[ne]&&ne>=0&&(a.enableVertexAttribArray(ne),s.glEnabledAttribLocs[ne]=!0),s.glCurrentAttribLocs[ne]=!0,a.vertexAttribPointer(ne,J.count,J.glType,J.isNormalized,J.stride,ie),a.vertexAttribDivisor(ne,J.isInstanced?1:0)}}}var re=n.gpuIndexBuffer;re&&s.glElementArrayBuffer!==re.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,re.glBuffer),s.glElementArrayBuffer=re.glBuffer);for(var oe=0;oe<e.capabilities.maxVertexAttributes;++oe)s.glEnabledAttribLocs[oe]!==s.glCurrentAttribLocs[oe]&&(a.disableVertexAttribArray(oe),s.glEnabledAttribLocs[oe]=!1)}if(t&&t.dynamicStates.length)for(var ae=t.dynamicStates.length,se=0;se<ae;se++)switch(t.dynamicStates[se]){case Ii.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case Ii.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case Ii.BLEND_CONSTANTS:var ce=o.blendConstant;s.bs.blendColor.x===ce.x&&s.bs.blendColor.y===ce.y&&s.bs.blendColor.z===ce.z&&s.bs.blendColor.w===ce.w||(a.blendColor(ce.x,ce.y,ce.z,ce.w),s.bs.blendColor.copy(ce));break;case Ii.STENCIL_WRITE_MASK:var le=o.stencilStatesFront,ue=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==le.writeMask&&(a.stencilMaskSeparate(a.FRONT,le.writeMask),s.dss.stencilWriteMaskFront=le.writeMask),s.dss.stencilWriteMaskBack!==ue.writeMask&&(a.stencilMaskSeparate(a.BACK,ue.writeMask),s.dss.stencilWriteMaskBack=ue.writeMask);break;case Ii.STENCIL_COMPARE_MASK:var he=o.stencilStatesFront,_e=o.stencilStatesBack;s.dss.stencilRefFront===he.reference&&s.dss.stencilReadMaskFront===he.compareMask||(a.stencilFuncSeparate(a.FRONT,y5[s.dss.stencilFuncFront],he.reference,he.compareMask),s.dss.stencilRefFront=he.reference,s.dss.stencilReadMaskFront=he.compareMask),s.dss.stencilRefBack===_e.reference&&s.dss.stencilReadMaskBack===_e.compareMask||(a.stencilFuncSeparate(a.BACK,y5[s.dss.stencilFuncBack],_e.reference,_e.compareMask),s.dss.stencilRefBack=_e.reference,s.dss.stencilReadMaskBack=_e.compareMask)}}function B5(e,t){var n=e.gl,i=M5.gpuInputAssembler,r=M5.glPrimitive,o=e.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(t.instanceCount)if(a){if(t.indexCount>0){var h=t.firstIndex*a.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(a){if(t.indexCount>0){var _=t.firstIndex*a.stride;n.drawElements(r,t.indexCount,i.glIndexType,_)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}var F5=new Array(g5.COUNT);function z5(e,t){F5.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=F5[i]++;switch(i){case g5.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];N5(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case g5.BIND_STATES:var a=t.bindStatesCmds.array[r];L5(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case g5.DRAW:B5(e,t.drawCmds.array[r].drawInfo);break;case g5.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];I5(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case g5.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];U5(e,c.buffers,c.gpuTexture,c.regions)}}}function U5(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Gr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt!==c5.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[a++];u?n.glInternalFmt!==c5.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&ui.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var k5=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=r(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),G5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new k5,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&si.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&ri.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),M5.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&ri.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),M5.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&ri.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&ri.INDIRECT||t.usage&ri.TRANSFER_DST||t.usage&ri.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(u5.instance,this._gpuBuffer),u5.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),M5.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),M5.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(u5.instance,this._gpuBuffer),u5.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&si.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&ri.VERTEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),M5.gpuInputAssembler=null,i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&ri.INDEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),M5.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&ri.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&ri.INDIRECT||t.usage&ri.TRANSFER_DST||t.usage&ri.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(u5.instance,this._gpuBuffer),u5.instance.memoryStatus.bufferSize-=t,u5.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&ri.INDIRECT?0:e.byteLength,I5(u5.instance,this._gpuBuffer,e,0,n))},c(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(Jr),H5=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new wl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),V5=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new H5(C5,1),this.bindStatesCmdPool=new H5(A5,1),this.drawCmdPool=new H5(b5,1),this.updateBufferCmdPool=new H5(P5,1),this.copyBufferToTextureCmdPool=new H5(R5,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),j5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new w5,t._cmdAllocator=new V5,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new Ur,t._isStateInvalied=!1,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=u5.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(C5);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(g5.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Di.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Di.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Di.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Di.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Li.PRIMARY&&this._isInRenderPass||this._type===Li.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(b5);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(g5.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Li.PRIMARY&&!this._isInRenderPass||this._type===Li.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(P5),a=0;e.usage&ri.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(g5.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Li.PRIMARY&&!this._isInRenderPass||this._type===Li.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(R5);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(g5.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(A5);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(g5.BIND_STATES),this._isStateInvalied=!1},t}($r),W5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=Gr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(u5.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=u5.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},c(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(no),q5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=f5(o.format,n),l=Gr[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Gr[o.format].count,stride:s.stride,componentCount:v5(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(u5.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=u5.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.gl,o=e.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),o===i.value&&(r.bindVertexArray(null),o=null),i=n.next();e.stateCache.glVAO=o,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},c(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(ao),X5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&jr)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},c(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(co),Y5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},c(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(lo),K5=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],Q5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:K5[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},c(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(mo),Z5=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){N5(u5.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;B5(u5.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=u5.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=u5.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&ri.INDIRECT?0:t.byteLength,I5(u5.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&U5(u5.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];z5(u5.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){L5(u5.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(j5),J5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(vo),$5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},c(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(go),e8=function(e){function t(t,n){var i,r,o,a,s;return(i=e.call(this,t,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=u5.instance,o=i._gpuSampler,(s=(a=r.gl).createSampler())&&(o.minFilter===fi.LINEAR||o.minFilter===fi.ANISOTROPIC?o.mipFilter===fi.LINEAR||o.mipFilter===fi.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===fi.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===fi.LINEAR||o.mipFilter===fi.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===fi.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===fi.LINEAR||o.magFilter===fi.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=h5[o.addressU],o.glWrapT=h5[o.addressV],o.glWrapR=h5[o.addressW],o.glSampler=s,a.samplerParameteri(s,a.TEXTURE_MIN_FILTER,o.glMinFilter),a.samplerParameteri(s,a.TEXTURE_MAG_FILTER,o.glMagFilter),a.samplerParameteri(s,a.TEXTURE_WRAP_S,o.glWrapS),a.samplerParameteri(s,a.TEXTURE_WRAP_T,o.glWrapT),a.samplerParameteri(s,a.TEXTURE_WRAP_R,o.glWrapR),a.samplerParameterf(s,a.TEXTURE_MIN_LOD,0),a.samplerParameterf(s,a.TEXTURE_MAX_LOD,1e3)),i}return u(t,e),t.prototype.destroy=function(){this._gpuSampler&&(function(e,t){var n=e.gl;if(t.glSampler){n.deleteSampler(t.glSampler);for(var i=e.stateCache.glSamplerUnits,r=0;r<i.length;++r)i[r]===t.glSampler&&(n.bindSampler(r,null),i[r]=null);t.glSampler=null}}(u5.instance,this._gpuSampler),this._gpuSampler=null)},c(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(yo),t8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case xi.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case xi.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));B("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(t.glProgram,d),v=p5(f.type,n),g=m5(f.type,n);t.glInputs[_]={name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}var y,x,S,T,E=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(E){t.glBlocks=new Array(E);for(var C=0;C<E;++C){var A=(y=n.getActiveUniformBlockName(t.glProgram,C)).indexOf("[");-1!==A&&(y=y.substr(0,A)),T=null;for(var b=0;b<t.blocks.length;b++)if(t.blocks[b].name===y){T=t.blocks[b];break}if(T){x=C,S=n.getActiveUniformBlockParameter(t.glProgram,x,n.UNIFORM_BLOCK_DATA_SIZE);var P=T.binding+(e.bindingMappingInfo.bufferOffsets[T.set]||0);n.uniformBlockBinding(t.glProgram,x,P),t.glBlocks[C]={set:T.set,binding:T.binding,idx:x,name:y,size:S,glBinding:P}}else N("Block '"+y+"' does not bound")}}for(var R=0;R<t.subpassInputs.length;++R){var w=t.subpassInputs[R];t.samplerTextures.push(new ur(w.set,w.binding,w.name,ii.SAMPLER2D,w.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var I=0;I<t.samplerTextures.length;++I){var D=t.samplerTextures[I];t.glSamplerTextures[I]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:d5(D.type,n),glLoc:null}}}for(var O=[],M=[],L=e.stateCache.texUnitCacheMap,F=0,z=0;z<t.blocks.length;++z)t.blocks[z].set===e.bindingMappingInfo.flexibleSet&&F++;for(var U=0,k=0;k<t.samplerTextures.length;++k){var G=t.samplerTextures[k],H=n.getUniformLocation(t.glProgram,G.name);if(H&&-1!==H.id&&(O.push(t.glSamplerTextures[k]),M.push(H)),void 0===L[G.name]){var V=G.binding+e.bindingMappingInfo.samplerOffsets[G.set]+U;G.set===e.bindingMappingInfo.flexibleSet&&(V-=F),L[G.name]=V%e.capabilities.maxTextureUnits,U+=G.count-1}}if(O.length){for(var j=[],W=0;W<O.length;++W){var q=O[W],X=L[q.name];if(void 0!==X){q.glLoc=M[W];for(var Y=0;Y<q.count;++Y){for(;j[X];)X=(X+1)%e.capabilities.maxTextureUnits;q.units.push(X),j[X]=!0}}}for(var K=0,Q=0;Q<O.length;++Q){var Z=O[Q];if(!Z.glLoc){for(Z.glLoc=M[Q];j[K];)K++;for(var J=0;J<Z.count;++J){for(;j[K];)K=(K+1)%e.capabilities.maxTextureUnits;void 0===L[Z.name]&&(L[Z.name]=K),Z.units.push(K),j[K]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var $=0;$<O.length;$++){var ee=O[$];ee.glUnits=new Int32Array(ee.units),n.uniform1iv(ee.glLoc,ee.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=O}}(u5.instance,this._gpuShader)},n.destroy=function(){var e,t;this._gpuShader&&(e=u5.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)},c(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(xo),n8=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new Ki,this.scissorRect=new Hi(0,0,0,0),this.rs=new uo,this.dss=new ho,this.bs=new fo,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},e}(),i8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL2 does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=Wr(this._width)&&Wr(this._height),this._size=Xr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},D5(u5.instance,this._gpuTexture),u5.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(O5(u5.instance,this._gpuTexture),u5.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=Xr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case ci.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&W(9100,o,e.capabilities.maxTextureSize),t.samples===hi.ONE){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),Gr[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=qr(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else O5(e,t),D5(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case ci.CUBE:t.type=ci.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>e.capabilities.maxCubeMapTextureSize&&W(9100,u,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),Gr[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var f=0;f<t.mipLevel;++f){var d=qr(t.format,i,r,1),p=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,t.glInternalFmt,i,r,0,p),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else O5(e,t),D5(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=ci.TEX2D,t.glTarget=n.TEXTURE_2D}}}(u5.instance,this._gpuTexture),u5.instance.memoryStatus.textureSize-=n,u5.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new or;t.format=e.format,t.usage=Gr[e.format].hasDepth?li.DEPTH_STENCIL_ATTACHMENT:li.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},c(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(So),r8="webglcontextlost";function o8(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function a8(e){var t={EXT_texture_filter_anisotropic:o8(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:o8(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:o8(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:o8(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:o8(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:o8(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:o8(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:o8(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:o8(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:o8(e,"WEBGL_debug_shaders"),WEBGL_lose_context:o8(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:o8(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:o8(e,"OES_texture_half_float_linear"),OES_texture_float_linear:o8(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return Jl.os!==Vl.ANDROID&&Jl.os!==Vl.IOS&&(t.WEBGL_multi_draw=o8(e,"WEBGL_multi_draw")),t}var s8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new n8,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(r8,this._onWebGLContextLost);var t=u5.instance.gl;this.stateCache.initialize(u5.instance.capabilities.maxTextureUnits,u5.instance.capabilities.maxUniformBufferBindings,u5.instance.capabilities.maxVertexAttributes),this._extensions=a8(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=ti.RGBA8,i=ti.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=ti.DEPTH_STENCIL:r&&(i=ti.DEPTH),this._colorTexture=new i8,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new i8,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=u5.instance.createTexture(new or(ci.TEX2D,li.SAMPLED,ti.RGBA8,2,2,ui.NONE)),this.nullTexCube=u5.instance.createTexture(new or(ci.CUBE,li.SAMPLED,ti.RGBA8,2,2,ui.NONE,6));var a=new Yi;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),u5.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,u5.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(r8,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(B("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){V(11e3),M(e)},c(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(to),c8=e("WebGL2Device",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}u(t,e);var n=t.prototype;return n.initialize=function(e){u5.setInstance(this),this._gfxAPI=Jn.WEBGL2,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:$e.ENABLE_TRANSPARENT_CANVAS,antialias:$e.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(eo.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Nr(Mi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Mr(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=t.getSupportedExtensions(),i="";if(n)for(var r,o=g(n);!(r=o()).done;)i+=r.value+" ";var a=a8(t);a.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),this._features[ei.TEXTURE_FLOAT]=!0,this._features[ei.TEXTURE_HALF_FLOAT]=!0,this._features[ei.FORMAT_R11G11B10F]=!0,this._features[ei.FORMAT_SRGB]=!0,this._features[ei.FORMAT_RGB8]=!0,this._features[ei.ELEMENT_INDEX_UINT]=!0,this._features[ei.INSTANCED_ARRAYS]=!0,this._features[ei.MULTIPLE_RENDER_TARGETS]=!0,this._features[ei.BLEND_MINMAX]=!0,a.EXT_color_buffer_float&&(this._features[ei.COLOR_FLOAT]=!0,this._features[ei.COLOR_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[ei.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[ei.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[ei.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[ei.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[ei.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[ei.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[ei.FORMAT_ASTC]=!0,c+="astc "),B("WebGL2 device initialized."),B("RENDERER: "+this._renderer),B("VENDOR: "+this._vendor),B("VERSION: "+s),B("COMPRESSED_FORMAT: "+c),B("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===Li.PRIMARY?Z5:j5);return t.initialize(e),t},n.createSwapchain=function(e){var t=new s8;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new G5;return t.initialize(e),t},n.createTexture=function(e){var t=new i8;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new l5;return t.initialize(e),t},n.createShader=function(e){var t=new t8;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new q5;return t.initialize(e),t},n.createRenderPass=function(e){var t=new $5;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new W5;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new X5;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new Y5;return t.initialize(e),t},n.createPipelineState=function(e){var t=new Q5;return t.initialize(e),t},n.createQueue=function(e){var t=new J5;return t.initialize(e),t},n.getSampler=function(e){var t=yo.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new e8(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=To.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new To(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Eo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Eo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){U5(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&ui.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},c(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(eo));function l8(e,t,n,i){var r=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),o=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),a=(i.y-n.y)*(t.x-e.x)-(i.x-n.x)*(t.y-e.y);if(0!==a){var s=r/a,c=o/a;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}T.WebGL2Device=c8;var u8=new gn,h8=new gn,_8=new gn,f8=new gn;function d8(e,t,n){for(var i=n.length,r=0;r<i;++r)if(l8(e,t,n[r],n[(r+1)%i]))return!0;return!1}function p8(e,t){for(var n=!1,i=e.x,r=e.y,o=t.length,a=0,s=o-1;a<o;s=a++){var c=t[a].x,l=t[a].y,u=t[s].x,h=t[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function m8(e,t,n,i){var r,o=n.x-t.x,a=n.y-t.y,s=o*o+a*a,c=((e.x-t.x)*o+(e.y-t.y)*a)/s;return r=i?s?c<0?t:c>1?n:u8.set(t.x+c*o,t.y+c*a):t:u8.set(t.x+c*o,t.y+c*a),o=e.x-r.x,a=e.y-r.y,Math.sqrt(o*o+a*a)}var v8=e("Intersection2D",(function(){}));function g8(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}v8.lineLine=l8,v8.lineRect=function(e,t,n){var i=u8.set(n.x,n.y),r=h8.set(n.x,n.yMax),o=_8.set(n.xMax,n.yMax),a=f8.set(n.xMax,n.y);return!!(l8(e,t,i,r)||l8(e,t,r,o)||l8(e,t,o,a)||l8(e,t,a,i))},v8.linePolygon=d8,v8.rectRect=function(e,t){var n=e.x,i=e.y,r=e.x+e.width,o=e.y+e.height,a=t.x,s=t.y,c=t.x+t.width,l=t.y+t.height;return n<=c&&r>=a&&i<=l&&o>=s},v8.rectPolygon=function(e,t){var n=u8.set(e.x,e.y),i=h8.set(e.x,e.yMax),r=_8.set(e.xMax,e.yMax),o=f8.set(e.xMax,e.y);if(d8(n,i,t))return!0;if(d8(i,r,t))return!0;if(d8(r,o,t))return!0;if(d8(o,n,t))return!0;for(var a=0,s=t.length;a<s;++a)if(e.contains(t[a]))return!0;return!!(p8(n,t)||p8(i,t)||p8(r,t)||p8(o,t))},v8.rectCircle=function(e,t,n){var i=t.x,r=t.y,o=e.x,a=e.y,s=e.width,c=e.height,l=i,u=r;i<o?l=o:i>o+s&&(l=o+s),r<a?u=a:r>a+c&&(u=a+c);var h=i-l,_=r-u;return Math.sqrt(h*h+_*_)<=n},v8.polygonPolygon=function(e,t){var n,i;for(n=0,i=e.length;n<i;++n)if(d8(e[n],e[(n+1)%i],t))return!0;for(n=0,i=t.length;n<i;++n)if(p8(t[n],e))return!0;for(n=0,i=e.length;n<i;++n)if(p8(e[n],t))return!0;return!1},v8.circleCircle=function(e,t,n,i){return gn.distance(e,n)<t+i},v8.polygonCircle=function(e,t,n){var i=t;if(p8(i,e))return!0;for(var r=0,o=e.length;r<o;r++)if(m8(i,0===r?e[e.length-1]:e[r-1],e[r],!0)<n)return!0;return!1},v8.pointInPolygon=p8,v8.pointLineDistance=m8;var y8=new dn,x8=new dn,S8=new dn,T8=new dn,E8=new dn,C8=new dn,A8=new dn,b8=new dn,P8=new dn,R8=new dn,w8=new dn,I8=new dn,D8=new dn(0,0,0),O8=new dn(0,0,0);function M8(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,s=void 0===i.capped||i.capped,c=i.arc||2*Math.PI,l=0;s||(e>0&&l++,t>0&&l++);var u=(o+1)*(a+1);s&&(u+=(o+1)*l+o*l);var h=o*a*6;s&&(h+=o*l*3);var _=new Array(h),f=new Array(3*u),d=new Array(3*u),p=new Array(2*u),m=Math.max(e,t),v=new dn(-m,-r,-m),g=new dn(m,r,m),y=Math.sqrt(m*m+r*r),x=0,S=0;return function(){for(var i=[],s=e-t,l=s*s/n*Math.sign(s),u=0;u<=a;u++){for(var h=[],m=u/a,v=m*s+t,g=0;g<=o;++g){var y=g/o,T=y*c,E=Math.sin(T),C=Math.cos(T);f[3*x]=v*E,f[3*x+1]=m*n-r,f[3*x+2]=v*C,dn.normalize(D8,dn.set(O8,E,-l,C)),d[3*x]=D8.x,d[3*x+1]=D8.y,d[3*x+2]=D8.z,p[2*x]=2*(1-y)%1,p[2*x+1]=m,h.push(x),++x}i.push(h)}for(var A=0;A<a;++A)for(var b=0;b<o;++b){var P=i[A][b],R=i[A+1][b],w=i[A+1][b+1],I=i[A][b+1];_[S]=P,++S,_[S]=I,++S,_[S]=R,++S,_[S]=I,++S,_[S]=w,++S,_[S]=R,++S}}(),s&&(t>0&&T(!1),e>0&&T(!0)),{positions:f,normals:d,uvs:p,indices:_,minPos:v,maxPos:g,boundingRadius:y};function T(n){for(var i=n?e:t,a=n?1:-1,s=x,l=1;l<=o;++l)f[3*x]=0,f[3*x+1]=r*a,f[3*x+2]=0,d[3*x]=0,d[3*x+1]=a,d[3*x+2]=0,p[2*x]=.5,p[2*x+1]=.5,++x;for(var u=x,h=0;h<=o;++h){var m=h/o*c,v=Math.cos(m),g=Math.sin(m);f[3*x]=i*g,f[3*x+1]=r*a,f[3*x+2]=i*v,d[3*x]=0,d[3*x+1]=a,d[3*x+2]=0,p[2*x]=.5-.5*g*a,p[2*x+1]=.5+.5*v,++x}for(var y=0;y<o;++y){var T=s+y,E=u+y;n?(_[S]=E+1,++S,_[S]=T,++S,_[S]=E,++S):(_[S]=T,++S,_[S]=E+1,++S,_[S]=E,++S)}}}var N8,L8,B8,F8,z8,U8,k8,G8,H8,V8=new dn(0,0,0),j8=new dn(0,0,0),W8=new dn(0,0,0),q8=new dn(0,0,0),X8=new dn(0,0,0),Y8=new dn(0,0,0),K8=new dn(0,0,0),Q8=new dn(0,0,0),Z8=new dn(0,0,0),J8=Object.freeze({__proto__:null,box:function(e){var t=(e=e||{}).widthSegments||1,n=e.heightSegments||1,i=e.lengthSegments||1,r=(e.width||1)/2,o=(e.height||1)/2,a=(e.length||1)/2,s=[dn.set(E8,-r,-o,a),dn.set(C8,r,-o,a),dn.set(A8,r,o,a),dn.set(b8,-r,o,a),dn.set(P8,r,-o,-a),dn.set(R8,-r,-o,-a),dn.set(w8,-r,o,-a),dn.set(I8,r,o,-a)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],h=[],_=[],f=[],d=[],p=[],m=new dn(-r,-o,-a),v=new dn(r,o,a),g=Math.sqrt(r*r+o*o+a*a);function y(e,t,n){var i,r,o,a,m=h.length/3,v=c[e],g=l[e],y=u[e];for(a=0;a<=n;a++)for(o=0;o<=t;o++)if(i=o/t,r=a/n,dn.lerp(y8,s[v[0]],s[v[1]],i),dn.lerp(x8,s[v[0]],s[v[2]],r),dn.subtract(S8,x8,s[v[0]]),dn.add(T8,y8,S8),h.push(T8.x,T8.y,T8.z),_.push(g[0],g[1],g[2]),f.push(i,r),d.push(y[0],y[1],y[2],y[3]),o<t&&a<n){var x=t+1,S=o+a*x,T=o+(a+1)*x,E=o+1+(a+1)*x,C=o+1+a*x;p.push(m+S,m+C,m+T),p.push(m+T,m+C,m+E)}}return y(0,t,n),y(4,i,n),y(1,t,n),y(5,i,n),y(3,t,i),y(2,t,i),{positions:h,normals:_,uvs:f,tangents:d,indices:p,minPos:m,maxPos:v,boundingRadius:g}},cone:function(e,t,n){return void 0===e&&(e=.5),void 0===t&&(t=1),void 0===n&&(n={}),M8(0,e,t,n)},cylinder:M8,plane:function(e){var t=function(e){return(e=g8(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),n=t.width,i=t.length,r=t.widthSegments,o=t.lengthSegments,a=.5*n,s=.5*i,c=[],l=[],u=[],h=new dn(-a,0,-s),_=new dn(a,0,s),f=Math.sqrt(n*n+i*i);dn.set(X8,-a,0,s),dn.set(Y8,a,0,s),dn.set(K8,-a,0,-s);for(var d=0;d<=o;d++)for(var p=0;p<=r;p++){var m=p/r,v=d/o;if(dn.lerp(V8,X8,Y8,m),dn.lerp(j8,X8,K8,v),dn.subtract(W8,j8,X8),dn.add(q8,V8,W8),c.push(q8.x,q8.y,q8.z),t.includeUV&&l.push(m,v),p<r&&d<o){var g=r+1,y=p+d*g,x=p+(d+1)*g,S=p+1+(d+1)*g,T=p+1+d*g;u.push(y,T,x),u.push(T,S,x)}}var E={positions:c,indices:u,minPos:h,maxPos:_,boundingRadius:f};if(t.includeNormal){var C=(o+1)*(r+1),A=new Array(3*C);E.normals=A;for(var b=0;b<C;++b)A[3*b+0]=0,A[3*b+1]=1,A[3*b+2]=0}return t.includeUV&&(E.uvs=l),E},quad:function(e){var t=g8(e),n={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(n.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(n.uvs=[0,0,0,1,1,1,1,0]),n},sphere:function(e,t){void 0===e&&(e=.5),void 0===t&&(t={});for(var n=void 0!==t.segments?t.segments:32,i=[],r=[],o=[],a=[],s=new dn(-e,-e,-e),c=new dn(e,e,e),l=e,u=0;u<=n;++u)for(var h=u*Math.PI/n,_=Math.sin(h),f=-Math.cos(h),d=0;d<=n;++d){var p=2*d*Math.PI/n-Math.PI/2,m=Math.sin(p)*_,v=f,g=Math.cos(p)*_,y=d/n,x=u/n;if(i.push(m*e,v*e,g*e),r.push(m,v,g),o.push(y,x),u<n&&d<n){var S=n+1,T=S*u+d,E=S*(u+1)+d,C=S*(u+1)+d+1,A=S*u+d+1;a.push(T,A,E),a.push(A,C,E)}}return{positions:i,indices:a,normals:r,uvs:o,minPos:s,maxPos:c,boundingRadius:l}},torus:function(e,t,n){void 0===e&&(e=.4),void 0===t&&(t=.1),void 0===n&&(n={});for(var i=n.radialSegments||32,r=n.tubularSegments||32,o=n.arc||2*Math.PI,a=[],s=[],c=[],l=[],u=new dn(-e-t,-t,-e-t),h=new dn(e+t,t,e+t),_=e+t,f=0;f<=i;f++)for(var d=0;d<=r;d++){var p=d/r,m=f/i,v=p*o,g=m*Math.PI*2,y=(e+t*Math.cos(g))*Math.sin(v),x=t*Math.sin(g),S=(e+t*Math.cos(g))*Math.cos(v),T=Math.sin(v)*Math.cos(g),E=Math.sin(g),C=Math.cos(v)*Math.cos(g);if(a.push(y,x,S),s.push(T,E,C),c.push(p,m),d<r&&f<i){var A=r+1,b=A*f+d,P=A*(f+1)+d,R=A*(f+1)+d+1,w=A*f+d+1;l.push(b,w,P),l.push(w,R,P)}}return{positions:a,normals:s,uvs:c,indices:l,minPos:u,maxPos:h,boundingRadius:_}},capsule:function(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=n-e-t,o=i.sides||32,a=i.heightSegments||32,s=t/n,c=r/n,l=e/n,u=Math.floor(a*s),h=Math.floor(a*l),_=Math.floor(a*c),f=r+t-n/2,d=t-n/2,p=t-n/2,m=i.arc||2*Math.PI,v=[],g=[],y=[],x=[],S=Math.max(e,t),T=new dn(-S,-n/2,-S),E=new dn(S,n/2,S),C=n/2,A=0,b=[];return function(){for(var e=0;e<=u;++e)for(var n=e*Math.PI/u/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,h=r,_=Math.cos(c)*i,f=s/o,d=e/a;if(v.push(l*t,h*t+p,_*t),g.push(l,h,_),y.push(f,d),e<u&&s<o){var m=o+1,S=m*e+s,T=m*(e+1)+s,E=m*(e+1)+s+1,C=m*e+s+1;x.push(S,C,T),x.push(C,E,T)}++A}}(),function(){for(var n=(e-t)/r,i=0;i<=_;i++){for(var a=[],l=i/_,u=l*(e-t)+t,h=0;h<=o;++h){var f=h/o,p=l*c+s,S=f*m-m/4,T=Math.sin(S),E=Math.cos(S);v.push(u*T),v.push(l*r+d),v.push(u*E),dn.normalize(Q8,dn.set(Z8,T,-n,E)),g.push(Q8.x),g.push(Q8.y),g.push(Q8.z),y.push(f,p),a.push(A),++A}b.push(a)}for(var C=0;C<_;++C)for(var P=0;P<o;++P){var R=b[C][P],w=b[C+1][P],I=b[C+1][P+1],D=b[C][P+1];x.push(R),x.push(D),x.push(w),x.push(D),x.push(I),x.push(w)}}(),function(){for(var t=0;t<=h;++t)for(var n=t*Math.PI/h/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,u=Math.sin(c)*i,d=r,p=Math.cos(c)*i,m=s/o,S=t/a+(1-l);if(v.push(u*e,d*e+f,p*e),g.push(u,d,p),y.push(m,S),t<h&&s<o){var T=o+1,E=T*t+s+b[_][o]+1,C=T*(t+1)+s+b[_][o]+1,A=T*(t+1)+s+1+b[_][o]+1,P=T*t+s+1+b[_][o]+1;x.push(E,P,C),x.push(P,A,C)}}}(),{positions:v,normals:g,uvs:y,indices:x,minPos:T,maxPos:E,boundingRadius:C}},circle:function(e){var t=function(e){return(e=g8(e)).segments=64,e}(e).segments,n=new Array(3*(t+1));n[0]=0,n[1]=0,n[2]=0;var i=new Array(1+2*t);i[0]=0;for(var r=2*Math.PI/t,o=0;o<t;++o){var a=r*o,s=Math.cos(a),c=Math.sin(a),l=3*(o+1);n[l+0]=s,n[l+1]=c,n[l+2]=0;var u=2*o;i[1+u]=o+1,i[1+(u+1)]=o+2}return t>0&&(i[i.length-1]=1),{positions:n,indices:i,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:bi.TRIANGLE_FAN}},translate:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]+=n,e.positions[c]+=i,e.positions[l]+=r}return e.minPos&&(e.minPos.x+=n,e.minPos.y+=i,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=n,e.maxPos.y+=i,e.maxPos.z+=r),e},scale:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]*=n,e.positions[c]*=i,e.positions[l]*=r}return e.minPos&&(e.minPos.x*=n,e.minPos.y*=i,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=n,e.maxPos.y*=i,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(n,i),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==bi.TRIANGLE_LIST)return e;for(var n=[[0,1],[1,2],[2,0]],i=[],r={},o=0;o<t.length;o+=3)for(var a=0;a<3;++a){var s=t[o+n[a][0]],c=t[o+n[a][1]],l=s>c?c<<16|s:s<<16|c;void 0===r[l]&&(r[l]=0,i.push(s,c))}return e.indices=i,e.primitiveMode=bi.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],n=[],i={},r=0;r<e.length;r+=3)for(var o=0;o<3;++o){var a=e[r+t[o][0]],s=e[r+t[o][1]],c=a>s?s<<16|a:a<<16|s;void 0===i[c]&&(i[c]=0,n.push(a,s))}return n},invWinding:function(e){for(var t=[],n=0;n<e.length;n+=3)t.push(e[n],e[n+2],e[n+1]);return t},toWavefrontOBJ:function(e,t){if(void 0===t&&(t=1),!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==bi.TRIANGLE_LIST)return"";for(var n=e.positions,i=e.uvs,r=e.normals,o=e.indices,a=function(e){return o[e]+1+"/"+(o[e]+1)+"/"+(o[e]+1)},s="",c=0;c<n.length;c+=3)s+="v "+n[c]*t+" "+n[c+1]*t+" "+n[c+2]*t+"\n";for(var l=0;l<i.length;l+=2)s+="vt "+i[l]+" "+i[l+1]+"\n";for(var u=0;u<r.length;u+=3)s+="vn "+r[u]+" "+r[u+1]+" "+r[u+2]+"\n";for(var h=0;h<o.length;h+=3)s+="f "+a(h)+" "+a(h+1)+" "+a(h+2)+"\n";return s},normals:function(e,t,n){void 0===n&&(n=1);for(var i=new Array(2*e.length),r=0;r<e.length/3;++r){var o=3*r,a=6*r;i[a+0]=e[o+0],i[a+1]=e[o+1],i[a+2]=e[o+2],i[a+3]=e[o+0]+t[o+0]*n,i[a+4]=e[o+1]+t[o+1]*n,i[a+5]=e[o+2]+t[o+2]*n}return i},applyDefaultGeometryOptions:g8});e("primitives",J8),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(H8||(H8={})),Ze(H8);var $8,e6,t6,n6,i6,r6,o6,a6,s6,c6,l6,u6,h6,_6,f6,d6,p6,m6,v6,g6,y6,x6,S6,T6,E6,C6,A6,b6,P6,R6,w6,I6,D6,O6,M6,N6,L6,B6,F6,z6,U6,k6,G6,H6,V6,j6,W6,q6,X6,Y6,K6,Q6,Z6,J6,$6,e7,t7,n7,i7,r7,o7=e("Primitive",(N8=$s("cc.Primitive"),L8=Mc(H8),N8((G8=k8=function(e){function t(t){var n;return void 0===t&&(t=H8.BOX),y(n=e.call(this)||this,"type",z8,m(n)),y(n,"info",U8,m(n)),n.type=t,n}return u(t,e),t.prototype.onLoaded=function(){YJ(J8[H8[this.type].toLowerCase()](this.info),this)},t}(kJ),k8.PrimitiveType=H8,z8=x((F8=G8).prototype,"type",[L8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return H8.BOX}}),U8=x(F8.prototype,"info",[oc,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),B8=F8))||B8));T.Primitive=o7,T.primitives=J8;var a7,s7,c7,l7=new Wn;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(a7||(a7={})),Ze(a7),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(s7||(s7={})),function(e){e.CLICK="click"}(c7||(c7={}));var u7=e("Button",($8=$s("cc.Button"),e6=pc(),t6=tc(110),n6=hc(),i6=ec(QH),r6=Mc(TA),o6=bc(),a6=xc(),s6=bc(),c6=xc(),l6=Mc(a7),u6=bc(),h6=xc(),_6=bc(),f6=xc(),d6=bc(),p6=xc(),m6=bc(),v6=xc(),g6=bc(),y6=xc(),x6=Tc(),S6=Ec(),T6=bc(),E6=xc(),C6=bc(),A6=xc(),b6=Mc(EG),P6=bc(),R6=xc(),w6=Mc(EG),I6=bc(),D6=xc(),O6=Mc(EG),M6=bc(),N6=xc(),L6=Mc(EG),B6=bc(),F6=xc(),z6=Mc([eB]),U6=bc(),k6=xc(),$8(G6=e6(G6=t6(G6=n6(G6=i6(G6=uc((r7=i7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",V6,m(t)),y(t,"_interactable",j6,m(t)),y(t,"_transition",W6,m(t)),y(t,"_normalColor",q6,m(t)),y(t,"_hoverColor",X6,m(t)),y(t,"_pressedColor",Y6,m(t)),y(t,"_disabledColor",K6,m(t)),y(t,"_normalSprite",Q6,m(t)),y(t,"_hoverSprite",Z6,m(t)),y(t,"_pressedSprite",J6,m(t)),y(t,"_disabledSprite",$6,m(t)),y(t,"_duration",e7,m(t)),y(t,"_zoomScale",t7,m(t)),y(t,"_target",n7,m(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new Wn,t._toColor=new Wn,t._time=0,t._transitionFinished=!0,t._fromScale=new dn,t._toScale=new dn,t._originalScale=null,t._sprite=null,t._targetScale=new dn,t}u(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(EX);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===a7.COLOR||this._transition===a7.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===a7.COLOR){var i=t._uiProps.uiComp;Wn.lerp(l7,this._fromColor,this._toColor,n),i&&(i.color=l7)}else this.transition===a7.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=Zt(this._fromScale.x,this._toScale.x,n),this._targetScale.y=Zt(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===a7.COLOR&&this._interactable){var n=e.getComponent(Nj);n&&(n.color=this._normalColor)}else t===a7.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(xE.TOUCH_START,this._onTouchBegan,this),this.node.on(xE.TOUCH_MOVE,this._onTouchMove,this),this.node.on(xE.TOUCH_END,this._onTouchEnded,this),this.node.on(xE.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(xE.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(xE.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(xE.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(xE.TOUCH_START,this._onTouchBegan,this),this.node.off(xE.TOUCH_MOVE,this._onTouchMove,this),this.node.off(xE.TOUCH_END,this._onTouchEnded,this),this.node.off(xE.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(xE.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(xE.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(xE.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(EX)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new dn),dn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===a7.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case s7.NORMAL:this._normalSprite=e;break;case s7.HOVER:this._hoverSprite=e;break;case s7.PRESSED:this._pressedSprite=e;break;case s7.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===a7.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case s7.NORMAL:this._normalColor=e;break;case s7.HOVER:this._hoverColor=e;break;case s7.PRESSED:this._pressedColor=e;break;case s7.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&wg.SCALE&&this._originalScale&&this._transition===a7.SCALE&&this._transitionFinished&&dn.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());this._transition===a7.SCALE&&this.target&&this._originalScale?i?(dn.copy(this._fromScale,this._originalScale),dn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?s7.PRESSED:s7.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(eB.emitEvents(this.clickEvents,e),this.node.emit(c7.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==a7.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=s7.NORMAL;return this._interactable?this._pressed?e=s7.PRESSED:this._hovered&&(e=s7.HOVER):e=s7.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(Nj);i&&(e===s7.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===s7.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(dn.copy(this._fromScale,this._originalScale),dn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(dn.copy(this._fromScale,this.target.getScale()),dn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===a7.COLOR?this._updateColorTransition(e):t===a7.SPRITE?this._updateSpriteTransition(e):t===a7.SCALE&&this._updateScaleTransition(e)},c(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===a7.COLOR?this._updateColorTransition(s7.NORMAL):this._transition===a7.SPRITE&&this._updateSpriteTransition(s7.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(EX);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(Bu),i7.Transition=a7,i7.EventType=c7,x((H6=r7).prototype,"target",[r6,o6,a6],Object.getOwnPropertyDescriptor(H6.prototype,"target"),H6.prototype),x(H6.prototype,"interactable",[s6,c6],Object.getOwnPropertyDescriptor(H6.prototype,"interactable"),H6.prototype),x(H6.prototype,"transition",[l6,u6,h6],Object.getOwnPropertyDescriptor(H6.prototype,"transition"),H6.prototype),x(H6.prototype,"normalColor",[_6,f6],Object.getOwnPropertyDescriptor(H6.prototype,"normalColor"),H6.prototype),x(H6.prototype,"pressedColor",[d6,p6],Object.getOwnPropertyDescriptor(H6.prototype,"pressedColor"),H6.prototype),x(H6.prototype,"hoverColor",[m6,v6],Object.getOwnPropertyDescriptor(H6.prototype,"hoverColor"),H6.prototype),x(H6.prototype,"disabledColor",[g6,y6],Object.getOwnPropertyDescriptor(H6.prototype,"disabledColor"),H6.prototype),x(H6.prototype,"duration",[x6,S6,T6,E6],Object.getOwnPropertyDescriptor(H6.prototype,"duration"),H6.prototype),x(H6.prototype,"zoomScale",[C6,A6],Object.getOwnPropertyDescriptor(H6.prototype,"zoomScale"),H6.prototype),x(H6.prototype,"normalSprite",[b6,P6,R6],Object.getOwnPropertyDescriptor(H6.prototype,"normalSprite"),H6.prototype),x(H6.prototype,"pressedSprite",[w6,I6,D6],Object.getOwnPropertyDescriptor(H6.prototype,"pressedSprite"),H6.prototype),x(H6.prototype,"hoverSprite",[O6,M6,N6],Object.getOwnPropertyDescriptor(H6.prototype,"hoverSprite"),H6.prototype),x(H6.prototype,"disabledSprite",[L6,B6,F6],Object.getOwnPropertyDescriptor(H6.prototype,"disabledSprite"),H6.prototype),V6=x(H6.prototype,"clickEvents",[z6,oc,U6,k6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),j6=x(H6.prototype,"_interactable",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),W6=x(H6.prototype,"_transition",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a7.NONE}}),q6=x(H6.prototype,"_normalColor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.WHITE.clone()}}),X6=x(H6.prototype,"_hoverColor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(211,211,211,255)}}),Y6=x(H6.prototype,"_pressedColor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.WHITE.clone()}}),K6=x(H6.prototype,"_disabledColor",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(124,124,124,255)}}),Q6=x(H6.prototype,"_normalSprite",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Z6=x(H6.prototype,"_hoverSprite",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J6=x(H6.prototype,"_pressedSprite",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$6=x(H6.prototype,"_disabledSprite",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e7=x(H6.prototype,"_duration",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),t7=x(H6.prototype,"_zoomScale",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),n7=x(H6.prototype,"_target",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),G6=H6))||G6)||G6)||G6)||G6)||G6)||G6));T.Button=u7;var h7,_7,f7,d7=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();d7._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(h7||(h7={})),Ye(h7),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(_7||(_7={})),Ye(_7),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(f7||(f7={})),Ye(f7);var p7,m7,v7,g7,y7,x7,S7,T7,E7,C7,A7,b7,P7,R7,w7,I7,D7,O7,M7,N7,L7,B7,F7,z7,U7,k7,G7,H7,V7,j7,W7,q7,X7,Y7,K7,Q7,Z7,J7,$7,e9,t9,n9,i9,r9,o9,a9,s9,c9,l9,u9,h9,_9,f9,d9,p9,m9,v9,g9,y9,x9,S9,T9=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),E9=new Ln,C9=new Ln,A9=new dn,b9=null,P9=0,R9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++P9,t}u(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===_7.ANY?this._createTextArea():this._createInput(),d7.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),d7.remove(this),b9===this&&(b9=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,d7.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){b9&&b9!==this&&b9.setFocus(!1),this._editing=!0,b9=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){T.GAME_VIEW&&this._edTxt?(T.gameView.container.appendChild(this._edTxt),T.gameView.head.appendChild(this._placeholderStyleSheet)):aM.container&&this._edTxt&&(aM.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(T.GAME_VIEW?st(T.gameView.container,this._edTxt):st(aM.container,this._edTxt))&&this._edTxt&&(T.GAME_VIEW?T.gameView.container.removeChild(this._edTxt):aM.container.removeChild(this._edTxt)),(T.GAME_VIEW?st(T.gameView.head,this._placeholderStyleSheet):st(document.head,this._placeholderStyleSheet))&&(T.GAME_VIEW?T.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),qu.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),qu.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){qu.os!==Vl.ANDROID&&qu.os!==Vl.OHOS||(Vu.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){qu.os!==Vl.ANDROID&&qu.os!==Vl.OHOS||(Vu.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){qu.browserType!==kl.WECHAT||qu.os!==Vl.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=fM.getScaleX(),n=fM.getScaleY(),i=1,r=1;T.GAME_VIEW&&(i=T.gameView.canvas.width/T.game.canvas.width,r=T.gameView.canvas.height/T.game.canvas.height),t*=i,n*=r;var o=fM.getViewportRect(),a=Vu.devicePixelRatio;e.getWorldMatrix(E9);var s=e._uiProps.uiTransformComp;if(s&&dn.set(A9,-s.anchorX*s.width,-s.anchorY*s.height,A9.z),Ln.transform(E9,E9,A9),e._uiProps.uiTransformComp){var c=bM.root.batcher2D.getFirstRenderCamera(e);if(c){c.node.getWorldRT(C9);var l=C9.m12,u=C9.m13,h=OO.center;C9.m12=h.x-(C9.m00*l+C9.m04*u),C9.m13=h.y-(C9.m01*l+C9.m05*u),Ln.multiply(C9,C9,E9),t/=a,n/=a;var _=T.GAME_VIEW?T.gameView.container:aM.container,f=C9.m00*t,d=E9.m01,p=E9.m04,m=C9.m05*n,v=parseInt(_&&_.style.paddingLeft||"0");v+=o.x*i/a;var g=parseInt(_&&_.style.paddingBottom||"0");g+=o.y/a;var y="matrix("+f+","+-d+","+-p+","+m+","+(C9.m12*t+v)+","+-(C9.m13*n+g)+")";this._edTxt.style.transform=y,this._edTxt.style["-webkit-transform"]=y,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===f7.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===f7.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===f7.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===_7.EMAIL_ADDR?a="email":t===_7.NUMERIC||t===_7.DECIMAL?a="number":t===_7.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===_7.URL?a="url":(a="text",i===h7.SEARCH&&(a="search")),r.type=a;var s="none";n===f7.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===f7.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof jG?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case Lj.HorizontalAlign.LEFT:i.style.textAlign="left";break;case Lj.HorizontalAlign.CENTER:i.style.textAlign="center";break;case Lj.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof jG?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case Lj.HorizontalAlign.LEFT:a="left";break;case Lj.HorizontalAlign.CENTER:a="center";break;case Lj.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",qu.browserType===kl.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&qu.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===UO.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===UO.TAB&&(n.propagationStopped=!0,n.preventDefault(),d7.next(e))},i.onBlur=function(){qu.isMobile&&n&&i.compositionEnd(),e._editing=!1,b9=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}(T9);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(S9||(S9={}));var w9,I9,D9,O9,M9,N9,L9,B9,F9,z9,U9,k9,G9,H9,V9,j9,W9,q9,X9,Y9,K9,Q9,Z9,J9,$9,eee,tee,nee,iee,ree,oee,aee,see,cee,lee,uee,hee,_ee,fee,dee,pee,mee,vee,gee,yee,xee,See,Tee,Eee,Cee,Aee,bee,Pee,Ree,wee,Iee,Dee,Oee,Mee,Nee,Lee,Bee=e("EditBox",(p7=$s("cc.EditBox"),m7=pc(),v7=tc(110),g7=hc(),y7=ec(QH),x7=bc(),S7=xc(),T7=bc(),E7=xc(),C7=Mc(Lj),A7=bc(),b7=xc(),P7=Mc(Lj),R7=bc(),w7=xc(),I7=Mc(EG),D7=bc(),O7=xc(),M7=Mc(f7),N7=bc(),L7=xc(),B7=Mc(_7),F7=bc(),z7=xc(),U7=Mc(h7),k7=bc(),G7=xc(),H7=bc(),V7=xc(),j7=bc(),W7=xc(),q7=Mc([eB]),X7=bc(),Y7=xc(),K7=Mc([eB]),Q7=bc(),Z7=xc(),J7=Mc([eB]),$7=bc(),e9=xc(),t9=Mc([eB]),n9=bc(),i9=xc(),p7(r9=m7(r9=v7(r9=g7(r9=y7(r9=uc((x9=y9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",a9,m(t)),y(t,"textChanged",s9,m(t)),y(t,"editingDidEnded",c9,m(t)),y(t,"editingReturn",l9,m(t)),t._impl=null,t._background=null,y(t,"_textLabel",u9,m(t)),y(t,"_placeholderLabel",h9,m(t)),y(t,"_returnType",_9,m(t)),y(t,"_string",f9,m(t)),y(t,"_tabIndex",d9,m(t)),y(t,"_backgroundImage",p9,m(t)),y(t,"_inputFlag",m9,m(t)),y(t,"_inputMode",v9,m(t)),y(t,"_maxLength",g9,m(t)),t._isLabelVisible=!1,t}u(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){eB.emitEvents(this.editingDidBegan,this),this.node.emit(S9.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){eB.emitEvents(this.editingDidEnded,this),this.node.emit(S9.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,eB.emitEvents(this.textChanged,e,this),this.node.emit(S9.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){eB.emitEvents(this.editingReturn,this),this.node.emit(S9.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(xE.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(EX);e||(e=this.node.addComponent(EX)),e!==this._background&&(e.type=EX.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||((t=new TA("TEXT_LABEL")).layer=this.node.layer),(e=t.getComponent(Lj))||(e=t.addComponent(Lj)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=Lj.Overflow.CLAMP,this._inputMode===_7.ANY?(e.verticalAlign=Dj.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||((t=new TA("PLACEHOLDER_LABEL")).layer=this.node.layer),(e=t.getComponent(Lj))||(e=t.addComponent(Lj)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=Lj.Overflow.CLAMP,this._inputMode===_7.ANY?(e.verticalAlign=Dj.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==f7.PASSWORD)i===f7.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===f7.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===f7.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=e.length,a=0;a<o;++a)r+="";e=r}return e},n._registerEvent=function(){this.node.on(xE.TOUCH_START,this._onTouchBegan,this),this.node.on(xE.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(xE.TOUCH_START,this._onTouchBegan,this),this.node.off(xE.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(EX.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(EX.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(n+2,i+e.height,o.node.position.z),this._inputMode===_7.ANY&&(o.verticalAlign=Dj.TOP),o.enableWrapText=this._inputMode===_7.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),this._inputMode===_7.ANY&&(r.verticalAlign=Dj.TOP),r.enableWrapText=this._inputMode===_7.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize),this._syncSize()},c(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(Bu),y9._EditBoxImpl=T9,y9.KeyboardReturnType=h7,y9.InputFlag=f7,y9.InputMode=_7,y9.EventType=S9,x((o9=x9).prototype,"string",[x7,S7],Object.getOwnPropertyDescriptor(o9.prototype,"string"),o9.prototype),x(o9.prototype,"placeholder",[T7,E7],Object.getOwnPropertyDescriptor(o9.prototype,"placeholder"),o9.prototype),x(o9.prototype,"textLabel",[C7,A7,b7],Object.getOwnPropertyDescriptor(o9.prototype,"textLabel"),o9.prototype),x(o9.prototype,"placeholderLabel",[P7,R7,w7],Object.getOwnPropertyDescriptor(o9.prototype,"placeholderLabel"),o9.prototype),x(o9.prototype,"backgroundImage",[I7,D7,O7],Object.getOwnPropertyDescriptor(o9.prototype,"backgroundImage"),o9.prototype),x(o9.prototype,"inputFlag",[M7,N7,L7],Object.getOwnPropertyDescriptor(o9.prototype,"inputFlag"),o9.prototype),x(o9.prototype,"inputMode",[B7,F7,z7],Object.getOwnPropertyDescriptor(o9.prototype,"inputMode"),o9.prototype),x(o9.prototype,"returnType",[U7,k7,G7],Object.getOwnPropertyDescriptor(o9.prototype,"returnType"),o9.prototype),x(o9.prototype,"maxLength",[H7,V7],Object.getOwnPropertyDescriptor(o9.prototype,"maxLength"),o9.prototype),x(o9.prototype,"tabIndex",[j7,W7],Object.getOwnPropertyDescriptor(o9.prototype,"tabIndex"),o9.prototype),a9=x(o9.prototype,"editingDidBegan",[q7,oc,X7,Y7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),s9=x(o9.prototype,"textChanged",[K7,oc,Q7,Z7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c9=x(o9.prototype,"editingDidEnded",[J7,oc,$7,e9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),l9=x(o9.prototype,"editingReturn",[t9,oc,n9,i9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u9=x(o9.prototype,"_textLabel",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h9=x(o9.prototype,"_placeholderLabel",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_9=x(o9.prototype,"_returnType",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return h7.DEFAULT}}),f9=x(o9.prototype,"_string",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),d9=x(o9.prototype,"_tabIndex",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),p9=x(o9.prototype,"_backgroundImage",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m9=x(o9.prototype,"_inputFlag",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f7.DEFAULT}}),v9=x(o9.prototype,"_inputMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _7.ANY}}),g9=x(o9.prototype,"_maxLength",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),r9=o9))||r9)||r9)||r9)||r9)||r9)||r9));"object"==typeof window&&"object"==typeof document&&(Bee._EditBoxImpl=R9),T.internal.EditBox=Bee,function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(Iee||(Iee={})),Ze(Iee),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(Dee||(Dee={})),Ze(Dee),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Oee||(Oee={})),Ze(Oee),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(Mee||(Mee={})),Ze(Mee),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Nee||(Nee={})),Ze(Nee),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(Lee||(Lee={})),Ze(Lee);var Fee,zee,Uee,kee,Gee,Hee,Vee,jee,Wee,qee,Xee,Yee,Kee,Qee,Zee,Jee,$ee,ete,tte,nte,ite,rte,ote,ate=new dn,ste=e("Layout",(w9=$s("cc.Layout"),I9=pc(),D9=tc(110),O9=hc(),M9=ec(QH),N9=vc(),L9=xc(),B9=vc(),F9=xc(),z9=Mc(Iee),U9=bc(),k9=xc(),G9=Mc(Dee),H9=vc(),V9=xc(),j9=vc(),W9=xc(),q9=Mc(Oee),X9=xc(),Y9=xc(),K9=xc(),Q9=xc(),Z9=xc(),J9=xc(),$9=xc(),eee=Mc(Mee),tee=xc(),nee=Mc(Nee),iee=xc(),ree=Mc(Lee),oee=vc(),aee=xc(),see=vc(),cee=xc(),lee=xc(),w9(uee=I9(uee=D9(uee=O9(uee=M9(uee=uc((wee=Ree=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",_ee,m(t)),y(t,"_layoutType",fee,m(t)),y(t,"_cellSize",dee,m(t)),y(t,"_startAxis",pee,m(t)),y(t,"_paddingLeft",mee,m(t)),y(t,"_paddingRight",vee,m(t)),y(t,"_paddingTop",gee,m(t)),y(t,"_paddingBottom",yee,m(t)),y(t,"_spacingX",xee,m(t)),y(t,"_spacingY",See,m(t)),y(t,"_verticalDirection",Tee,m(t)),y(t,"_horizontalDirection",Eee,m(t)),y(t,"_constraint",Cee,m(t)),y(t,"_constraintNum",Aee,m(t)),y(t,"_affectedByScale",bee,m(t)),y(t,"_isAlign",Pee,m(t)),t._layoutSize=new kn(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}u(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(kn.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){bM.on(AM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(xE.SIZE_CHANGED,this._resized,this),this.node.on(xE.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(xE.CHILD_ADDED,this._childAdded,this),this.node.on(xE.CHILD_REMOVED,this._childRemoved,this),this.node.on(xE.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){bM.off(AM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(xE.SIZE_CHANGED,this._resized,this),this.node.off(xE.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(xE.CHILD_ADDED,this._childAdded,this),this.node.off(xE.CHILD_REMOVED,this._childRemoved,this),this.node.off(xE.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(xE.SIZE_CHANGED,this._doLayoutDirty,this),n.on(xE.TRANSFORM_CHANGED,this._transformDirty,this),n.on(xE.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(xE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(xE.SIZE_CHANGED,this._doLayoutDirty,this),n.off(xE.TRANSFORM_CHANGED,this._transformDirty,this),n.off(xE.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(xE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(e){e.on(xE.SIZE_CHANGED,this._doLayoutDirty,this),e.on(xE.TRANSFORM_CHANGED,this._transformDirty,this),e.on(xE.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(xE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(xE.SIZE_CHANGED,this._doLayoutDirty,this),e.off(xE.TRANSFORM_CHANGED,this._transformDirty,this),e.off(xE.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(xE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===Nee.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==Iee.GRID&&this._resizeMode===Dee.CHILDREN&&(m=(e-v-(p-1)*this._spacingX)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,T=S.scale,E=this._getUsedScaleValue(T.x),C=this._getUsedScaleValue(T.y);this._resizeMode===Dee.CHILDREN&&(x.width=m/E,this._layoutType===Iee.GRID&&(x.height=this._cellSize.height/C));var A=Math.abs(this._horizontalDirection-x.anchorX),b=x.width*E,P=x.height*C;P>_&&(f=Math.max(_,f),h=_||P,_=P),l+=a*(A*b+this._spacingX);var R=a*(1-A)*b;if(t){if(o>0)(d=y/o>0&&y%o==0)&&(h=_>P?_:h);else if(b>e-v)l>c+a*A*b&&(d=!0);else{var w=(1-this._horizontalDirection-r.x)*e,I=l+R+a*(a>0?this._paddingRight:this._paddingLeft);d=Math.abs(I)>Math.abs(w)}d&&(l=c+a*A*b,P!==_&&(h=_),u+=h+this._spacingY,h=_=P)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=R}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===Mee.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==Iee.GRID&&this._resizeMode===Dee.CHILDREN&&(m=(e-v-(p-1)*this._spacingY)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,T=S.scale,E=this._getUsedScaleValue(T.x),C=this._getUsedScaleValue(T.y);this._resizeMode===Dee.CHILDREN&&(x.height=m/C,this._layoutType===Iee.GRID&&(x.width=this._cellSize.width/E));var A=Math.abs(this._verticalDirection-x.anchorY),b=x.width*E,P=x.height*C;b>u&&(h=Math.max(u,h),_=u||b,u=b),l+=a*(A*P+this._spacingY);var R=a*(1-A)*P;if(t){if(o>0)(d=y/o>0&&y%o==0)&&(_=u>P?u:_);else if(P>e-v)l>c+a*A*P&&(d=!0);else{var w=(1-this._verticalDirection-r.y)*e,I=l+R+a*(a>0?this._paddingTop:this._paddingBottom);d=Math.abs(I)>Math.abs(w)}d&&(l=c+a*A*P,b!==u&&(_=u),f+=_+this._spacingX,_=u=b)}var D=n(S,x,f);i&&(S.getPosition(ate),S.setPosition(D,l,ate.z)),l+=R}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,o=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===Mee.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*t.height,a=this._paddingTop);var s=function(e,t,i){return o+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+a)},c=0;this._resizeMode===Dee.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-e.y*c,this._verticalDirection===Mee.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===Dee.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,o=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===Nee.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*t.width,a=this._paddingRight);var s=function(e,t,i){return o+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+a)},c=0;this._resizeMode===Dee.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-e.x*c,this._horizontalDirection===Nee.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===Dee.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===Oee.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===Oee.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===Dee.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===Dee.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===Iee.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?dn.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===Iee.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?dn.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===Iee.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&wg.SCALE&&e&wg.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==Iee.GRID||this._constraint===Lee.NONE||this._constraintNum<=0)return 0;var e=this._constraint===Lee.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===Oee.VERTICAL&&(e=this._constraint===Lee.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},c(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===Iee.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===Iee.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==Iee.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==Iee.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==Lee.NONE&&this._constraintNum!==e&&(e<=0&&M("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(Bu),Ree.Type=Iee,Ree.VerticalDirection=Mee,Ree.HorizontalDirection=Nee,Ree.ResizeMode=Dee,Ree.AxisDirection=Oee,Ree.Constraint=Lee,x((hee=wee).prototype,"alignHorizontal",[N9,L9],Object.getOwnPropertyDescriptor(hee.prototype,"alignHorizontal"),hee.prototype),x(hee.prototype,"alignVertical",[B9,F9],Object.getOwnPropertyDescriptor(hee.prototype,"alignVertical"),hee.prototype),x(hee.prototype,"type",[z9,U9,k9],Object.getOwnPropertyDescriptor(hee.prototype,"type"),hee.prototype),x(hee.prototype,"resizeMode",[G9,H9,V9],Object.getOwnPropertyDescriptor(hee.prototype,"resizeMode"),hee.prototype),x(hee.prototype,"cellSize",[j9,W9],Object.getOwnPropertyDescriptor(hee.prototype,"cellSize"),hee.prototype),x(hee.prototype,"startAxis",[q9,X9],Object.getOwnPropertyDescriptor(hee.prototype,"startAxis"),hee.prototype),x(hee.prototype,"paddingLeft",[Y9],Object.getOwnPropertyDescriptor(hee.prototype,"paddingLeft"),hee.prototype),x(hee.prototype,"paddingRight",[K9],Object.getOwnPropertyDescriptor(hee.prototype,"paddingRight"),hee.prototype),x(hee.prototype,"paddingTop",[Q9],Object.getOwnPropertyDescriptor(hee.prototype,"paddingTop"),hee.prototype),x(hee.prototype,"paddingBottom",[Z9],Object.getOwnPropertyDescriptor(hee.prototype,"paddingBottom"),hee.prototype),x(hee.prototype,"spacingX",[J9],Object.getOwnPropertyDescriptor(hee.prototype,"spacingX"),hee.prototype),x(hee.prototype,"spacingY",[$9],Object.getOwnPropertyDescriptor(hee.prototype,"spacingY"),hee.prototype),x(hee.prototype,"verticalDirection",[eee,tee],Object.getOwnPropertyDescriptor(hee.prototype,"verticalDirection"),hee.prototype),x(hee.prototype,"horizontalDirection",[nee,iee],Object.getOwnPropertyDescriptor(hee.prototype,"horizontalDirection"),hee.prototype),x(hee.prototype,"constraint",[ree,oee,aee],Object.getOwnPropertyDescriptor(hee.prototype,"constraint"),hee.prototype),x(hee.prototype,"constraintNum",[see,cee],Object.getOwnPropertyDescriptor(hee.prototype,"constraintNum"),hee.prototype),x(hee.prototype,"affectedByScale",[lee],Object.getOwnPropertyDescriptor(hee.prototype,"affectedByScale"),hee.prototype),_ee=x(hee.prototype,"_resizeMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dee.NONE}}),fee=x(hee.prototype,"_layoutType",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Iee.NONE}}),dee=x(hee.prototype,"_cellSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kn(40,40)}}),pee=x(hee.prototype,"_startAxis",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oee.HORIZONTAL}}),mee=x(hee.prototype,"_paddingLeft",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vee=x(hee.prototype,"_paddingRight",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gee=x(hee.prototype,"_paddingTop",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yee=x(hee.prototype,"_paddingBottom",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xee=x(hee.prototype,"_spacingX",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),See=x(hee.prototype,"_spacingY",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tee=x(hee.prototype,"_verticalDirection",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mee.TOP_TO_BOTTOM}}),Eee=x(hee.prototype,"_horizontalDirection",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nee.LEFT_TO_RIGHT}}),Cee=x(hee.prototype,"_constraint",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lee.NONE}}),Aee=x(hee.prototype,"_constraintNum",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),bee=x(hee.prototype,"_affectedByScale",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pee=x(hee.prototype,"_isAlign",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uee=hee))||uee)||uee)||uee)||uee)||uee)||uee));T.Layout=ste,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(ote||(ote={})),Ye(ote);var cte,lte,ute,hte,_te,fte,dte,pte,mte,vte,gte,yte,xte,Ste,Tte,Ete,Cte,Ate,bte,Pte,Rte,wte,Ite,Dte,Ote=e("ProgressBar",(Fee=$s("cc.ProgressBar"),zee=pc(),Uee=tc(110),kee=hc(),Gee=ec(QH),Hee=Mc(EX),Vee=xc(),jee=Mc(ote),Wee=xc(),qee=xc(),Xee=Sc(),Yee=xc(),Kee=xc(),Fee(Qee=zee(Qee=Uee(Qee=kee(Qee=Gee((rte=ite=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",Jee,m(t)),y(t,"_mode",$ee,m(t)),y(t,"_totalLength",ete,m(t)),y(t,"_progress",tte,m(t)),y(t,"_reverse",nte,m(t)),t}u(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===EX.FillType.RADIAL&&(this._mode=ote.FILLED),this._mode===ote.HORIZONTAL?this.totalLength=r.width:this._mode===ote.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var o=-n.width*i.x;e.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),o=new gn(0,.5),a=Qt(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case ote.HORIZONTAL:this._reverse&&(o=new gn(1,.5)),c=new kn(s,i.height),l=this._totalLength,u=i.height;break;case ote.VERTICAL:o=this._reverse?new gn(.5,1):new gn(.5,0),c=new kn(i.width,s),l=i.width,u=this._totalLength}if(this._mode===ote.FILLED)this._barSprite.type!==EX.Type.FILLED?M("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==EX.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new dn(l*h,u*_,0);e.setPosition(r.x+f.x,r.y+f.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)}else M("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},c(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===ote.HORIZONTAL?this.totalLength=n.width:this._mode===ote.VERTICAL?this.totalLength=n.height:this._mode===ote.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===ote.FILLED&&(e=Qt(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(Bu),ite.Mode=ote,x((Zee=rte).prototype,"barSprite",[Hee,Vee],Object.getOwnPropertyDescriptor(Zee.prototype,"barSprite"),Zee.prototype),x(Zee.prototype,"mode",[jee,Wee],Object.getOwnPropertyDescriptor(Zee.prototype,"mode"),Zee.prototype),x(Zee.prototype,"totalLength",[qee],Object.getOwnPropertyDescriptor(Zee.prototype,"totalLength"),Zee.prototype),x(Zee.prototype,"progress",[Xee,Ac,Yee],Object.getOwnPropertyDescriptor(Zee.prototype,"progress"),Zee.prototype),x(Zee.prototype,"reverse",[Kee],Object.getOwnPropertyDescriptor(Zee.prototype,"reverse"),Zee.prototype),Jee=x(Zee.prototype,"_barSprite",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$ee=x(Zee.prototype,"_mode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ote.HORIZONTAL}}),ete=x(Zee.prototype,"_totalLength",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tte=x(Zee.prototype,"_progress",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),nte=x(Zee.prototype,"_reverse",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qee=Zee))||Qee)||Qee)||Qee)||Qee)||Qee));T.ProgressBar=Ote;var Mte,Nte=new dn,Lte=new dn,Bte=new dn,Fte=new gn,zte=new Wn,Ute=new gn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Mte||(Mte={})),Ze(Mte);var kte,Gte=e("ScrollBar",(cte=$s("cc.ScrollBar"),lte=pc(),ute=tc(110),hte=hc(),_te=ec(QH),fte=Mc(EX),dte=bc(),pte=xc(),mte=Mc(Mte),vte=bc(),gte=xc(),yte=bc(),xte=xc(),Ste=bc(),Tte=xc(),cte(Ete=lte(Ete=ute(Ete=hte(Ete=_te((Dte=Ite=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",Ate,m(t)),y(t,"_handle",bte,m(t)),y(t,"_direction",Pte,m(t)),y(t,"_enableAutoHide",Rte,m(t)),y(t,"_autoHideTime",wte,m(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}u(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=Ute;u.set(0,0),this._direction===Mte.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===Mte.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(o,a,l,s),_=Ute;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(EX);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){Nte.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(Nte,Lte);var r=n.convertToNodeSpaceAR(Lte);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(gn.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(EX);t&&(zte.set(t.color),zte.a=e,t.color=zte),(t=this._handle.getComponent(EX))&&(zte.set(t.color),zte.a=e,t.color=zte)}},n._updateHandlerPosition=function(e){if(this._handle){var t=Bte;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;dn.set(Nte,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(Nte,Lte),s=e;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===Mte.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===Mte.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===Mte.HORIZONTAL||e.height<=t.height&&this._direction===Mte.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,o,a){var s=t-n;o&&(s+=Math.abs(o));var c=0;s&&(c=Qt(c=r/s));var l=(i-a)*c;this._direction===Mte.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===Fte.x&&i.y===Fte.y||t.setAnchorPoint(Fte),this._direction===Mte.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},c(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(gn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(gn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(Bu),Ite.Direction=Mte,x((Cte=Dte).prototype,"handle",[fte,dte,pte],Object.getOwnPropertyDescriptor(Cte.prototype,"handle"),Cte.prototype),x(Cte.prototype,"direction",[mte,vte,gte],Object.getOwnPropertyDescriptor(Cte.prototype,"direction"),Cte.prototype),x(Cte.prototype,"enableAutoHide",[yte,xte],Object.getOwnPropertyDescriptor(Cte.prototype,"enableAutoHide"),Cte.prototype),x(Cte.prototype,"autoHideTime",[Ste,Tte],Object.getOwnPropertyDescriptor(Cte.prototype,"autoHideTime"),Cte.prototype),Ate=x(Cte.prototype,"_scrollView",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bte=x(Cte.prototype,"_handle",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pte=x(Cte.prototype,"_direction",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mte.HORIZONTAL}}),Rte=x(Cte.prototype,"_enableAutoHide",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wte=x(Cte.prototype,"_autoHideTime",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ete=Cte))||Ete)||Ete)||Ete)||Ete)||Ete));T.ScrollBar=Gte;var Hte,Vte,jte,Wte,qte,Xte,Yte,Kte,Qte,Zte,Jte,$te,ene,tne,nne,ine,rne,one,ane,sne,cne,lne,une,hne,_ne,fne,dne,pne,mne,vne,gne,yne,xne,Sne,Tne,Ene,Cne,Ane,bne,Pne,Rne,wne,Ine,Dne,One,Mne,Nne,Lne,Bne=e("ViewGroup",$s("cc.ViewGroup")(kte=tc(110)(kte=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(Bu))||kte)||kte);T.ViewGroup=Bne;var Fne,zne=1e-4,Une=new dn,kne=new dn,Gne=new gn,Hne=new gn,Vne=function(){return(new Date).getMilliseconds()},jne={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(Fne||(Fne={}));var Wne,qne,Xne,Yne,Kne,Qne,Zne,Jne,$ne,eie,tie,nie,iie,rie,oie,aie,sie,cie,lie,uie,hie,_ie=e("ScrollView",(Hte=$s("cc.ScrollView"),Vte=pc(),jte=tc(110),Wte=hc(),qte=ec(QH),Xte=Sc(),Yte=bc(),Kte=xc(),Qte=Sc(),Zte=bc(),Jte=xc(),$te=bc(),ene=xc(),tne=bc(),nne=xc(),ine=Mc(TA),rne=bc(),one=xc(),ane=bc(),sne=xc(),cne=Mc(Gte),lne=bc(),une=xc(),hne=bc(),_ne=xc(),fne=Mc(Gte),dne=bc(),pne=xc(),mne=bc(),vne=xc(),gne=Mc([eB]),yne=bc(),xne=xc(),Hte(Sne=Vte(Sne=jte(Sne=Wte(Sne=qte((Lne=Nne=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",Ene,m(t)),y(t,"brake",Cne,m(t)),y(t,"elastic",Ane,m(t)),y(t,"inertia",bne,m(t)),y(t,"horizontal",Pne,m(t)),y(t,"vertical",Rne,m(t)),y(t,"cancelInnerEvents",wne,m(t)),y(t,"scrollEvents",Ine,m(t)),t._autoScrolling=!1,t._scrolling=!1,y(t,"_content",Dne,m(t)),y(t,"_horizontalScrollBar",One,m(t)),y(t,"_verticalScrollBar",Mne,m(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new dn,t._autoScrollTargetDelta=new dn,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new dn,t._outOfBoundaryAmount=new dn,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new dn,t._deltaPos=new dn,t}u(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new gn(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new gn(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new gn(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new gn(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new gn(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new gn(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new gn(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new gn(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new gn(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new gn(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return gn.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new gn(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new gn(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new gn(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new gn(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<zne&&Math.abs(e.y-t.y)<zne||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):dn.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return zne},n.start=function(){this._calculateBoundary(),this._content&&bM.once(AM.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(xE.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(xE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(xE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(xE.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(xE.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(xE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(xE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(xE.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(xE.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(xE.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(xE.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(xE.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(xE.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(xE.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(xE.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(xE.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(xE.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(xE.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new dn,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(Gne);if(i.subtract(n.getUIStartLocation(Hne)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new zO(e.getTouches(),e.bubbles,vb.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(Fne.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent(ste);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==MO.CAPTURING_PHASE)return!1;if(t)for(var n,i=g(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(Bne));if(r.getComponent(Bne))return!0}return!1},n._startInertiaScroll=function(e){var t=new dn(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,dn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(dn.ZERO,zne)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new dn,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(dn.ZERO);else{var n=new dn;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);Une.set(this._getContentPosition()),Une.add(n),Une.set(Math.round(1e4*Une.x)*zne,Math.round(1e4*Une.y)*zne,Une.z),this._setContentPosition(Une);var i=this._getHowMuchOutOfBoundary();Gne.set(i.x,i.y),this._updateScrollBar(Gne),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new dn).equals(dn.ZERO,zne)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new dn,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):o+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(o+e.y)),e.equals(dn.ZERO,zne)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===Fne.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===Fne.SCROLL_TO_TOP||e===Fne.SCROLL_TO_BOTTOM||e===Fne.SCROLL_TO_LEFT||e===Fne.SCROLL_TO_RIGHT){var t=1<<jne[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}eB.emitEvents(this.scrollEvents,this,jne[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();Une.set(this._getContentPosition()),Une.add(e),this._content.setPosition(Une),this._updateScrollBar(gn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===MO.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(Fne.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new dn;n&&(t.getUILocation(Gne),t.getUIPreviousLocation(Hne),Une.set(Gne.x,Gne.y,0),kne.set(Hne.x,Hne.y,0),n.convertToNodeSpaceAR(Une,Une),n.convertToNodeSpaceAR(kne,kne),dn.subtract(i,Une,kne)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||dn.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=Fne.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=Fne.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=Fne.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=Fne.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(Fne.SCROLL_BEGAN)),this._dispatchEvent(Fne.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(Fne.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Vne(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=Vne();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(dn.ZERO,zne))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(Fne.BOUNCE_TOP),e.y<0&&this._dispatchEvent(Fne.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(Fne.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(Fne.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(Une,zne)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(dn.ZERO,zne)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=zne;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(Fne.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(dn.ZERO,zne)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(Fne.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(Fne.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(dn.ZERO,zne))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Fne.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Fne.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(gn.ZERO,gn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new dn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*t.x),i&&(s=c.height-l.height,a.y=r-s*t.y)}return a},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new dn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(i=o.height-e.height,n.y=t-i),o.width<e.width&&(i=o.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===wg.SCALE&&this._calculateBoundary()},c(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):G(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(gn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(gn.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(Bne),Nne.EventType=Fne,Ene=x((Tne=Lne).prototype,"bounceDuration",[oc,Xte,Yte,Kte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Cne=x(Tne.prototype,"brake",[oc,Qte,Zte,Jte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Ane=x(Tne.prototype,"elastic",[oc,$te,ene],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bne=x(Tne.prototype,"inertia",[oc,tne,nne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x(Tne.prototype,"content",[ine,rne,one],Object.getOwnPropertyDescriptor(Tne.prototype,"content"),Tne.prototype),Pne=x(Tne.prototype,"horizontal",[oc,ane,sne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x(Tne.prototype,"horizontalScrollBar",[cne,lne,une],Object.getOwnPropertyDescriptor(Tne.prototype,"horizontalScrollBar"),Tne.prototype),Rne=x(Tne.prototype,"vertical",[oc,hne,_ne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x(Tne.prototype,"verticalScrollBar",[fne,dne,pne],Object.getOwnPropertyDescriptor(Tne.prototype,"verticalScrollBar"),Tne.prototype),wne=x(Tne.prototype,"cancelInnerEvents",[oc,mne,vne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ine=x(Tne.prototype,"scrollEvents",[gne,oc,yne,xne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dne=x(Tne.prototype,"_content",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),One=x(Tne.prototype,"_horizontalScrollBar",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mne=x(Tne.prototype,"_verticalScrollBar",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sne=Tne))||Sne)||Sne)||Sne)||Sne)||Sne));T.ScrollView=_ie;var fie,die=new dn;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(fie||(fie={})),Ze(fie);var pie,mie,vie,gie,yie,xie,Sie,Tie,Eie,Cie,Aie,bie,Pie,Rie,wie,Iie,Die,Oie,Mie,Nie,Lie=e("Slider",(Wne=$s("cc.Slider"),qne=pc(),Xne=tc(110),Yne=hc(),Kne=ec(QH),Qne=Mc(EX),Zne=xc(),Jne=Mc(fie),$ne=xc(),eie=Sc(),tie=xc(),nie=Mc([eB]),iie=xc(),Wne(rie=qne(rie=Xne(rie=Yne(rie=Kne((hie=uie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",aie,m(t)),y(t,"_handle",sie,m(t)),y(t,"_direction",cie,m(t)),y(t,"_progress",lie,m(t)),t._offset=new dn,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new dn,t._touchPos=new dn,t}u(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(xE.TOUCH_START,this._onTouchBegan,this),this.node.on(xE.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(xE.TOUCH_END,this._onTouchEnded,this),this.node.on(xE.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(xE.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(xE.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(xE.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(xE.TOUCH_START,this._onTouchBegan,this),this.node.off(xE.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(xE.TOUCH_END,this._onTouchEnded,this),this.node.off(xE.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(xE.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(xE.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(xE.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();dn.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new dn,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){eB.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();dn.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,die);this.direction===fie.Horizontal?this.progress=Qt(.5+(i.x-this._offset.x)/n.width):this.progress=Qt(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===fie.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===fie.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},c(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(Bu),uie.Direction=fie,x((oie=hie).prototype,"handle",[Qne,Zne],Object.getOwnPropertyDescriptor(oie.prototype,"handle"),oie.prototype),x(oie.prototype,"direction",[Jne,$ne],Object.getOwnPropertyDescriptor(oie.prototype,"direction"),oie.prototype),x(oie.prototype,"progress",[Ac,eie,tie],Object.getOwnPropertyDescriptor(oie.prototype,"progress"),oie.prototype),aie=x(oie.prototype,"slideEvents",[nie,oc,iie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sie=x(oie.prototype,"_handle",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cie=x(oie.prototype,"_direction",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fie.Horizontal}}),lie=x(oie.prototype,"_progress",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),rie=oie))||rie)||rie)||rie)||rie)||rie));function Bie(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}T.Slider=Lie,function(e){e.TOGGLE="toggle"}(Nie||(Nie={}));var Fie,zie,Uie,kie,Gie,Hie,Vie,jie,Wie,qie,Xie,Yie,Kie=e("Toggle",(pie=$s("cc.Toggle"),mie=pc(),vie=tc(110),gie=hc(),yie=ec(QH),xie=bc(),Sie=xc(),Tie=Mc(EX),Eie=bc(),Cie=xc(),Aie=Mc([eB]),bie=xc(),pie(Pie=mie(Pie=vie(Pie=gie(Pie=yie((Mie=Oie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",wie,m(t)),y(t,"_isChecked",Iie,m(t)),y(t,"_checkMark",Die,m(t)),t}u(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&eB.emitEvents(this.checkEvents,this)},c(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return T.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(u7),Oie.EventType=Bie(Nie,c7),x((Rie=Mie).prototype,"isChecked",[xie,Sie],Object.getOwnPropertyDescriptor(Rie.prototype,"isChecked"),Rie.prototype),x(Rie.prototype,"checkMark",[Tie,Eie,Cie],Object.getOwnPropertyDescriptor(Rie.prototype,"checkMark"),Rie.prototype),wie=x(Rie.prototype,"checkEvents",[Aie,oc,bie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Iie=x(Rie.prototype,"_isChecked",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Die=x(Rie.prototype,"_checkMark",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pie=Rie))||Pie)||Pie)||Pie)||Pie)||Pie));T.Toggle=Kie;var Qie,Zie,Jie,$ie,ere,tre,nre,ire,rre,ore,are,sre,cre,lre,ure,hre,_re,fre,dre,pre,mre,vre,gre,yre,xre,Sre,Tre,Ere,Cre,Are,bre,Pre,Rre,wre,Ire,Dre,Ore,Mre,Nre,Lre,Bre,Fre,zre,Ure,kre,Gre=e("ToggleContainer",(Fie=$s("cc.ToggleContainer"),zie=pc(),Uie=tc(110),kie=hc(),Gie=xc(),Hie=Mc([eB]),Vie=xc(),Fie(jie=zie(jie=Uie(jie=kie(jie=uc((Yie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",qie,m(t)),y(t,"checkEvents",Xie,m(t)),t}u(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(xE.CHILD_ADDED,this.ensureValidState,this),this.node.on(xE.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(xE.CHILD_ADDED,this.ensureValidState,this),this.node.off(xE.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==e&&(t?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&T.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},c(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(Bu),qie=x((Wie=Yie).prototype,"_allowSwitchOff",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x(Wie.prototype,"allowSwitchOff",[Gie],Object.getOwnPropertyDescriptor(Wie.prototype,"allowSwitchOff"),Wie.prototype),Xie=x(Wie.prototype,"checkEvents",[Hie,oc,Vie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jie=Wie))||jie)||jie)||jie)||jie)||jie));T.ToggleContainer=Gre;var Hre,Vre,jre=new gn;function Wre(e){return e instanceof CI?OO:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:kn.ZERO}function qre(e,t,n,i){e.parent?jre.set(e.parent.getScale().x,e.parent.getScale().y):jre.set(0,0);for(var r=jre.x,o=jre.y,a=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?jre.set(c.getScale().x,c.getScale().y):jre.set(0,0);var u=jre.x,h=jre.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(Hre||(Hre={})),Ze(Hre),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(Vre||(Vre={}));var Xre,Yre,Kre,Qre,Zre,Jre,$re,eoe,toe,noe,ioe,roe,ooe,aoe,soe,coe,loe,uoe,hoe,_oe=Vre.TOP|Vre.BOT,foe=Vre.LEFT|Vre.RIGHT,doe=e("Widget",(Qie=$s("cc.Widget"),Zie=pc(),Jie=tc(110),$ie=hc(),ere=ec(QH),tre=Mc(TA),nre=xc(),ire=xc(),rre=xc(),ore=xc(),are=xc(),sre=xc(),cre=xc(),lre=vc(),ure=vc(),hre=xc(),_re=xc(),fre=xc(),dre=xc(),pre=xc(),mre=xc(),vre=Mc(Hre),gre=xc(),Qie(yre=Zie(yre=Jie(yre=$ie(yre=ere(yre=uc((kre=Ure=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new dn,t._lastSize=new kn,t._dirty=!0,t._hadAlignOnce=!1,y(t,"_alignFlags",Sre,m(t)),y(t,"_target",Tre,m(t)),y(t,"_left",Ere,m(t)),y(t,"_right",Cre,m(t)),y(t,"_top",Are,m(t)),y(t,"_bottom",bre,m(t)),y(t,"_horizontalCenter",Pre,m(t)),y(t,"_verticalCenter",Rre,m(t)),y(t,"_isAbsLeft",wre,m(t)),y(t,"_isAbsRight",Ire,m(t)),y(t,"_isAbsTop",Dre,m(t)),y(t,"_isAbsBottom",Ore,m(t)),y(t,"_isAbsHorizontalCenter",Mre,m(t)),y(t,"_isAbsVerticalCenter",Nre,m(t)),y(t,"_originalWidth",Lre,m(t)),y(t,"_originalHeight",Bre,m(t)),y(t,"_alignMode",Fre,m(t)),y(t,"_lockFlags",zre,m(t)),t}u(t,e);var n=t.prototype;return n.updateAlignment=function(){T._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),T._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){T._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(xE.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(xE.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(xE.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(xE.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(xE.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(xE.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(xE.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(xE.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:OO;this.isAlignLeft&&e===Vre.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===Vre.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===Vre.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===Vre.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===Vre.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===Vre.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(QH)&&(e.on(xE.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(xE.SIZE_CHANGED,this._setDirtyByMode,this),e.on(xE.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(xE.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(xE.SIZE_CHANGED,this._setDirtyByMode,this),e.off(xE.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(xE.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(xE.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===Hre.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&foe)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},c(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&Vre.TOP)>0},set:function(e){this._setAlign(Vre.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&Vre.BOT)>0},set:function(e){this._setAlign(Vre.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&Vre.LEFT)>0},set:function(e){this._setAlign(Vre.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&Vre.RIGHT)>0},set:function(e){this._setAlign(Vre.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&Vre.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=Vre.MID):this._alignFlags&=~Vre.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&Vre.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=Vre.CENTER):this._alignFlags&=~Vre.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&foe)===foe}},{key:"isStretchHeight",get:function(){return(this._alignFlags&_oe)===_oe}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(Vre.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(Vre.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(Vre.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(Vre.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(Vre.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(Vre.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(Bu),Ure.AlignMode=Hre,x((xre=kre).prototype,"target",[tre,nre],Object.getOwnPropertyDescriptor(xre.prototype,"target"),xre.prototype),x(xre.prototype,"isAlignTop",[ire],Object.getOwnPropertyDescriptor(xre.prototype,"isAlignTop"),xre.prototype),x(xre.prototype,"isAlignBottom",[rre],Object.getOwnPropertyDescriptor(xre.prototype,"isAlignBottom"),xre.prototype),x(xre.prototype,"isAlignLeft",[ore],Object.getOwnPropertyDescriptor(xre.prototype,"isAlignLeft"),xre.prototype),x(xre.prototype,"isAlignRight",[are],Object.getOwnPropertyDescriptor(xre.prototype,"isAlignRight"),xre.prototype),x(xre.prototype,"isAlignVerticalCenter",[sre],Object.getOwnPropertyDescriptor(xre.prototype,"isAlignVerticalCenter"),xre.prototype),x(xre.prototype,"isAlignHorizontalCenter",[cre],Object.getOwnPropertyDescriptor(xre.prototype,"isAlignHorizontalCenter"),xre.prototype),x(xre.prototype,"isStretchWidth",[lre],Object.getOwnPropertyDescriptor(xre.prototype,"isStretchWidth"),xre.prototype),x(xre.prototype,"isStretchHeight",[ure],Object.getOwnPropertyDescriptor(xre.prototype,"isStretchHeight"),xre.prototype),x(xre.prototype,"top",[hre],Object.getOwnPropertyDescriptor(xre.prototype,"top"),xre.prototype),x(xre.prototype,"editorTop",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"editorTop"),xre.prototype),x(xre.prototype,"bottom",[_re],Object.getOwnPropertyDescriptor(xre.prototype,"bottom"),xre.prototype),x(xre.prototype,"editorBottom",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"editorBottom"),xre.prototype),x(xre.prototype,"left",[fre],Object.getOwnPropertyDescriptor(xre.prototype,"left"),xre.prototype),x(xre.prototype,"editorLeft",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"editorLeft"),xre.prototype),x(xre.prototype,"right",[dre],Object.getOwnPropertyDescriptor(xre.prototype,"right"),xre.prototype),x(xre.prototype,"editorRight",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"editorRight"),xre.prototype),x(xre.prototype,"horizontalCenter",[pre],Object.getOwnPropertyDescriptor(xre.prototype,"horizontalCenter"),xre.prototype),x(xre.prototype,"editorHorizontalCenter",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"editorHorizontalCenter"),xre.prototype),x(xre.prototype,"verticalCenter",[mre],Object.getOwnPropertyDescriptor(xre.prototype,"verticalCenter"),xre.prototype),x(xre.prototype,"editorVerticalCenter",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"editorVerticalCenter"),xre.prototype),x(xre.prototype,"isAbsoluteTop",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"isAbsoluteTop"),xre.prototype),x(xre.prototype,"isAbsoluteBottom",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"isAbsoluteBottom"),xre.prototype),x(xre.prototype,"isAbsoluteLeft",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"isAbsoluteLeft"),xre.prototype),x(xre.prototype,"isAbsoluteRight",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"isAbsoluteRight"),xre.prototype),x(xre.prototype,"isAbsoluteHorizontalCenter",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"isAbsoluteHorizontalCenter"),xre.prototype),x(xre.prototype,"isAbsoluteVerticalCenter",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"isAbsoluteVerticalCenter"),xre.prototype),x(xre.prototype,"alignMode",[vre,gre],Object.getOwnPropertyDescriptor(xre.prototype,"alignMode"),xre.prototype),x(xre.prototype,"alignFlags",[mc],Object.getOwnPropertyDescriptor(xre.prototype,"alignFlags"),xre.prototype),Sre=x(xre.prototype,"_alignFlags",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tre=x(xre.prototype,"_target",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ere=x(xre.prototype,"_left",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cre=x(xre.prototype,"_right",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Are=x(xre.prototype,"_top",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bre=x(xre.prototype,"_bottom",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pre=x(xre.prototype,"_horizontalCenter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rre=x(xre.prototype,"_verticalCenter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wre=x(xre.prototype,"_isAbsLeft",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ire=x(xre.prototype,"_isAbsRight",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dre=x(xre.prototype,"_isAbsTop",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ore=x(xre.prototype,"_isAbsBottom",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Mre=x(xre.prototype,"_isAbsHorizontalCenter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Nre=x(xre.prototype,"_isAbsVerticalCenter",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Lre=x(xre.prototype,"_originalWidth",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bre=x(xre.prototype,"_originalHeight",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fre=x(xre.prototype,"_alignMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hre.ON_WINDOW_RESIZE}}),zre=x(xre.prototype,"_lockFlags",[oc,sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yre=xre))||yre)||yre)||yre)||yre)||yre)||yre));T.internal.computeInverseTransForTarget=qre,T.internal.getReadonlyNodeSize=Wre,T.Widget=doe;var poe,moe=new Wn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(poe||(poe={})),Ze(poe);var voe,goe,yoe,xoe,Soe,Toe,Eoe,Coe,Aoe,boe,Poe,Roe,woe,Ioe,Doe,Ooe,Moe,Noe,Loe,Boe,Foe,zoe,Uoe,koe,Goe,Hoe,Voe,joe,Woe,qoe,Xoe,Yoe,Koe,Qoe,Zoe,Joe,$oe,eae,tae,nae,iae,rae,oae,aae=e("PageViewIndicator",(Xre=$s("cc.PageViewIndicator"),Yre=pc(),Kre=tc(110),Qre=hc(),Zre=Mc(EG),Jre=xc(),$re=Mc(poe),eoe=xc(),toe=Mc(kn),noe=xc(),ioe=xc(),Xre(roe=Yre(roe=Kre(roe=Qre((hoe=uoe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"spacing",aoe,m(t)),y(t,"_spriteFrame",soe,m(t)),y(t,"_direction",coe,m(t)),y(t,"_cellSize",loe,m(t)),t._layout=null,t._pageView=null,t._indicators=[],t}u(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(ste),this._layout||(this._layout=this.addComponent(ste));var e=this._layout;this.direction===poe.HORIZONTAL?(e.type=ste.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===poe.VERTICAL&&(e.type=ste.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=ste.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new TA;e.layer=this.node.layer;var t=e.addComponent(EX);return t.spriteFrame=this.spriteFrame,t.sizeMode=EX.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;moe.set(r.color),moe.a=127.5,r.color=moe}}if(e[t]._uiProps.uiComp){var o=e[t]._uiProps.uiComp;moe.set(o.color),moe.a=255,o.color=moe}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},c(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(Bu),uoe.Direction=poe,x((ooe=hoe).prototype,"spriteFrame",[Zre,Jre],Object.getOwnPropertyDescriptor(ooe.prototype,"spriteFrame"),ooe.prototype),x(ooe.prototype,"direction",[$re,eoe],Object.getOwnPropertyDescriptor(ooe.prototype,"direction"),ooe.prototype),x(ooe.prototype,"cellSize",[toe,noe],Object.getOwnPropertyDescriptor(ooe.prototype,"cellSize"),ooe.prototype),aoe=x(ooe.prototype,"spacing",[oc,ioe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),soe=x(ooe.prototype,"_spriteFrame",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),coe=x(ooe.prototype,"_direction",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return poe.HORIZONTAL}}),loe=x(ooe.prototype,"_cellSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kn(20,20)}}),roe=ooe))||roe)||roe)||roe)||roe));T.PageViewIndicator=aae;var sae,cae,lae,uae=new gn;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(sae||(sae={})),Ze(sae),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(cae||(cae={})),Ze(cae),function(e){e.PAGE_TURNING="page-turning"}(lae||(lae={}));var hae=e("PageView",(voe=$s("cc.PageView"),goe=pc(),yoe=tc(110),xoe=hc(),Soe=Mc(sae),Toe=xc(),Eoe=Mc(cae),Coe=xc(),Aoe=Sc(),boe=xc(),Poe=Sc(),Roe=xc(),woe=Mc(aae),Ioe=xc(),Doe=xc(),Ooe=Mc(Gte),Moe=vc(),Noe=Mc(Gte),Loe=vc(),Boe=vc(),Foe=vc(),zoe=vc(),Uoe=Mc([eB]),koe=vc(),Goe=xc(),Hoe=Mc([eB]),Voe=xc(),voe(joe=goe(joe=yoe(joe=xoe((oae=rae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",qoe,m(t)),y(t,"horizontal",Xoe,m(t)),y(t,"vertical",Yoe,m(t)),y(t,"cancelInnerEvents",Koe,m(t)),y(t,"scrollEvents",Qoe,m(t)),y(t,"pageTurningSpeed",Zoe,m(t)),y(t,"pageEvents",Joe,m(t)),y(t,"_sizeMode",$oe,m(t)),y(t,"_direction",eae,m(t)),y(t,"_scrollThreshold",tae,m(t)),y(t,"_pageTurningEventTiming",nae,m(t)),y(t,"_indicator",iae,m(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new dn,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new gn,t._touchEndPosition=new gn,t}u(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(xE.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(xE.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):G(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void G(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):V(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent(ste);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===cae.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===sae.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(uae),gn.set(this._touchBeganPosition,uae.x,uae.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(uae),gn.set(this._touchEndPosition,uae.x,uae.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(uae),gn.set(this._touchEndPosition,uae.x,uae.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===cae.Horizontal,this.vertical=this.direction===cae.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(ste);if(t){if(this._sizeMode===sae.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===cae.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===cae.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,eB.emitEvents(this.pageEvents,this,lae.PAGE_TURNING),this.node.emit(lae.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===cae.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===cae.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new gn;if(this._sizeMode===sae.Free)this.direction===cae.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===cae.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===cae.Horizontal?t.x=e*n.width:this.direction===cae.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===cae.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===sae.Free){var i=0,r=0;if(this.direction===cae.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===cae.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===cae.Horizontal)return Math.abs(e.x)>=o.width*this.scrollThreshold;if(this.direction===cae.Vertical)return Math.abs(e.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new gn;gn.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},c(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(_ie),rae.SizeMode=sae,rae.Direction=cae,rae.EventType=Bie(lae,Fne),x((Woe=oae).prototype,"sizeMode",[Soe,Toe],Object.getOwnPropertyDescriptor(Woe.prototype,"sizeMode"),Woe.prototype),x(Woe.prototype,"direction",[Eoe,Coe],Object.getOwnPropertyDescriptor(Woe.prototype,"direction"),Woe.prototype),x(Woe.prototype,"scrollThreshold",[Ac,Aoe,boe],Object.getOwnPropertyDescriptor(Woe.prototype,"scrollThreshold"),Woe.prototype),x(Woe.prototype,"pageTurningEventTiming",[Ac,Poe,Roe],Object.getOwnPropertyDescriptor(Woe.prototype,"pageTurningEventTiming"),Woe.prototype),x(Woe.prototype,"indicator",[woe,Ioe],Object.getOwnPropertyDescriptor(Woe.prototype,"indicator"),Woe.prototype),qoe=x(Woe.prototype,"autoPageTurningThreshold",[oc,Doe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),x(Woe.prototype,"verticalScrollBar",[Ooe,Vc,Moe],Object.getOwnPropertyDescriptor(Woe.prototype,"verticalScrollBar"),Woe.prototype),x(Woe.prototype,"horizontalScrollBar",[Noe,Vc,Loe],Object.getOwnPropertyDescriptor(Woe.prototype,"horizontalScrollBar"),Woe.prototype),Xoe=x(Woe.prototype,"horizontal",[Vc,oc,Boe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yoe=x(Woe.prototype,"vertical",[Vc,oc,Foe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Koe=x(Woe.prototype,"cancelInnerEvents",[Vc,oc,zoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Qoe=x(Woe.prototype,"scrollEvents",[Uoe,oc,Vc,koe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zoe=x(Woe.prototype,"pageTurningSpeed",[oc,mc,Goe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Joe=x(Woe.prototype,"pageEvents",[Hoe,oc,Voe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$oe=x(Woe.prototype,"_sizeMode",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sae.Unified}}),eae=x(Woe.prototype,"_direction",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cae.Horizontal}}),tae=x(Woe.prototype,"_scrollThreshold",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),nae=x(Woe.prototype,"_pageTurningEventTiming",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),iae=x(Woe.prototype,"_indicator",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),joe=Woe))||joe)||joe)||joe)||joe));T.PageView=hae;var _ae=new dn,fae=new gn,dae=new gn,pae=new gn(1,1),mae=new gn,vae=new gn;function gae(e,t){if(!t._hadAlignOnce){t.alignMode===Hre.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=dae,o=pae;i?qre(e,n=i,r,o):n=e.parent;var a=Wre(n),s=n instanceof CI||!n.getComponent(QH),c=s?fae:n.getComponent(QH).anchorPoint,l=s;e.getPosition(_ae);var u=e._uiProps.uiTransformComp,h=_ae.x,_=_ae.y,f=u.anchorPoint,d=e.getScale();if(t.alignFlags&Vre.HORIZONTAL){var p=0,m=0,v=a.width;l?(p=OO.left.x,m=OO.right.x):m=(p=-c.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(p+=r.x,p*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,x=d.x;if(x<0&&(y=1-y,x=-x),t.isStretchWidth)g=m-p,0!==x&&(u.width=g/x),h=p+y*g;else if(g=u.width*x,t.isAlignHorizontalCenter){var S=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,T=(.5-c.x)*a.width;i&&(S*=o.x,T+=r.x,T*=o.x),h=T+(y-.5)*g+S}else h=t.isAlignLeft?p+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&Vre.VERTICAL){var E=0,C=0,A=a.height;l?(C=OO.bottom.y,E=OO.top.y):E=(C=-c.y*A)+A,C+=t.isAbsoluteBottom?t.bottom:t.bottom*A,E-=t.isAbsoluteTop?t.top:t.top*A,i&&(C+=r.y,C*=o.y,E+=r.y,E*=o.y);var b=0,P=f.y,R=d.y;if(R<0&&(P=1-P,R=-R),t.isStretchHeight)b=E-C,0!==R&&(u.height=b/R),_=C+P*b;else if(b=u.height*R,t.isAlignVerticalCenter){var w=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*A,I=(.5-c.y)*a.height;i&&(w*=o.y,I+=r.y,I*=o.y),_=I+(P-.5)*b+w}else _=t.isAlignBottom?C+P*b:E+(P-1)*b;t._lastSize.height=b}e.setPosition(h,_,_ae.z),dn.set(t._lastPos,h,_,_ae.z)}}function yae(e){var t=e.getComponent(doe);if(t&&t.enabled){if(!T.isValid(e,!0))return;Tae.push(t)}for(var n,i=g(e.children);!(n=i()).done;){var r=n.value;r.active&&yae(r)}}function xae(){var e=bM.getScene();if(e){Eae.isAligning=!0,Eae._nodesOrderDirty&&(Tae.length=0,yae(e),Eae._nodesOrderDirty=!1);var t=null,n=Eae._activeWidgetsIterator;for(n.i=0;n.i<Tae.length;++n.i)(t=Tae[n.i])._dirty&&(gae(t.node,t),t._dirty=!1);Eae.isAligning=!1}}var Sae,Tae=[],Eae=e("widgetManager",T._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new We.MutableForwardIterator(Tae),animationState:null,init:function(){bM.on(AM.EVENT_AFTER_SCENE_LAUNCH,xae),bM.on(AM.EVENT_AFTER_UPDATE,xae),lM.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);lM.instance.on("canvas-resize",e),Vu.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=bM.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=TA.isNode(e)&&e.getComponent(doe);t&&t.enabled&&(t.alignMode===Hre.ON_WINDOW_RESIZE||t.alignMode===Hre.ALWAYS)&&t.setDirty();for(var n,i=g(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var o=mae;o.set(0,0);var a=vae;if(a.set(1,1),e.target&&qre(i,r=e.target,o,a),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:fae,l=i._uiProps.uiTransformComp,u=Wre(r),h=l.anchorPoint,_=i.getPosition(),f=Vre,d=i.getScale(),p=0;if(t&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,p=_.x-h.x*l.width*d.x-m,e.isAbsoluteLeft||(p/=u.width),p/=a.x,e.left=n(e.left,p)}if(t&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,p=(v*=a.x)-(_.x+(1-h.x)*l.width*d.x),e.isAbsoluteRight||(p/=u.width),p/=a.x,e.right=n(e.right,p)}if(t&f.TOP){var g=(1-c.y)*u.height;g+=o.y,p=(g*=a.y)-(_.y+(1-h.y)*l.height*d.y),e.isAbsoluteTop||(p/=u.height),p/=a.y,e.top=n(e.top,p)}if(t&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,p=_.y-h.y*l.height*d.y-y,e.isAbsoluteBottom||(p/=u.height),p/=a.y,e.bottom=n(e.bottom,p)}}},updateAlignment:function e(t){var n=t.parent;n&&TA.isNode(n)&&e(n);var i=t.getComponent(doe);i&&n&&gae(t,i)},AlignMode:Hre,AlignFlags:Vre});bM.on(AM.EVENT_INIT,(function(){Eae.init()}));var Cae,Aae,bae,Pae,Rae,wae,Iae,Dae,Oae,Mae,Nae,Lae,Bae,Fae,zae,Uae,kae,Gae,Hae,Vae=e("SafeArea",$s("cc.SafeArea")(Sae=pc()(Sae=tc(110)(Sae=uc(Sae=hc()(Sae=ec(doe)(Sae=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),Vu.on("window-resize",this.updateArea,this),Vu.on("orientation-change",this.updateArea,this)},n.onDisable=function(){Vu.off("window-resize",this.updateArea,this),Vu.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(doe),t=this.node.getComponent(QH);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=fM.getVisibleSize(),o=r.width,a=r.height,s=qu.getSafeAreaRect();e.top=a-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=o-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),Eae.add(e)}},t}(Bu))||Sae)||Sae)||Sae)||Sae)||Sae)||Sae);T.SafeArea=Vae,e("UICoordinateTracker",(Cae=$s("cc.UICoordinateTracker"),Aae=pc(),bae=hc(),Pae=tc(110),Rae=Mc(TA),wae=xc(),Iae=Mc(gB),Dae=xc(),Oae=xc(),Mae=xc(),Nae=Mc([eB]),Lae=xc(),Cae(Bae=Aae(Bae=bae(Bae=Pae((x((Fae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",zae,m(t)),y(t,"_target",Uae,m(t)),y(t,"_camera",kae,m(t)),y(t,"_useScale",Gae,m(t)),y(t,"_distance",Hae,m(t)),t._transformPos=new dn,t._viewPos=new dn,t._canMove=!0,t._lastWPos=new dn,t._lastCameraPos=new dn,t}u(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&dn.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);eB.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},c(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(Bu)).prototype,"target",[Rae,wae],Object.getOwnPropertyDescriptor(Fae.prototype,"target"),Fae.prototype),x(Fae.prototype,"camera",[Iae,Dae],Object.getOwnPropertyDescriptor(Fae.prototype,"camera"),Fae.prototype),x(Fae.prototype,"useScale",[Oae],Object.getOwnPropertyDescriptor(Fae.prototype,"useScale"),Fae.prototype),x(Fae.prototype,"distance",[Mae],Object.getOwnPropertyDescriptor(Fae.prototype,"distance"),Fae.prototype),zae=x(Fae.prototype,"syncEvents",[Nae,oc,Lae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uae=x(Fae.prototype,"_target",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kae=x(Fae.prototype,"_camera",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gae=x(Fae.prototype,"_useScale",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hae=x(Fae.prototype,"_distance",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Bae=Fae))||Bae)||Bae)||Bae)||Bae));var jae,Wae=[xE.TOUCH_START,xE.TOUCH_END,xE.TOUCH_MOVE,xE.MOUSE_DOWN,xE.MOUSE_MOVE,xE.MOUSE_UP,xE.MOUSE_ENTER,xE.MOUSE_LEAVE,xE.MOUSE_WHEEL];function qae(e){e.propagationStopped=!0}e("BlockInputEvents",$s("cc.BlockInputEvents")(jae=pc()(jae=hc()(jae=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<Wae.length;e++)this.node.on(Wae[e],qae,this)},n.onDisable=function(){for(var e=0;e<Wae.length;e++)this.node.off(Wae[e],qae,this)},t}(Bu))||jae)||jae)||jae);var Xae,Yae,Kae,Qae,Zae,Jae,$ae,ese,tse,nse,ise,rse,ose,ase,sse,cse={},lse=e("SubContextView",(Xae=$s("cc.SubContextView"),Yae=pc(),Kae=tc(110),Qae=ec(QH),Zae=hc(),Jae=xc(),$ae=xc(),Xae(ese=Yae(ese=Kae(ese=Qae(ese=Zae((x((tse=function(e){function t(){var t;return y(t=e.call(this)||this,"_fps",nse,m(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,y(t,"_designResolutionSize",ise,m(t)),t._content=new TA("content"),t._content.hideFlags|=Jc.Flags.DontSave|Jc.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new bm,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new Km,t}u(t,e);var n=t.prototype;return n.onLoad=function(){cse.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=cse.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas;e.width=this._designResolutionSize.width,e.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(EX),this._sprite||(this._sprite=this._content.addComponent(EX)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new EG;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(QH),t=this._content.getComponent(QH),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var o=fM.getViewportRect(),a=t.getBoundingBoxToWorld(),s=fM.getVisibleSize(),c=Vu.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(xE.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(xE.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(xE.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(xE.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(xE.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(xE.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},c(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(Bu)).prototype,"designResolutionSize",[Jae],Object.getOwnPropertyDescriptor(tse.prototype,"designResolutionSize"),tse.prototype),x(tse.prototype,"fps",[$ae],Object.getOwnPropertyDescriptor(tse.prototype,"fps"),tse.prototype),nse=x(tse.prototype,"_fps",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),ise=x(tse.prototype,"_designResolutionSize",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kn(640,960)}}),ese=tse))||ese)||ese)||ese)||ese)||ese));T.SubContextView=lse;var use=e("VideoClip",$s("cc.VideoClip")((sse=function(e){function t(){var t;return y(t=e.call(this)||this,"_duration",ase,m(t)),t._video=null,t}return u(t,e),c(t,[{key:"_nativeAsset",get:function(){return this._video},set:function(e){this._video=e,this._duration=e?e.duration:0}}]),t}(pu),ase=x((ose=sse).prototype,"_duration",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rse=ose))||rse);function hse(e,t,n){var i=document.createElement("video"),r=document.createElement("source");i.appendChild(r);var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){200===this.status||0===this.status?(r.src=URL.createObjectURL(this.response),n(null,i)):n(new Error(o.status+"(no response)"))},o.onerror=function(){var t="load video failure - "+e;O(t),n(new Error(t))},o.send()}function _se(e,t,n,i){var r=new use;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}oN.register({".mp4":hse,".avi":hse,".mov":hse,".mpg":hse,".mpeg":hse,".rm":hse,".rmvb":hse}),_N.register({".mp4":_se,".avi":_se,".mov":_se,".mpg":_se,".mpeg":_se,".rm":_se,".rmvb":_se});var fse,dse,pse=Ye({REMOTE:0,LOCAL:1});!function(e){e.NONE="none",e.PLAYING="playing",e.PAUSED="paused",e.STOPPED="stopped",e.COMPLETED="completed",e.META_LOADED="meta-loaded",e.READY_TO_PLAY="ready-to-play",e.ERROR="error",e.CLICKED="clicked"}(fse||(fse={})),function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(dse||(dse={}));var mse=function(){function e(e){var t=this;this._componentEventList=new Map,this._state=fse.NONE,this._video=null,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._fullScreenOnAwake=!1,this._visible=!0,this._playing=!1,this._cachedCurrentTime=-1,this._waitingFullscreen=!1,this._waitingPlay=!1,this._keepAspectRatio=!1,this._component=null,this._uiTrans=null,this._node=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=e,this._node=e.node,this._uiTrans=e.node.getComponent(QH),this._onHide=function(){t.video&&t._state===fse.PLAYING&&(t.video.pause(),t._interrupted=!0)},this._onShow=function(){t._interrupted&&t.video&&(t.video.play(),t._interrupted=!1)},T.game.on(T.Game.EVENT_HIDE,this._onHide),T.game.on(T.Game.EVENT_SHOW,this._onShow)}var t=e.prototype;return t.onLoadedMetadata=function(e){this._loadedMeta=!0,this._forceUpdate=!0,this._visible?this.enable():this.disable(),this.dispatchEvent(fse.META_LOADED);var t=e.target;this._keepAspectRatio&&t&&this.syncUITransform(t.videoWidth,t.videoHeight),this.delayedFullScreen(),this.delayedPlay()},t.onCanPlay=function(){this._loaded=!0,this.dispatchEvent(fse.READY_TO_PLAY)},t.onPlay=function(){this._playing=!0,this.dispatchEvent(fse.PLAYING)},t.onPlaying=function(){this.dispatchEvent(fse.PLAYING)},t.onPause=function(){this._ignorePause?this._ignorePause=!1:(this._playing=!1,this.dispatchEvent(fse.PAUSED))},t.onStoped=function(){this._playing=!1,this._ignorePause=!1,this.dispatchEvent(fse.STOPPED)},t.onEnded=function(){this.dispatchEvent(fse.COMPLETED)},t.onClick=function(){this.dispatchEvent(fse.CLICKED)},t.onError=function(e){this.dispatchEvent(fse.ERROR);var t=e.target;t&&t.error&&N("Error "+t.error.code+"; details: "+t.error.message)},t.play=function(){this._loadedMeta||this._loaded?this.canPlay():this._waitingPlay=!0},t.delayedPlay=function(){this._waitingPlay&&(this.canPlay(),this._waitingPlay=!1)},t.syncFullScreenOnAwake=function(e){this._fullScreenOnAwake=e,this._loadedMeta||this._loaded?this.canFullScreen(e):this._waitingFullscreen=!0},t.delayedFullScreen=function(){this._waitingFullscreen&&(this.canFullScreen(this._fullScreenOnAwake),this._waitingFullscreen=!1)},t.dispatchEvent=function(e){var t=this._componentEventList.get(e);t&&(this._state=e,t.call(this))},t.syncUITransform=function(e,t){this._uiTrans&&(this._uiTrans.width=e,this._uiTrans.height=t)},t.syncCurrentTime=function(){this.video&&-1!==this._cachedCurrentTime&&this.video.currentTime!==this._cachedCurrentTime&&(this.seekTo(this._cachedCurrentTime),this._cachedCurrentTime=-1)},t.destroy=function(){this.removeVideoPlayer(),this._componentEventList.clear(),T.game.off(T.Game.EVENT_HIDE,this._onHide),T.game.off(T.Game.EVENT_SHOW,this._onShow)},c(e,[{key:"fullScreenOnAwake",get:function(){return this._fullScreenOnAwake}},{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"video",get:function(){return this._video}},{key:"state",get:function(){return this._state}},{key:"isPlaying",get:function(){return this._playing}},{key:"UICamera",get:function(){return bM.root.batcher2D.getFirstRenderCamera(this._node)}}]),e}();T.internal.VideoPlayerImpl=mse;var vse,gse,yse,xse,Sse,Tse,Ese,Cse,Ase,bse,Pse,Rse,wse,Ise,Dse,Ose,Mse,Nse,Lse,Bse,Fse,zse,Use,kse,Gse,Hse,Vse,jse,Wse,qse,Xse,Yse,Kse,Qse,Zse,Jse,$se,ece,tce,nce=-Math.pow(2,15),ice=zn(),rce=function(e){function t(t){var n;return(n=e.call(this,t)||this)._eventList=new Map,n._clearColorA=-1,n._clearFlag=void 0,n}u(t,e);var n=t.prototype;return n.addListener=function(e,t){this._video&&(this._eventList.set(e,t),this._video.addEventListener(e,t))},n.removeAllListeners=function(){var e=this;this._eventList.forEach((function(t,n){e._video&&e._video.removeEventListener(n,t)})),this._eventList.clear()},n.canPlay=function(){var e=this;if(this.video){var t=this.video.play();window.Promise&&t instanceof Promise&&t.catch((function(){})).then((function(){e.syncCurrentTime()}))}},n.pause=function(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)},n.resume=function(){this.play()},n.stop=function(){var e=this;this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),this._cachedCurrentTime=0,setTimeout((function(){e._ignorePause=!1,e.dispatchEvent(fse.STOPPED)}),0))},n.syncClip=function(e){this.removeVideoPlayer(),e&&this.createVideoPlayer(e.nativeUrl)},n.syncURL=function(e){this.removeVideoPlayer(),e&&this.createVideoPlayer(e)},n.syncPlaybackRate=function(e){qu.browserType!==kl.UC?this.video&&(this.video.playbackRate=e):M("playbackRate is not supported by the uc mobile browser.")},n.syncVolume=function(e){this.video&&(this.video.volume=e)},n.syncMute=function(e){this.video&&(this.video.muted=e)},n.syncLoop=function(e){this.video&&(this.video.loop=e)},n.getDuration=function(){return this.video?this.video.duration:0},n.getCurrentTime=function(){return this.video?this.video.currentTime:-1},n.seekTo=function(e){this.video&&(this.video.currentTime=e)},n.canFullScreen=function(e){var t=this,n=this._video;if(n&&n.readyState===dse.HAVE_ENOUGH_DATA)return qu.os===Vl.IOS&&qu.isBrowser?(e?n.webkitEnterFullscreen&&n.webkitEnterFullscreen():n.webkitExitFullscreen&&n.webkitExitFullscreen(),void(this._fullScreenOnAwake=n.webkitDisplayingFullscreen)):Wu.supportsFullScreen?void(e?(qu.browserType===kl.IE&&(n.style.transform=""),n.setAttribute("x5-video-player-fullscreen","true"),Wu.requestFullScreen(n,(function(e){var i=qu.browserType===kl.IE?e.msFullscreenElement:e.fullscreenElement;t._fullScreenOnAwake=i===n}),(function(){t._fullScreenOnAwake=!1}))):(n.removeAttribute("x5-video-player-fullscreen"),Wu.exitFullScreen())):(this._fullScreenOnAwake=e,this._forceUpdate=!0,void this.syncMatrix())},n.syncStayOnBottom=function(e){this._video&&(this._video.style["z-index"]=e?nce:0,this._stayOnBottom=e),this._dirty=!0},n.syncKeepAspectRatio=function(e){this._keepAspectRatio=e,e&&this._loadedMeta&&this._video&&this.syncUITransform(this._video.videoWidth,this._video.videoHeight)},n.removeVideoPlayer=function(){var e=this._video;e&&st(aM.container,e)&&(aM.container.removeChild(e),this.removeAllListeners()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._loadedMeta=!1,this._video=null},n.createVideoPlayer=function(e){var t=this._video=document.createElement("video");t.className="cocosVideo",t.style.visibility="hidden",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style["transform-origin"]="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",t.setAttribute("preload","auto"),t.setAttribute("webkit-playsinline",""),t.setAttribute("x5-playsinline",""),t.setAttribute("playsinline",""),this._bindDomEvent(),aM.container.appendChild(t);var n=document.createElement("source");t.appendChild(n),n.src=e},n._bindDomEvent=function(){this._video,this.addListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.addListener("canplay",this.onCanPlay.bind(this)),this.addListener("canplaythrough",this.onCanPlay.bind(this)),this.addListener("play",this.onPlay.bind(this)),this.addListener("playing",this.onPlaying.bind(this)),this.addListener("pause",this.onPause.bind(this)),this.addListener("click",this.onClick.bind(this)),this.addListener("ended",this.onEnded.bind(this)),this.addListener("error",this.onError.bind(this))},n.onCanPlay=function(t){var n=t.target;if(!this._loaded||!n)switch(n.readyState){case dse.HAVE_METADATA:case dse.HAVE_ENOUGH_DATA:e.prototype.onCanPlay.call(this,t)}},n.enable=function(){if(this._video){if(this._visible=!0,"visible"===this._video.style.visibility)return;this._video.style.visibility="visible"}},n.disable=function(e){if(this._video){if(!e&&this._playing&&this._video.pause(),this._visible=!1,"hidden"===this._video.style.visibility)return;this._video.style.visibility="hidden"}},n.syncMatrix=function(){if(this._video&&this._visible&&this._component){var e=this.UICamera;if(e&&!Wu.fullScreen()){this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=e.clearColor.w,this._clearFlag=e.clearFlag,e.clearColor.w=0,e.clearFlag=Bi.ALL):this._clearFlag&&(e.clearColor.w=this._clearColorA,e.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._component.node.getWorldMatrix(ice),e.update(!0),e.worldMatrixToScreen(ice,ice,aM.canvas.width,aM.canvas.height);var t=0,n=0;if(this._fullScreenOnAwake?(t=OO.width,n=OO.height):(t=this._uiTrans.contentSize.width,n=this._uiTrans.contentSize.height),this._forceUpdate||this._m00!==ice.m00||this._m01!==ice.m01||this._m04!==ice.m04||this._m05!==ice.m05||this._m12!==ice.m12||this._m13!==ice.m13||this._w!==t||this._h!==n){this._m00=ice.m00,this._m01=ice.m01,this._m04=ice.m04,this._m05=ice.m05,this._m12=ice.m12,this._m13=ice.m13,this._w=t,this._h=n;var i=Vu.devicePixelRatio,r=1/i,o=1/i,a=aM.container,s=ice.m00*r,c=ice.m01,l=ice.m04,u=ice.m05*o;this._video.style.width=this._w+"px",this._video.style.height=this._h+"px",qu.browserType!==kl.MOBILE_QQ?this._video.style.objectFit=this._keepAspectRatio?"none":"fill":M("keepAspectRatio is not supported by the qq mobile browser.");var h=this._w*r,_=this._h*o,f=this._uiTrans.anchorPoint,d=f.x,p=f.y,m=h*ice.m00*d,v=_*ice.m05*p,g=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,y=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0,x="matrix("+s+","+-c+","+-l+","+u+","+(ice.m12*r-m+g)+","+-(ice.m13*o-v+y)+")";this._video.style.transform=x,this._video.style["-webkit-transform"]=x,qu.browserType!==kl.IE&&(this._forceUpdate=!1)}}}},t}(mse),oce=function(){function e(){}return e.getImpl=function(e){return new rce(e)},e}();T.internal.VideoPlayerImplManager=oce;var ace=e("VideoPlayer",(vse=$s("cc.VideoPlayer"),gse=pc(),yse=hc(),xse=ec(QH),Sse=Mc(use),Tse=Mc(pse),Ese=xc(),Cse=xc(),Ase=Mc(use),bse=xc(),Pse=xc(),Rse=Sc(),wse=xc(),Ise=Sc(),Dse=xc(),Ose=xc(),Mse=xc(),Nse=xc(),Lse=xc(),Bse=xc(),Fse=Mc([eB]),zse=bc(),Use=xc(),vse(kse=gse(kse=yse(kse=xse(kse=uc((tce=ece=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return y(t=e.call.apply(e,[this].concat(i))||this,"_resourceType",Hse,m(t)),y(t,"_remoteURL",Vse,m(t)),y(t,"_clip",jse,m(t)),y(t,"_playOnAwake",Wse,m(t)),y(t,"_volume",qse,m(t)),y(t,"_mute",Xse,m(t)),y(t,"_playbackRate",Yse,m(t)),y(t,"_loop",Kse,m(t)),y(t,"_fullScreenOnAwake",Qse,m(t)),y(t,"_stayOnBottom",Zse,m(t)),y(t,"_keepAspectRatio",Jse,m(t)),t._impl=null,t._cachedCurrentTime=0,y(t,"videoPlayerEvent",$se,m(t)),t}u(t,e);var n=t.prototype;return n.syncSource=function(){this._impl&&(this._resourceType===pse.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))},n.__preload=function(){this._impl=oce.getImpl(this),this.syncSource(),this._impl.syncLoop(this._loop),this._impl.syncVolume(this._volume),this._impl.syncMute(this._mute),this._impl.seekTo(this._cachedCurrentTime),this._impl.syncPlaybackRate(this._playbackRate),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.componentEventList.set(fse.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.componentEventList.set(fse.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.componentEventList.set(fse.PLAYING,this.onPlaying.bind(this)),this._impl.componentEventList.set(fse.PAUSED,this.onPaused.bind(this)),this._impl.componentEventList.set(fse.STOPPED,this.onStopped.bind(this)),this._impl.componentEventList.set(fse.COMPLETED,this.onCompleted.bind(this)),this._impl.componentEventList.set(fse.ERROR,this.onError.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()},n.onEnable=function(){this._impl&&this._impl.enable()},n.onDisable=function(){this._impl&&this._impl.disable()},n.onDestroy=function(){this._impl&&(this._impl.destroy(),this._impl=null)},n.update=function(){this._impl&&this._impl.syncMatrix()},n.onMetaLoaded=function(){eB.emitEvents(this.videoPlayerEvent,this,fse.META_LOADED),this.node.emit("meta-loaded",this)},n.onReadyToPlay=function(){this._playOnAwake&&!this.isPlaying&&this.play(),eB.emitEvents(this.videoPlayerEvent,this,fse.READY_TO_PLAY),this.node.emit(fse.READY_TO_PLAY,this)},n.onPlaying=function(){eB.emitEvents(this.videoPlayerEvent,this,fse.PLAYING),this.node.emit(fse.PLAYING,this)},n.onPaused=function(){eB.emitEvents(this.videoPlayerEvent,this,fse.PAUSED),this.node.emit(fse.PAUSED,this)},n.onStopped=function(){eB.emitEvents(this.videoPlayerEvent,this,fse.STOPPED),this.node.emit(fse.STOPPED,this)},n.onCompleted=function(){eB.emitEvents(this.videoPlayerEvent,this,fse.COMPLETED),this.node.emit(fse.COMPLETED,this)},n.onError=function(){eB.emitEvents(this.videoPlayerEvent,this,fse.ERROR),this.node.emit(fse.ERROR,this)},n.play=function(){this._impl&&this._impl.play()},n.resume=function(){this._impl&&this._impl.resume()},n.pause=function(){this._impl&&this._impl.pause()},n.stop=function(){this._impl&&this._impl.stop()},c(t,[{key:"resourceType",get:function(){return this._resourceType},set:function(e){this._resourceType!==e&&(this._resourceType=e,this.syncSource())}},{key:"remoteURL",get:function(){return this._remoteURL},set:function(e){this._remoteURL!==e&&(this._remoteURL=e,this.syncSource())}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip!==e&&(this._clip=e,this.syncSource())}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"playbackRate",get:function(){return this._playbackRate},set:function(e){this._playbackRate=e,this._impl&&this._impl.syncPlaybackRate(e)}},{key:"volume",get:function(){return this._volume},set:function(e){this._volume=e,this._impl&&this._impl.syncVolume(e)}},{key:"mute",get:function(){return this._mute},set:function(e){this._mute=e,this._impl&&this._impl.syncMute(e)}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._impl&&this._impl.syncLoop(e)}},{key:"keepAspectRatio",get:function(){return this._keepAspectRatio},set:function(e){this._keepAspectRatio!==e&&(this._keepAspectRatio=e,this._impl&&this._impl.syncKeepAspectRatio(e))}},{key:"fullScreenOnAwake",get:function(){return this._impl?(this._fullScreenOnAwake=this._impl.fullScreenOnAwake,this._fullScreenOnAwake):this._fullScreenOnAwake},set:function(e){this._fullScreenOnAwake!==e&&(this._fullScreenOnAwake=e,this._impl&&this._impl.syncFullScreenOnAwake(e))}},{key:"stayOnBottom",get:function(){return this._stayOnBottom},set:function(e){this._stayOnBottom!==e&&(this._stayOnBottom=e,this._impl&&this._impl.syncStayOnBottom(e))}},{key:"nativeVideo",get:function(){return this._impl&&this._impl.video||null}},{key:"currentTime",get:function(){return this._impl?this._impl.getCurrentTime():this._cachedCurrentTime},set:function(e){Number.isNaN(e)?M("illegal video time! value:"+e):(e=Kt(e,0,this.duration),this._cachedCurrentTime=e,this._impl&&this._impl.seekTo(e))}},{key:"duration",get:function(){return this._impl?this._impl.getDuration():0}},{key:"state",get:function(){return this._impl?this._impl.state:fse.NONE}},{key:"isPlaying",get:function(){return!!this._impl&&this._impl.isPlaying}}]),t}(Bu),ece.EventType=fse,ece.ResourceType=pse,Hse=x((Gse=tce).prototype,"_resourceType",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pse.LOCAL}}),Vse=x(Gse.prototype,"_remoteURL",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jse=x(Gse.prototype,"_clip",[Sse,oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wse=x(Gse.prototype,"_playOnAwake",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qse=x(Gse.prototype,"_volume",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Xse=x(Gse.prototype,"_mute",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yse=x(Gse.prototype,"_playbackRate",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Kse=x(Gse.prototype,"_loop",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qse=x(Gse.prototype,"_fullScreenOnAwake",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zse=x(Gse.prototype,"_stayOnBottom",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jse=x(Gse.prototype,"_keepAspectRatio",[oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x(Gse.prototype,"resourceType",[Tse,Ese],Object.getOwnPropertyDescriptor(Gse.prototype,"resourceType"),Gse.prototype),x(Gse.prototype,"remoteURL",[Cse],Object.getOwnPropertyDescriptor(Gse.prototype,"remoteURL"),Gse.prototype),x(Gse.prototype,"clip",[Ase,bse],Object.getOwnPropertyDescriptor(Gse.prototype,"clip"),Gse.prototype),x(Gse.prototype,"playOnAwake",[Pse],Object.getOwnPropertyDescriptor(Gse.prototype,"playOnAwake"),Gse.prototype),x(Gse.prototype,"playbackRate",[Ac,Rse,wse],Object.getOwnPropertyDescriptor(Gse.prototype,"playbackRate"),Gse.prototype),x(Gse.prototype,"volume",[Ac,Ise,Dse],Object.getOwnPropertyDescriptor(Gse.prototype,"volume"),Gse.prototype),x(Gse.prototype,"mute",[Ose],Object.getOwnPropertyDescriptor(Gse.prototype,"mute"),Gse.prototype),x(Gse.prototype,"loop",[Mse],Object.getOwnPropertyDescriptor(Gse.prototype,"loop"),Gse.prototype),x(Gse.prototype,"keepAspectRatio",[Nse],Object.getOwnPropertyDescriptor(Gse.prototype,"keepAspectRatio"),Gse.prototype),x(Gse.prototype,"fullScreenOnAwake",[Lse],Object.getOwnPropertyDescriptor(Gse.prototype,"fullScreenOnAwake"),Gse.prototype),x(Gse.prototype,"stayOnBottom",[Bse],Object.getOwnPropertyDescriptor(Gse.prototype,"stayOnBottom"),Gse.prototype),$se=x(Gse.prototype,"videoPlayerEvent",[oc,Fse,zse,Use],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kse=Gse))||kse)||kse)||kse)||kse)||kse));T.internal.VideoPlayer=ace}}}));
